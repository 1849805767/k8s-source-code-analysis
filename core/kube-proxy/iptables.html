
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Iptables-mode Proxier · 《k8s-1.13版本源码分析》</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Tao Hu <farmer.hutao@outlook.com>">
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-codeblock-filename/block.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-navigator/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-multipart/multipart.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-tbfed-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-prism/prism.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-donate/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-theme-comscore/test.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="ipvs.html" />
    
    
    <link rel="prev" href="arch.html" />
    

    <style>
    @media only screen and (max-width: 640px) {
        .book-header .hidden-mobile {
            display: none;
        }
    }
    </style>
    <script>
        window["gitbook-plugin-github-buttons"] = {"repo":"farmer-hutao/k8s-source-code-analysis","types":["star"],"size":"small"};
    </script>

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Part I - 准备工作</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                        <b>1.1.</b>
                    
                    前言
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../../prepare/">
            
                <a href="../../prepare/">
            
                    
                        <b>1.2.</b>
                    
                    k8s源码分析准备工作
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../../prepare/get-code.html">
            
                <a href="../../prepare/get-code.html">
            
                    
                        <b>1.2.1.</b>
                    
                    源码准备
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../../prepare/debug-environment.html">
            
                <a href="../../prepare/debug-environment.html">
            
                    
                        <b>1.2.2.</b>
                    
                    测试环境搭建-单节点
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../../prepare/debug-environment-3node.html">
            
                <a href="../../prepare/debug-environment-3node.html">
            
                    
                        <b>1.2.3.</b>
                    
                    测试环境搭建-三节点
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../../prepare/debug.html">
            
                <a href="../../prepare/debug.html">
            
                    
                        <b>1.2.4.</b>
                    
                    源码调试
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Part II - 核心组件</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../">
            
                <a href="../">
            
                    
                        <b>2.1.</b>
                    
                    概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../scheduler/">
            
                <a href="../scheduler/">
            
                    
                        <b>2.2.</b>
                    
                    scheduler
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.2.1" data-path="../scheduler/design.html">
            
                <a href="../scheduler/design.html">
            
                    
                        <b>2.2.1.</b>
                    
                    调度器设计
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.2" data-path="../scheduler/before-scheduler-run.html">
            
                <a href="../scheduler/before-scheduler-run.html">
            
                    
                        <b>2.2.2.</b>
                    
                    调度程序启动前逻辑
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.3" data-path="../scheduler/scheduler-framework.html">
            
                <a href="../scheduler/scheduler-framework.html">
            
                    
                        <b>2.2.3.</b>
                    
                    调度器框架
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.4" data-path="../scheduler/generic-scheduler.html">
            
                <a href="../scheduler/generic-scheduler.html">
            
                    
                        <b>2.2.4.</b>
                    
                    一般调度过程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.5" data-path="../scheduler/predicate.html">
            
                <a href="../scheduler/predicate.html">
            
                    
                        <b>2.2.5.</b>
                    
                    预选过程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.6" data-path="../scheduler/priority.html">
            
                <a href="../scheduler/priority.html">
            
                    
                        <b>2.2.6.</b>
                    
                    优选过程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.7" data-path="../scheduler/preempt.html">
            
                <a href="../scheduler/preempt.html">
            
                    
                        <b>2.2.7.</b>
                    
                    抢占调度
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.8" data-path="../scheduler/init.html">
            
                <a href="../scheduler/init.html">
            
                    
                        <b>2.2.8.</b>
                    
                    调度器初始化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.9" data-path="../scheduler/affinity.html">
            
                <a href="../scheduler/affinity.html">
            
                    
                        <b>2.2.9.</b>
                    
                    专题-亲和性调度
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.10" data-path="../scheduler/summarize.html">
            
                <a href="../scheduler/summarize.html">
            
                    
                        <b>2.2.10.</b>
                    
                    scheduler 总结
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../controller-manager/">
            
                <a href="../controller-manager/">
            
                    
                        <b>2.3.</b>
                    
                    controller-manager
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.3.1" data-path="../controller-manager/controller.html">
            
                <a href="../controller-manager/controller.html">
            
                    
                        <b>2.3.1.</b>
                    
                    控制器概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.2" data-path="../controller-manager/custom-controller.html">
            
                <a href="../controller-manager/custom-controller.html">
            
                    
                        <b>2.3.2.</b>
                    
                    自定义控制器
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../apiserver/">
            
                <a href="../apiserver/">
            
                    
                        <b>2.4.</b>
                    
                    apiserver
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="./">
            
                <a href="./">
            
                    
                        <b>2.5.</b>
                    
                    kube-proxy
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.5.1" data-path="arch.html">
            
                <a href="arch.html">
            
                    
                        <b>2.5.1.</b>
                    
                    Proxy 服务框架
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.5.2" data-path="iptables.html">
            
                <a href="iptables.html">
            
                    
                        <b>2.5.2.</b>
                    
                    Iptables-mode Proxier
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5.3" data-path="ipvs.html">
            
                <a href="ipvs.html">
            
                    
                        <b>2.5.3.</b>
                    
                    Ipvs-Mode Proxier
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5.4" data-path="userspace.html">
            
                <a href="userspace.html">
            
                    
                        <b>2.5.4.</b>
                    
                    Userspace-mode Proxier
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="../kubelet/">
            
                <a href="../kubelet/">
            
                    
                        <b>2.6.</b>
                    
                    kubelet
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Part III - 周边项目</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../../around/">
            
                <a href="../../around/">
            
                    
                        <b>3.1.</b>
                    
                    概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../../around/client-go/">
            
                <a href="../../around/client-go/">
            
                    
                        <b>3.2.</b>
                    
                    client-go
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.2.1" data-path="../../around/client-go/informer.html">
            
                <a href="../../around/client-go/informer.html">
            
                    
                        <b>3.2.1.</b>
                    
                    Informer (一)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.2" data-path="../../around/client-go/informer2.html">
            
                <a href="../../around/client-go/informer2.html">
            
                    
                        <b>3.2.2.</b>
                    
                    Informer(二)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../../around/runc/">
            
                <a href="../../around/runc/">
            
                    
                        <b>3.3.</b>
                    
                    RunC
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.3.1" data-path="../../around/runc/namespace.html">
            
                <a href="../../around/runc/namespace.html">
            
                    
                        <b>3.3.1.</b>
                    
                    RunC 源码通读之 NameSpace
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.2" data-path="../../around/runc/cgroup.html">
            
                <a href="../../around/runc/cgroup.html">
            
                    
                        <b>3.3.2.</b>
                    
                    RunC 源码通读之 Cgroup
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Iptables-mode Proxier</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="Iptables-mode_Proxier">Iptables-mode Proxier</h1>
<!-- toc -->
<ul>
<li><a href="#%E6%A6%82%E8%BF%B0">&#x6982;&#x8FF0;</a></li>
<li><a href="#proxier-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%B1%BB%E5%AE%9A%E4%B9%89">Proxier &#x6570;&#x636E;&#x7ED3;&#x6784;&#x4E0E;&#x7C7B;&#x5B9A;&#x4E49;</a></li>
<li><a href="#proxier%E5%AF%B9%E8%B1%A1%E7%94%9F%E6%88%90%E4%B8%8E%E8%BF%90%E8%A1%8C">Proxier&#x5BF9;&#x8C61;&#x751F;&#x6210;&#x4E0E;&#x8FD0;&#x884C;</a></li>
<li><a href="#proxier-%E6%9C%8D%E5%8A%A1%E4%B8%8E%E7%AB%AF%E7%82%B9%E6%9B%B4%E6%96%B0-tracker">Proxier &#x670D;&#x52A1;&#x4E0E;&#x7AEF;&#x70B9;&#x66F4;&#x65B0; Tracker</a></li>
<li><a href="#syncproxyrule-%E5%90%8C%E6%AD%A5%E9%85%8D%E7%BD%AE%E4%B8%8E%E8%A7%84%E5%88%99">syncProxyRule &#x540C;&#x6B65;&#x914D;&#x7F6E;&#x4E0E;&#x89C4;&#x5219;</a><ul>
<li><a href="#%E6%9B%B4%E6%96%B0-service-%E5%92%8C-endpoints-%E8%BF%94%E5%9B%9E%E6%9B%B4%E6%96%B0%E7%BB%93%E6%9E%9C">&#x66F4;&#x65B0; service &#x548C; endpoints ;&#x8FD4;&#x56DE;&#x66F4;&#x65B0;&#x7ED3;&#x679C;</a><ul>
<li><a href="#updateservicemap-svc-%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%9B%B4%E6%96%B0%E5%AE%9E%E7%8E%B0">UpdateServiceMap() SVC &#x670D;&#x52A1;&#x7684;&#x66F4;&#x65B0;&#x5B9E;&#x73B0;</a></li>
<li><a href="#updateendpointsmap-%E7%AB%AF%E7%82%B9%E6%9B%B4%E6%96%B0%E7%9A%84%E5%AE%9E%E7%8E%B0">UpdateEndpointsMap() &#x7AEF;&#x70B9;&#x66F4;&#x65B0;&#x7684;&#x5B9E;&#x73B0;</a></li>
</ul>
</li>
<li><a href="#%E5%88%9B%E5%BB%BA%E4%B8%8E%E8%81%94%E6%8E%A5-kube-%E9%93%BE">&#x521B;&#x5EFA;&#x4E0E;&#x8054;&#x63A5; kube &#x94FE;</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA-iptables-%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE">&#x521B;&#x5EFA; Iptables &#x57FA;&#x7840;&#x6570;&#x636E;</a></li>
<li><a href="#%E4%B8%BA%E6%AF%8F%E4%B8%AA-service-%E5%88%9B%E5%BB%BA-rules">&#x4E3A;&#x6BCF;&#x4E2A; service &#x521B;&#x5EFA; rules</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E6%94%B6%E5%B0%BE%E8%A7%84%E5%88%99%E6%95%B0%E6%8D%AE">&#x914D;&#x7F6E;&#x6536;&#x5C3E;&#x89C4;&#x5219;&#x6570;&#x636E;</a></li>
<li><a href="#%E6%B1%87%E9%9B%86%E4%B8%8E%E5%8A%A0%E8%BD%BD-iptables-%E9%85%8D%E7%BD%AE%E8%A7%84%E5%88%99%E6%95%B0%E6%8D%AE">&#x6C47;&#x96C6;&#x4E0E;&#x52A0;&#x8F7D; iptables &#x914D;&#x7F6E;&#x89C4;&#x5219;&#x6570;&#x636E;</a></li>
</ul>
</li>
<li><a href="#iptables-%E5%BA%95%E5%B1%82%E7%9A%84-runner-%E5%AE%9E%E7%8E%B0">IPtables &#x5E95;&#x5C42;&#x7684; runner &#x5B9E;&#x73B0;</a><ul>
<li><a href="#iptables-%E6%89%A7%E8%A1%8C%E5%99%A8">iptables &#x6267;&#x884C;&#x5668;</a></li>
<li><a href="#iptables-%E6%89%A7%E8%A1%8C%E5%99%A8%E6%96%B9%E6%B3%95">iptables &#x6267;&#x884C;&#x5668;&#x65B9;&#x6CD5;</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
<h2 id="&#x6982;&#x8FF0;">1. &#x6982;&#x8FF0;</h2>
<p>kube-Proxy&#x63D0;&#x4F9B;&#x4E09;&#x79CD;&#x6A21;&#x5F0F;(userspace/iptables/ipvs)&#x7684;proxier&#x5B9E;&#x73B0;,userspace&#x662F;&#x65E9;&#x671F;&#x7684;proxy&#x6A21;&#x5F0F;&#xFF0C;ipvs&#x6A21;&#x5F0F;&#x5904;&#x4E8E;&#x5B9E;&#x9A8C;&#x6027;&#x9636;&#x6BB5;proxy&#x6A21;&#x5F0F;&#xFF0C;&#x672C;&#x6587;&#x5148;&#x4ECE;&#x9ED8;&#x8BA4;&#x7684;&#x5185;&#x6838;&#x7EA7;iptables proxier&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#x4E0E;&#x903B;&#x8F91;&#x5206;&#x6790;&#x5F00;&#x59CB;&#xFF0C;&#x5176;&#x5B83;&#x6A21;&#x5F0F;&#x5C06;&#x7528;&#x4E13;&#x6587;&#x89E3;&#x6790;&#x6E90;&#x7801;&#x3002;</p>
<p>Iptables-mode Proxier&#x7684;service&#x914D;&#x7F6E;&#x548C;&#x4EE3;&#x7801;&#x5185;&#x90FD;&#x5305;&#x542B;&#x4E00;&#x4E9B;&#x57FA;&#x7840;&#x6982;&#x5FF5;&#x5982;clusterIP&#x3001;nodeport&#x3001;loadbalancer&#x3001;Ingress&#x3001;ClusterCIDR&#x3001;onlyLocal&#x3001;ExternalIP&#x7B49;&#xFF0C;&#x8BF7;&#x5728;&#x4E86;&#x89E3;&#x6E90;&#x7801;&#x4E4B;&#x524D;&#x5148;&#x719F;&#x6089;&#x5176;&#x6982;&#x5FF5;&#x7528;&#x9014;&#x573A;&#x666F;&#x4E0E;&#x7C7B;&#x578B;&#x533A;&#x522B;&#xFF0C;&#x518D;&#x770B;&#x6E90;&#x7801;&#x5C06;&#x5BF9;&#x4F60;&#x7406;&#x89E3;proxy&#x4E8B;&#x534A;&#x529F;&#x500D;&#x3002;&#x5F53;&#x7136;&#x4E5F;&#x9700;&#x8981;&#x5BF9;netfilter&#x3001;iptables&#x3001;connTrack&#x7B49;proxy&#x57FA;&#x7840;&#x4F9D;&#x8D56;&#x7684;&#x5DE5;&#x5177;&#x719F;&#x6089;&#x3002;&#x57FA;&#x7840;&#x6982;&#x5FF5;&#x90E8;&#x5206;&#x5728;&#x672C;&#x6587;&#x5C06;&#x4E0D;&#x6DF1;&#x5165;&#x4ECB;&#x7ECD;&#xFF0C;&#x6709;&#x9700;&#x6C42;&#x53EF;&#x81EA;&#x884C;&#x67E5;&#x9605;&#x76F8;&#x5173;&#x8D44;&#x6599;&#x3002;</p>
<p>&#x4ECE;kube-proxy&#x7EC4;&#x4EF6;&#x6574;&#x4F53;&#x6846;&#x67B6;&#x5C42;&#x7684;&#x4EE3;&#x7801;&#x6765;&#x770B;&#xFF0C;&#x5728;ProxyServer.Run()&#x6700;&#x540E;&#x8D70;&#x5230;&#x4E86;<strong>s.Proxier.SyncLoop()</strong>&#x6267;&#x884C;&#x7A7A;&#x95F4;&#x4E00;&#x76F4;&#x65E0;&#x9650;loop&#x4E0B;&#x53BB;&#x3002;&#x800C;&#x9ED8;&#x8BA4;&#x7684;ProxyServer&#x914D;&#x7F6E;&#x7684;Proxier&#x5BF9;&#x8C61;&#x5C31;&#x662F;Iptables(<em>if proxyMode == proxyModeIPTables</em>)&#xFF0C;&#x5C06;&#x8C03;&#x7528;iptabls-mode&#x7684;Proxier.SyncLoop()&#xFF0C;SyncLoop()&#x65F6;&#x95F4;&#x5B9A;&#x65F6;&#x5FAA;&#x73AF;&#x6267;&#x884C;syncProxyRules()&#x5B8C;&#x6210;services&#x3001;endpoints&#x4E0E;iptables&#x89C4;&#x5219;&#x7684;&#x540C;&#x6B65;&#x64CD;&#x4F5C;&#x3002;</p>
<p>Iptables-mode proxier&#x7684;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x673A;&#x5236;&#x662F;&#x901A;&#x8FC7;&#x5E95;&#x5C42;netfliter/iptables&#x89C4;&#x5219;&#x6765;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x901A;&#x8FC7;Informer&#x673A;&#x5236;watch&#x670D;&#x52A1;&#x4E0E;&#x7AEF;&#x70B9;&#x4FE1;&#x606F;&#x7684;&#x53D8;&#x66F4;&#x4E8B;&#x4EF6;&#x89E6;&#x53D1;&#x5BF9;iptables&#x7684;&#x89C4;&#x5219;&#x7684;&#x540C;&#x6B65;&#x66F4;&#x65B0;&#xFF0C;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#x903B;&#x8F91;&#x793A;&#x610F;&#x56FE;&#xFF1A;</p>
<p><img src="image/iptables-proxier.png" alt="iptables-proxier"></p>
<p>&#x4E0B;&#x9762;proxier&#x6E90;&#x7801;&#x5206;&#x6790;,&#x6211;&#x4EEC;&#x5148;&#x4ECE;proxier&#x7684;&#x63A5;&#x53E3;&#x3001;&#x5B9E;&#x73B0;&#x7C7B;&#x3001;&#x5B9E;&#x73B0;&#x7C7B;&#x65B9;&#x6CD5;&#x5217;&#x8868;&#x4E00;&#x7AA5;&#x7A76;&#x7ADF;&#xFF0C;&#x4ECE;&#x7ED3;&#x6784;&#x4E0A;&#x770B;&#x6574;&#x4F53;Proxier&#x7684;&#x6846;&#x67B6;&#x3002;&#x7136;&#x540E;&#x6211;&#x4EEC;&#x518D;&#x8BE6;&#x7EC6;&#x5206;&#x6790;proxier&#x5BF9;&#x8C61;&#x7684;&#x4EA7;&#x751F;&#x65F6;&#x6240;&#x5B9A;&#x4E49;&#x7684;&#x5C5E;&#x6027;&#x503C;&#x3001;&#x503C;&#x7C7B;&#x578B;&#x548C;&#x7528;&#x9014;&#x3002;&#x6709;&#x4E86;&#x524D;&#x9762;&#x7684;&#x4E24;&#x9879;&#x7684;&#x4E86;&#x89E3;&#x540E;&#x6211;&#x4EEC;&#x518D;&#x6765;&#x5206;&#x6790;proxier&#x7C7B;&#x65B9;&#x6CD5;&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;proxier&#x4EE3;&#x7406;&#x903B;&#x8F91;&#x90E8;&#x5206;(&#x5173;&#x952E;&#x903B;&#x8F91;&#x90E8;&#x5206;&#x5728;<strong>syncProxyRules()</strong>&#x65B9;&#x6CD5;&#x5206;&#x6790;&#x90E8;&#x5206;)&#x3002;&#x6700;&#x540E;&#x6211;&#x4EEC;&#x5206;&#x6790;proxier&#x5E95;&#x5C42;&#x5185;&#x6838;iptables&#x7684;runner&#x5B9E;&#x73B0;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;proxy&#x4E0A;&#x5C42;&#x903B;&#x8F91;&#x5C42;&#x6700;&#x7EC8;&#x4F1A;&#x8C03;&#x7528;iptables&#x547D;&#x4EE4;&#x53BB;&#x6267;&#x884C;&#x89C4;&#x5219;&#x7684;&#x64CD;&#x4F5C;&#x90E8;&#x5206;&#x3002;</p>
<h2 id="Proxier_&#x6570;&#x636E;&#x7ED3;&#x6784;&#x4E0E;&#x7C7B;&#x5B9A;&#x4E49;">2. Proxier &#x6570;&#x636E;&#x7ED3;&#x6784;&#x4E0E;&#x7C7B;&#x5B9A;&#x4E49;</h2>
<p><strong>ProxyProvider</strong> &#x4EE3;&#x7406;&#x63D0;&#x4F9B;&#x8005;&#x63A5;&#x53E3;&#x5B9A;&#x4E49;&#xFF0C;&#x9700;&#x8981;&#x5B9E;&#x73B0;&#x4E24;&#x4E2A;proxy&#x7684;&#x5173;&#x952E;&#x65B9;&#x6CD5;Sync()&#x548C;SyncLoop()</p>
<div><p class="code-filename">pkg/proxy/types.go:27</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> ProxyProvider <span class="token keyword">interface</span> <span class="token punctuation">{</span>
  <span class="token comment">// Sync &#x5373;&#x65F6;&#x540C;&#x6B65;Proxy&#x63D0;&#x4F9B;&#x8005;&#x7684;&#x5F53;&#x524D;&#x72B6;&#x6001;&#x81F3;proxy&#x89C4;&#x5219;</span>
    <span class="token function">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// SyncLoop &#x5468;&#x671F;&#x6027;&#x8FD0;&#x884C;</span>
  <span class="token comment">// &#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x6216;&#x5E94;&#x7528;&#x4E3B;loop&#x8FD0;&#x884C;&#xFF0C;&#x65E0;&#x8FD4;&#x56DE;.</span>
    <span class="token function">SyncLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>Iptables-mode Proxier</strong> &#x4E3A; ProxyProvider &#x63A5;&#x53E3;&#x5B9E;&#x73B0;&#x7C7B;&#xFF0C;proxier &#x7C7B;&#x5C5E;&#x6027;&#x9879;&#x6BD4;&#x8F83;&#x591A;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x770B;&#x4E00;&#x4E0B;&#x6CE8;&#x91CA;&#x7528;&#x9014;&#x4E0E;&#x7ED3;&#x6784;&#x5B9A;&#x4E49;&#xFF0C;&#x5728;&#x5B9E;&#x4F8B;&#x5316;proxier&#x5BF9;&#x8C61;&#x65F6;&#x6211;&#x4EEC;&#x518D;&#x8BE6;&#x770B;&#x3002;</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:205</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> Proxier <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    endpointsChanges <span class="token operator">*</span>proxy<span class="token punctuation">.</span>EndpointChangeTracker <span class="token comment">// &#x7AEF;&#x70B9;&#x66F4;&#x65B0;&#x4FE1;&#x606F;&#x8DDF;&#x8E2A;&#x5668;</span>
    serviceChanges   <span class="token operator">*</span>proxy<span class="token punctuation">.</span>ServiceChangeTracker  <span class="token comment">// &#x670D;&#x52A1;&#x66F4;&#x65B0;&#x4FE1;&#x606F;&#x8DDF;&#x8E2A;&#x5668;</span>

    mu           sync<span class="token punctuation">.</span>Mutex                       <span class="token comment">// &#x4FDD;&#x62A4;&#x540C;&#x6B65;&#x9501;</span>
    serviceMap   proxy<span class="token punctuation">.</span>ServiceMap                 <span class="token comment">// &#x5B58;&#x653E;&#x670D;&#x52A1;&#x5217;&#x8868;&#x4FE1;&#x606F;                &#x2460;</span>
    endpointsMap proxy<span class="token punctuation">.</span>EndpointsMap               <span class="token comment">// &#x5B58;&#x653E;&#x7AEF;&#x70B9;&#x5217;&#x8868;&#x4FE1;&#x606F;                &#x2461;</span>
    portsMap     <span class="token keyword">map</span><span class="token punctuation">[</span>utilproxy<span class="token punctuation">.</span>LocalPort<span class="token punctuation">]</span>utilproxy<span class="token punctuation">.</span>Closeable <span class="token comment">//&#x7AEF;&#x53E3;&#x5173;&#x95ED;&#x63A5;&#x53E3;map</span>

    endpointsSynced <span class="token builtin">bool</span>                          <span class="token comment">// ep&#x540C;&#x6B65;&#x72B6;&#x6001;</span>
    servicesSynced  <span class="token builtin">bool</span>                          <span class="token comment">// svc&#x540C;&#x6B65;&#x72B6;&#x6001;</span>
    initialized     <span class="token builtin">int32</span>                         <span class="token comment">// &#x521D;&#x59CB;&#x5316;&#x72B6;&#x6001;</span>
    syncRunner      <span class="token operator">*</span>async<span class="token punctuation">.</span>BoundedFrequencyRunner <span class="token comment">// &#x6307;&#x5B9A;&#x9891;&#x7387;&#x8FD0;&#x884C;&#x5668;&#xFF0C;&#x6B64;&#x5904;&#x7528;&#x4E8E;&#x7BA1;&#x7406;&#x5BF9; </span>
                                                <span class="token comment">// syncProxyRules&#x7684;&#x8C03;&#x7528;</span>

    iptables       utiliptables<span class="token punctuation">.</span>Interface         <span class="token comment">// iptables&#x547D;&#x4EE4;&#x6267;&#x884C;&#x63A5;&#x53E3;</span>
    masqueradeAll  <span class="token builtin">bool</span>                          
    masqueradeMark <span class="token builtin">string</span>                         <span class="token comment">// SNAT&#x5730;&#x5740;&#x4F2A;&#x88C5;Mark</span>
    exec           utilexec<span class="token punctuation">.</span>Interface             <span class="token comment">// exec&#x547D;&#x4EE4;&#x6267;&#x884C;&#x5DE5;&#x5177;&#x63A5;&#x53E3;</span>
    clusterCIDR    <span class="token builtin">string</span>                         <span class="token comment">// &#x96C6;&#x7FA4;CIDR</span>
    hostname       <span class="token builtin">string</span>                         <span class="token comment">// &#x4E3B;&#x673A;&#x540D;</span>
    nodeIP         net<span class="token punctuation">.</span>IP                         <span class="token comment">// &#x8282;&#x70B9;IP&#x5730;&#x5740;</span>
    portMapper     utilproxy<span class="token punctuation">.</span>PortOpener           <span class="token comment">// TCP/UTP&#x7AEF;&#x53E3;&#x6253;&#x5F00;&#x4E0E;&#x76D1;&#x542C;</span>
    recorder       record<span class="token punctuation">.</span>EventRecorder           <span class="token comment">// &#x4E8B;&#x4EF6;&#x8BB0;&#x5F55;&#x5668;</span>
    healthChecker  healthcheck<span class="token punctuation">.</span>Server             <span class="token comment">// healthcheck&#x670D;&#x52A1;&#x5668;&#x5BF9;&#x8C61;</span>
    healthzServer  healthcheck<span class="token punctuation">.</span>HealthzUpdater     <span class="token comment">// Healthz&#x66F4;&#x65B0;&#x5668;</span>

    precomputedProbabilities <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>             <span class="token comment">//&#x9884;&#x8BA1;&#x7B97;&#x53EF;&#x80FD;&#x6027;</span>

  <span class="token comment">//iptables&#x89C4;&#x5219;&#x4E0E;&#x94FE;&#x6570;&#x636E;(Filter/NAT)</span>
    iptablesData             <span class="token operator">*</span>bytes<span class="token punctuation">.</span>Buffer        
    existingFilterChainsData <span class="token operator">*</span>bytes<span class="token punctuation">.</span>Buffer        
    filterChains             <span class="token operator">*</span>bytes<span class="token punctuation">.</span>Buffer         
    filterRules              <span class="token operator">*</span>bytes<span class="token punctuation">.</span>Buffer           
    natChains                <span class="token operator">*</span>bytes<span class="token punctuation">.</span>Buffer        
    natRules                 <span class="token operator">*</span>bytes<span class="token punctuation">.</span>Buffer      

    endpointChainsNumber <span class="token builtin">int</span>                       

    <span class="token comment">// Node&#x8282;&#x70B9;IP&#x4E0E;&#x7AEF;&#x53E3;&#x4FE1;&#x606F;</span>
    nodePortAddresses <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>                    

    networkInterfacer utilproxy<span class="token punctuation">.</span>NetworkInterfacer  <span class="token comment">//&#x7F51;&#x7EDC;&#x63A5;&#x53E3;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x2460; ServiceMap&#x548C;ServicePort&#x5B9A;&#x4E49;</p>
<div><p class="code-filename">pkg/proxy/service.go:229</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> ServiceMap <span class="token keyword">map</span><span class="token punctuation">[</span>ServicePortName<span class="token punctuation">]</span>ServicePort

<span class="token comment">//String() =&gt;  &quot;NS/SvcName:PortName&quot;</span>
ServicePortName<span class="token punctuation">{</span>NamespacedName<span class="token punctuation">:</span> svcName<span class="token punctuation">,</span> Port<span class="token punctuation">:</span> servicePort<span class="token punctuation">.</span>Name<span class="token punctuation">}</span>
</code></pre>
<p><em>ServiceSpec service.spec&#x5B9A;&#x4E49;&#xFF0C;&#x5728;&#x7528;&#x6237;&#x524D;&#x7AEF;&#x53EF;&#x5B9A;&#x4E49;service&#x7684;spec&#x914D;&#x7F6E;&#x9879;&#x3002;</em></p>
<div><p class="code-filename">vendor/k8s.io/api/core/v1/types.go:3606</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> ServiceSpec <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Ports <span class="token punctuation">[</span><span class="token punctuation">]</span>ServicePort                   <span class="token comment">//&#x670D;&#x52A1;&#x7AEF;&#x53E3;&#x5217;&#x8868;</span>
    Selector <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>            <span class="token comment">//&#x9009;&#x62E9;&#x5668;</span>
    ClusterIP <span class="token builtin">string</span>                      <span class="token comment">//VIP &#x3001; portal</span>
    Type ServiceType                      <span class="token comment">//&#x670D;&#x52A1;&#x7C7B;&#x578B;   </span>
    ExternalIPs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>                  <span class="token comment">//&#x5916;&#x90E8;IP&#x5217;&#x8868;&#xFF0C;&#x5982;&#x5916;&#x90E8;&#x8D1F;&#x8F7D;&#x5747;&#x8861;</span>
    SessionAffinity ServiceAffinity       <span class="token comment">//&#x4F1A;&#x8BDD;&#x4FDD;&#x6301;</span>
    LoadBalancerIP <span class="token builtin">string</span>                 <span class="token comment">//service&#x7C7B;&#x578B;&#x4E3A;&quot;LoadBalancer&quot;&#x65F6;&#x914D;&#x7F6E;LB ip</span>
    LoadBalancerSourceRanges <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>     <span class="token comment">//cloud-provider&#x7684;&#x9650;&#x5236;client ip&#x533A;&#x95F4;</span>
    ExternalName <span class="token builtin">string</span> 
    ExternalTrafficPolicy ServiceExternalTrafficPolicyType 
    HealthCheckNodePort <span class="token builtin">int32</span>              
    PublishNotReadyAddresses <span class="token builtin">bool</span> 
    SessionAffinityConfig <span class="token operator">*</span>SessionAffinityConfig  <span class="token comment">//&#x4F1A;&#x8BDD;&#x4FDD;&#x6301;&#x914D;&#x7F6E;&#x4FE1;&#x606F;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><em>ServicePort&#x7C7B;&#x5B9A;&#x4E49;&#x548C;ServicePort&#x63A5;&#x53E3;</em></p>
<div><p class="code-filename">vendor/k8s.io/api/core/v1/types.go:3563</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> ServicePort <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name <span class="token builtin">string</span> 
    Protocol Protocol 
    Port <span class="token builtin">int32</span> 
    TargetPort intstr<span class="token punctuation">.</span>IntOrString 
    NodePort <span class="token builtin">int32</span> 
<span class="token punctuation">}</span>

<span class="token comment">//ServicePort&#x63A5;&#x53E3;</span>
<span class="token keyword">type</span> ServicePort <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x8FD4;&#x56DE;&#x670D;&#x52A1;&#x5B57;&#x4E32;&#xFF0C;&#x683C;&#x5F0F;&#x5982;: `IP:Port/Protocol`.</span>
    <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
    <span class="token comment">// &#x8FD4;&#x56DE;&#x96C6;&#x7FA4;IP&#x5B57;&#x4E32;</span>
    <span class="token function">ClusterIPString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
    <span class="token comment">// &#x8FD4;&#x56DE;&#x534F;&#x8BAE;</span>
    <span class="token function">GetProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> v1<span class="token punctuation">.</span>Protocol
    <span class="token comment">// &#x8FD4;&#x56DE;&#x5065;&#x5EB7;&#x68C0;&#x6D4B;&#x7AEF;&#x53E3;</span>
    <span class="token function">GetHealthCheckNodePort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x2461; EndpointsMap&#x5B9A;&#x4E49;&#x4E0E;Endpoint&#x63A5;&#x53E3;</p>
<div><p class="code-filename">pkg/proxy/endpoints.go:181</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> EndpointsMap <span class="token keyword">map</span><span class="token punctuation">[</span>ServicePortName<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Endpoint

<span class="token keyword">type</span> Endpoint <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x8FD4;&#x56DE;endpoint&#x5B57;&#x4E32;&#xFF0C;&#x683C;&#x5F0F; `IP:Port`.</span>
    <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
  <span class="token comment">// &#x662F;&#x5426;&#x672C;&#x5730;</span>
    <span class="token function">GetIsLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
    <span class="token comment">// &#x8FD4;&#x56DE;IP</span>
    <span class="token function">IP</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
    <span class="token comment">// &#x8FD4;&#x56DE;&#x7AEF;&#x53E3;</span>
    <span class="token function">Port</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token comment">// &#x68C0;&#x6D4B;&#x4E24;&#x4E0A;endpoint&#x662F;&#x5426;&#x76F8;&#x7B49;</span>
    <span class="token function">Equal</span><span class="token punctuation">(</span>Endpoint<span class="token punctuation">)</span> <span class="token builtin">bool</span>
<span class="token punctuation">}</span>
</code></pre>
<p><em>Endpoints&#x7ED3;&#x6784;&#x4E0E;&#x76F8;&#x5173;&#x5B9A;&#x4E49;</em></p>
<div><p class="code-filename">vendor/k8s.io/api/core/v1/types.go:3710</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> Endpoints <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    metav1<span class="token punctuation">.</span>TypeMeta 
    metav1<span class="token punctuation">.</span>ObjectMeta 
    Subsets <span class="token punctuation">[</span><span class="token punctuation">]</span>EndpointSubset  
<span class="token punctuation">}</span>

<span class="token keyword">type</span> EndpointSubset <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Addresses <span class="token punctuation">[</span><span class="token punctuation">]</span>EndpointAddress            <span class="token comment">// EndpointAddress&#x5730;&#x5740;&#x5217;&#x8868;</span>
    NotReadyAddresses <span class="token punctuation">[</span><span class="token punctuation">]</span>EndpointAddress    
    Ports <span class="token punctuation">[</span><span class="token punctuation">]</span>EndpointPort                   <span class="token comment">// EndpointPort&#x7AEF;&#x53E3;&#x5217;&#x8868;</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> EndpointAddress <span class="token keyword">struct</span> <span class="token punctuation">{</span>           
    IP <span class="token builtin">string</span> 
    Hostname <span class="token builtin">string</span> 
    NodeName <span class="token operator">*</span><span class="token builtin">string</span>
    TargetRef <span class="token operator">*</span>ObjectReference 
<span class="token punctuation">}</span>

<span class="token keyword">type</span> EndpointPort <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name <span class="token builtin">string</span> 
    Port <span class="token builtin">int32</span> 
    Protocol Protocol 
<span class="token punctuation">}</span>
</code></pre>
<p><strong>Iptables-mode Proxier</strong>&#x63D0;&#x4F9B;&#x7684;&#x65B9;&#x6CD5;&#x5217;&#x8868;&#xFF0C;&#x5148;&#x5927;&#x6982;&#x4ECE;&#x540D;&#x79F0;&#x4E0A;&#x6765;&#x4E86;&#x89E3;&#x4E00;&#x4E0B;&#x65B9;&#x6CD5;&#x7528;&#x9014;&#xFF0C;&#x540E;&#x9762;&#x6211;&#x5728;&#x903B;&#x8F91;&#x90E8;&#x5206;&#x5BF9;&#x4E3B;&#x8981;&#x4F7F;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#x518D;&#x6DF1;&#x5165;&#x5206;&#x6790;&#x3002;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">precomputeProbabilities</span><span class="token punctuation">(</span>numberOfPrecomputed <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">probability</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">string</span><span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">SyncLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">setInitialized</span><span class="token punctuation">(</span>value <span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">isInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">OnServiceAdd</span><span class="token punctuation">(</span>service <span class="token operator">*</span>v1<span class="token punctuation">.</span>Service<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">OnServiceUpdate</span><span class="token punctuation">(</span>oldService<span class="token punctuation">,</span> service <span class="token operator">*</span>v1<span class="token punctuation">.</span>Service<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">OnServiceDelete</span><span class="token punctuation">(</span>service <span class="token operator">*</span>v1<span class="token punctuation">.</span>Service<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">OnServiceSynced</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">OnEndpointsAdd</span><span class="token punctuation">(</span>endpoints <span class="token operator">*</span>v1<span class="token punctuation">.</span>Endpoints<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">OnEndpointsUpdate</span><span class="token punctuation">(</span>oldEndpoints<span class="token punctuation">,</span> endpoints <span class="token operator">*</span>v1<span class="token punctuation">.</span>Endpoints<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">OnEndpointsDelete</span><span class="token punctuation">(</span>endpoints <span class="token operator">*</span>v1<span class="token punctuation">.</span>Endpoints<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">OnEndpointsSynced</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">deleteEndpointConnections</span><span class="token punctuation">(</span>connectionMap <span class="token punctuation">[</span><span class="token punctuation">]</span>proxy<span class="token punctuation">.</span>ServiceEndpoint<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">appendServiceCommentLocked</span><span class="token punctuation">(</span>args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> svcName <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">syncProxyRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>
</code></pre>
<h2 id="Proxier&#x5BF9;&#x8C61;&#x751F;&#x6210;&#x4E0E;&#x8FD0;&#x884C;">3. Proxier&#x5BF9;&#x8C61;&#x751F;&#x6210;&#x4E0E;&#x8FD0;&#x884C;</h2>
<p>iptables <strong>Proxier</strong> <strong>&#x6784;&#x5EFA;</strong><code>New</code>&#x65B9;&#x6CD5;&#xFF0C;&#x4E0B;&#x9762;&#x7701;&#x7565;&#x90E8;&#x5206;&#x6821;&#x9A8C;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x5173;&#x6CE8;&#x5173;&#x952E;&#x6784;&#x9020;&#x90E8;&#x5206;&#x3002;</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:281</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">NewProxier</span><span class="token punctuation">(</span>ipt utiliptables<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span>
    sysctl utilsysctl<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span>
    exec utilexec<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span>
    syncPeriod time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span>
    minSyncPeriod time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span>
    masqueradeAll <span class="token builtin">bool</span><span class="token punctuation">,</span>
    masqueradeBit <span class="token builtin">int</span><span class="token punctuation">,</span>
    clusterCIDR <span class="token builtin">string</span><span class="token punctuation">,</span>
    hostname <span class="token builtin">string</span><span class="token punctuation">,</span>
    nodeIP net<span class="token punctuation">.</span>IP<span class="token punctuation">,</span>
    recorder record<span class="token punctuation">.</span>EventRecorder<span class="token punctuation">,</span>
    healthzServer healthcheck<span class="token punctuation">.</span>HealthzUpdater<span class="token punctuation">,</span>
    nodePortAddresses <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Proxier<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// ...&#x4EE5;&#x4E0B;&#x4E3A;&#x7701;&#x7565;&#x90E8;&#x5206;&#x89E3;&#x6790;...</span>
  <span class="token comment">// sysctl&#x5BF9;&quot;net/ipv4/conf/all/route_localnet&quot;&#x8BBE;&#x7F6E; &#xFF0C;&#x5185;&#x6838;iptables&#x652F;&#x6301;   </span>
    <span class="token comment">// sysctl&#x5BF9;&quot;net/bridge/bridge-nf-call-iptables&quot;&#x8BBE;&#x7F6E;&#xFF0C;&#x5185;&#x6838;iptables&#x652F;&#x6301;</span>

  <span class="token comment">// &#x751F;&#x4EA7;SNAT&#x7684;IP&#x4F2A;&#x88C5;mark</span>
  <span class="token comment">// &#x5982;&#x679C;&#x8282;&#x70B9;IP&#x4E3A;&#x7A7A;&#xFF0C;&#x5219;kube-proxy&#x7684;nodeIP&#x7684;&#x521D;&#x59CB;IP&#x4E3A;127.0.0.1</span>
  <span class="token comment">// &#x96C6;&#x7FA4;CIDR&#x68C0;&#x9A8C;&#x662F;&#x5426;&#x4E3A;&#x7A7A;&#xFF0C;IPv6&#x9A8C;&#x8BC1;</span>
  <span class="token comment">// ...</span>

  <span class="token comment">//healthcheck&#x670D;&#x52A1;&#x5668;&#x5BF9;&#x8C61;</span>
    healthChecker <span class="token operator">:=</span> healthcheck<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> recorder<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span> 

  <span class="token comment">//proxier&#x5BF9;&#x8C61;</span>
    proxier <span class="token operator">:=</span> <span class="token operator">&amp;</span>Proxier<span class="token punctuation">{</span>
        portsMap<span class="token punctuation">:</span>                 <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>utilproxy<span class="token punctuation">.</span>LocalPort<span class="token punctuation">]</span>utilproxy<span class="token punctuation">.</span>Closeable<span class="token punctuation">)</span><span class="token punctuation">,</span>
        serviceMap<span class="token punctuation">:</span>               <span class="token function">make</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>ServiceMap<span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">//svc&#x5B58;&#x653E;map</span>
        serviceChanges<span class="token punctuation">:</span>           proxy<span class="token punctuation">.</span><span class="token function">NewServiceChangeTracker</span><span class="token punctuation">(</span>newServiceInfo<span class="token punctuation">,</span> <span class="token operator">&amp;</span>isIPv6<span class="token punctuation">,</span> recorder<span class="token punctuation">)</span><span class="token punctuation">,</span>                                              <span class="token comment">//svc&#x53D8;&#x5316;&#x8DDF;&#x8E2A;&#x5668;</span>
        endpointsMap<span class="token punctuation">:</span>             <span class="token function">make</span><span class="token punctuation">(</span>proxy<span class="token punctuation">.</span>EndpointsMap<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//ep&#x5B58;&#x653E;map</span>
        endpointsChanges<span class="token punctuation">:</span>         proxy<span class="token punctuation">.</span><span class="token function">NewEndpointChangeTracker</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> newEndpointInfo<span class="token punctuation">,</span> <span class="token operator">&amp;</span>isIPv6<span class="token punctuation">,</span> recorder<span class="token punctuation">)</span><span class="token punctuation">,</span>                                     <span class="token comment">//ep&#x53D8;&#x5316;&#x8DDF;&#x8E2A;&#x5668;</span>
        iptables<span class="token punctuation">:</span>                 ipt<span class="token punctuation">,</span>
        masqueradeAll<span class="token punctuation">:</span>            masqueradeAll<span class="token punctuation">,</span>
        masqueradeMark<span class="token punctuation">:</span>           masqueradeMark<span class="token punctuation">,</span>
        exec<span class="token punctuation">:</span>                     exec<span class="token punctuation">,</span>
        clusterCIDR<span class="token punctuation">:</span>              clusterCIDR<span class="token punctuation">,</span>
        hostname<span class="token punctuation">:</span>                 hostname<span class="token punctuation">,</span>
        nodeIP<span class="token punctuation">:</span>                   nodeIP<span class="token punctuation">,</span>
        portMapper<span class="token punctuation">:</span>               <span class="token operator">&amp;</span>listenPortOpener<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>       <span class="token comment">//&#x670D;&#x52A1;&#x7AEF;&#x53E3;&#x76D1;&#x542C;&#x5668;</span>
        recorder<span class="token punctuation">:</span>                 recorder<span class="token punctuation">,</span>
        healthChecker<span class="token punctuation">:</span>            healthChecker<span class="token punctuation">,</span>
        healthzServer<span class="token punctuation">:</span>            healthzServer<span class="token punctuation">,</span>
        precomputedProbabilities<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1001</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        iptablesData<span class="token punctuation">:</span>             bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">//iptables&#x914D;&#x7F6E;&#x89C4;&#x5219;&#x6570;&#x636E;</span>
        existingFilterChainsData<span class="token punctuation">:</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        filterChains<span class="token punctuation">:</span>             bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        filterRules<span class="token punctuation">:</span>              bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        natChains<span class="token punctuation">:</span>                bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        natRules<span class="token punctuation">:</span>                 bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        nodePortAddresses<span class="token punctuation">:</span>        nodePortAddresses<span class="token punctuation">,</span>
        networkInterfacer<span class="token punctuation">:</span>        utilproxy<span class="token punctuation">.</span>RealNetwork<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>   <span class="token comment">//&#x7F51;&#x7EDC;&#x63A5;&#x53E3;</span>
    <span class="token punctuation">}</span>
    burstSyncs <span class="token operator">:=</span> <span class="token number">2</span>
    klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;minSyncPeriod: %v, syncPeriod: %v, burstSyncs: %d&quot;</span><span class="token punctuation">,</span> minSyncPeriod<span class="token punctuation">,</span> syncPeriod<span class="token punctuation">,</span> burstSyncs<span class="token punctuation">)</span>
  <span class="token comment">//&#x8FD0;&#x884C;&#x5668;&#x6267;&#x884C;&#x6307;&#x5B9A;&#x9891;&#x7387;&#x5BF9;syncProxyRules&#x8C03;&#x7528;&#x6765;&#x540C;&#x6B65;&#x89C4;&#x5219;,&#x5173;&#x952E;&#x7684;&#x903B;&#x8F91;&#x5219;&#x5728;syncProxyRules()&#x65B9;&#x6CD5;&#x5185;&#xFF0C;&#x540E;&#x9762;&#x6709;&#x8BE6;&#x8FF0;&#x65B9;&#x6CD5;                               </span>
    proxier<span class="token punctuation">.</span>syncRunner <span class="token operator">=</span> async<span class="token punctuation">.</span><span class="token function">NewBoundedFrequencyRunner</span><span class="token punctuation">(</span><span class="token string">&quot;sync-runner&quot;</span><span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>syncProxyRules<span class="token punctuation">,</span> minSyncPeriod<span class="token punctuation">,</span> syncPeriod<span class="token punctuation">,</span> burstSyncs<span class="token punctuation">)</span>  
    <span class="token keyword">return</span> proxier<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>proxier.<strong>SyncLoop()</strong> &#x6211;&#x4EEC;&#x77E5;&#x9053;proxy server&#x7684;&#x8FD0;&#x884C;&#x65F6;&#x6700;&#x540E;&#x7684;&#x8C03;&#x7528;&#x5C31;&#x662F;&quot;s.Proxier.SyncLoop()&quot;,&#x6B64;&#x5904;&#x6211;&#x4EEC;&#x6765;&#x8BE6;&#x7EC6;&#x4E86;&#x89E3;&#x4E00;&#x4E0B;SyncLoop&#x7684;<code>proxier&#x8FD0;&#x884C;</code>&#x5B9E;&#x73B0;&#x3002;</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:487</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">SyncLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> proxier<span class="token punctuation">.</span>healthzServer <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        proxier<span class="token punctuation">.</span>healthzServer<span class="token punctuation">.</span><span class="token function">UpdateTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token comment">// proxier.syncRunner&#x5728;proxier&#x5BF9;&#x8C61;&#x521B;&#x5EFA;&#x65F6;&#x6307;&#x5B9A;&#x4E3A;async.NewBoundedFrequencyRunner(...)     &#x2460; </span>
    proxier<span class="token punctuation">.</span>syncRunner<span class="token punctuation">.</span><span class="token function">Loop</span><span class="token punctuation">(</span>wait<span class="token punctuation">.</span>NeverStop<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre>
<p> &#x2460;  <strong>async.BoundedFrequencyRunner</strong>&#x65F6;&#x95F4;&#x5668;&#x5FAA;&#x73AF;func&#x6267;&#x884C;&#x5668;&#x3002;</p>
<p>proxier&#x7C7B;&#x7ED3;&#x6784;&#x5185;&#x5B9A;&#x4E49;&#x7684;proxier.<strong>syncRunner</strong> &#x7C7B;&#x578B;&#x4E3A;async.BoundedFrequencyRunner </p>
<div><p class="code-filename">pkg/util/async/bounded_frequency_runner.go:31</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> BoundedFrequencyRunner <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    name        <span class="token builtin">string</span>        
    minInterval time<span class="token punctuation">.</span>Duration <span class="token comment">// &#x4E24;&#x6B21;&#x8FD0;&#x884C;&#x7684;&#x6700;&#x5C0F;&#x95F4;&#x9694;&#x65F6;&#x95F4;</span>
    maxInterval time<span class="token punctuation">.</span>Duration <span class="token comment">// &#x4E24;&#x6B21;&#x8FD0;&#x884C;&#x7684;&#x6700;&#x5927;&#x95F4;&#x9694;&#x65F6;&#x95F4;</span>

    run <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>         <span class="token comment">// &#x6267;&#x884C;&#x4E00;&#x6B21;run</span>

    mu      sync<span class="token punctuation">.</span>Mutex  
    fn      <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment">// &#x9700;&#x8981;&#x8FD0;&#x884C;&#x7684;func</span>
    lastRun time<span class="token punctuation">.</span>Time         <span class="token comment">// &#x6700;&#x8FD1;&#x4E00;&#x6B21;&#x8FD0;&#x884C;&#x65F6;&#x95F4;</span>
    timer   timer             <span class="token comment">// &#x5B9A;&#x65F6;&#x5668;</span>
    limiter rateLimiter       <span class="token comment">// &#x6309;&#x9700;&#x9650;&#x5236;&#x8FD0;&#x884C;&#x7684;QPS</span>
<span class="token punctuation">}</span>
</code></pre>
<p>BoundedFrequencyRunner&#x5B9E;&#x4F8B;&#x5316;&#x6784;&#x5EFA;&#xFF0C;&#x901A;&#x8FC7;&#x4F20;&#x53C2;&#x6309;&#x9700;&#x6765;&#x63A7;&#x5236;&#x5BF9;func&#x7684;&#x8C03;&#x7528;&#x3002;</p>
<div><p class="code-filename">pkg/util/async/bounded_frequency_runner.go:134</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">NewBoundedFrequencyRunner</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> fn <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> minInterval<span class="token punctuation">,</span> maxInterval time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> burstRuns <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>BoundedFrequencyRunner <span class="token punctuation">{</span>
    timer <span class="token operator">:=</span> realTimer<span class="token punctuation">{</span>Timer<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">NewTimer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span>       <span class="token comment">// &#x7ACB;&#x5373;tick</span>
    <span class="token operator">&lt;-</span>timer<span class="token punctuation">.</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                       <span class="token comment">// &#x6D88;&#x8D39;&#x7B2C;&#x4E00;&#x6B21;tick,&#x5B8C;&#x6210;&#x4E00;&#x6267;&#x884C;run</span>
    <span class="token keyword">return</span> <span class="token function">construct</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> minInterval<span class="token punctuation">,</span> maxInterval<span class="token punctuation">,</span> burstRuns<span class="token punctuation">,</span> timer<span class="token punctuation">)</span>  <span class="token comment">// -&gt;</span>
<span class="token punctuation">}</span>

<span class="token comment">//&#x5B9E;&#x4F8B;&#x6784;&#x5EFA;</span>
<span class="token keyword">func</span> <span class="token function">construct</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> fn <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> minInterval<span class="token punctuation">,</span> maxInterval time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> burstRuns <span class="token builtin">int</span><span class="token punctuation">,</span> timer timer<span class="token punctuation">)</span> <span class="token operator">*</span>BoundedFrequencyRunner <span class="token punctuation">{</span>
    <span class="token keyword">if</span> maxInterval <span class="token operator">&lt;</span> minInterval <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: maxInterval (%v) must be &gt;= minInterval (%v)&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> minInterval<span class="token punctuation">,</span> maxInterval<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> timer <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: timer must be non-nil&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    bfr <span class="token operator">:=</span> <span class="token operator">&amp;</span>BoundedFrequencyRunner<span class="token punctuation">{</span>
        name<span class="token punctuation">:</span>        name<span class="token punctuation">,</span>
        fn<span class="token punctuation">:</span>          fn<span class="token punctuation">,</span>                               <span class="token comment">//&#x88AB;&#x8C03;&#x7528;&#x5904;&#x7406;&#x7684;func</span>
        minInterval<span class="token punctuation">:</span> minInterval<span class="token punctuation">,</span>
        maxInterval<span class="token punctuation">:</span> maxInterval<span class="token punctuation">,</span>
        run<span class="token punctuation">:</span>         <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        timer<span class="token punctuation">:</span>       timer<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> minInterval <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>                            <span class="token comment">//&#x6700;&#x5C0F;&#x95F4;&#x9694;&#x65F6;&#x95F4;&#x5982;&#x679C;&#x4E0D;&#x6307;&#x5B9A;&#xFF0C;&#x5C06;&#x4E0D;&#x53D7;&#x9650;&#x5236;</span>
        bfr<span class="token punctuation">.</span>limiter <span class="token operator">=</span> nullLimiter<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// TokenBucketRateLimiter&#x7684;&#x5B9E;&#x73B0;&#x6D41;&#x63A7;&#x673A;&#x5236;&#xFF0C;&#x6709;&#x5174;&#x8DA3;&#x53EF;&#x4EE5;&#x518D;&#x6DF1;&#x5165;&#x4E86;&#x89E3;&#x673A;&#x5236;&#xFF0C;&#x6B64;&#x5904;&#x4E0D;&#x5C55;&#x5F00;</span>
        qps <span class="token operator">:=</span> <span class="token function">float32</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">float32</span><span class="token punctuation">(</span>minInterval<span class="token punctuation">)</span>
        bfr<span class="token punctuation">.</span>limiter <span class="token operator">=</span> flowcontrol<span class="token punctuation">.</span><span class="token function">NewTokenBucketRateLimiterWithClock</span><span class="token punctuation">(</span>qps<span class="token punctuation">,</span> burstRuns<span class="token punctuation">,</span> timer<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bfr
<span class="token punctuation">}</span>
</code></pre>
<p>proxier.syncRunner.<code>Loop()</code>  &#x65F6;&#x95F4;&#x5668;&#x5FAA;&#x73AF;&#x8FD0;&#x884C;&#x7684;&#x5B9E;&#x73B0;</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>bfr <span class="token operator">*</span>BoundedFrequencyRunner<span class="token punctuation">)</span> <span class="token function">Loop</span><span class="token punctuation">(</span>stop <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%s Loop running&quot;</span><span class="token punctuation">,</span> bfr<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    bfr<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span>bfr<span class="token punctuation">.</span>maxInterval<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        <span class="token keyword">select</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>stop<span class="token punctuation">:</span>             <span class="token comment">// &#x505C;&#x6B62;channel&#x5B9E;&#x73B0;&#x5173;&#x95ED;loop</span>
            bfr<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%s Loop stopping&quot;</span><span class="token punctuation">,</span> bfr<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>bfr<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment">//&#x5B9A;&#x65F6;&#x5668;tick&#x8FD0;&#x884C;</span>
            bfr<span class="token punctuation">.</span><span class="token function">tryRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span>           
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>bfr<span class="token punctuation">.</span>run<span class="token punctuation">:</span>          <span class="token comment">// &#x6267;&#x884C;&#x4E00;&#x6B21;&#x8FD0;&#x884C;</span>
            bfr<span class="token punctuation">.</span><span class="token function">tryRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>BoundedFrequencyRunner.<em>tryRun()</em>  &#x6309;&#x6307;&#x5B9A;&#x9891;&#x7387;&#x5BF9;func&#x7684;&#x8FD0;&#x884C;</p>
<p>!FILENAME:pkg/util/async/bounded_frequency_runner.go:211</p>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>bfr <span class="token operator">*</span>BoundedFrequencyRunner<span class="token punctuation">)</span> <span class="token function">tryRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bfr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> bfr<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">//&#x9650;&#x5236;&#x6761;&#x4EF6;&#x5141;&#x8BB8;&#x8FD0;&#x884C;func</span>
    <span class="token keyword">if</span> bfr<span class="token punctuation">.</span>limiter<span class="token punctuation">.</span><span class="token function">TryAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bfr<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                  <span class="token comment">// &#x8C03;&#x7528;func</span>
        bfr<span class="token punctuation">.</span>lastRun <span class="token operator">=</span> bfr<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>             <span class="token comment">// &#x8BB0;&#x5F55;&#x8FD0;&#x884C;&#x65F6;&#x95F4;</span>
        bfr<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                          
        bfr<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span>bfr<span class="token punctuation">.</span>maxInterval<span class="token punctuation">)</span>          <span class="token comment">// &#x91CD;&#x8BBE;&#x4E0B;&#x6B21;&#x8FD0;&#x884C;&#x65F6;&#x95F4;</span>
        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%s: ran, next possible in %v, periodic in %v&quot;</span><span class="token punctuation">,</span> bfr<span class="token punctuation">.</span>name<span class="token punctuation">,</span> bfr<span class="token punctuation">.</span>minInterval<span class="token punctuation">,</span> bfr<span class="token punctuation">.</span>maxInterval<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

  <span class="token comment">//&#x9650;&#x5236;&#x6761;&#x4EF6;&#x4E0D;&#x5141;&#x8BB8;&#x8FD0;&#x884C;&#xFF0C;&#x8BA1;&#x7B97;&#x4E0B;&#x6B21;&#x8FD0;&#x884C;&#x65F6;&#x95F4;</span>
  elapsed <span class="token operator">:=</span> bfr<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>bfr<span class="token punctuation">.</span>lastRun<span class="token punctuation">)</span>    <span class="token comment">// elapsed:&#x4E0A;&#x6B21;&#x8FD0;&#x884C;&#x65F6;&#x95F4;&#x5230;&#x73B0;&#x5728;&#x5DF2;&#x8FC7;&#x591A;&#x4E45;</span>
  nextPossible <span class="token operator">:=</span> bfr<span class="token punctuation">.</span>minInterval <span class="token operator">-</span> elapsed  <span class="token comment">// nextPossible:&#x4E0B;&#x6B21;&#x8FD0;&#x884C;&#x81F3;&#x5C11;&#x5DEE;&#x591A;&#x4E45;&#xFF08;&#x6700;&#x5C0F;&#x5468;&#x671F;&#xFF09;</span>
  nextScheduled <span class="token operator">:=</span> bfr<span class="token punctuation">.</span>maxInterval <span class="token operator">-</span> elapsed <span class="token comment">// nextScheduled:&#x4E0B;&#x6B21;&#x8FD0;&#x884C;&#x6700;&#x8FDF;&#x5DEE;&#x591A;&#x4E45;(&#x6700;&#x5927;&#x5468;&#x671F;)</span>
    klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%s: %v since last run, possible in %v, scheduled in %v&quot;</span><span class="token punctuation">,</span> bfr<span class="token punctuation">.</span>name<span class="token punctuation">,</span> elapsed<span class="token punctuation">,</span> nextPossible<span class="token punctuation">,</span> nextScheduled<span class="token punctuation">)</span>

    <span class="token keyword">if</span> nextPossible <span class="token operator">&lt;</span> nextScheduled <span class="token punctuation">{</span>
        <span class="token comment">// Set the timer for ASAP, but don&apos;t drain here.  Assuming Loop is running,</span>
        <span class="token comment">// it might get a delivery in the mean time, but that is OK.</span>
        bfr<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        bfr<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span>nextPossible<span class="token punctuation">)</span>
        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%s: throttled, scheduling run in %v&quot;</span><span class="token punctuation">,</span> bfr<span class="token punctuation">.</span>name<span class="token punctuation">,</span> nextPossible<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="Proxier_&#x670D;&#x52A1;&#x4E0E;&#x7AEF;&#x70B9;&#x66F4;&#x65B0;_Tracker">4. Proxier &#x670D;&#x52A1;&#x4E0E;&#x7AEF;&#x70B9;&#x66F4;&#x65B0; Tracker</h2>
<p>kube-proxy&#x9700;&#x8981;&#x53CA;&#x65F6;&#x540C;&#x6B65;services&#x548C;endpoints&#x7684;&#x53D8;&#x5316;&#x4FE1;&#x606F;,&#x524D;&#x9762;&#x6211;&#x4EEC;&#x770B;&#x5230;proxier&#x7C7B;&#x5BF9;&#x8C61;&#x6709;&#x4E24;&#x4E2A;&#x5C5E;&#x6027;&#xFF1A;<strong>serviceChanges</strong>&#x548C;<strong>endpointsChanges</strong>&#x662F;&#x5C31;&#x662F;&#x7528;&#x6765;&#x8DDF;&#x8E2A;Service&#x548C;Endpoint&#x7684;&#x66F4;&#x65B0;&#x4FE1;&#x606F;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x6765;&#x5206;&#x6790;&#x4E0E;&#x4E4B;&#x76F8;&#x5173;&#x8FD9;&#x4E24;&#x4E2A;&#x7C7B;ServiceChangeTracker&#x548C;EndpointChangeTracker&#x3002;</p>
<p><strong>ServiceChangeTracker</strong>  &#x670D;&#x52A1;&#x4FE1;&#x606F;&#x53D8;&#x66F4;Tracker</p>
<div><p class="code-filename">pkg/proxy/service.go:143</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> ServiceChangeTracker <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x540C;&#x6B65;&#x9501;&#x4FDD;&#x62A4;items</span>
    lock sync<span class="token punctuation">.</span>Mutex
    <span class="token comment">// items&#x4E3A;service&#x53D8;&#x5316;&#x8BB0;&#x5F55;map</span>
  items <span class="token keyword">map</span><span class="token punctuation">[</span>types<span class="token punctuation">.</span>NamespacedName<span class="token punctuation">]</span><span class="token operator">*</span>serviceChange
    <span class="token comment">// makeServiceInfo&#x5141;&#x8BB8;proxier&#x5728;&#x5904;&#x7406;&#x670D;&#x52A1;&#x65F6;&#x5B9A;&#x5236;&#x4FE1;&#x606F;</span>
    makeServiceInfo makeServicePortFunc    
    isIPv6Mode <span class="token operator">*</span><span class="token builtin">bool</span>                           <span class="token comment">//IPv6</span>
    recorder   record<span class="token punctuation">.</span>EventRecorder            <span class="token comment">//&#x4E8B;&#x4EF6;&#x8BB0;&#x5F55;&#x5668; </span>
<span class="token punctuation">}</span>

<span class="token comment">//serviceChange&#x7C7B;&#x578B;&#x5B9A;&#x4E49;&#xFF0C; &lt;previous, current&gt; &#x65B0;&#x65E7;&#x670D;&#x52A1;&#x5BF9;.</span>
<span class="token keyword">type</span> serviceChange <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    previous ServiceMap
    current  ServiceMap
<span class="token punctuation">}</span>
<span class="token comment">//ServiceMap&#x7C7B;&#x578B;&#x5B9A;&#x4E49;</span>
<span class="token keyword">type</span> ServiceMap <span class="token keyword">map</span><span class="token punctuation">[</span>ServicePortName<span class="token punctuation">]</span>ServicePort

<span class="token comment">//ServicePortName&#x7C7B;&#x578B;&#x5B9A;&#x4E49;</span>
<span class="token keyword">type</span> ServicePortName <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    types<span class="token punctuation">.</span>NamespacedName
    Port <span class="token builtin">string</span>
<span class="token punctuation">}</span>
<span class="token comment">//NamespacedName&#x7C7B;&#x578B;&#x5B9A;&#x4E49;</span>
<span class="token keyword">type</span> NamespacedName <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Namespace <span class="token builtin">string</span>
    Name      <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">//&#x5B9E;&#x4F8B;&#x5316;ServiceChangeTracker&#x5BF9;&#x8C61;</span>
<span class="token keyword">func</span> <span class="token function">NewServiceChangeTracker</span><span class="token punctuation">(</span>makeServiceInfo makeServicePortFunc<span class="token punctuation">,</span> isIPv6Mode <span class="token operator">*</span><span class="token builtin">bool</span><span class="token punctuation">,</span> recorder record<span class="token punctuation">.</span>EventRecorder<span class="token punctuation">)</span> <span class="token operator">*</span>ServiceChangeTracker <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>ServiceChangeTracker<span class="token punctuation">{</span>
        items<span class="token punctuation">:</span>           <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>types<span class="token punctuation">.</span>NamespacedName<span class="token punctuation">]</span><span class="token operator">*</span>serviceChange<span class="token punctuation">)</span><span class="token punctuation">,</span>
        makeServiceInfo<span class="token punctuation">:</span> makeServiceInfo<span class="token punctuation">,</span>
        isIPv6Mode<span class="token punctuation">:</span>      isIPv6Mode<span class="token punctuation">,</span>
        recorder<span class="token punctuation">:</span>        recorder<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>EndpointChangeTracker.<strong>Update()</strong></p>
<div><p class="code-filename">pkg/proxy/service.go:173</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ect <span class="token operator">*</span>EndpointChangeTracker<span class="token punctuation">)</span> <span class="token function">Update</span><span class="token punctuation">(</span>previous<span class="token punctuation">,</span> current <span class="token operator">*</span>v1<span class="token punctuation">.</span>Endpoints<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    endpoints <span class="token operator">:=</span> current
    <span class="token keyword">if</span> endpoints <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        endpoints <span class="token operator">=</span> previous
    <span class="token punctuation">}</span>
    <span class="token comment">// previous == nil &amp;&amp; current == nil is unexpected, we should return false directly.</span>
    <span class="token keyword">if</span> endpoints <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    namespacedName <span class="token operator">:=</span> types<span class="token punctuation">.</span>NamespacedName<span class="token punctuation">{</span>Namespace<span class="token punctuation">:</span> endpoints<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> Name<span class="token punctuation">:</span> endpoints<span class="token punctuation">.</span>Name<span class="token punctuation">}</span>

    ect<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> ect<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    change<span class="token punctuation">,</span> exists <span class="token operator">:=</span> ect<span class="token punctuation">.</span>items<span class="token punctuation">[</span>namespacedName<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>exists <span class="token punctuation">{</span>
        change <span class="token operator">=</span> <span class="token operator">&amp;</span>endpointsChange<span class="token punctuation">{</span><span class="token punctuation">}</span>
        change<span class="token punctuation">.</span>previous <span class="token operator">=</span> ect<span class="token punctuation">.</span><span class="token function">endpointsToEndpointsMap</span><span class="token punctuation">(</span>previous<span class="token punctuation">)</span>
        ect<span class="token punctuation">.</span>items<span class="token punctuation">[</span>namespacedName<span class="token punctuation">]</span> <span class="token operator">=</span> change
    <span class="token punctuation">}</span>
    change<span class="token punctuation">.</span>current <span class="token operator">=</span> ect<span class="token punctuation">.</span><span class="token function">endpointsToEndpointsMap</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span>
    <span class="token comment">// if change.previous equal to change.current, it means no change</span>
    <span class="token keyword">if</span> reflect<span class="token punctuation">.</span><span class="token function">DeepEqual</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>previous<span class="token punctuation">,</span> change<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">delete</span><span class="token punctuation">(</span>ect<span class="token punctuation">.</span>items<span class="token punctuation">,</span> namespacedName<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>ect<span class="token punctuation">.</span>items<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>EndpointChangeTracker</strong> &#x7AEF;&#x70B9;&#x4FE1;&#x606F;&#x53D8;&#x66F4;Tracker</p>
<div><p class="code-filename">pkg/proxy/endpoints.go:83</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> EndpointChangeTracker <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    lock sync<span class="token punctuation">.</span>Mutex
    <span class="token comment">// kube-proxy&#x8FD0;&#x884C;&#x7684;&#x4E3B;&#x673A;&#x540D;.</span>
    hostname <span class="token builtin">string</span>
    <span class="token comment">// items&#x4E3A;&quot;endpoints&quot;&#x53D8;&#x5316;&#x8BB0;&#x5F55;map</span>
    items <span class="token keyword">map</span><span class="token punctuation">[</span>types<span class="token punctuation">.</span>NamespacedName<span class="token punctuation">]</span><span class="token operator">*</span>endpointsChange
    makeEndpointInfo makeEndpointFunc
    isIPv6Mode <span class="token operator">*</span><span class="token builtin">bool</span>
    recorder   record<span class="token punctuation">.</span>EventRecorder
<span class="token punctuation">}</span>
<span class="token comment">//endpointsChange&#x7C7B;&#x578B;&#x5B9A;&#x4E49;&#xFF0C;&lt;previous, current&gt; &#x65B0;&#x65E7;&#x7AEF;&#x70B9;&#x5BF9;</span>
<span class="token keyword">type</span> endpointsChange <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    previous EndpointsMap
    current  EndpointsMap
<span class="token punctuation">}</span>
<span class="token comment">//EndpointsMap&#x7C7B;&#x578B;&#x5B9A;&#x4E49;</span>
<span class="token keyword">type</span> EndpointsMap <span class="token keyword">map</span><span class="token punctuation">[</span>ServicePortName<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Endpoint

<span class="token comment">//Endpoint&#x63A5;&#x53E3;</span>
<span class="token keyword">type</span> Endpoint <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x8FD4;&#x56DE;endpoint&#x5B57;&#x4E32; &#x5982;&#x683C;&#x5F0F;: `IP:Port`.</span>
    <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
    <span class="token comment">// &#x662F;&#x5426;&#x672C;&#x5730;&#x4E3B;&#x673A;</span>
    <span class="token function">GetIsLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
    <span class="token comment">// &#x8FD4;&#x56DE;endpoint&#x7684;IP&#x90E8;&#x5206;</span>
    <span class="token function">IP</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
    <span class="token comment">// &#x8FD4;&#x56DE;endpoint&#x7684;Port&#x90E8;&#x5206;</span>
    <span class="token function">Port</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token comment">// &#x8BA1;&#x7B97;&#x4E24;&#x4E2A;endpoint&#x662F;&#x5426;&#x76F8;&#x7B49;</span>
    <span class="token function">Equal</span><span class="token punctuation">(</span>Endpoint<span class="token punctuation">)</span> <span class="token builtin">bool</span>
<span class="token punctuation">}</span>

<span class="token comment">//&#x5B9E;&#x4F8B;&#x5316;NewEndpointChangeTracker&#x5BF9;&#x8C61;</span>
<span class="token keyword">func</span> <span class="token function">NewEndpointChangeTracker</span><span class="token punctuation">(</span>hostname <span class="token builtin">string</span><span class="token punctuation">,</span> makeEndpointInfo makeEndpointFunc<span class="token punctuation">,</span> isIPv6Mode <span class="token operator">*</span><span class="token builtin">bool</span><span class="token punctuation">,</span> recorder record<span class="token punctuation">.</span>EventRecorder<span class="token punctuation">)</span> <span class="token operator">*</span>EndpointChangeTracker <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>EndpointChangeTracker<span class="token punctuation">{</span>
        hostname<span class="token punctuation">:</span>         hostname<span class="token punctuation">,</span>
        items<span class="token punctuation">:</span>            <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>types<span class="token punctuation">.</span>NamespacedName<span class="token punctuation">]</span><span class="token operator">*</span>endpointsChange<span class="token punctuation">)</span><span class="token punctuation">,</span>
        makeEndpointInfo<span class="token punctuation">:</span> makeEndpointInfo<span class="token punctuation">,</span>
        isIPv6Mode<span class="token punctuation">:</span>       isIPv6Mode<span class="token punctuation">,</span>
        recorder<span class="token punctuation">:</span>         recorder<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>EndpointChangeTracker.<strong>Update()</strong></p>
<div><p class="code-filename">pkg/proxy/endpoints.go:116</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ect <span class="token operator">*</span>EndpointChangeTracker<span class="token punctuation">)</span> <span class="token function">Update</span><span class="token punctuation">(</span>previous<span class="token punctuation">,</span> current <span class="token operator">*</span>v1<span class="token punctuation">.</span>Endpoints<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    endpoints <span class="token operator">:=</span> current
    <span class="token keyword">if</span> endpoints <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        endpoints <span class="token operator">=</span> previous
    <span class="token punctuation">}</span>
    <span class="token comment">// previous == nil &amp;&amp; current == nil is unexpected, we should return false directly.</span>
    <span class="token keyword">if</span> endpoints <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    namespacedName <span class="token operator">:=</span> types<span class="token punctuation">.</span>NamespacedName<span class="token punctuation">{</span>Namespace<span class="token punctuation">:</span> endpoints<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span> Name<span class="token punctuation">:</span> endpoints<span class="token punctuation">.</span>Name<span class="token punctuation">}</span>

    ect<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> ect<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    change<span class="token punctuation">,</span> exists <span class="token operator">:=</span> ect<span class="token punctuation">.</span>items<span class="token punctuation">[</span>namespacedName<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>exists <span class="token punctuation">{</span>
        change <span class="token operator">=</span> <span class="token operator">&amp;</span>endpointsChange<span class="token punctuation">{</span><span class="token punctuation">}</span>
        change<span class="token punctuation">.</span>previous <span class="token operator">=</span> ect<span class="token punctuation">.</span><span class="token function">endpointsToEndpointsMap</span><span class="token punctuation">(</span>previous<span class="token punctuation">)</span>
        ect<span class="token punctuation">.</span>items<span class="token punctuation">[</span>namespacedName<span class="token punctuation">]</span> <span class="token operator">=</span> change
    <span class="token punctuation">}</span>
    change<span class="token punctuation">.</span>current <span class="token operator">=</span> ect<span class="token punctuation">.</span><span class="token function">endpointsToEndpointsMap</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span>
    <span class="token comment">// if change.previous equal to change.current, it means no change</span>
    <span class="token keyword">if</span> reflect<span class="token punctuation">.</span><span class="token function">DeepEqual</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>previous<span class="token punctuation">,</span> change<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">delete</span><span class="token punctuation">(</span>ect<span class="token punctuation">.</span>items<span class="token punctuation">,</span> namespacedName<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>ect<span class="token punctuation">.</span>items<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Proxier&#x670D;&#x52A1;&#x4E0E;&#x7AEF;&#x70B9;&#x540C;&#x6B65;&#xFF08;Add / delete /update&#xFF09;&#x90FD;&#x5C06;&#x8C03;&#x7528;ChangeTracker&#x7684;update()&#x6765;&#x6267;&#x884C;syncProxyRules</p>
<p><strong>Proxier.OnServiceSynced()</strong>&#x670D;&#x52A1;&#x4FE1;&#x606F;&#x540C;&#x6B65;</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:528</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">OnServiceSynced</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    proxier<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    proxier<span class="token punctuation">.</span>servicesSynced <span class="token operator">=</span> <span class="token boolean">true</span>
    proxier<span class="token punctuation">.</span><span class="token function">setInitialized</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>servicesSynced <span class="token operator">&amp;&amp;</span> proxier<span class="token punctuation">.</span>endpointsSynced<span class="token punctuation">)</span>
    proxier<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// &#x975E;&#x5468;&#x671F;&#x540C;&#x6B65;&#xFF0C;&#x5355;&#x6B21;&#x6267;&#x884C;&#x540C;&#x6B65;</span>
    proxier<span class="token punctuation">.</span><span class="token function">syncProxyRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>service&#x670D;&#x52A1;&#x66F4;&#x65B0;(add/delete/update),&#x90FD;&#x8C03;&#x7528;Proxier.OnServiceUpdate()&#x65B9;&#x6CD5;</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:513</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">OnServiceAdd</span><span class="token punctuation">(</span>service <span class="token operator">*</span>v1<span class="token punctuation">.</span>Service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  proxier<span class="token punctuation">.</span><span class="token function">OnServiceUpdate</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span>    <span class="token comment">//&#x4F20;&#x53C2;&#x4E00;:oldService&#x4E3A;nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// update Service &#x5305;&#x542B;Add / Delete</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">OnServiceUpdate</span><span class="token punctuation">(</span>oldService<span class="token punctuation">,</span> service <span class="token operator">*</span>v1<span class="token punctuation">.</span>Service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> proxier<span class="token punctuation">.</span>serviceChanges<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>oldService<span class="token punctuation">,</span> service<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> proxier<span class="token punctuation">.</span><span class="token function">isInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        proxier<span class="token punctuation">.</span>syncRunner<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">//&#x5355;&#x6B21;&#x6267;&#x884C;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">OnServiceDelete</span><span class="token punctuation">(</span>service <span class="token operator">*</span>v1<span class="token punctuation">.</span>Service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  proxier<span class="token punctuation">.</span><span class="token function">OnServiceUpdate</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>   <span class="token comment">//&#x4F20;&#x53C2;&#x4E8C;:newService&#x4E3A;nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>Proxier.OnEndpointsSynced()</strong>&#x7AEF;&#x70B9;&#x4FE1;&#x606F;&#x540C;&#x6B65;</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:552</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">OnEndpointsSynced</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    proxier<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    proxier<span class="token punctuation">.</span>endpointsSynced <span class="token operator">=</span> <span class="token boolean">true</span>
    proxier<span class="token punctuation">.</span><span class="token function">setInitialized</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>servicesSynced <span class="token operator">&amp;&amp;</span> proxier<span class="token punctuation">.</span>endpointsSynced<span class="token punctuation">)</span>
    proxier<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Sync unconditionally - this is called once per lifetime.</span>
    proxier<span class="token punctuation">.</span><span class="token function">syncProxyRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x540C;service&#x670D;&#x52A1;&#x4E00;&#x6837;endpoint&#x66F4;&#x65B0;(add/delete/update),&#x90FD;&#x8C03;&#x7528;Proxier.OnEndpointsUpdate()&#x65B9;&#x6CD5;</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:538</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">OnEndpointsAdd</span><span class="token punctuation">(</span>endpoints <span class="token operator">*</span>v1<span class="token punctuation">.</span>Endpoints<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  proxier<span class="token punctuation">.</span><span class="token function">OnEndpointsUpdate</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> endpoints<span class="token punctuation">)</span>       <span class="token comment">//&#x4F20;&#x53C2;&#x4E00;:oldEndpoints&#x4E3A;nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// update endpoints&#xFF0C;&#x5305;&#x542B; Add / Delete</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">OnEndpointsUpdate</span><span class="token punctuation">(</span>oldEndpoints<span class="token punctuation">,</span> endpoints <span class="token operator">*</span>v1<span class="token punctuation">.</span>Endpoints<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> proxier<span class="token punctuation">.</span>endpointsChanges<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>oldEndpoints<span class="token punctuation">,</span> endpoints<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> proxier<span class="token punctuation">.</span><span class="token function">isInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        proxier<span class="token punctuation">.</span>syncRunner<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">OnEndpointsDelete</span><span class="token punctuation">(</span>endpoints <span class="token operator">*</span>v1<span class="token punctuation">.</span>Endpoints<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  proxier<span class="token punctuation">.</span><span class="token function">OnEndpointsUpdate</span><span class="token punctuation">(</span>endpoints<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>    <span class="token comment">//&#x4F20;&#x53C2;&#x4E8C;:endpoints&#x4E3A;nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="syncProxyRule_&#x540C;&#x6B65;&#x914D;&#x7F6E;&#x4E0E;&#x89C4;&#x5219;">5. syncProxyRule &#x540C;&#x6B65;&#x914D;&#x7F6E;&#x4E0E;&#x89C4;&#x5219;</h2>
<p><strong>proxier.syncProxyRules()</strong>  &#x5B9E;&#x73B0;&#x76D1;&#x542C;svc&#x6216;ep&#x66F4;&#x65B0;&#x914D;&#x7F6E;&#x5230;iptables&#x89C4;&#x5219;&#x7684;&#x4E00;&#x81F4;&#x6027;&#x540C;&#x6B65;&#x673A;&#x5236;&#x529F;&#x80FD;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F;iptables proxer&#x6700;&#x6838;&#x5FC3;&#x7684;&#x903B;&#x8F91;&#x4EE3;&#x7801;&#x3002;&#x4F5C;&#x8005;&#x5B9E;&#x73B0;&#x662F;&#x5229;&#x7528;&#x4E86;iptables-save/iptables-restore&#x673A;&#x5236;&#x5C06;&#x73B0;&#x5B58;&#x7684;iptables&#x914D;&#x7F6E;&#x548C;&#x670D;&#x52A1;&#x4E0E;&#x7AEF;&#x70B9;&#x540C;&#x6B65;&#x7684;&#x4FE1;&#x606F;&#x6765;&#x751F;&#x6210;&#x76F8;&#x5BF9;&#x5E94;&#x7684;iptables&#x94FE;&#x4E0E;&#x89C4;&#x5219;&#x6570;&#x636E;&#xFF0C;&#x6BCF;&#x6B21;&#x540C;&#x6B65;&#x6267;&#x884C;&#x5199;&#x5165;&#x53EF;restore&#x6807;&#x51C6;&#x683C;&#x5F0F;&#x7684;&#x89C4;&#x5219;&#x6570;&#x636E;&#x540E;&#x901A;&#x8FC7;iptables-restore&#x547D;&#x4EE4;&#x8FDB;&#x884C;&#x91CD;&#x8BBE;iptables&#x89C4;&#x5219;&#x3002;</p>
<p>&#x8FD9;&#x4E2A;&#x540C;&#x6B65;&#x89C4;&#x5219;&#x5904;&#x7406;&#x4EE3;&#x7801;&#x6BD4;&#x8F83;&#x957F;&#xFF0C;&#x6211;&#x4EEC;&#x540E;&#x9762;&#x5C06;&#x5206;&#x89E3;&#x6210;&#x5C0F;&#x5757;&#x6765;&#x8BB2;&#x89E3;&#x3002;&#x4E0B;&#x9762;&#x4E3A;syncProxyRules(&#x90E8;&#x5206;&#x5DF2;&#x89E3;&#x6790;&#x6CE8;&#x91CA;&#x66FF;&#x4EE3;)&#x4EE3;&#x7801;&#x6846;&#x67B6;&#x8BF4;&#x660E;&#xFF0C;&#x5185;&#x6CE8;&#x91CA;&#x7684;&#x6BCF;&#x5757;&#x5185;&#x5BB9;&#x5728;&#x540E;&#x9762;&#x90FD;&#x5C06;&#x6709;&#x5355;&#x72EC;&#x4EE3;&#x7801;&#x5206;&#x6790;&#x8BF4;&#x660E;&#x3002;</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:634</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>proxier <span class="token operator">*</span>Proxier<span class="token punctuation">)</span> <span class="token function">syncProxyRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  proxier<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> proxier<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        metrics<span class="token punctuation">.</span>SyncProxyRulesLatency<span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">SinceInMicroseconds</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span>
        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;syncProxyRules took %v&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// don&apos;t sync rules till we&apos;ve received services and endpoints</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>proxier<span class="token punctuation">.</span>endpointsSynced <span class="token operator">||</span> <span class="token operator">!</span>proxier<span class="token punctuation">.</span>servicesSynced <span class="token punctuation">{</span>
        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Not syncing iptables until Services and Endpoints have been received from master&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

  <span class="token comment">// &#x68C0;&#x6D4B;&#x4E0E;&#x66F4;&#x65B0;&#x53D8;&#x5316;(service/endpoints)</span>
  <span class="token comment">//...</span>

  <span class="token comment">// &#x521B;&#x5EFA;&#x4E0E;&#x8054;&#x63A5;kube&#x94FE;</span>
  <span class="token comment">//...</span>

    <span class="token comment">// &#x83B7;&#x53D6;&#x73B0;&#x5B58;&#x5728;&#x7684;Filter/Nat&#x8868;&#x94FE;&#x6570;&#x636E;</span>
  <span class="token comment">//...</span>


  <span class="token comment">// &#x521B;&#x5EFA;iptables-save/restore&#x683C;&#x5F0F;&#x6570;&#x636E;&#xFF08;&#x8868;&#x5934;&#x3001;&#x94FE;&#xFF09;</span>
  <span class="token comment">//...</span>

  <span class="token comment">// &#x5199;kubernets&#x7279;&#x6709;&#x7684;SNAT&#x5730;&#x5740;&#x4F2A;&#x88C5;&#x89C4;&#x5219;</span>
  <span class="token comment">//...</span>

    <span class="token comment">// Accumulate NAT chains to keep.</span>
    activeNATChains <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span>utiliptables<span class="token punctuation">.</span>Chain<span class="token punctuation">]</span><span class="token builtin">bool</span><span class="token punctuation">{</span><span class="token punctuation">}</span> 
    <span class="token comment">// Accumulate the set of local ports that we will be holding open once this update is complete</span>
    replacementPortsMap <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span>utilproxy<span class="token punctuation">.</span>LocalPort<span class="token punctuation">]</span>utilproxy<span class="token punctuation">.</span>Closeable<span class="token punctuation">{</span><span class="token punctuation">}</span>

    endpoints <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>endpointsInfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    endpointChains <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>utiliptables<span class="token punctuation">.</span>Chain<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    args <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>

    <span class="token comment">// Compute total number of endpoint chains across all services.</span>
    proxier<span class="token punctuation">.</span>endpointChainsNumber <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> svcName <span class="token operator">:=</span> <span class="token keyword">range</span> proxier<span class="token punctuation">.</span>serviceMap <span class="token punctuation">{</span>
        proxier<span class="token punctuation">.</span>endpointChainsNumber <span class="token operator">+=</span> <span class="token function">len</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>endpointsMap<span class="token punctuation">[</span>svcName<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

  <span class="token comment">// &#x4E3A;&#x4E2A;&quot;&#x670D;&#x52A1;&quot;&#x521B;&#x5EFA;rules&#xFF08;service portal&#x89C4;&#x5219;&#x7684;&#x521B;&#x5EFA;&#xFF09;</span>
    <span class="token keyword">for</span> svcName<span class="token punctuation">,</span> svc <span class="token operator">:=</span> <span class="token keyword">range</span> proxier<span class="token punctuation">.</span>serviceMap <span class="token punctuation">{</span>
     <span class="token comment">//...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// &#x5220;&#x9664;&#x4E0D;&#x518D;&#x4F7F;&#x7528;&#x7684;&#x94FE;</span>
  <span class="token comment">//...</span>

    <span class="token comment">// nodeports&#x94FE;</span>
  <span class="token comment">//...</span>

  <span class="token comment">// FORWARD&#x7B56;&#x7565;</span>
  <span class="token comment">//...</span>

    <span class="token comment">// &#x914D;&#x7F6E;clusterCIDR&#x89C4;&#x5219;</span>
  <span class="token comment">//...</span>

    <span class="token comment">// &#x5199;&#x7ED3;&#x6574;&#x6807;&#x7B7E;</span>
  <span class="token comment">//...</span>

    <span class="token comment">//&#x6C47;&#x96C6;&#x4E0E;iptables-restore&#x52A0;&#x8F7D;&#x6570;&#x636E;</span>
  <span class="token comment">//...</span>

  <span class="token comment">// &#x5173;&#x95ED;&#x8FC7;&#x65E7;&#x7684;&#x672C;&#x5730;&#x7AEF;&#x53E3;&#xFF0C;&#x66F4;&#x65B0;portmap&#x6570;&#x636E;</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> proxier<span class="token punctuation">.</span>portsMap <span class="token punctuation">{</span>
        <span class="token keyword">if</span> replacementPortsMap<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            v<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    proxier<span class="token punctuation">.</span>portsMap <span class="token operator">=</span> replacementPortsMap

    <span class="token comment">// &#x66F4;&#x65B0;healthz timestamp.</span>
    <span class="token keyword">if</span> proxier<span class="token punctuation">.</span>healthzServer <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        proxier<span class="token punctuation">.</span>healthzServer<span class="token punctuation">.</span><span class="token function">UpdateTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// &#x66F4;&#x65B0;healthchecks.</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> proxier<span class="token punctuation">.</span>healthChecker<span class="token punctuation">.</span><span class="token function">SyncServices</span><span class="token punctuation">(</span>serviceUpdateResult<span class="token punctuation">.</span>HCServiceNodePorts<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Error syncing healthcheck services: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> proxier<span class="token punctuation">.</span>healthChecker<span class="token punctuation">.</span><span class="token function">SyncEndpoints</span><span class="token punctuation">(</span>endpointUpdateResult<span class="token punctuation">.</span>HCEndpointsLocalIPSize<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Error syncing healthcheck endpoints: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// &#x5B8C;&#x6210;&#x6E05;&#x7406;&#x5DE5;&#x4F5C;</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> svcIP <span class="token operator">:=</span> <span class="token keyword">range</span> staleServices<span class="token punctuation">.</span><span class="token function">UnsortedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> conntrack<span class="token punctuation">.</span><span class="token function">ClearEntriesForIP</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>exec<span class="token punctuation">,</span> svcIP<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>ProtocolUDP<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to delete stale service IP %s connections, error: %v&quot;</span><span class="token punctuation">,</span> svcIP<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    proxier<span class="token punctuation">.</span><span class="token function">deleteEndpointConnections</span><span class="token punctuation">(</span>endpointUpdateResult<span class="token punctuation">.</span>StaleEndpoints<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4E0B;&#x9762;&#x5C06;&#x5206;&#x89E3;&#x8BE6;&#x8FF0;&#x6BCF;&#x5757;&#x4EE3;&#x7801;&#x903B;&#x8F91;:</p>
<h3 id="&#x66F4;&#x65B0;_service_&#x548C;_endpoints__&#x8FD4;&#x56DE;&#x66F4;&#x65B0;&#x7ED3;&#x679C;">5.1. &#x66F4;&#x65B0; service &#x548C; endpoints ;&#x8FD4;&#x56DE;&#x66F4;&#x65B0;&#x7ED3;&#x679C;</h3>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:652</p></div>
<pre class="language-"><code class="lang-go">    <span class="token comment">//&#x66F4;&#x65B0;SVC/EP</span>
  serviceUpdateResult <span class="token operator">:=</span> proxy<span class="token punctuation">.</span><span class="token function">UpdateServiceMap</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>serviceMap<span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>serviceChanges<span class="token punctuation">)</span>
    endpointUpdateResult <span class="token operator">:=</span> proxy<span class="token punctuation">.</span><span class="token function">UpdateEndpointsMap</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>endpointsMap<span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>endpointsChanges<span class="token punctuation">)</span>

    staleServices <span class="token operator">:=</span> serviceUpdateResult<span class="token punctuation">.</span>UDPStaleClusterIP
  <span class="token comment">// &#x4ECE;EndpointsMap&#x66F4;&#x65B0;&#x7ED3;&#x679C;&#x8FD4;&#x56DE;&#x4E2D;&#x5408;&#x5E76;UDP&#x534F;&#x8BAE;&#x5E9F;&#x5F03;&#x670D;&#x52A1;&#x4FE1;&#x606F;</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> svcPortName <span class="token operator">:=</span> <span class="token keyword">range</span> endpointUpdateResult<span class="token punctuation">.</span>StaleServiceNames <span class="token punctuation">{</span>
        <span class="token keyword">if</span> svcInfo<span class="token punctuation">,</span> ok <span class="token operator">:=</span> proxier<span class="token punctuation">.</span>serviceMap<span class="token punctuation">[</span>svcPortName<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> svcInfo <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> svcInfo<span class="token punctuation">.</span><span class="token function">GetProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> v1<span class="token punctuation">.</span>ProtocolUDP <span class="token punctuation">{</span>
            klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Stale udp service %v -&gt; %s&quot;</span><span class="token punctuation">,</span> svcPortName<span class="token punctuation">,</span> svcInfo<span class="token punctuation">.</span><span class="token function">ClusterIPString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            staleServices<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>svcInfo<span class="token punctuation">.</span><span class="token function">ClusterIPString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<h4 id="UpdateServiceMap()_SVC_&#x670D;&#x52A1;&#x7684;&#x66F4;&#x65B0;&#x5B9E;&#x73B0;">5.1.1. UpdateServiceMap() SVC &#x670D;&#x52A1;&#x7684;&#x66F4;&#x65B0;&#x5B9E;&#x73B0;</h4>
<div><p class="code-filename">pkg/proxy/service.go:212</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">UpdateServiceMap</span><span class="token punctuation">(</span>serviceMap ServiceMap<span class="token punctuation">,</span> changes <span class="token operator">*</span>ServiceChangeTracker<span class="token punctuation">)</span> <span class="token punctuation">(</span>result UpdateServiceMapResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result<span class="token punctuation">.</span>UDPStaleClusterIP <span class="token operator">=</span> sets<span class="token punctuation">.</span><span class="token function">NewString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">// &#x5DF2;&#x5E9F;&#x5F03;&#x7684;UDP&#x7AEF;&#x53E3;</span>
    serviceMap<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>changes<span class="token punctuation">,</span> result<span class="token punctuation">.</span>UDPStaleClusterIP<span class="token punctuation">)</span>  <span class="token comment">// &#x5E94;&#x7528;&#x66F4;&#x65B0;map-&gt;</span>

    result<span class="token punctuation">.</span>HCServiceNodePorts <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>types<span class="token punctuation">.</span>NamespacedName<span class="token punctuation">]</span><span class="token builtin">uint16</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> svcPortName<span class="token punctuation">,</span> info <span class="token operator">:=</span> <span class="token keyword">range</span> serviceMap <span class="token punctuation">{</span>
        <span class="token keyword">if</span> info<span class="token punctuation">.</span><span class="token function">GetHealthCheckNodePort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            result<span class="token punctuation">.</span>HCServiceNodePorts<span class="token punctuation">[</span>svcPortName<span class="token punctuation">.</span>NamespacedName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">uint16</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">GetHealthCheckNodePort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">//&#x5065;&#x5EB7;&#x68C0;&#x6D4B;&#x7684;node Port</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre>
<p><strong>serviceMap.apply() </strong>&#x5E94;&#x7528;&#x66F4;&#x65B0;&#x53D8;&#x5316;&#x4E8B;&#x4EF6;&#x7684;&#x670D;&#x52A1;&#x9879;(merge-&gt;filter-&gt;unmerge)</p>
<div><p class="code-filename">pkg/proxy/service.go:268</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>serviceMap <span class="token operator">*</span>ServiceMap<span class="token punctuation">)</span> <span class="token function">apply</span><span class="token punctuation">(</span>changes <span class="token operator">*</span>ServiceChangeTracker<span class="token punctuation">,</span> UDPStaleClusterIP sets<span class="token punctuation">.</span>String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    changes<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> changes<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> change <span class="token operator">:=</span> <span class="token keyword">range</span> changes<span class="token punctuation">.</span>items <span class="token punctuation">{</span>
        serviceMap<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>current<span class="token punctuation">)</span>         <span class="token comment">//&#x5408;&#x5E76;&#x53D8;&#x66F4;&#x589E;&#x52A0;&#x9879;&#x5230;serviceMap              &#x2460;</span>
        change<span class="token punctuation">.</span>previous<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>current<span class="token punctuation">)</span>   <span class="token comment">//&#x8FC7;&#x6EE4;&#x6389;&#x5DF2;&#x5904;&#x7406;&#x66F4;&#x65B0;&#x53D8;&#x5316;&#x7684;&#x9879;&#xFF0C;&#x8DF3;&#x8FC7;unmerge&#x5904;&#x7406;  &#x2461;</span>
        serviceMap<span class="token punctuation">.</span><span class="token function">unmerge</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>previous<span class="token punctuation">,</span> UDPStaleClusterIP<span class="token punctuation">)</span>  <span class="token comment">//&#x5220;&#x9664;&#x5E9F;&#x5F03;&#x7684;&#x9879;            &#x2462;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// clear changes after applying them to ServiceMap.</span>
    changes<span class="token punctuation">.</span>items <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>types<span class="token punctuation">.</span>NamespacedName<span class="token punctuation">]</span><span class="token operator">*</span>serviceChange<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x2460;  serviceMap.merge() &#x5408;&#x5E76;&#x589E;&#x52A0;&quot;other&#x201C;&#x5185;&#x5BB9;&#x5230;&#x5F53;&#x524D;&#x7684;serviceMap&#x5185;&#x3002;&quot;<strong>&#x5373;&#x5C06;&#x53D8;&#x5316;&#x7684;&#x670D;&#x52A1;&#x5217;&#x8868;&#x8FDB;&#x884C;&#x5408;&#x5E76;</strong>&#x201D;&#x3002;</p>
<div><p class="code-filename">pkg/proxy/service.go:301</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>sm <span class="token operator">*</span>ServiceMap<span class="token punctuation">)</span> <span class="token function">merge</span><span class="token punctuation">(</span>other ServiceMap<span class="token punctuation">)</span> sets<span class="token punctuation">.</span>String <span class="token punctuation">{</span>
    existingPorts <span class="token operator">:=</span> sets<span class="token punctuation">.</span><span class="token function">NewString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> svcPortName<span class="token punctuation">,</span> info <span class="token operator">:=</span> <span class="token keyword">range</span> other <span class="token punctuation">{</span>
        existingPorts<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>svcPortName<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token boolean">_</span><span class="token punctuation">,</span> exists <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>sm<span class="token punctuation">)</span><span class="token punctuation">[</span>svcPortName<span class="token punctuation">]</span>
     <span class="token comment">//...</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>sm<span class="token punctuation">)</span><span class="token punctuation">[</span>svcPortName<span class="token punctuation">]</span> <span class="token operator">=</span> info
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> existingPorts
<span class="token punctuation">}</span>
</code></pre>
<p>&#x2461; serviceMap.unmerge()  &#x4ECE;&#x5F53;&#x524D;map&#x79FB;&#x9664;&quot;other&quot;&#x5B58;&#x5728;&#x7684;&#x5185;&#x5BB9;&#x9879;&#x3002;&quot;<strong>&#x5373;&#x5220;&#x9664;&#x5E9F;&#x5F03;&#x7684;&#x9879;</strong>&quot;</p>
<div><p class="code-filename">pkg/proxy/service.go:330</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>sm <span class="token operator">*</span>ServiceMap<span class="token punctuation">)</span> <span class="token function">unmerge</span><span class="token punctuation">(</span>other ServiceMap<span class="token punctuation">,</span> UDPStaleClusterIP sets<span class="token punctuation">.</span>String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> svcPortName <span class="token operator">:=</span> <span class="token keyword">range</span> other <span class="token punctuation">{</span>
        info<span class="token punctuation">,</span> exists <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>sm<span class="token punctuation">)</span><span class="token punctuation">[</span>svcPortName<span class="token punctuation">]</span>
        <span class="token keyword">if</span> exists <span class="token punctuation">{</span>
            <span class="token keyword">if</span> info<span class="token punctuation">.</span><span class="token function">GetProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> v1<span class="token punctuation">.</span>ProtocolUDP <span class="token punctuation">{</span>
                UDPStaleClusterIP<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">ClusterIPString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//&#x5B58;&#x50A8;&#x5DF2;&#x5E9F;&#x4E22;UDP&#x670D;&#x52A1;&#x7684;&#x96C6;&#x7FA4;IP&#x5217;&#x8868; </span>
            <span class="token punctuation">}</span>
            <span class="token function">delete</span><span class="token punctuation">(</span><span class="token operator">*</span>sm<span class="token punctuation">,</span> svcPortName<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token comment">//...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x2462; serviceMap.filter()  &#x57FA;&#x4E8E;&quot;other&quot;&#x7ED9;&#x5B9A;&#x7684;&#x670D;&#x52A1;&#x7AEF;&#x53E3;&#x540D;(key&#x503C;)&#xFF0C;<strong>&#x8FC7;&#x6EE4;&#x6389;&#x5B58;&#x5728;&#x4E8E;serviceMap&#x7684;&#x9879;</strong></p>
<div><p class="code-filename">pkg/proxy/service.go:319</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>sm <span class="token operator">*</span>ServiceMap<span class="token punctuation">)</span> <span class="token function">filter</span><span class="token punctuation">(</span>other ServiceMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> svcPortName <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token operator">*</span>sm <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> other<span class="token punctuation">[</span>svcPortName<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
            <span class="token function">delete</span><span class="token punctuation">(</span><span class="token operator">*</span>sm<span class="token punctuation">,</span> svcPortName<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="UpdateEndpointsMap()_&#x7AEF;&#x70B9;&#x66F4;&#x65B0;&#x7684;&#x5B9E;&#x73B0;">5.1.2. UpdateEndpointsMap() &#x7AEF;&#x70B9;&#x66F4;&#x65B0;&#x7684;&#x5B9E;&#x73B0;</h4>
<div><p class="code-filename">pkg/proxy/endpoints.go:163</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">UpdateEndpointsMap</span><span class="token punctuation">(</span>endpointsMap EndpointsMap<span class="token punctuation">,</span> changes <span class="token operator">*</span>EndpointChangeTracker<span class="token punctuation">)</span> <span class="token punctuation">(</span>result UpdateEndpointMapResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result<span class="token punctuation">.</span>StaleEndpoints <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>ServiceEndpoint<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    result<span class="token punctuation">.</span>StaleServiceNames <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>ServicePortName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    endpointsMap<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>changes<span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">.</span>StaleEndpoints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">.</span>StaleServiceNames<span class="token punctuation">)</span>

    <span class="token comment">// TODO: If this will appear to be computationally expensive, consider</span>
    <span class="token comment">// computing this incrementally similarly to endpointsMap.</span>
    result<span class="token punctuation">.</span>HCEndpointsLocalIPSize <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>types<span class="token punctuation">.</span>NamespacedName<span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    localIPs <span class="token operator">:=</span> <span class="token function">GetLocalEndpointIPs</span><span class="token punctuation">(</span>endpointsMap<span class="token punctuation">)</span>
    <span class="token keyword">for</span> nsn<span class="token punctuation">,</span> ips <span class="token operator">:=</span> <span class="token keyword">range</span> localIPs <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span>HCEndpointsLocalIPSize<span class="token punctuation">[</span>nsn<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>ips<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre>
<p><strong>EndpointsMap.apply()</strong> &#x5E94;&#x7528;&#x66F4;&#x65B0;&#x53D8;&#x5316;&#x4E8B;&#x4EF6;&#x7684;&#x7AEF;&#x70B9;&#x9879;(merge-&gt;unmerge)</p>
<div><p class="code-filename">pkg/proxy/endpoints.go:242</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>endpointsMap EndpointsMap<span class="token punctuation">)</span> <span class="token function">apply</span><span class="token punctuation">(</span>changes <span class="token operator">*</span>EndpointChangeTracker<span class="token punctuation">,</span> staleEndpoints <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span>ServiceEndpoint<span class="token punctuation">,</span> staleServiceNames <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span>ServicePortName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> changes <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    changes<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> changes<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> change <span class="token operator">:=</span> <span class="token keyword">range</span> changes<span class="token punctuation">.</span>items <span class="token punctuation">{</span>
        endpointsMap<span class="token punctuation">.</span><span class="token function">Unmerge</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>previous<span class="token punctuation">)</span>                  <span class="token comment">// &#x5220;&#x9664;                &#x2460;</span>
        endpointsMap<span class="token punctuation">.</span><span class="token function">Merge</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>current<span class="token punctuation">)</span>                     <span class="token comment">// &#x66F4;&#x65B0;                &#x2461;</span>
        <span class="token function">detectStaleConnections</span><span class="token punctuation">(</span>change<span class="token punctuation">.</span>previous<span class="token punctuation">,</span> change<span class="token punctuation">.</span>current<span class="token punctuation">,</span> staleEndpoints<span class="token punctuation">,</span> staleServiceNames<span class="token punctuation">)</span>                                           <span class="token comment">//&#x5E9F;&#x5F03;&#x67E5;&#x627E;              &#x2462;      </span>
    <span class="token punctuation">}</span>
    changes<span class="token punctuation">.</span>items <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>types<span class="token punctuation">.</span>NamespacedName<span class="token punctuation">]</span><span class="token operator">*</span>endpointsChange<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x2460; EndpointsMap.Merge()   &#x5C06;&quot;other&quot;&#x5185;&#x6307;&#x5B9A;&#x9879;&#x7684;&#x503C;(&#x7AEF;&#x70B9;&#x5217;&#x8868;)&#x66F4;&#x65B0;&#x81F3;EndpointMap</p>
<div><p class="code-filename">pkg/proxy/endpoints.go:259</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>em EndpointsMap<span class="token punctuation">)</span> <span class="token function">Merge</span><span class="token punctuation">(</span>other EndpointsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> svcPortName <span class="token operator">:=</span> <span class="token keyword">range</span> other <span class="token punctuation">{</span>
        em<span class="token punctuation">[</span>svcPortName<span class="token punctuation">]</span> <span class="token operator">=</span> other<span class="token punctuation">[</span>svcPortName<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x2461; EndpointsMap.Unmerge()  &#x5220;&#x9664;&quot;other&quot;&#x5185;&#x6307;&#x5B9A;&#x9879;</p>
<div><p class="code-filename">pkg/proxy/endpoints.go:266</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>em EndpointsMap<span class="token punctuation">)</span> <span class="token function">Unmerge</span><span class="token punctuation">(</span>other EndpointsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> svcPortName <span class="token operator">:=</span> <span class="token keyword">range</span> other <span class="token punctuation">{</span>
        <span class="token function">delete</span><span class="token punctuation">(</span>em<span class="token punctuation">,</span> svcPortName<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x2462; EndpointsMap.detectStaleConnections() &#x67E5;&#x627E;&#x5E9F;&#x5F03;&#x540E;&#x7AEF;&#x8FDE;&#x63A5;&#x4FE1;&#x606F;&#x9879;</p>
<div><p class="code-filename">pkg/proxy/endpoints.go:291</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">detectStaleConnections</span><span class="token punctuation">(</span>oldEndpointsMap<span class="token punctuation">,</span> newEndpointsMap EndpointsMap<span class="token punctuation">,</span> staleEndpoints <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span>ServiceEndpoint<span class="token punctuation">,</span> staleServiceNames <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span>ServicePortName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> svcPortName<span class="token punctuation">,</span> epList <span class="token operator">:=</span> <span class="token keyword">range</span> oldEndpointsMap <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ep <span class="token operator">:=</span> <span class="token keyword">range</span> epList <span class="token punctuation">{</span>
            stale <span class="token operator">:=</span> <span class="token boolean">true</span>
            <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> newEndpointsMap<span class="token punctuation">[</span>svcPortName<span class="token punctuation">]</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> newEndpointsMap<span class="token punctuation">[</span>svcPortName<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>ep<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">//&#x5B58;&#x5728;&#x5219;stale&#x4E3A;&#x5426;</span>
                    stale <span class="token operator">=</span> <span class="token boolean">false</span>
                    <span class="token keyword">break</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> stale <span class="token punctuation">{</span>  
                klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Stale endpoint %v -&gt; %v&quot;</span><span class="token punctuation">,</span> svcPortName<span class="token punctuation">,</span> ep<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">*</span>staleEndpoints <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token operator">*</span>staleEndpoints<span class="token punctuation">,</span> ServiceEndpoint<span class="token punctuation">{</span>Endpoint<span class="token punctuation">:</span> ep<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ServicePortName<span class="token punctuation">:</span> svcPortName<span class="token punctuation">}</span><span class="token punctuation">)</span>   <span class="token comment">//&#x5B58;&#x50A8;&#x5E9F;&#x5F03;&#x7684;endpoint&#x5217;&#x8868;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> svcPortName<span class="token punctuation">,</span> epList <span class="token operator">:=</span> <span class="token keyword">range</span> newEndpointsMap <span class="token punctuation">{</span>
    <span class="token comment">//&#x5BF9;&#x4E8E;UDP&#x670D;&#x52A1;&#xFF0C;&#x5982;&#x679C;&#x540E;&#x7AEF;&#x53D8;&#x5316;&#x4ECE;0&#x81F3;&#x975E;0&#xFF0C;&#x53EF;&#x80FD;&#x5B58;&#x5728;conntrack&#x9879;&#x5C06;&#x670D;&#x52A1;&#x7684;&#x6D41;&#x91CF;&#x9ED1;&#x6D1E;</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>epList<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>oldEndpointsMap<span class="token punctuation">[</span>svcPortName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token operator">*</span>staleServiceNames <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token operator">*</span>staleServiceNames<span class="token punctuation">,</span> svcPortName<span class="token punctuation">)</span>
      <span class="token comment">//&#x5B58;&#x50A8;&#x5E9F;&#x5F03;&#x7684;&#x670D;&#x52A1;&#x540D;&#x5217;&#x8868;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x521B;&#x5EFA;&#x4E0E;&#x8054;&#x63A5;_kube_&#x94FE;">5.2. &#x521B;&#x5EFA;&#x4E0E;&#x8054;&#x63A5; kube &#x94FE;</h3>
<ul>
<li><p>filter&#x8868;&#x4E2D;INPUT&#x94FE;&#x5934;&#x90E8;&#x63D2;&#x5165;&#x81EA;&#x5B9A;&#x4E49;&#x94FE;&#x8C03;&#x8F6C;&#x5230;KUBE-EXTERNAL-SERVICES&#x94FE;
<em>iptables  -I &quot;INPUT&quot; -t &quot;filter&quot; -m &quot;conntrack&quot; --ctstate  &quot;NEW&quot;  -m comment --comment  &quot;kubernetes externally-visible service portals&quot; -j &quot;KUBE-EXTERNAL-SERVICES&quot;</em>  </p>
</li>
<li><p>filter&#x8868;&#x4E2D;OUTPUT&#x94FE;&#x5934;&#x90E8;&#x63D2;&#x5165;&#x81EA;&#x5B9A;&#x4E49;&#x94FE;&#x8C03;&#x8F6C;&#x5230;KUBE-SERVICE&#x94FE;
<em>iptables  -I &quot;OUTPUT&quot; -t &quot;filter&quot; -m &quot;conntrack&quot; --ctstate  &quot;NEW&quot;  -m comment --comment  &quot;kubernetes service portals&quot; -j &quot;KUBE-SERVICES&quot;</em></p>
</li>
<li><p>nat&#x8868;&#x4E2D;OUTPUT&#x94FE;&#x5934;&#x90E8;&#x63D2;&#x5165;&#x81EA;&#x5B9A;&#x4E49;&#x94FE;&#x8C03;&#x8F6C;&#x5230;KUBE-SERVICES&#x94FE;
<em>iptables  -I &quot;OUTPUT&quot; -t &quot;nat&quot; -m comment --comment  &quot;kubernetes service portals&quot; -j &quot;KUBE-SERVICES&quot;</em></p>
</li>
<li><p>nat&#x8868;&#x4E2D;PREROUTING&#x94FE;&#x5934;&#x90E8;&#x63D2;&#x5165;&#x81EA;&#x5B9A;&#x4E49;&#x94FE;&#x8C03;&#x8F6C;&#x5230;KUBE-SERVICES&#x94FE;
<em>iptables  -I &quot;PREROUTING&quot; -t &quot;nat&quot; -m comment --comment  &quot;kubernetes service portals&quot; -j &quot;KUBE-SERVICES&quot;</em></p>
</li>
<li><p>nat&#x8868;&#x4E2D;POSTROUTING&#x94FE;&#x5934;&#x90E8;&#x63D2;&#x5165;&#x81EA;&#x5B9A;&#x4E49;&#x94FE;&#x8C03;&#x8F6C;&#x5230;KUBE-POSTROUTING&#x94FE;
<em>iptables  -I &quot;POSTROUTING&quot; -t &quot;nat&quot; -m comment --comment &quot;kubernetes postrouting rules&quot; -j  &quot;KUBE-POSTROUTING&quot;</em></p>
</li>
<li><p>filter&#x8868;&#x4E2D;FORWARD&#x94FE;&#x5934;&#x90E8;&#x63D2;&#x5165;&#x81EA;&#x5B9A;&#x4E49;&#x94FE;&#x8C03;&#x8F6C;&#x5230;KUBE-FORWARD&#x94FE;
<em>iptables  -I &quot;FORWARD&quot; -t &quot;filter&quot; -m comment --comment &quot;kubernetes forwarding rules&quot; -j &quot;KUBE-FORWARD&quot;</em></p>
</li>
</ul>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:667</p></div>
<pre class="language-"><code class="lang-go"><span class="token comment">//&#x5FAA;&#x73AF;iptablesJumpChains&#x5B9A;&#x4E49;</span>
<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> chain <span class="token operator">:=</span> <span class="token keyword">range</span> iptablesJumpChains <span class="token punctuation">{</span>
    <span class="token comment">//&#x5E95;&#x5C42;&#x547D;&#x4EE4;iptables -t $tableName -N $chainName</span>
        <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> proxier<span class="token punctuation">.</span>iptables<span class="token punctuation">.</span><span class="token function">EnsureChain</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span>table<span class="token punctuation">,</span> chain<span class="token punctuation">.</span>chain<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to ensure that %s chain %s exists: %v&quot;</span><span class="token punctuation">,</span> chain<span class="token punctuation">.</span>table<span class="token punctuation">,</span> kubeServicesChain<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        args <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span>extraArgs<span class="token punctuation">,</span>
            <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span> chain<span class="token punctuation">.</span>comment<span class="token punctuation">,</span>
            <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span>chain<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token comment">//&#x5E95;&#x5C42;&#x547D;&#x4EE4;iptables  -I $chainName -t $tableName -m comment --comment $comment -j $chain</span>
        <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> proxier<span class="token punctuation">.</span>iptables<span class="token punctuation">.</span><span class="token function">EnsureRule</span><span class="token punctuation">(</span>utiliptables<span class="token punctuation">.</span>Prepend<span class="token punctuation">,</span> chain<span class="token punctuation">.</span>table<span class="token punctuation">,</span> chain<span class="token punctuation">.</span>sourceChain<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to ensure that %s chain %s jumps to %s: %v&quot;</span><span class="token punctuation">,</span> chain<span class="token punctuation">.</span>table<span class="token punctuation">,</span> chain<span class="token punctuation">.</span>sourceChain<span class="token punctuation">,</span> chain<span class="token punctuation">.</span>chain<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x521B;&#x5EFA;_Iptables_&#x57FA;&#x7840;&#x6570;&#x636E;">5.3. &#x521B;&#x5EFA; Iptables &#x57FA;&#x7840;&#x6570;&#x636E;</h3>
<ul>
<li>&#x83B7;&#x53D6;&#x73B0;&#x5B58;&#x5728;&#x7684;Filter/Nat&#x8868;&#x94FE;&#x6570;&#x636E;</li>
<li>&#x521B;&#x5EFA;iptables-save/restore&#x683C;&#x5F0F;&#x6570;&#x636E;&#xFF08;&#x8868;&#x5934;&#x3001;&#x94FE;&#xFF09;</li>
<li>&#x521B;&#x5EFA;SNAT&#x5730;&#x5740;&#x4F2A;&#x88C5;&#x89C4;&#x5219;</li>
</ul>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:688</p></div>
<pre class="language-"><code class="lang-go">    <span class="token comment">//&#x73B0;&#x5B58;&#x5728;&#x7684;filter&#x8868;&#x94FE;&#x83B7;&#x53D6;</span>
    existingFilterChains <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>utiliptables<span class="token punctuation">.</span>Chain<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span>
    proxier<span class="token punctuation">.</span>existingFilterChainsData<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    err <span class="token operator">:=</span> proxier<span class="token punctuation">.</span>iptables<span class="token punctuation">.</span><span class="token function">SaveInto</span><span class="token punctuation">(</span>utiliptables<span class="token punctuation">.</span>TableFilter<span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>existingFilterChainsData<span class="token punctuation">)</span>  <span class="token comment">//&#x901A;&#x8FC7;iptables-save&#x65B9;&#x5F0F;&#x6765;&#x83B7;&#x53D6;</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to execute iptables-save, syncing all rules: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
        existingFilterChains <span class="token operator">=</span> utiliptables<span class="token punctuation">.</span><span class="token function">GetChainLines</span><span class="token punctuation">(</span>utiliptables<span class="token punctuation">.</span>TableFilter<span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>existingFilterChainsData<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//&#x8F93;&#x51FA;&#x7ED3;&#x679C;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//&#x540C;&#x4E0A;&#xFF0C;&#x73B0;&#x5B58;&#x5728;&#x7684;nat&#x8868;&#x94FE;&#x83B7;&#x53D6;</span>
    existingNATChains <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>utiliptables<span class="token punctuation">.</span>Chain<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span>
    proxier<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    err <span class="token operator">=</span> proxier<span class="token punctuation">.</span>iptables<span class="token punctuation">.</span><span class="token function">SaveInto</span><span class="token punctuation">(</span>utiliptables<span class="token punctuation">.</span>TableNAT<span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>iptablesData<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to execute iptables-save, syncing all rules: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
        existingNATChains <span class="token operator">=</span> utiliptables<span class="token punctuation">.</span><span class="token function">GetChainLines</span><span class="token punctuation">(</span>utiliptables<span class="token punctuation">.</span>TableNAT<span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Reset all buffers used later.</span>
    <span class="token comment">// This is to avoid memory reallocations and thus improve performance.</span>
    proxier<span class="token punctuation">.</span>filterChains<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    proxier<span class="token punctuation">.</span>filterRules<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    proxier<span class="token punctuation">.</span>natChains<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// &#x5199;&#x8868;&#x5934;</span>
    <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>filterChains<span class="token punctuation">,</span> <span class="token string">&quot;*filter&quot;</span><span class="token punctuation">)</span>
    <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natChains<span class="token punctuation">,</span> <span class="token string">&quot;*nat&quot;</span><span class="token punctuation">)</span>
</code></pre>
<p>&#x5199;&#x94FE;&#x6570;&#x636E;</p>
<p>  <em>fileter:  &quot;KUBE-SERVICES&quot; / &quot;KUBE-EXTERNAL-SERVICES&quot;/ &quot;KUBE-FORWARD&quot;</em>
  <em>nat: &quot;KUBE-SERVICES&quot; / &quot;KUBE-NODEPORTS&quot; / &quot;KUBE-POSTROUTING&quot; / &quot;KUBE-MARK-MASQ&quot;</em></p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:720</p></div>
<pre class="language-"><code class="lang-go">    <span class="token comment">// &#x5199;chain&#x94FE;&#x6570;&#x636E;,&#x5C06;filter&#x548C;Nat&#x76F8;&#x5173;&#x94FE;&#x683C;&#x5F0F;&#x5316;&#x5B58;&#x653E;buffer</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> chainName <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>utiliptables<span class="token punctuation">.</span>Chain<span class="token punctuation">{</span>kubeServicesChain<span class="token punctuation">,</span> kubeExternalServicesChain<span class="token punctuation">,</span> kubeForwardChain<span class="token punctuation">}</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> chain<span class="token punctuation">,</span> ok <span class="token operator">:=</span> existingFilterChains<span class="token punctuation">[</span>chainName<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
            <span class="token function">writeBytesLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>filterChains<span class="token punctuation">,</span> chain<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// iptables-save/restore&#x683C;&#x5F0F;&#x7684;&#x94FE;&#x884C;&quot;:$chainName - [0:0]&quot;</span>
            <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>filterChains<span class="token punctuation">,</span> utiliptables<span class="token punctuation">.</span><span class="token function">MakeChainLine</span><span class="token punctuation">(</span>chainName<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> chainName <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>utiliptables<span class="token punctuation">.</span>Chain<span class="token punctuation">{</span>kubeServicesChain<span class="token punctuation">,</span> kubeNodePortsChain<span class="token punctuation">,</span> kubePostroutingChain<span class="token punctuation">,</span> KubeMarkMasqChain<span class="token punctuation">}</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> chain<span class="token punctuation">,</span> ok <span class="token operator">:=</span> existingNATChains<span class="token punctuation">[</span>chainName<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
            <span class="token function">writeBytesLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natChains<span class="token punctuation">,</span> chain<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natChains<span class="token punctuation">,</span> utiliptables<span class="token punctuation">.</span><span class="token function">MakeChainLine</span><span class="token punctuation">(</span>chainName<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x5199;&#x5730;&#x5740;&#x4F2A;&#x88C5;&#x89C4;&#x5219;&#xFF0C;&#x5728;POSTROUTING&#x9636;&#x6BB5;&#x5BF9;&#x5730;&#x5740;&#x8FDB;&#x884C;MASQUERADE&#xFF08;&#x57FA;&#x4E8E;&#x63A5;&#x53E3;&#x52A8;&#x6001;IP&#x7684;SNAT&#xFF09;&#x5904;&#x7406;&#xFF0C;&#x539F;&#x59CB;&#x8BF7;&#x6C42;&#x6E90;IP&#x5C06;&#x88AB;&#x4E22;&#x5931;&#xFF0C;&#x88AB;&#x8BF7;&#x6C42;POD&#x7684;&#x5E94;&#x7528;&#x770B;&#x5230;&#x4E3A;NodeIP&#x6216;CNI&#x8BBE;&#x5907;IP(bridge/vxlan&#x8BBE;&#x5907;)</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:738</p></div>
<pre class="language-"><code class="lang-go">  <span class="token comment">// &#x5199;kubernets&#x7279;&#x6709;&#x7684;SNAT&#x5730;&#x5740;&#x4F2A;&#x88C5;&#x89C4;&#x5219;</span>
  <span class="token comment">// -A KUBE-POSTROUTING -m comment --comment &quot;kubernetes service traffic requiring SNAT&quot; -m mark --mark 0x4000/0x4000 -j MASQUERADE</span>
    <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
        <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>kubePostroutingChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span> <span class="token string">`&quot;kubernetes service traffic requiring SNAT&quot;`</span><span class="token punctuation">,</span>
        <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mark&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--mark&quot;</span><span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>masqueradeMark<span class="token punctuation">,</span>
        <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;MASQUERADE&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token operator">...</span><span class="token punctuation">)</span>

  <span class="token comment">//-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000</span>
    <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
        <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>KubeMarkMasqChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;MARK&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--set-xmark&quot;</span><span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>masqueradeMark<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token operator">...</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="&#x4E3A;&#x6BCF;&#x4E2A;_service_&#x521B;&#x5EFA;_rules">5.4. &#x4E3A;&#x6BCF;&#x4E2A; service &#x521B;&#x5EFA; rules</h3>
<p>&#x5148;&#x4E86;&#x89E3;serviceInfo&#x7684;&#x5B8C;&#x6574;&#x5B9A;&#x4E49;&#x8BF4;&#x660E;</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:141</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> serviceInfo <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>proxy<span class="token punctuation">.</span>BaseServiceInfo
    <span class="token comment">// The following fields are computed and stored for performance reasons.</span>
    serviceNameString        <span class="token builtin">string</span>
  servicePortChainName     utiliptables<span class="token punctuation">.</span>Chain  <span class="token comment">// KUBE-SVC-XXXX16BitXXXX  &#x670D;&#x52A1;&#x94FE;</span>
    serviceFirewallChainName utiliptables<span class="token punctuation">.</span>Chain  <span class="token comment">// KUBE-FW-XXXX16BitXXXX   Firewall&#x94FE;</span>
    serviceLBChainName       utiliptables<span class="token punctuation">.</span>Chain  <span class="token comment">// KUBE-XLB-XXXX16BitXXXX  SLB&#x94FE;</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> BaseServiceInfo <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  ClusterIP                net<span class="token punctuation">.</span>IP                   <span class="token comment">//PortalIP(VIP)</span>
    Port                     <span class="token builtin">int</span>                      <span class="token comment">//portal&#x7AEF;&#x53E3;</span>
    Protocol                 v1<span class="token punctuation">.</span>Protocol              <span class="token comment">//&#x534F;&#x8BAE;</span>
    NodePort                 <span class="token builtin">int</span>                      <span class="token comment">//node&#x8282;&#x70B9;&#x7AEF;&#x53E3;     </span>
    LoadBalancerStatus       v1<span class="token punctuation">.</span>LoadBalancerStatus    <span class="token comment">//LB Ingress</span>
    SessionAffinityType      v1<span class="token punctuation">.</span>ServiceAffinity       <span class="token comment">//&#x4F1A;&#x8BDD;&#x4FDD;&#x6301;</span>
    StickyMaxAgeSeconds      <span class="token builtin">int</span>                      <span class="token comment">//&#x4FDD;&#x6301;&#x6700;&#x5927;&#x65F6;&#x957F;</span>
    ExternalIPs              <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>                 <span class="token comment">//ExternalIPs&#xFF08;&#x6307;&#x5B9A;&#x7684;node&#x4E0A;&#x76D1;&#x542C;&#x7AEF;&#x53E3;&#xFF09;</span>
    LoadBalancerSourceRanges <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>                 <span class="token comment">//&#x8FC7;&#x6EE4;&#x6E90;&#x5730;&#x5740;&#x6D41;&#x91CF;</span>
    HealthCheckNodePort      <span class="token builtin">int</span>                      <span class="token comment">//HealthCheck&#x68C0;&#x6D4B;&#x7AEF;&#x53E3;</span>
    OnlyNodeLocalEndpoints   <span class="token builtin">bool</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4E3A;&#x6BCF;&#x4E2A;&#x670D;&#x52A1;&#x521B;&#x5EFA;&#x670D;&#x52A1;&quot;KUBE-SVC-XXX&#x2026;&quot;&#x548C;&#x5916;&#x90E8;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&quot;KUBE-XLB-XXX&#x2026;&quot;&#x94FE;</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:791</p></div>
<pre class="language-"><code class="lang-go">        svcChain <span class="token operator">:=</span> svcInfo<span class="token punctuation">.</span>servicePortChainName  <span class="token comment">//&quot;KUBE-SVC-XXX...&quot;</span>
        <span class="token keyword">if</span> hasEndpoints <span class="token punctuation">{</span>
            <span class="token comment">// Create the per-service chain, retaining counters if possible.</span>
            <span class="token keyword">if</span> chain<span class="token punctuation">,</span> ok <span class="token operator">:=</span> existingNATChains<span class="token punctuation">[</span>svcChain<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
                <span class="token function">writeBytesLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natChains<span class="token punctuation">,</span> chain<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natChains<span class="token punctuation">,</span> utiliptables<span class="token punctuation">.</span><span class="token function">MakeChainLine</span><span class="token punctuation">(</span>svcChain<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            activeNATChains<span class="token punctuation">[</span>svcChain<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>

        svcXlbChain <span class="token operator">:=</span> svcInfo<span class="token punctuation">.</span>serviceLBChainName  <span class="token comment">// &quot;KUBE-XLB-XXX&#x2026;&quot; </span>
        <span class="token keyword">if</span> svcInfo<span class="token punctuation">.</span>OnlyNodeLocalEndpoints <span class="token punctuation">{</span>
            <span class="token comment">// Only for services request OnlyLocal traffic</span>
            <span class="token comment">// create the per-service LB chain, retaining counters if possible.</span>
            <span class="token keyword">if</span> lbChain<span class="token punctuation">,</span> ok <span class="token operator">:=</span> existingNATChains<span class="token punctuation">[</span>svcXlbChain<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
                <span class="token function">writeBytesLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natChains<span class="token punctuation">,</span> lbChain<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natChains<span class="token punctuation">,</span> utiliptables<span class="token punctuation">.</span><span class="token function">MakeChainLine</span><span class="token punctuation">(</span>svcXlbChain<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            activeNATChains<span class="token punctuation">[</span>svcXlbChain<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
</code></pre>
<p>clusterIP&#x6D41;&#x91CF;&#x7684;&#x5339;&#x914D;&#xFF0C;clusterIP&#x4E3A;&#x9ED8;&#x8BA4;&#x65B9;&#x5F0F;&#xFF0C;&#x4EC5;&#x8D44;&#x6E90;&#x96C6;&#x7FA4;&#x5185;&#x53EF;&#x8BBF;&#x95EE;&#x3002;</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:815</p></div>
<pre class="language-"><code class="lang-go">    <span class="token comment">//&#x5B58;&#x5728;&#x7AEF;&#x70B9;&#xFF0C;&#x5199;&#x89C4;&#x5219;</span>
        <span class="token keyword">if</span> hasEndpoints <span class="token punctuation">{</span>
            args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>kubeServicesChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">`&quot;%s cluster IP&quot;`</span><span class="token punctuation">,</span> svcNameString<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> <span class="token string">&quot;-p&quot;</span><span class="token punctuation">,</span> protocol<span class="token punctuation">,</span>
                <span class="token string">&quot;-d&quot;</span><span class="token punctuation">,</span> utilproxy<span class="token punctuation">.</span><span class="token function">ToCIDR</span><span class="token punctuation">(</span>svcInfo<span class="token punctuation">.</span>ClusterIP<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;--dport&quot;</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>svcInfo<span class="token punctuation">.</span>Port<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
     <span class="token comment">// proxier&#x914D;&#x7F6E;masqueradeAll</span>
     <span class="token comment">//  -A KUBE-SERVICES -m comment --comment &quot;...&quot; -m $prot -p $prot -d $clusterIP \</span>
     <span class="token comment">//     --dport $port -j KUBE-MARK-MASQ</span>
            <span class="token keyword">if</span> proxier<span class="token punctuation">.</span>masqueradeAll <span class="token punctuation">{</span>
                <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>KubeMarkMasqChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>clusterCIDR<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
       <span class="token comment">// proxier&#x914D;&#x7F6E;clusterCIDR&#x60C5;&#x51B5;&#xFF1A;</span>
       <span class="token comment">// -A KUBE-SERVICES ! -s $clusterCIDR -m comment --comment &quot;...&quot; -m $prot \</span>
       <span class="token comment">//    -p $prot -d $clusterIP --dport $port -j  KUBE-MARK-MASQ</span>
                <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;! -s&quot;</span><span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>clusterCIDR<span class="token punctuation">,</span> <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>KubeMarkMasqChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
      <span class="token comment">//  -A KUBE-SERVICES -m comment --comment &quot;...&quot; -m $prot -p $prot -d $clusterIP \</span>
      <span class="token comment">//     --dport $port -j KUBE-SVC-XXXX16bitXXXX</span>
            <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>svcChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// &#x65E0;Endpoints&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x5219;&#x521B;&#x5EFA;REJECT&#x89C4;&#x5219;</span>
      <span class="token comment">// -A KUBE-SERVICES -m comment --comment $svcName -m $prot -p $prot -d $clusterIP \</span>
      <span class="token comment">// --dport $port -j REJECT</span>
            <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>filterRules<span class="token punctuation">,</span>
                <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>kubeServicesChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">`&quot;%s has no endpoints&quot;`</span><span class="token punctuation">,</span> svcNameString<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> <span class="token string">&quot;-p&quot;</span><span class="token punctuation">,</span> protocol<span class="token punctuation">,</span>
                <span class="token string">&quot;-d&quot;</span><span class="token punctuation">,</span> utilproxy<span class="token punctuation">.</span><span class="token function">ToCIDR</span><span class="token punctuation">(</span>svcInfo<span class="token punctuation">.</span>ClusterIP<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;--dport&quot;</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>svcInfo<span class="token punctuation">.</span>Port<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;REJECT&quot;</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
</code></pre>
<p>&#x670D;&#x52A1;&#x662F;&#x5426;&#x542F;&#x7528;ExternalIPs(&#x6307;&#x5B9A;&#x7684;node&#x4E0A;&#x5F00;&#x542F;&#x76D1;&#x542C;&#x7AEF;&#x53E3;)</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:846</p></div>
<pre class="language-"><code class="lang-go">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> externalIP <span class="token operator">:=</span> <span class="token keyword">range</span> svcInfo<span class="token punctuation">.</span>ExternalIPs <span class="token punctuation">{</span>
      <span class="token comment">// &#x5224;&#x65AD;externalIP&#x662F;&#x5426;&#x4E3A;&#x672C;node&#x7684;IP&#x4EE5;&#x53CA;&#x534F;&#x8BAE;&#x4E3A;SCTP&#xFF0C;&#x4E14;&#x7AEF;&#x53E3;&#x662F;&#x5426;&#x5DF2;&#x5F00;&#x542F;</span>
      <span class="token comment">// &#x5982;&#x679C;&#x672A;&#x5F00;&#x542F;&#x5219;&#x5728;&#x672C;&#x5730;&#x6253;&#x5F00;&#x76D1;&#x542C;&#x7AEF;&#x53E3;</span>
            <span class="token keyword">if</span> local<span class="token punctuation">,</span> err <span class="token operator">:=</span> utilproxy<span class="token punctuation">.</span><span class="token function">IsLocalIP</span><span class="token punctuation">(</span>externalIP<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;can&apos;t determine if IP is local, assuming not: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> local <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>svcInfo<span class="token punctuation">.</span><span class="token function">GetProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> v1<span class="token punctuation">.</span>ProtocolSCTP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                lp <span class="token operator">:=</span> utilproxy<span class="token punctuation">.</span>LocalPort<span class="token punctuation">{</span>
                    Description<span class="token punctuation">:</span> <span class="token string">&quot;externalIP for &quot;</span> <span class="token operator">+</span> svcNameString<span class="token punctuation">,</span>
                    IP<span class="token punctuation">:</span>          externalIP<span class="token punctuation">,</span>
                    Port<span class="token punctuation">:</span>        svcInfo<span class="token punctuation">.</span>Port<span class="token punctuation">,</span>
                    Protocol<span class="token punctuation">:</span>    protocol<span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> proxier<span class="token punctuation">.</span>portsMap<span class="token punctuation">[</span>lp<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Port %s was open before and is still needed&quot;</span><span class="token punctuation">,</span> lp<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    replacementPortsMap<span class="token punctuation">[</span>lp<span class="token punctuation">]</span> <span class="token operator">=</span> proxier<span class="token punctuation">.</span>portsMap<span class="token punctuation">[</span>lp<span class="token punctuation">]</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">//&#x6253;&#x5F00;&#x4E0E;&#x76D1;&#x542C;&#x672C;&#x5730;&#x7AEF;&#x53E3;</span>
                    socket<span class="token punctuation">,</span> err <span class="token operator">:=</span> proxier<span class="token punctuation">.</span>portMapper<span class="token punctuation">.</span><span class="token function">OpenLocalPort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lp<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                        msg <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;can&apos;t open %s, skipping this externalIP: %v&quot;</span><span class="token punctuation">,</span> lp<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>

                        proxier<span class="token punctuation">.</span>recorder<span class="token punctuation">.</span><span class="token function">Eventf</span><span class="token punctuation">(</span>
                            <span class="token operator">&amp;</span>v1<span class="token punctuation">.</span>ObjectReference<span class="token punctuation">{</span>
                                Kind<span class="token punctuation">:</span>      <span class="token string">&quot;Node&quot;</span><span class="token punctuation">,</span>
                                Name<span class="token punctuation">:</span>      proxier<span class="token punctuation">.</span>hostname<span class="token punctuation">,</span>
                                UID<span class="token punctuation">:</span>       types<span class="token punctuation">.</span><span class="token function">UID</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>hostname<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                Namespace<span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
                            <span class="token punctuation">}</span><span class="token punctuation">,</span> v1<span class="token punctuation">.</span>EventTypeWarning<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
                        klog<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
                        <span class="token keyword">continue</span>
                    <span class="token punctuation">}</span>
                    replacementPortsMap<span class="token punctuation">[</span>lp<span class="token punctuation">]</span> <span class="token operator">=</span> socket
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

      <span class="token comment">//&#x5B58;&#x5728;&#x7AEF;&#x70B9;&#xFF0C;&#x5199;&#x89C4;&#x5219;</span>
            <span class="token keyword">if</span> hasEndpoints <span class="token punctuation">{</span>
                args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>kubeServicesChain<span class="token punctuation">)</span><span class="token punctuation">,</span>        
                    <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">`&quot;%s external IP&quot;`</span><span class="token punctuation">,</span> svcNameString<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> <span class="token string">&quot;-p&quot;</span><span class="token punctuation">,</span> protocol<span class="token punctuation">,</span>
                    <span class="token string">&quot;-d&quot;</span><span class="token punctuation">,</span> utilproxy<span class="token punctuation">.</span><span class="token function">ToCIDR</span><span class="token punctuation">(</span>net<span class="token punctuation">.</span><span class="token function">ParseIP</span><span class="token punctuation">(</span>externalIP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;--dport&quot;</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>svcInfo<span class="token punctuation">.</span>Port<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>

         <span class="token comment">// -A KUBE-EXTERNAL-SERVICES -m comment --comment &quot;...&quot; -m $prot -p $prot -d \</span>
        <span class="token comment">//    $externalIP --dport $port -j KUBE-MARK-MASQ </span>
                <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>KubeMarkMasqChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>

        <span class="token comment">//  -A KUBE-EXTERNAL-SERVICES -m comment --comment &quot;...&quot; -m $prot -p $prot -d \</span>
        <span class="token comment">//     $externalIP --dport $port -m physdev ! --physdev-is-in \ </span>
        <span class="token comment">//     -m addrtype ! --src-type Local -j KUBE-SVC-XXXX16bitXXXXX</span>
                externalTrafficOnlyArgs <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span>
                    <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;physdev&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--physdev-is-in&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;addrtype&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--src-type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;LOCAL&quot;</span><span class="token punctuation">)</span>
                <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>externalTrafficOnlyArgs<span class="token punctuation">,</span> <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>svcChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
                dstLocalOnlyArgs <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;addrtype&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--dst-type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;LOCAL&quot;</span><span class="token punctuation">)</span>

        <span class="token comment">//  -A KUBE-EXTERNAL-SERVICES -m comment --comment &quot;...&quot; -m $prot -p $prot -d \</span>
        <span class="token comment">//     $externalIP --dport $port -m addrtype --dst-type Local </span>
        <span class="token comment">//     -j KUBE-SVC-XXXX16bitXXXXX</span>
                <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>dstLocalOnlyArgs<span class="token punctuation">,</span> <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>svcChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// &#x4E0D;&#x5B58;&#x5728;&#x7AEF;&#x70B9;&#x4FE1;&#x606F;&#x5219;reject</span>
        <span class="token comment">// -A KUBE-EXTERNAL-SERVICES -m comment --comment &quot;...&quot; -m $prot -p $prot -d \</span>
        <span class="token comment">//    $externalIP --dport $port -j REJECT </span>
                <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>filterRules<span class="token punctuation">,</span>
                    <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>kubeExternalServicesChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">`&quot;%s has no endpoints&quot;`</span><span class="token punctuation">,</span> svcNameString<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> <span class="token string">&quot;-p&quot;</span><span class="token punctuation">,</span> protocol<span class="token punctuation">,</span>
                    <span class="token string">&quot;-d&quot;</span><span class="token punctuation">,</span> utilproxy<span class="token punctuation">.</span><span class="token function">ToCIDR</span><span class="token punctuation">(</span>net<span class="token punctuation">.</span><span class="token function">ParseIP</span><span class="token punctuation">(</span>externalIP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;--dport&quot;</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>svcInfo<span class="token punctuation">.</span>Port<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;REJECT&quot;</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre>
<p>&#x670D;&#x52A1;&#x662F;&#x5426;&#x542F;&#x7528;&#x4E86;&#x5916;&#x90E8;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x670D;&#x52A1;load-balancer <strong>ingress</strong></p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:917</p></div>
<pre class="language-"><code class="lang-go">    <span class="token comment">//&#x5B58;&#x5728;&#x7AEF;&#x70B9;&#xFF0C;&#x5199;&#x89C4;&#x5219;</span>
        <span class="token keyword">if</span> hasEndpoints <span class="token punctuation">{</span>
            fwChain <span class="token operator">:=</span> svcInfo<span class="token punctuation">.</span>serviceFirewallChainName     <span class="token comment">//&quot;KUBE-FW-XXXX16bitXXXXX&quot;</span>
            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ingress <span class="token operator">:=</span> <span class="token keyword">range</span> svcInfo<span class="token punctuation">.</span>LoadBalancerStatus<span class="token punctuation">.</span>Ingress <span class="token punctuation">{</span>
                <span class="token keyword">if</span> ingress<span class="token punctuation">.</span>IP <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
                    <span class="token comment">// &#x521B;&#x5EFA;&#x670D;&#x52A1;KUBE-FW-X&#x94FE;</span>
                    <span class="token keyword">if</span> chain<span class="token punctuation">,</span> ok <span class="token operator">:=</span> existingNATChains<span class="token punctuation">[</span>fwChain<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
                        <span class="token function">writeBytesLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natChains<span class="token punctuation">,</span> chain<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment">//&#x539F;&#x6765;&#x4E0D;&#x5B58;&#x5728;&#x5219;&#x65B0;&#x5EFA;</span>
                        <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natChains<span class="token punctuation">,</span> utiliptables<span class="token punctuation">.</span><span class="token function">MakeChainLine</span><span class="token punctuation">(</span>fwChain<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                    activeNATChains<span class="token punctuation">[</span>fwChain<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
                    <span class="token comment">// The service firewall rules are created based on ServiceSpec.loadBalancerSourceRanges field.</span>
                    <span class="token comment">// This currently works for loadbalancers that preserves source ips.</span>
                    <span class="token comment">// For loadbalancers which direct traffic to service NodePort, the firewall rules will not apply.</span>

                    args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>kubeServicesChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">`&quot;%s loadbalancer IP&quot;`</span><span class="token punctuation">,</span> svcNameString<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> <span class="token string">&quot;-p&quot;</span><span class="token punctuation">,</span> protocol<span class="token punctuation">,</span>
                        <span class="token string">&quot;-d&quot;</span><span class="token punctuation">,</span> utilproxy<span class="token punctuation">.</span><span class="token function">ToCIDR</span><span class="token punctuation">(</span>net<span class="token punctuation">.</span><span class="token function">ParseIP</span><span class="token punctuation">(</span>ingress<span class="token punctuation">.</span>IP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;--dport&quot;</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>svcInfo<span class="token punctuation">.</span>Port<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">)</span>          
          <span class="token comment">// -A KUBE-SERVICES -m comment --comment &quot;...&quot; -m $prot -p $prot -d \</span>
          <span class="token comment">//    $ingresIP --dport $port -j KUBE-FW-XXXX16bitXXXXX </span>
                    <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>fwChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>

                    args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>fwChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">`&quot;%s loadbalancer IP&quot;`</span><span class="token punctuation">,</span> svcNameString<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">)</span>

           <span class="token comment">// &#x5728;KUBE-FW&#x94FE;&#xFF0C;&#x6BCF;&#x4E2A;&#x6E90;&#x5339;&#x914D;&#x89C4;&#x5219;&#x53EF;&#x80FD;&#x8DF3;&#x8F6C;&#x81F3;&#x4E00;&#x4E2A;SVC&#x6216;XLB&#x94FE;</span>
                    chosenChain <span class="token operator">:=</span> svcXlbChain
                    <span class="token comment">// If we are proxying globally, we need to masquerade in case we cross nodes.</span>
                    <span class="token comment">// If we are proxying only locally, we can retain the source IP.</span>
                    <span class="token keyword">if</span> <span class="token operator">!</span>svcInfo<span class="token punctuation">.</span>OnlyNodeLocalEndpoints <span class="token punctuation">{</span>
            <span class="token comment">// -j &quot;KUBE-MARK-MASQ&quot; &#x5730;&#x5740;&#x4F2A;&#x88C5;&#x5B9E;&#x73B0;&#x8DE8;&#x4E3B;&#x673A;&#x8BBF;&#x95EE; </span>
                        <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>KubeMarkMasqChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
                        chosenChain <span class="token operator">=</span> svcChain   <span class="token comment">// &#x9009;&#x62E9;&#x4E3A;SVC&#x94FE;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>svcInfo<span class="token punctuation">.</span>LoadBalancerSourceRanges<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token comment">// &#x5141;&#x8BB8;&#x6240;&#x6709;&#x6E90;&#xFF0C;&#x76F4;&#x63A5;&#x8DF3;&#x8F6C; </span>
                        <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>chosenChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">// &#x57FA;&#x4E8E;source range&#x914D;&#x7F6E;&#x8FC7;&#x6EE4; &quot;-s $srcRanges&quot;</span>
            allowFromNode <span class="token operator">:=</span> <span class="token boolean">false</span>
                        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> src <span class="token operator">:=</span> <span class="token keyword">range</span> svcInfo<span class="token punctuation">.</span>LoadBalancerSourceRanges <span class="token punctuation">{</span>
                            <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;-s&quot;</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>chosenChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
                            <span class="token boolean">_</span><span class="token punctuation">,</span> cidr<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">ParseCIDR</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span>
                            <span class="token keyword">if</span> cidr<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>nodeIP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                allowFromNode <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token comment">//&#x914D;&#x7F6E;CIDR&#x5305;&#x542B;&#x8282;&#x70B9;IP&#xFF0C;&#x5219;&#x5141;&#x8BB8;&#x6765;&#x81EA;&#x8282;&#x70B9;&#x8BF7;&#x6C42;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>

            <span class="token comment">// &#x6DFB;&#x52A0; &quot;-s $ingresIP&quot; &#x6765;&#x5141;&#x8BB8;LB&#x540E;&#x7AEF;&#x4E3B;&#x673A;&#x8BF7;&#x6C42;</span>
                        <span class="token keyword">if</span> allowFromNode <span class="token punctuation">{</span>
                            <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;-s&quot;</span><span class="token punctuation">,</span> utilproxy<span class="token punctuation">.</span><span class="token function">ToCIDR</span><span class="token punctuation">(</span>net<span class="token punctuation">.</span><span class="token function">ParseIP</span><span class="token punctuation">(</span>ingress<span class="token punctuation">.</span>IP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>chosenChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

          <span class="token comment">// &#x6761;&#x4EF6;ingress.IP&#x4E3A;&#x7A7A;&quot;-j KUBE-MARK-DROP&quot;</span>
                    <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>KubeMarkDropChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre>
<p>&#x670D;&#x52A1;&#x662F;&#x5426;&#x542F;&#x7528;&#x4E86;nodeport(&#x5728;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x4E0A;&#x90FD;&#x5C06;&#x5F00;&#x542F;&#x4E00;&#x4E2A;nodeport&#x7AEF;&#x53E3;)</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:989</p></div>
<pre class="language-"><code class="lang-go">        <span class="token keyword">if</span> svcInfo<span class="token punctuation">.</span>NodePort <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
      <span class="token comment">// &#x83B7;&#x53D6;node addresses</span>
            addresses<span class="token punctuation">,</span> err <span class="token operator">:=</span> utilproxy<span class="token punctuation">.</span><span class="token function">GetNodeAddresses</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>nodePortAddresses<span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>networkInterfacer<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to get node ip address matching nodeport cidr: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>

            lps <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>utilproxy<span class="token punctuation">.</span>LocalPort<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> address <span class="token operator">:=</span> <span class="token keyword">range</span> addresses <span class="token punctuation">{</span>
                lp <span class="token operator">:=</span> utilproxy<span class="token punctuation">.</span>LocalPort<span class="token punctuation">{</span>
                    Description<span class="token punctuation">:</span> <span class="token string">&quot;nodePort for &quot;</span> <span class="token operator">+</span> svcNameString<span class="token punctuation">,</span>
                    IP<span class="token punctuation">:</span>          address<span class="token punctuation">,</span>
                    Port<span class="token punctuation">:</span>        svcInfo<span class="token punctuation">.</span>NodePort<span class="token punctuation">,</span>
                    Protocol<span class="token punctuation">:</span>    protocol<span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> utilproxy<span class="token punctuation">.</span><span class="token function">IsZeroCIDR</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Empty IP address means all</span>
                    lp<span class="token punctuation">.</span>IP <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
                    lps <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>lps<span class="token punctuation">,</span> lp<span class="token punctuation">)</span>
                    <span class="token comment">// If we encounter a zero CIDR, then there is no point in processing the rest of the addresses.</span>
                    <span class="token keyword">break</span>
                <span class="token punctuation">}</span>
                lps <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>lps<span class="token punctuation">,</span> lp<span class="token punctuation">)</span>     <span class="token comment">//IP&#x5217;&#x8868;</span>
            <span class="token punctuation">}</span>

      <span class="token comment">// &#x4E3A;node&#x8282;&#x70B9;&#x7684;ips&#x6253;&#x5F00;&#x7AEF;&#x53E3;&#x5E76;&#x4FDD;&#x5B58;&#x6301;&#x6709;socket&#x53E5;&#x67C4;</span>
            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> lp <span class="token operator">:=</span> <span class="token keyword">range</span> lps <span class="token punctuation">{</span>
                <span class="token keyword">if</span> proxier<span class="token punctuation">.</span>portsMap<span class="token punctuation">[</span>lp<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Port %s was open before and is still needed&quot;</span><span class="token punctuation">,</span> lp<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    replacementPortsMap<span class="token punctuation">[</span>lp<span class="token punctuation">]</span> <span class="token operator">=</span> proxier<span class="token punctuation">.</span>portsMap<span class="token punctuation">[</span>lp<span class="token punctuation">]</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> svcInfo<span class="token punctuation">.</span><span class="token function">GetProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> v1<span class="token punctuation">.</span>ProtocolSCTP <span class="token punctuation">{</span>
          <span class="token comment">// &#x6253;&#x5F00;&#x548C;&#x76D1;&#x542C;&#x7AEF;&#x53E3;</span>
                    socket<span class="token punctuation">,</span> err <span class="token operator">:=</span> proxier<span class="token punctuation">.</span>portMapper<span class="token punctuation">.</span><span class="token function">OpenLocalPort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lp<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                        klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;can&apos;t open %s, skipping this nodePort: %v&quot;</span><span class="token punctuation">,</span> lp<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
                        <span class="token keyword">continue</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> lp<span class="token punctuation">.</span>Protocol <span class="token operator">==</span> <span class="token string">&quot;udp&quot;</span> <span class="token punctuation">{</span>
                <span class="token comment">//&#x6E05;&#x7406;udp conntrack&#x8BB0;&#x5F55;</span>
                        err <span class="token operator">:=</span> conntrack<span class="token punctuation">.</span><span class="token function">ClearEntriesForPort</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>exec<span class="token punctuation">,</span> lp<span class="token punctuation">.</span>Port<span class="token punctuation">,</span> isIPv6<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>ProtocolUDP<span class="token punctuation">)</span>
                        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                            klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to clear udp conntrack for port %d, error: %v&quot;</span><span class="token punctuation">,</span> lp<span class="token punctuation">.</span>Port<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    replacementPortsMap<span class="token punctuation">[</span>lp<span class="token punctuation">]</span> <span class="token operator">=</span> socket <span class="token comment">//socket&#x4FDD;&#x5B58;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

      <span class="token comment">//&#x5B58;&#x5728;&#x7AEF;&#x70B9;&#xFF0C;&#x5199;&#x89C4;&#x5219;</span>
            <span class="token keyword">if</span> hasEndpoints <span class="token punctuation">{</span>
        <span class="token comment">// -A KUBE-NODEPORTS -m comment --comment &quot;...&quot; -m $prot -p $prot --dport $nodePort</span>
                args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>kubeNodePortsChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span> svcNameString<span class="token punctuation">,</span>
                    <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> <span class="token string">&quot;-p&quot;</span><span class="token punctuation">,</span> protocol<span class="token punctuation">,</span>
                    <span class="token string">&quot;--dport&quot;</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>svcInfo<span class="token punctuation">.</span>NodePort<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token operator">!</span>svcInfo<span class="token punctuation">.</span>OnlyNodeLocalEndpoints <span class="token punctuation">{</span>
          <span class="token comment">//&#x975E;&#x672C;&#x5730;nodeports&#x5219;&#x9700;SNAT&#x89C4;&#x5219;&#x6DFB;&#x52A0;,</span>
          <span class="token comment">// -j KUBE-MARK-MASQ -j KUBE-XLB-XXXX16bitXXXX</span>
                    <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>KubeMarkMasqChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
                    <span class="token comment">// Jump to the service chain.</span>
                    <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>svcChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    loopback <span class="token operator">:=</span> <span class="token string">&quot;127.0.0.0/8&quot;</span>
                    <span class="token keyword">if</span> isIPv6 <span class="token punctuation">{</span>
                        loopback <span class="token operator">=</span> <span class="token string">&quot;::1/128&quot;</span>
                    <span class="token punctuation">}</span>
           <span class="token comment">// &#x672C;&#x5730;nodeports&#x5219;&#x89C4;&#x5219;&#x6DFB;&#x52A0;,</span>
          <span class="token comment">// -s $loopback -j KUBE-MARK-MASQ -j KUBE-XLB-XXXX16bitXXXX</span>
                    <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;-s&quot;</span><span class="token punctuation">,</span> loopback<span class="token punctuation">,</span> <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>KubeMarkMasqChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
                    <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>svcXlbChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// &#x65E0;hasEndpoints&#xFF0C;&#x6DFB;&#x52A0;-j reject&#x89C4;&#x5219; </span>
        <span class="token comment">// -A KUBE-EXTERNAL-SERVICES -m comment --comment &quot;...&quot; -m addrtype \</span>
        <span class="token comment">//     --dst-type LOCAL -m $prot -p $prot --dport $nodePort -j REJECT</span>
                <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>filterRules<span class="token punctuation">,</span>
                    <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>kubeExternalServicesChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">`&quot;%s has no endpoints&quot;`</span><span class="token punctuation">,</span> svcNameString<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;addrtype&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--dst-type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;LOCAL&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> <span class="token string">&quot;-p&quot;</span><span class="token punctuation">,</span> protocol<span class="token punctuation">,</span>
                    <span class="token string">&quot;--dport&quot;</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>svcInfo<span class="token punctuation">.</span>NodePort<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;REJECT&quot;</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre>
<p>&#x57FA;&#x4E8E;&#x670D;&#x52A1;&#x540D;&#x548C;&#x534F;&#x8BAE;&#xFF0C;&#x751F;&#x6210;&#x6BCF;&#x4E2A;&#x7AEF;&#x70B9;&#x94FE;</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:1087</p></div>
<pre class="language-"><code class="lang-go">  <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ep <span class="token operator">:=</span> <span class="token keyword">range</span> proxier<span class="token punctuation">.</span>endpointsMap<span class="token punctuation">[</span>svcName<span class="token punctuation">]</span> <span class="token punctuation">{</span>
            epInfo<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ep<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>endpointsInfo<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
                klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to cast endpointsInfo %q&quot;</span><span class="token punctuation">,</span> ep<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>
            endpoints <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>endpoints<span class="token punctuation">,</span> epInfo<span class="token punctuation">)</span>
      <span class="token comment">//&#x57FA;&#x4E8E;&#x670D;&#x52A1;&#x540D;&#x548C;&#x534F;&#x8BAE;&#x751F;&#x6210;&#x7AEF;&#x70B9;&#x94FE;&#x540D;&#x79F0; &quot;KUBE-SEP-XXXX16bitXXXX&quot;</span>
            endpointChain <span class="token operator">=</span> epInfo<span class="token punctuation">.</span><span class="token function">endpointChain</span><span class="token punctuation">(</span>svcNameString<span class="token punctuation">,</span> protocol<span class="token punctuation">)</span>
            endpointChains <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>endpointChains<span class="token punctuation">,</span> endpointChain<span class="token punctuation">)</span>

      <span class="token comment">// &#x521B;&#x5EFA;&#x7AEF;&#x70B9;&#x94FE;</span>
            <span class="token keyword">if</span> chain<span class="token punctuation">,</span> ok <span class="token operator">:=</span> existingNATChains<span class="token punctuation">[</span>utiliptables<span class="token punctuation">.</span><span class="token function">Chain</span><span class="token punctuation">(</span>endpointChain<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
                <span class="token function">writeBytesLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natChains<span class="token punctuation">,</span> chain<span class="token punctuation">)</span> 
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natChains<span class="token punctuation">,</span> utiliptables<span class="token punctuation">.</span><span class="token function">MakeChainLine</span><span class="token punctuation">(</span>endpointChain<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            activeNATChains<span class="token punctuation">[</span>endpointChain<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
</code></pre>
<p>&#x5199;SessionAffinity&#x4F1A;&#x8BDD;&#x4FDD;&#x6301;&#x89C4;&#x5219;&#xFF0C;&#x5B9E;&#x73B0;&#x5728;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#x5185;&#x4FDD;&#x6301;session affinity&#xFF0C;&#x4FDD;&#x6301;&#x65F6;&#x95F4;&#x4E3A;180&#x79D2;&#xFF0C;&#x901A;&#x8FC7;&#x6DFB;&#x52A0;&#x201C;-m recent &#x2013;rcheck &#x2013;seconds 180 &#x2013;reap&#x201D;&#x7684;iptables&#x89C4;&#x5219;&#x5B9E;&#x73B0;&#x4E86;&#x4F1A;&#x8BDD;&#x4FDD;&#x6301;&#x3002;</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:1107</p></div>
<pre class="language-"><code class="lang-go">    <span class="token comment">//SessionAffinityType&#x8BBE;&#x7F6E;&#x4E3A;&quot;ClientIP&quot;&#xFF0C;&#x5219;&#x5199;session&#x4FDD;&#x6301;&#x89C4;&#x5219;</span>
    <span class="token comment">// -A KUBE-SVC-XXXX16bitXXXX -m recent -m comment &#x2013;comment &quot;...&quot; \</span>
    <span class="token comment">//    --name KUBE-SEP-XXXX16bitXXXX --rcheck --seconds 180 --reap \</span>
    <span class="token comment">//    -j KUBE-SEP-XXXX16bitXXXX</span>
        <span class="token keyword">if</span> svcInfo<span class="token punctuation">.</span>SessionAffinityType <span class="token operator">==</span> v1<span class="token punctuation">.</span>ServiceAffinityClientIP <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> endpointChain <span class="token operator">:=</span> <span class="token keyword">range</span> endpointChains <span class="token punctuation">{</span>
                args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>svcChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
                proxier<span class="token punctuation">.</span><span class="token function">appendServiceCommentLocked</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> svcNameString<span class="token punctuation">)</span>
                args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span>
                    <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;recent&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--name&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>endpointChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;--rcheck&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--seconds&quot;</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>svcInfo<span class="token punctuation">.</span>StickyMaxAgeSeconds<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;--reap&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>endpointChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
                <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre>
<p>&#x5199;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x548C;DNAT&#x89C4;&#x5219;&#xFF0C;&#x4F7F;&#x7528;&#x201C;-m statistic &#x2013;-mode random -&#x2013;probability &#x201D; iptables&#x89C4;&#x5219;&#x5C06;&#x540E;&#x7AEF;POD&#x7EC4;&#x6210;&#x4E00;&#x4E2A;&#x57FA;&#x4E8E;&#x6982;&#x7387;&#x8BBF;&#x95EE;&#x7684;&#x7EC4;&#x5408;,&#x5B9E;&#x73B0;&#x670D;&#x52A1;&#x8BBF;&#x95EE;&#x7684;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x529F;&#x80FD;&#x6548;&#x679C;&#x3002;</p>
<ul>
<li>&#x9488;&#x5BF9;&#x670D;&#x52A1;&#x7684;&#x6BCF;&#x4E2A;&#x7AEF;&#x70B9;&#x5728;nat&#x8868;&#x5185;&#x8BE5;service&#x5BF9;&#x5E94;&#x7684;&#x81EA;&#x5B9A;&#x4E49;&#x94FE;&#x201C;KUBE-SVC-XXXX16bitXXXX&#x201D;&#x4E2D;&#x52A0;&#x5165;iptables&#x89C4;&#x5219;&#x3002;&#x5982;&#x679C;&#x8BE5;&#x670D;&#x52A1;&#x5BF9;&#x5E94;&#x7684;endpoints&#x5927;&#x4E8E;&#x7B49;&#x4E8E;2&#xFF0C;&#x5219;&#x6DFB;&#x52A0;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x89C4;&#x5219;&#x3002;</li>
<li><p>&#x9488;&#x5BF9;&#x9009;&#x62E9;&#x975E;&#x672C;&#x5730;Node&#x4E0A;&#x7684;POD&#xFF0C;&#x9700;&#x8FDB;&#x884C;DNAT&#xFF0C;&#x5C06;&#x8BF7;&#x6C42;&#x7684;&#x76EE;&#x6807;&#x5730;&#x5740;&#x8BBE;&#x7F6E;&#x6210;&#x540E;&#x9009;&#x7684;POD&#x7684;IP&#x540E;&#x8FDB;&#x884C;&#x8DEF;&#x7531;&#x3002;KUBE-MARK-MASQ&#x5C06;&#x91CD;&#x8BBE;(&#x4F2A;&#x88C5;)&#x6E90;&#x5730;&#x5740;</p>
<p><em>-A KUBE-SVC-XXXX16bitXXXX -m comment &#x2013;comment &quot;...&quot; -m statistic --mode random --probability $prob  -j KUBE-SEP-XXXX16bitXXXX</em></p>
</li>
</ul>
<p><em>-A KUBE-SEP-XXXX16bitXXXX -m comment &#x2013;comment &quot;...&quot;  -s $epIp -j &quot;KUBE-MARK-MASQ&quot;</em></p>
<p><em>-A KUBE-SVC-XXXX16bitXXXX -m comment &#x2013;comment &quot;&#x2026;&quot; -m prot  -p $prot -j DNAT --to-destination X.X.X.X:xxx</em></p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:1123</p></div>
<pre class="language-"><code class="lang-go">    <span class="token comment">// &#x5199;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x548C;DNAT&#x89C4;&#x5219;</span>
        n <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>endpointChains<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> endpointChain <span class="token operator">:=</span> <span class="token keyword">range</span> endpointChains <span class="token punctuation">{</span>
            epIP <span class="token operator">:=</span> endpoints<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">IP</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> epIP <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
                <span class="token comment">// Error parsing this endpoint has been logged. Skip to next endpoint.</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// &#x6BCF;&#x4E2A;&#x670D;&#x52A1;&#x751F;&#x6210;&#x7684;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x89C4;&#x5219;&#xFF0C;&#x540E;&#x7AEF;POD&#x7EC4;&#x6210;&#x4E00;&#x4E2A;&#x57FA;&#x4E8E;&#x6982;&#x7387;&#x8BBF;&#x95EE;&#x7684;&#x7EC4;&#x5408;</span>
      <span class="token comment">//  // -A KUBE-SVC-XXXX16bitXXXX -m comment &#x2013;comment &quot;...&quot; </span>
      <span class="token comment">//    -m statistic --mode random --probability $prob </span>
      <span class="token comment">//    -j KUBE-SEP-XXXX16bitXXXX</span>
            args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>svcChain<span class="token punctuation">)</span><span class="token punctuation">)</span>
            proxier<span class="token punctuation">.</span><span class="token function">appendServiceCommentLocked</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> svcNameString<span class="token punctuation">)</span>
            <span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">// &#x5F53;&#x7AEF;&#x70B9;&#x5927;&#x4E8E;&#x6216;&#x7B49;&#x4E8E;2 </span>
                args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span>
                    <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;statistic&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;--mode&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;random&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;--probability&quot;</span><span class="token punctuation">,</span> proxier<span class="token punctuation">.</span><span class="token function">probability</span><span class="token punctuation">(</span>n<span class="token operator">-</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// The final (or only if n == 1) rule is a guaranteed match.</span>
            args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>endpointChain<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>

      <span class="token comment">// &#x6BCF;&#x4E2A;&#x7AEF;&#x70B9;&#x94FE;&#x89C4;&#x5219;</span>
      <span class="token comment">// -A KUBE-SEP-XXXX16bitXXXX -m comment &#x2013;comment &quot;...&quot;  -s $epIp -j &quot;KUBE-MARK-MASQ&quot;</span>
            args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>endpointChain<span class="token punctuation">)</span><span class="token punctuation">)</span>
            proxier<span class="token punctuation">.</span><span class="token function">appendServiceCommentLocked</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> svcNameString<span class="token punctuation">)</span>
            <span class="token comment">// Handle traffic that loops back to the originator with SNAT.</span>
            <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span>
                <span class="token string">&quot;-s&quot;</span><span class="token punctuation">,</span> utilproxy<span class="token punctuation">.</span><span class="token function">ToCIDR</span><span class="token punctuation">(</span>net<span class="token punctuation">.</span><span class="token function">ParseIP</span><span class="token punctuation">(</span>epIP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>KubeMarkMasqChain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>

      <span class="token comment">// &#x5982;&#x914D;&#x7F6E;session&#x4FDD;&#x6301;&quot;ClientIP&quot;</span>
      <span class="token comment">// -m recent --name KUBE-SEP-XXXX16bitXXXX --set </span>
            <span class="token keyword">if</span> svcInfo<span class="token punctuation">.</span>SessionAffinityType <span class="token operator">==</span> v1<span class="token punctuation">.</span>ServiceAffinityClientIP <span class="token punctuation">{</span>
                args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;recent&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--name&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>endpointChain<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;--set&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// DNAT&#x81F3;&#x6700;&#x7EC8;&#x7684;&#x7AEF;&#x70B9;&#x670D;&#x52A1;&#x4E0A;</span>
      <span class="token comment">// -A KUBE-SVC-XXXX16bitXXXX -m comment &#x2013;comment &quot;...&quot; </span>
      <span class="token comment">//    -m $prot -p $prot -j DNAT --to-destination X.X.X.X:xxx</span>
            args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> <span class="token string">&quot;-p&quot;</span><span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;DNAT&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--to-destination&quot;</span><span class="token punctuation">,</span> endpoints<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Endpoint<span class="token punctuation">)</span>
            <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

    <span class="token comment">// &#x670D;&#x52A1;&#x8BF7;&#x6C42;&#x4EC5;&#x672C;&#x5730;&#x6D41;&#x91CF;</span>
        localEndpoints <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>endpointsInfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        localEndpointChains <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>utiliptables<span class="token punctuation">.</span>Chain<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> endpointChains <span class="token punctuation">{</span>
            <span class="token keyword">if</span> endpoints<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>IsLocal <span class="token punctuation">{</span>
                <span class="token comment">// These slices parallel each other; must be kept in sync</span>
                localEndpoints <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>localEndpoints<span class="token punctuation">,</span> endpoints<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                localEndpointChains <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>localEndpointChains<span class="token punctuation">,</span> endpointChains<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre>
<p>&#x542F;&#x7528;clusterCIDR (Kube-proxy&#x4E2D;&#x7684;<code>--cluster-dir</code>&#x6307;&#x5B9A;&#x7684;&#x662F;&#x96C6;&#x7FA4;&#x4E2D;pod&#x4F7F;&#x7528;&#x7684;&#x7F51;&#x6BB5;&#xFF0C;&#x800C;pod&#x4F7F;&#x7528;&#x7684;&#x7F51;&#x6BB5;&#x548C;apiserver&#x4E2D;&#x6307;&#x5B9A;&#x7684;service&#x7684;cluster ip&#x6216;vip&#x7F51;&#x6BB5;&#x4E0D;&#x662F;&#x540C;&#x4E00;&#x4E2A;&#x7F51;&#x6BB5;)</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:1179</p></div>
<pre class="language-"><code class="lang-go">     <span class="token comment">// pod -&gt; external VIP&#x6D41;&#x91CF;&#x5BFC;&#x5411;&#x670D;&#x52A1;VIP(&#x670D;&#x52A1;&#x94FE;)</span>
    <span class="token comment">// -A KUBE-XLB-XXXX16bitXXXX -m comment --comment &quot;...&quot; -s $clusterCIDR </span>
    <span class="token comment">//    -j  KUBE-SVC-XXXX16bitXXXXX</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>clusterCIDR<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>svcXlbChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span>
                <span class="token string">`&quot;Redirect pods trying to reach external loadbalancer VIP to clusterIP&quot;`</span><span class="token punctuation">,</span>
                <span class="token string">&quot;-s&quot;</span><span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>clusterCIDR<span class="token punctuation">,</span>
                <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>svcChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
</code></pre>
<p>&#x751F;&#x6210;&#x672C;&#x5730;&#x7AEF;&#x70B9;&#x94FE;&#x89C4;&#x5219;&#xFF0C;<strong>&#x672C;&#x5730;&#x6E90;IP&#x4FDD;&#x6301;</strong>(&#x5F53;&#x53EA;&#x5728;&#x672C;&#x5730;&#x9009;&#x62E9;POD&#x670D;&#x52A1;&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;&#x5219;&#x4E0D;&#x5B58;&#x5728;SNAT&#x89C4;&#x5219;&#xFF0C;&#x53EF;&#x4FDD;&#x6301;&#x6E90;&#x5730;&#x5740;IP&#x4FE1;&#x606F;&#x3002;&#x5728;nodePort&#x6216;XLB&#x65F6;&#xFF0C;&#x53EF;&#x5B9A;&#x4E49;<code>&quot;externalTrafficPolicy&quot;: &quot;Local&quot;</code>&#x63A7;&#x5236;&#x5411;&#x5C5E;&#x4E8E;&#x8FD9;&#x4E2A;service&#x7684;&#x672C;&#x5730;&#x7684;POD&#x8F6C;&#x53D1;&#x8BF7;&#x6C42;&#xFF0C;&#x5982;&#x679C;&#x672C;&#x5730;&#x6CA1;&#x6709;POD&#x80FD;&#x670D;&#x52A1;&#x8FD9;&#x4E2A;&#x8BF7;&#x6C42;&#xFF0C;&#x8BF7;&#x6C42;&#x5C06;&#x88AB;DROP&#x6389;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x4F1A;&#x53D1;&#x73B0;&#x8BF7;&#x6C42;&#x8D85;&#x65F6;&#x6CA1;&#x6709;&#x54CD;&#x5E94;&#x3002;</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:1190</p></div>
<pre class="language-"><code class="lang-go">    numLocalEndpoints <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>localEndpointChains<span class="token punctuation">)</span>
        <span class="token keyword">if</span> numLocalEndpoints <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
      <span class="token comment">// &#x65E0;&#x672C;&#x5730;&#x7AEF;&#x70B9;&#xFF0C;&#x5C06;&#x6D41;&#x91CF;Drop(&#x6D41;&#x91CF;&#x9ED1;&#x6D1E;&#x5904;&#x7406;)</span>
      <span class="token comment">// -A KUBE-XLB-XXXX16bitXXXX -m comment --comment &quot;...&quot; -j KUBE-MARK-DROP</span>
            args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>svcXlbChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span>
                fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">`&quot;%s has no local endpoints&quot;`</span><span class="token punctuation">,</span> svcNameString<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span>
                <span class="token function">string</span><span class="token punctuation">(</span>KubeMarkDropChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// &#x672C;&#x5730;&#x7AEF;&#x70B9;&#x4F1A;&#x8BDD;&#x4FDD;&#x6301;&#x5F00;&#x542F;</span>
      <span class="token comment">// -A KUBE-XLB-XXXX16bitXXXX -m comment --comment &quot;...&quot; -m recent \ </span>
      <span class="token comment">//    --name KUBE-SEP-XXXX16bitXXXX \</span>
      <span class="token comment">//    --rcheck --seconds $StickyMaxAge --reap -j KUBE-SEP-XXXX16bitXXXX</span>
            <span class="token keyword">if</span> svcInfo<span class="token punctuation">.</span>SessionAffinityType <span class="token operator">==</span> v1<span class="token punctuation">.</span>ServiceAffinityClientIP <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> endpointChain <span class="token operator">:=</span> <span class="token keyword">range</span> localEndpointChains <span class="token punctuation">{</span>
                    <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span>
                        <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>svcXlbChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span> svcNameString<span class="token punctuation">,</span>
                        <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;recent&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--name&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>endpointChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;--rcheck&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--seconds&quot;</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>svcInfo<span class="token punctuation">.</span>StickyMaxAgeSeconds<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;--reap&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>endpointChain<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

      <span class="token comment">// &#x672C;&#x5730;&#x7AEF;&#x70B9;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x5904;&#x7406;&quot;-m statistic --mode random --probability&quot;</span>
      <span class="token comment">// &#x540E;&#x7AEF;POD&#x7EC4;&#x6210;&#x4E00;&#x4E2A;&#x57FA;&#x4E8E;&#x6982;&#x7387;&#x8BBF;&#x95EE;&#x7684;&#x7EC4;&#x5408;</span>
            <span class="token keyword">for</span> i<span class="token punctuation">,</span> endpointChain <span class="token operator">:=</span> <span class="token keyword">range</span> localEndpointChains <span class="token punctuation">{</span>
                <span class="token comment">// Balancing rules in the per-service chain.</span>
                args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>svcXlbChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span>
                    fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">`&quot;Balancing rule %d for %s&quot;`</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> svcNameString<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
                <span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token punctuation">(</span>numLocalEndpoints <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Each rule is a probabilistic match.</span>
                    args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span>
                        <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;statistic&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;--mode&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;random&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;--probability&quot;</span><span class="token punctuation">,</span> proxier<span class="token punctuation">.</span><span class="token function">probability</span><span class="token punctuation">(</span>numLocalEndpoints<span class="token operator">-</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>

                args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>endpointChain<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// -A KUBE-XLB-XXXX16bitXXXX -m comment --comment &quot;...&quot; -m recent \ </span>
      <span class="token comment">//    --name KUBE-SEP-XXXX16bitXXXX -m statistic --mode random \</span>
      <span class="token comment">//    --probability 0.50000000000  -j KUBE-SEP-XXXX16bitXXXX</span>
                <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre>
<h3 id="&#x914D;&#x7F6E;&#x6536;&#x5C3E;&#x89C4;&#x5219;&#x6570;&#x636E;">5.5. &#x914D;&#x7F6E;&#x6536;&#x5C3E;&#x89C4;&#x5219;&#x6570;&#x636E;</h3>
<p>&#x5220;&#x9664;&#x4E0D;&#x518D;&#x4F7F;&#x7528;&#x7684;&#x670D;&#x52A1;&#x81EA;&#x5B9A;&#x4E49;kube&#x94FE;&quot;KUBE-SVC-*&quot;/&quot;KUBE-SEP-*&quot;/&quot;KUBE-FW-*&quot;/&quot;KUBE-XLB-*&quot;&#x3002;</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:1237</p></div>
<pre class="language-"><code class="lang-go">    <span class="token keyword">for</span> chain <span class="token operator">:=</span> <span class="token keyword">range</span> existingNATChains <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>activeNATChains<span class="token punctuation">[</span>chain<span class="token punctuation">]</span> <span class="token punctuation">{</span>
            chainString <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>chain<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>chainString<span class="token punctuation">,</span> <span class="token string">&quot;KUBE-SVC-&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>chainString<span class="token punctuation">,</span> <span class="token string">&quot;KUBE-SEP-&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>chainString<span class="token punctuation">,</span> <span class="token string">&quot;KUBE-FW-&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>chainString<span class="token punctuation">,</span> <span class="token string">&quot;KUBE-XLB-&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Ignore chains that aren&apos;t ours.</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// We must (as per iptables) write a chain-line for it, which has</span>
            <span class="token comment">// the nice effect of flushing the chain.  Then we can remove the</span>
            <span class="token comment">// chain.</span>
            <span class="token function">writeBytesLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natChains<span class="token punctuation">,</span> existingNATChains<span class="token punctuation">[</span>chain<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token string">&quot;-X&quot;</span><span class="token punctuation">,</span> chainString<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x6DFB;&#x52A0;&#x670D;&#x52A1;&#x7684;nodeports&#x89C4;&#x5219;(nat&#x8868;-&quot;KUBE-SERVICES&quot;&#x94FE;)</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:1254</p></div>
<pre class="language-"><code class="lang-go"><span class="token comment">// -A KUBE-SERVICES -m comment --comment &quot;...&quot; -m addrtype --dst-type LOCAL \</span>
<span class="token comment">//    -j KUBE-NODEPORTS</span>
<span class="token comment">//</span>
<span class="token comment">// -A KUBE-SERVICES -m comment --comment &quot;...&quot; -d $NODEIP -j KUBE-NODEPORTS</span>
<span class="token comment">//</span>
addresses<span class="token punctuation">,</span> err <span class="token operator">:=</span> utilproxy<span class="token punctuation">.</span><span class="token function">GetNodeAddresses</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>nodePortAddresses<span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>networkInterfacer<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to get node ip address matching nodeport cidr&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        isIPv6 <span class="token operator">:=</span> proxier<span class="token punctuation">.</span>iptables<span class="token punctuation">.</span><span class="token function">IsIpv6</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> address <span class="token operator">:=</span> <span class="token keyword">range</span> addresses <span class="token punctuation">{</span>
            <span class="token comment">// TODO(thockin, m1093782566): If/when we have dual-stack support we will want to distinguish v4 from v6 zero-CIDRs.</span>
            <span class="token keyword">if</span> utilproxy<span class="token punctuation">.</span><span class="token function">IsZeroCIDR</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>kubeServicesChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span> <span class="token string">`&quot;kubernetes service nodeports; NOTE: this must be the last rule in this chain&quot;`</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;addrtype&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--dst-type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;LOCAL&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>kubeNodePortsChain<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
                <span class="token comment">// Nothing else matters after the zero CIDR.</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Ignore IP addresses with incorrect version</span>
            <span class="token keyword">if</span> isIPv6 <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>utilnet<span class="token punctuation">.</span><span class="token function">IsIPv6String</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>isIPv6 <span class="token operator">&amp;&amp;</span> utilnet<span class="token punctuation">.</span><span class="token function">IsIPv6String</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;IP address %s has incorrect IP version&quot;</span><span class="token punctuation">,</span> address<span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// create nodeport rules for each IP one by one</span>
            args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>kubeServicesChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span> <span class="token string">`&quot;kubernetes service nodeports; NOTE: this must be the last rule in this chain&quot;`</span><span class="token punctuation">,</span>
                <span class="token string">&quot;-d&quot;</span><span class="token punctuation">,</span> address<span class="token punctuation">,</span>
                <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>kubeNodePortsChain<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x6DFB;&#x52A0;forward&#x89C4;&#x5219;(filter&#x8868;-&quot;KUBE-FORWARD&quot;&#x94FE;)</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:1289</p></div>
<pre class="language-"><code class="lang-go"><span class="token comment">//-A KUBE-FORWARD -m comment --comment &quot;...&quot; -m mark --mark 0xFFFF/0xFFFF -j ACCEPT</span>
<span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>filterRules<span class="token punctuation">,</span>
        <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>kubeForwardChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span> <span class="token string">`&quot;kubernetes forwarding rules&quot;`</span><span class="token punctuation">,</span>
        <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mark&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--mark&quot;</span><span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>masqueradeMark<span class="token punctuation">,</span>
        <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ACCEPT&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre>
<p>&#x6DFB;&#x52A0;&#x5E26;clusterCIDR&#x914D;&#x7F6E;(&#x6E90;/&#x76EE;&#x6807;)&#x89C4;&#x5219;(filter&#x8868;-&quot;KUBE-FORWARD&quot;&#x94FE;)</p>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:1297</p></div>
<pre class="language-"><code class="lang-go"><span class="token comment">//Kube-proxy&#x4E2D;&#x7684;cluster-dir&#x6307;&#x5B9A;&#x7684;&#x662F;&#x96C6;&#x7FA4;&#x4E2D;pod&#x4F7F;&#x7528;&#x7684;&#x7F51;&#x6BB5;</span>
<span class="token comment">//pod&#x4F7F;&#x7528;&#x7684;&#x7F51;&#x6BB5;&#x548C;service&#x7684;cluster ip&#x7F51;&#x6BB5;&#x4E0D;&#x662F;&#x540C;&#x4E00;&#x4E2A;&#x7F51;&#x6BB5;</span>
<span class="token comment">//</span>
<span class="token comment">// -A KUBE-FORWARD -s $clusterCIDR -m comment --comment &quot;...&quot; -m conntrack --ctstate \ </span>
<span class="token comment">//    RELATED,ESTABLISHED -j ACCEPT</span>
<span class="token comment">// -A KUBE-FORWARD -m comment --comment &quot;...&quot; -d $clusterCIDR -m conntrack --ctstate \ </span>
<span class="token comment">//    RELATED,ESTABLISHED -j ACCEPT</span>
<span class="token comment">//</span>
<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>clusterCIDR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>filterRules<span class="token punctuation">,</span>
            <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>kubeForwardChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;-s&quot;</span><span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>clusterCIDR<span class="token punctuation">,</span>           <span class="token comment">//&#x6307;&#x5B9A;&#x6E90;</span>
            <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span> <span class="token string">`&quot;kubernetes forwarding conntrack pod source rule&quot;`</span><span class="token punctuation">,</span>
            <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;conntrack&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;--ctstate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RELATED,ESTABLISHED&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ACCEPT&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>filterRules<span class="token punctuation">,</span>
            <span class="token string">&quot;-A&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>kubeForwardChain<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--comment&quot;</span><span class="token punctuation">,</span> <span class="token string">`&quot;kubernetes forwarding conntrack pod destination rule&quot;`</span><span class="token punctuation">,</span>
            <span class="token string">&quot;-d&quot;</span><span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>clusterCIDR<span class="token punctuation">,</span>            <span class="token comment">//&#x6307;&#x5B9A;&#x76EE;&#x6807;</span>
            <span class="token string">&quot;-m&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;conntrack&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;--ctstate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;RELATED,ESTABLISHED&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;-j&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ACCEPT&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x7ED3;&#x5C3E;&#x6807;&#x5FD7;&#x5199;&#x5165;</p>
<pre class="language-"><code class="lang-go">    <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>filterRules<span class="token punctuation">,</span> <span class="token string">&quot;COMMIT&quot;</span><span class="token punctuation">)</span>
    <span class="token function">writeLine</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">,</span> <span class="token string">&quot;COMMIT&quot;</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="&#x6C47;&#x96C6;&#x4E0E;&#x52A0;&#x8F7D;_iptables_&#x914D;&#x7F6E;&#x89C4;&#x5219;&#x6570;&#x636E;">5.6. &#x6C47;&#x96C6;&#x4E0E;&#x52A0;&#x8F7D; iptables &#x914D;&#x7F6E;&#x89C4;&#x5219;&#x6570;&#x636E;</h3>
<div><p class="code-filename">pkg/proxy/iptables/proxier.go:1326</p></div>
<pre class="language-"><code class="lang-go">  <span class="token comment">//&#x6C47;&#x96C6;&#x524D;&#x9762;&#x6240;&#x5904;&#x7406;&#x7684;filter&#x548C;nat&#x8868;&#x6570;&#x636E;&#x81F3;iptablesData</span>
  proxier<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    proxier<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>filterChains<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    proxier<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>filterRules<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    proxier<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natChains<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    proxier<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>natRules<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Restoring iptables rules: %s&quot;</span><span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// iptables-restore&#x52A0;&#x8F7D;&#x65B0;&#x914D;&#x7F6E;(iptablesData)</span>
    err <span class="token operator">=</span> proxier<span class="token punctuation">.</span>iptables<span class="token punctuation">.</span><span class="token function">RestoreAll</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>iptablesData<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> utiliptables<span class="token punctuation">.</span>NoFlushTables<span class="token punctuation">,</span> utiliptables<span class="token punctuation">.</span>RestoreCounters<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to execute iptables-restore: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token comment">// Revert new local ports.</span>
        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Closing local ports after iptables-restore failure&quot;</span><span class="token punctuation">)</span>
        utilproxy<span class="token punctuation">.</span><span class="token function">RevertPorts</span><span class="token punctuation">(</span>replacementPortsMap<span class="token punctuation">,</span> proxier<span class="token punctuation">.</span>portsMap<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
</code></pre>
<h2 id="IPtables_&#x5E95;&#x5C42;&#x7684;_runner_&#x5B9E;&#x73B0;">6. IPtables &#x5E95;&#x5C42;&#x7684; runner &#x5B9E;&#x73B0;</h2>
<p>&#x524D;&#x9762;&#x57FA;&#x672C;&#x5DF2;&#x770B;&#x5B8C;&#x6574;&#x4E2A;proxy&#x7684;&#x6267;&#x884C;&#x6D41;&#x7A0B;&#xFF0C;&#x6700;&#x540E;iptables proxier&#x662F;&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x7CFB;&#x7EDF;&#x5C42;iptables&#x547D;&#x4EE4;&#x8FDB;&#x884C;&#x5E95;&#x5C42;&#x7684;iptables&#x89C4;&#x5219;CRUD&#x64CD;&#x4F5C;&#xFF08;&#x901A;&#x4FD7;&#x7684;&#x7406;&#x89E3;&#xFF1A;iptables proxier&#x5B9E;&#x73B0;&#x90FD;&#x662F;&#x5728;&#x64CD;&#x4F5C;iptables&#x547D;&#x4EE4;&#x751F;&#x6210;&#x76F8;&#x5E94;&#x7684;&#x89C4;&#x5219;&#xFF09;&#xFF0C;&#x4E0B;&#x9762;&#x6211;&#x6765;&#x770B;&#x4E00;&#x4E0B;kuber-proxy&#x7EC4;&#x4EF6;&#x5E95;&#x5C42;iptables&#x64CD;&#x4F5C;&#x5668;&#x7684;&#x5C01;&#x88C5;&#x3002;</p>
<h3 id="iptables_&#x6267;&#x884C;&#x5668;">6.1. iptables &#x6267;&#x884C;&#x5668;</h3>
<p>Interface**&#x63A5;&#x53E3;&#x4E3A;&#x8FD0;&#x884C;iptables&#x547D;&#x4EE4;&#x5B9A;&#x4E49;</p>
<div><p class="code-filename">pkg/util/iptables/iptables.go:45</p></div>
<pre class="language-"><code class="lang-go"><span class="token comment">//&#x63A5;&#x53E3;&#x4E0E;&#x63A5;&#x53E3;&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;</span>
<span class="token keyword">type</span> Interface <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">GetVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">EnsureChain</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> chain Chain<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">FlushChain</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> chain Chain<span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token function">DeleteChain</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> chain Chain<span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token function">EnsureRule</span><span class="token punctuation">(</span>position RulePosition<span class="token punctuation">,</span> table Table<span class="token punctuation">,</span> chain Chain<span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token function">DeleteRule</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> chain Chain<span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token function">IsIpv6</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
    <span class="token function">SaveInto</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> buffer <span class="token operator">*</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token function">Restore</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> flush FlushFlag<span class="token punctuation">,</span> counters RestoreCountersFlag<span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token function">RestoreAll</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> flush FlushFlag<span class="token punctuation">,</span> counters RestoreCountersFlag<span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token function">AddReloadFunc</span><span class="token punctuation">(</span>reloadFunc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>iptables Interface&#x63A5;&#x5B9E;&#x73B0;&#x7C7B;runner,&#x5B8C;&#x6210;&#x5BF9;iptables&#x547D;&#x4EE4;&#x6267;&#x884C;&#x5668;&#x7684;&#x5B9A;&#x4E49;</p>
<div><p class="code-filename">pkg/util/iptables/iptables.go:135</p></div>
<pre class="language-"><code class="lang-go"><span class="token comment">// &#x7C7B;&#x7ED3;&#x6784;&#x5B9A;&#x4E49;</span>
<span class="token keyword">type</span> runner <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    mu              sync<span class="token punctuation">.</span>Mutex              <span class="token comment">//&#x540C;&#x6B65;&#x9501; </span>
    exec            utilexec<span class="token punctuation">.</span>Interface      <span class="token comment">//osExec&#x547D;&#x4EE4;&#x6267;&#x884C;</span>
    dbus            utildbus<span class="token punctuation">.</span>Interface      <span class="token comment">//D-Bus&#x64CD;&#x4F5C;API&#x63A5;&#x53E3; </span>
    protocol        Protocol                <span class="token comment">//&#x534F;&#x8BAE;IPv4/IPv6</span>
    hasCheck        <span class="token builtin">bool</span>                    <span class="token comment">//&quot;-C&quot;&#x68C0;&#x6D4B;&#x547D;&#x4EE4;flag</span>
  hasListener     <span class="token builtin">bool</span>                    <span class="token comment">//D-Bus&#x4FE1;&#x53F7;&#x76D1;&#x542C;&#x662F;&#x5426;&#x5F00;&#x542F;(FirewallD start/restart)</span>
    waitFlag        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>                <span class="token comment">//iptables&#x547D;&#x4EE4;&quot;wait&quot;flag,&#x7B49;&#x5F85;xtables&#x9501;</span>
    restoreWaitFlag <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>                <span class="token comment">//iptables-restore&#x547D;&#x4EE4;&quot;wait&quot;flag</span>
    lockfilePath    <span class="token builtin">string</span>                  <span class="token comment">//xtables&#x9501;&#x6587;&#x4EF6;&#x4F4D;&#x7F6E;</span>

    reloadFuncs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token comment">//&#x5B9A;&#x4E49;reload&#x5904;&#x7406;func</span>
    signal      <span class="token keyword">chan</span> <span class="token operator">*</span>godbus<span class="token punctuation">.</span>Signal         <span class="token comment">//dbus&#x4FE1;&#x53F7;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Runner&#x5B9E;&#x73B0;Iterface&#x65B9;&#x6CD5;&#x5217;&#x8868;&#xFF0C;&#x540E;&#x9762;&#x5C06;&#x8BE6;&#x7EC6;&#x5206;&#x6790;&#x5173;&#x952E;&#x7684;&#x65B9;&#x6CD5;&#x5B9E;&#x73B0;&#x4EE3;&#x7801;&#x903B;&#x8F91;</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">GetVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">EnsureChain</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> chain Chain<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">FlushChain</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> chain Chain<span class="token punctuation">)</span> <span class="token builtin">error</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">DeleteChain</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> chain Chain<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">EnsureRule</span><span class="token punctuation">(</span>position RulePosition<span class="token punctuation">,</span> table Table<span class="token punctuation">,</span> chain Chain<span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">DeleteRule</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> chain Chain<span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">IsIpv6</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">SaveInto</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> buffer <span class="token operator">*</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">Restore</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> flush FlushFlag<span class="token punctuation">,</span> counters RestoreCountersFlag<span class="token punctuation">)</span> <span class="token builtin">error</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">RestoreAll</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> flush FlushFlag<span class="token punctuation">,</span> counters RestoreCountersFlag<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">AddReloadFunc</span><span class="token punctuation">(</span>reloadFunc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 

<span class="token comment">// Runner&#x5185;&#x90E8;&#x65B9;&#x6CD5;&#x5217;&#x8868;</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">connectToFirewallD</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">restoreInternal</span><span class="token punctuation">(</span>args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> flush FlushFlag<span class="token punctuation">,</span> counters RestoreCountersFlag<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">run</span><span class="token punctuation">(</span>op operation<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">runContext</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> op operation<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">checkRule</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> chain Chain<span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">checkRuleWithoutCheck</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> chain Chain<span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> 
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">checkRuleUsingCheck</span><span class="token punctuation">(</span>args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">dbusSignalHandler</span><span class="token punctuation">(</span>bus utildbus<span class="token punctuation">.</span>Connection<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>iptables <strong>runner&#x5BF9;&#x8C61;</strong>&#x7684;&#x6784;&#x9020;New() -&gt; newInternal(),&#x8FD4;&#x56DE;runner{&#x2026;}&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;(Interface&#x63A5;&#x53E3;&#x7C7B;&#x578B;) &#xFF0C;&#x5B8C;&#x6210;&#x4E86;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;iptables&#x7684;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x5668;&#x751F;&#x6210;&#x5DE5;&#x4F5C;&#x3002;</p>
<div><p class="code-filename">pkg/util/iptables/iptables.go:152</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">newInternal</span><span class="token punctuation">(</span>exec utilexec<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> dbus utildbus<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> protocol Protocol<span class="token punctuation">,</span> lockfilePath <span class="token builtin">string</span><span class="token punctuation">)</span> Interface <span class="token punctuation">{</span>
    vstring<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getIPTablesVersionString</span><span class="token punctuation">(</span>exec<span class="token punctuation">,</span> protocol<span class="token punctuation">)</span>   <span class="token comment">//iptables&#x7248;&#x672C;&#x83B7;&#x53D6;</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">&quot;Error checking iptables version, assuming version at least %s: %v&quot;</span><span class="token punctuation">,</span> MinCheckVersion<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        vstring <span class="token operator">=</span> MinCheckVersion
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> lockfilePath <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
        lockfilePath <span class="token operator">=</span> LockfilePath16x                      <span class="token comment">//&#x9ED8;&#x8BA4;&#x9501;&#x6587;&#x4EF6;&#x4F4D;&#x7F6E;&quot;/run/xtables.lock&quot;</span>
    <span class="token punctuation">}</span>

    runner <span class="token operator">:=</span> <span class="token operator">&amp;</span>runner<span class="token punctuation">{</span>
        exec<span class="token punctuation">:</span>            exec<span class="token punctuation">,</span>                                         <span class="token comment">//utilexec = osExec&#x5C01;&#x88C5;</span>
        dbus<span class="token punctuation">:</span>            dbus<span class="token punctuation">,</span>                                         <span class="token comment">//utildbus</span>
        protocol<span class="token punctuation">:</span>        protocol<span class="token punctuation">,</span>                                     <span class="token comment">//IPv4 or IPv6</span>
        hasCheck<span class="token punctuation">:</span>        <span class="token function">getIPTablesHasCheckCommand</span><span class="token punctuation">(</span>vstring<span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment">//&quot;-C&quot; flag&#x662F;&#x5426;&#x6307;&#x5B9A;</span>
        hasListener<span class="token punctuation">:</span>     <span class="token boolean">false</span><span class="token punctuation">,</span>
        waitFlag<span class="token punctuation">:</span>        <span class="token function">getIPTablesWaitFlag</span><span class="token punctuation">(</span>vstring<span class="token punctuation">)</span><span class="token punctuation">,</span>                 <span class="token comment">//iptables -wait</span>
        restoreWaitFlag<span class="token punctuation">:</span> <span class="token function">getIPTablesRestoreWaitFlag</span><span class="token punctuation">(</span>exec<span class="token punctuation">,</span> protocol<span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">//iptables-restore -wait</span>
        lockfilePath<span class="token punctuation">:</span>    lockfilePath<span class="token punctuation">,</span>                                 <span class="token comment">//xtables&#x9501;&#x6587;&#x4EF6;&#x4F4D;&#x7F6E;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> runner
<span class="token punctuation">}</span>

<span class="token comment">// &#x8FD4;&#x56DE;iptables exec&#x547D;&#x4EE4;&#x6267;&#x884C;&#x5668;&#x5BF9;&#x8C61;runner</span>
<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>exec utilexec<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> dbus utildbus<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> protocol Protocol<span class="token punctuation">)</span> Interface <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">newInternal</span><span class="token punctuation">(</span>exec<span class="token punctuation">,</span> dbus<span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>     
<span class="token punctuation">}</span>
</code></pre>
<h3 id="iptables_&#x6267;&#x884C;&#x5668;&#x65B9;&#x6CD5;">6.2. iptables &#x6267;&#x884C;&#x5668;&#x65B9;&#x6CD5;</h3>
<p><strong>runner.run()</strong>  &#x8FD9;&#x4E2A;&#x662F;&#x65B9;&#x6CD5;&#x662F;runner&#x6700;&#x57FA;&#x7840;&#x548C;&#x516C;&#x5171;&#x8C03;&#x7528;&#x7684;&#x5185;&#x90E8;&#x65B9;&#x6CD5;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;iptables&#x547D;&#x4EE4;&#x6267;&#x884C;os exec&#x8C03;&#x7528;&#x4EE3;&#x7801;&#x3002;run()&#x6709;&#x4E24;&#x4E2A;&#x4F20;&#x53C2;&#xFF1A;1. &#x6307;&#x5B9A;iptables&#x64CD;&#x4F5C;command&#xFF0C;2.&#x53C2;&#x6570;&#x5217;&#x8868;&#x3002;&#x901A;&#x8FC7;&#x4F20;&#x53C2;&#x5C06;&#x7EC4;&#x6210;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;iptables&#x547D;&#x4EE4;&#x8FDB;&#x884C;exec&#x8C03;&#x7528;&#x6267;&#x884C;&#x3002;runContext()&#x6B64;&#x65B9;&#x6CD5;&#x5185;&#x542B;&#x6709;&#x5E26;context&#x4E0A;&#x4E0B;&#x6587;&#x548C;&#x4E0D;&#x5E26;context&#x4E24;&#x79CD;&#x6267;&#x884C;&#x65B9;&#x5F0F;&#x3002;</p>
<div><p class="code-filename">pkg/util/iptables/iptables.go:218</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">run</span><span class="token punctuation">(</span>op operation<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> runner<span class="token punctuation">.</span><span class="token function">runContext</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> op<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">runContext</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> op operation<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    iptablesCmd <span class="token operator">:=</span> <span class="token function">iptablesCommand</span><span class="token punctuation">(</span>runner<span class="token punctuation">.</span>protocol<span class="token punctuation">)</span>  <span class="token comment">// &quot;iptabels or ip6tables&quot;</span>
    fullArgs <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>runner<span class="token punctuation">.</span>waitFlag<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">)</span>
    fullArgs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>fullArgs<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
    klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;running iptables %s %v&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
  <span class="token comment">// &#x6839;&#x636E;&#x662F;&#x5426;&#x4F20;&#x6709;Context&#x4E0A;&#x4E0B;&#x6587;&#xFF0C;&#x8C03;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x6267;&#x884C;command/commandContext</span>
    <span class="token keyword">if</span> ctx <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> runner<span class="token punctuation">.</span>exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span>iptablesCmd<span class="token punctuation">,</span> fullArgs<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CombinedOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> runner<span class="token punctuation">.</span>exec<span class="token punctuation">.</span><span class="token function">CommandContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> iptablesCmd<span class="token punctuation">,</span> fullArgs<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CombinedOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//&#x652F;&#x6301;&#x7684;iptables&#x64CD;&#x4F5C;commands</span>
<span class="token keyword">type</span> operation <span class="token builtin">string</span>

<span class="token comment">//runner.exec&#x5B9E;&#x73B0;&#x662F;osexec&#x547D;&#x4EE4;&#x7684;&#x6267;&#x884C;</span>
<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Interface <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>executor<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Command is part of the Interface interface.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>executor <span class="token operator">*</span>executor<span class="token punctuation">)</span> <span class="token function">Command</span><span class="token punctuation">(</span>cmd <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> Cmd <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>cmdWrapper<span class="token punctuation">)</span><span class="token punctuation">(</span>osexec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// CommandContext is part of the Interface interface.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>executor <span class="token operator">*</span>executor<span class="token punctuation">)</span> <span class="token function">CommandContext</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> cmd <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> Cmd <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>cmdWrapper<span class="token punctuation">)</span><span class="token punctuation">(</span>osexec<span class="token punctuation">.</span><span class="token function">CommandContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>runner.GetVersion()</strong>  &#x83B7;&#x53D6;&#x7CFB;&#x7EDF;&#x5B89;&#x88C5;&#x7684;iptables&#x7248;&#x672C;&#x4FE1;&#x606F;&#xFF0C;&#x683C;&#x5F0F;&#x4E3A; &quot;X.Y.Z&quot;</p>
<div><p class="code-filename">pkg/util/iptables/iptables.go:218</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">GetVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getIPTablesVersionString</span><span class="token punctuation">(</span>runner<span class="token punctuation">.</span>exec<span class="token punctuation">,</span> runner<span class="token punctuation">.</span>protocol<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">getIPTablesVersionString</span><span class="token punctuation">(</span>exec utilexec<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> protocol Protocol<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x6267;&#x884C;&#x547D;&#x4EE4;&quot;iptables or ip6tables --version&quot;</span>
    iptablesCmd <span class="token operator">:=</span> <span class="token function">iptablesCommand</span><span class="token punctuation">(</span>protocol<span class="token punctuation">)</span>   
    bytes<span class="token punctuation">,</span> err <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span>iptablesCmd<span class="token punctuation">,</span> <span class="token string">&quot;--version&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CombinedOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
  <span class="token comment">// &#x6B63;&#x5219;&#x5339;&#x914D;&#xFF0C;&#x67E5;&#x627E;&#x7248;&#x672C;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x683C;&#x5F0F;&#x4E3A; &quot;X.Y.Z&quot;</span>
    versionMatcher <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">MustCompile</span><span class="token punctuation">(</span><span class="token string">&quot;v([0-9]+(\\.[0-9]+)+)&quot;</span><span class="token punctuation">)</span>
    match <span class="token operator">:=</span> versionMatcher<span class="token punctuation">.</span><span class="token function">FindStringSubmatch</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> match <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;no iptables version found in string: %s&quot;</span><span class="token punctuation">,</span> bytes<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>runner.EnsureChain()</strong> &quot;-N&quot;  &#x68C0;&#x6D4B;&#x6307;&#x5B9A;&#x7684;&#x89C4;&#x5219;&#x94FE;&#x662F;&#x5426;&#x5B58;&#x5728;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5B58;&#x5219;&#x521B;&#x5EFA;&#x6B64;&#x94FE;&#xFF0C;&#x5B58;&#x5728;&#x5219;&#x8FD4;&#x56DE;true </p>
<div><p class="code-filename">pkg/util/iptables/iptables.go:223</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">EnsureChain</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> chain Chain<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fullArgs <span class="token operator">:=</span> <span class="token function">makeFullArgs</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> chain<span class="token punctuation">)</span>

    runner<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> runner<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">//&#x6267;&#x884C;&quot;iptables -t $tableName -N $chainName&quot;</span>
    out<span class="token punctuation">,</span> err <span class="token operator">:=</span> runner<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>opCreateChain<span class="token punctuation">,</span> fullArgs<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> ee<span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span>utilexec<span class="token punctuation">.</span>ExitError<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
            <span class="token keyword">if</span> ee<span class="token punctuation">.</span><span class="token function">Exited</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ee<span class="token punctuation">.</span><span class="token function">ExitStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error creating chain %q: %v: %s&quot;</span><span class="token punctuation">,</span> chain<span class="token punctuation">,</span> err<span class="token punctuation">,</span> out<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>runner.FlushChain()</strong>  &quot;-F&quot; &#x6E05;&#x7A7A;&#x6307;&#x5B9A;&#x94FE;</p>
<div><p class="code-filename">pkg/util/iptables/iptables.go:242</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">FlushChain</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> chain Chain<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    fullArgs <span class="token operator">:=</span> <span class="token function">makeFullArgs</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> chain<span class="token punctuation">)</span>
  <span class="token comment">//...</span>
  <span class="token comment">//&#x6267;&#x884C;&quot;iptables -t $tableName -F $chainName&quot;</span>
    out<span class="token punctuation">,</span> err <span class="token operator">:=</span> runner<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>opFlushChain<span class="token punctuation">,</span> fullArgs<span class="token punctuation">)</span>
  <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>runner.DeleteChain()</strong>  &quot;-X&quot; &#x5220;&#x9664;&#x6307;&#x5B9A;&#x7684;&#x94FE;</p>
<div><p class="code-filename">pkg/util/iptables/iptables.go:256</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">DeleteChain</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> chain Chain<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    fullArgs <span class="token operator">:=</span> <span class="token function">makeFullArgs</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> chain<span class="token punctuation">)</span>
  <span class="token comment">//...</span>
  <span class="token comment">//&#x6267;&#x884C;&quot;iptables -t $tableName -X $chainName&quot;</span>
    out<span class="token punctuation">,</span> err <span class="token operator">:=</span> runner<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>opDeleteChain<span class="token punctuation">,</span> fullArgs<span class="token punctuation">)</span>
  <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>runner.EnsureRule()</strong> &#x68C0;&#x6D4B;&#x89C4;&#x5219;&#x662F;&#x5426;&#x5B58;&#x5728;&#xFF0C;&#x4E0D;&#x5B58;&#x5728;&#x5219;&#x6307;&#x5B9A;&#x7684;&quot;&#x8868;&#x5185;&#x94FE;&#x4E0A;&quot;, &#x6307;&#x5B9A;position&#x6DFB;&#x52A0;&#x89C4;&#x5219;</p>
<div><p class="code-filename">pkg/util/iptables/iptables.go:271</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">EnsureRule</span><span class="token punctuation">(</span>position RulePosition<span class="token punctuation">,</span> table Table<span class="token punctuation">,</span> chain Chain<span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fullArgs <span class="token operator">:=</span> <span class="token function">makeFullArgs</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>

    runner<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> runner<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// &#x68C0;&#x6D4B;&#x89C4;&#x5219;&#x662F;&#x5426;&#x5B58;&#x5728;</span>
    exists<span class="token punctuation">,</span> err <span class="token operator">:=</span> runner<span class="token punctuation">.</span><span class="token function">checkRule</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> exists <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
  <span class="token comment">// RulePosition &quot;-I&quot; &quot;-A&quot;</span>
  <span class="token comment">// &#x6307;&#x5B9A;&#x94FE;&#x5E8F;&#x63D2;&#x5165;&#x89C4;&#x5219;,&#x6267;&#x884C;&quot;iptables  -I $chainName -t $tableName ... &quot;</span>
  <span class="token comment">// &#x94FE;&#x672B;&#x6DFB;&#x52A0;&#x89C4;&#x5219;,&#x6267;&#x884C;&quot;iptables  -A $chainName -t $tableName ... &quot;    </span>
    out<span class="token punctuation">,</span> err <span class="token operator">:=</span> runner<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token function">operation</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">,</span> fullArgs<span class="token punctuation">)</span>  
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error appending rule: %v: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> out<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">//checkRule()&#x5148;&#x5224;&#x65AD;iptables&#x662F;&#x5426;&#x652F;&#x6301;&quot;-C&quot;flag,&#x8C03;&#x7528;&#x4E0D;&#x540C;&#x7248;&#x672C;&#x7684;&#x68C0;&#x6D4B;rule&#x7684;&#x65B9;&#x6CD5;</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">checkRule</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> chain Chain<span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> runner<span class="token punctuation">.</span>hasCheck <span class="token punctuation">{</span>
        <span class="token keyword">return</span> runner<span class="token punctuation">.</span><span class="token function">checkRuleUsingCheck</span><span class="token punctuation">(</span><span class="token function">makeFullArgs</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> runner<span class="token punctuation">.</span><span class="token function">checkRuleWithoutCheck</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//&#x652F;&#x6301;&quot;-C&quot;flag</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">checkRuleUsingCheck</span><span class="token punctuation">(</span>args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">//...</span>
  <span class="token comment">//&#x6267;&#x884C;&quot;iptables -wait -C $chainName -t $tableName ... &quot;</span>
    out<span class="token punctuation">,</span> err <span class="token operator">:=</span> runner<span class="token punctuation">.</span><span class="token function">runContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> opCheckRule<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
  <span class="token comment">//...</span>
<span class="token punctuation">}</span>

 <span class="token comment">//&#x4E0D;&#x652F;&#x6301;&quot;-C&quot;flag&#xFF0C;&#x4E3A;&#x4E86;&#x517C;&#x5BB9;iptables&#x7248;&#x672C;&lt;1.4.11 </span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">checkRuleWithoutCheck</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> chain Chain<span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// &apos;iptables-save -t $tableName&apos;</span>
    iptablesSaveCmd <span class="token operator">:=</span> <span class="token function">iptablesSaveCommand</span><span class="token punctuation">(</span>runner<span class="token punctuation">.</span>protocol<span class="token punctuation">)</span>
    klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;running %s -t %s&quot;</span><span class="token punctuation">,</span> iptablesSaveCmd<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">)</span>
    out<span class="token punctuation">,</span> err <span class="token operator">:=</span> runner<span class="token punctuation">.</span>exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span>iptablesSaveCmd<span class="token punctuation">,</span> <span class="token string">&quot;-t&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CombinedOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error checking rule: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//&#x79FB;&#x9664;&#x5F15;&#x53F7;</span>
    <span class="token keyword">var</span> argsCopy <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> args <span class="token punctuation">{</span>
        tmpField <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Trim</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;\&quot;&quot;</span><span class="token punctuation">)</span>
        tmpField <span class="token operator">=</span> <span class="token function">trimhex</span><span class="token punctuation">(</span>tmpField<span class="token punctuation">)</span>
        argsCopy <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>argsCopy<span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">Fields</span><span class="token punctuation">(</span>tmpField<span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    argset <span class="token operator">:=</span> sets<span class="token punctuation">.</span><span class="token function">NewString</span><span class="token punctuation">(</span>argsCopy<span class="token operator">...</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> line <span class="token operator">:=</span> <span class="token keyword">range</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> fields <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Fields</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>

        <span class="token comment">//&#x68C0;&#x6D4B;rule&#x7684;&#x94FE;&#x662F;&#x5426;&#x4E00;&#x81F4;</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;-A %s&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>chain<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">len</span><span class="token punctuation">(</span>argsCopy<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">2</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>

    <span class="token comment">// &#x79FB;&#x9664;&#x6240;&#x6709;&#x5F15;&#x53F7;</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> fields <span class="token punctuation">{</span>
            fields<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Trim</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;\&quot;&quot;</span><span class="token punctuation">)</span>
            fields<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">trimhex</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//&#x5B57;&#x7B26;&#x96C6;&#x5339;&#x914D;&#x67E5;&#x627E;&#x662F;&#x5426;&#x5B58;&#x5728;</span>
        <span class="token keyword">if</span> sets<span class="token punctuation">.</span><span class="token function">NewString</span><span class="token punctuation">(</span>fields<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsSuperset</span><span class="token punctuation">(</span>argset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;DBG: fields is not a superset of args: fields=%v  args=%v&quot;</span><span class="token punctuation">,</span> fields<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>runner.DeleteRule()</strong>  &quot;-D&quot; &#x6307;&#x5B9A;&#x7684;&quot;&#x8868;&#x4E2D;&#x94FE;&#x4E0A;&quot;&#x5220;&#x9664;&#x89C4;&#x5219;</p>
<div><p class="code-filename">pkg/util/iptables/iptables.go:292</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">DeleteRule</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> chain Chain<span class="token punctuation">,</span> args <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    fullArgs <span class="token operator">:=</span> <span class="token function">makeFullArgs</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
  <span class="token comment">//...</span>
  <span class="token comment">//&#x68C0;&#x6D4B;&#x89C4;&#x5219;&#x662F;&#x5426;&#x5B58;&#x5728;</span>
    exists<span class="token punctuation">,</span> err <span class="token operator">:=</span> runner<span class="token punctuation">.</span><span class="token function">checkRule</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
  <span class="token comment">//...</span>
  <span class="token comment">//&#x6267;&#x884C;&quot;iptables -D $chainName -t $tableName ...&quot;</span>
    out<span class="token punctuation">,</span> err <span class="token operator">:=</span> runner<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>opDeleteRule<span class="token punctuation">,</span> fullArgs<span class="token punctuation">)</span>
  <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>runner.SaveInto()</strong> &#x4FDD;&#x5B58;&#x6307;&#x5B9A;&#x8868;&#x7684;iptables&#x89C4;&#x5219;&#x96C6;&#xFF08;buffer&#x5185;&#xFF09;</p>
<div><p class="code-filename">pkg/util/iptables/iptables.go:317</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">SaveInto</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> buffer <span class="token operator">*</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  <span class="token comment">// &#x6267;&#x884C; &quot;iptables-save -t $tableName&quot;</span>
    iptablesSaveCmd <span class="token operator">:=</span> <span class="token function">iptablesSaveCommand</span><span class="token punctuation">(</span>runner<span class="token punctuation">.</span>protocol<span class="token punctuation">)</span>
    args <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;-t&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">}</span>

    cmd <span class="token operator">:=</span> runner<span class="token punctuation">.</span>exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span>iptablesSaveCmd<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>

    cmd<span class="token punctuation">.</span><span class="token function">SetStdout</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span>
    cmd<span class="token punctuation">.</span><span class="token function">SetStderr</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span>
    <span class="token keyword">return</span> cmd<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>runner.Restore()</strong> &#x88C5;&#x8F7D;&#x6307;&#x5B9A;&#x8868;&#x7531;<strong>iptables-save</strong>&#x4FDD;&#x5B58;&#x7684;&#x89C4;&#x5219;&#x96C6;(&#x4ECE;&#x6807;&#x51C6;&#x8F93;&#x5165;&#x63A5;&#x6536;&#x8F93;&#x5165;)</p>
<div><p class="code-filename">pkg/util/iptables/iptables.go:340</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">Restore</span><span class="token punctuation">(</span>table Table<span class="token punctuation">,</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> flush FlushFlag<span class="token punctuation">,</span> counters RestoreCountersFlag<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token comment">// &quot;iptables-restore -T $tableName&quot;</span>
    args <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;-T&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> runner<span class="token punctuation">.</span><span class="token function">restoreInternal</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> data<span class="token punctuation">,</span> flush<span class="token punctuation">,</span> counters<span class="token punctuation">)</span> <span class="token comment">//call and return</span>
<span class="token punctuation">}</span>

<span class="token comment">// restoreInternal()&#x53C2;&#x6570;&#x7EC4;&#x88C5;&#x548C;iptables-restore&#x547D;&#x4EE4;&#x6062;&#x590D;&#x89C4;&#x5219;&#x96C6;data</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">restoreInternal</span><span class="token punctuation">(</span>args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> flush FlushFlag<span class="token punctuation">,</span> counters RestoreCountersFlag<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    runner<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> runner<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    trace <span class="token operator">:=</span> utiltrace<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;iptables restore&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> trace<span class="token punctuation">.</span><span class="token function">LogIfLong</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>

  <span class="token comment">//&#x53C2;&#x6570;&#x7684;&#x7EC4;&#x88C5; &quot;--noflush&quot; &quot;--counters&quot; &quot;--wait&quot;</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>flush <span class="token punctuation">{</span>
        args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;--noflush&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> counters <span class="token punctuation">{</span>
        args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">&quot;--counters&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>runner<span class="token punctuation">.</span>restoreWaitFlag<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        locker<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">grabIptablesLocks</span><span class="token punctuation">(</span>runner<span class="token punctuation">.</span>lockfilePath<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        trace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">&quot;Locks grabbed&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span>locker iptablesLocker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> locker<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to close iptables locks: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span>locker<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


    fullArgs <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>runner<span class="token punctuation">.</span>restoreWaitFlag<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
    iptablesRestoreCmd <span class="token operator">:=</span> <span class="token function">iptablesRestoreCommand</span><span class="token punctuation">(</span>runner<span class="token punctuation">.</span>protocol<span class="token punctuation">)</span>
    klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;running %s %v&quot;</span><span class="token punctuation">,</span> iptablesRestoreCmd<span class="token punctuation">,</span> fullArgs<span class="token punctuation">)</span>

  <span class="token comment">// &quot;iptables-restore -T $tableName --wait --noflush --counters &lt; data&quot;</span>
    cmd <span class="token operator">:=</span> runner<span class="token punctuation">.</span>exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span>iptablesRestoreCmd<span class="token punctuation">,</span> fullArgs<span class="token operator">...</span><span class="token punctuation">)</span>
  <span class="token comment">//&#x4ECE;&#x6807;&#x51C6;&#x8F93;&#x5165;&#x63A5;&#x53D7;&#x8F93;&#x5165;&#x89C4;&#x5219;&#x96C6;data</span>
    cmd<span class="token punctuation">.</span><span class="token function">SetStdin</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">//command&#x5BF9;&#x8C61;&#x6267;&#x884C;&#x4E0E;&#x8F93;&#x51FA;&#x53CD;&#x9988;</span>
    b<span class="token punctuation">,</span> err <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">CombinedOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%v (%s)&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>runner.RestoreAll() </strong> &#x5982;&#x540C;&#x4E0A;Restore()&#xFF0C;&#x8C03;&#x7528;&#x547D;&#x4EE4;iptables-restore&#x88C5;&#x8F7D;&#x6240;&#x6709;&#x5907;&#x4EFD;&#x89C4;&#x5219;&#x96C6;</p>
<div><p class="code-filename">pkg/util/iptables/iptables.go:347</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">RestoreAll</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> flush FlushFlag<span class="token punctuation">,</span> counters RestoreCountersFlag<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    args <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token comment">//&#x540C;&#x4E0A;&#xFF0C;&#x65E0;&#x53C2;&#x6570;&#x9650;&#x5236;</span>
    <span class="token keyword">return</span> runner<span class="token punctuation">.</span><span class="token function">restoreInternal</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> data<span class="token punctuation">,</span> flush<span class="token punctuation">,</span> counters<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre>
<p><strong>runner.AddReloadFunc()  </strong>&#x6CE8;&#x518C;reload&#x56DE;&#x8C03;&#x51FD;&#x6570;&#xFF0C;&#x5B9E;&#x73B0;iptables reload&#x91CD;&#x65B0;&#x52A0;&#x8F7D;&#x89C4;&#x5219;</p>
<div><p class="code-filename">pkg/util/iptables/iptables.go:679</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">AddReloadFunc</span><span class="token punctuation">(</span>reloadFunc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    runner<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> runner<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//&#x662F;&#x5426;&#x5DF2;&#x542F;&#x52A8;&#x76D1;&#x542C;</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>runner<span class="token punctuation">.</span>hasListener <span class="token punctuation">{</span>
        runner<span class="token punctuation">.</span><span class="token function">connectToFirewallD</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//&#x542F;&#x52A8;D-bus&#x76D1;&#x542C;</span>
    <span class="token punctuation">}</span>
    runner<span class="token punctuation">.</span>reloadFuncs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>runner<span class="token punctuation">.</span>reloadFuncs<span class="token punctuation">,</span> reloadFunc<span class="token punctuation">)</span> <span class="token comment">//&#x6CE8;&#x518C;&#x4FE1;&#x53F7;&#x89E6;&#x53D1;&#x56DE;&#x8C03;func</span>
<span class="token punctuation">}</span>

<span class="token comment">//&#x901A;&#x8FC7;Linux&#x5185;&#x6838;D-bus&#x673A;&#x5236;&#x5B9E;&#x73B0;&#x5BF9;FirewallD&#x8FDB;&#x7A0B;&#x7684;&#x4FE1;&#x53F7;&#x76D1;&#x542C;&#x4E0E;&#x5904;&#x7406;&#xFF08;&#x5B9E;&#x73B0;reload iptables&#x89C4;&#x5219;&#xFF09;</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">connectToFirewallD</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bus<span class="token punctuation">,</span> err <span class="token operator">:=</span> runner<span class="token punctuation">.</span>dbus<span class="token punctuation">.</span><span class="token function">SystemBus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Could not connect to D-Bus system bus: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    runner<span class="token punctuation">.</span>hasListener <span class="token operator">=</span> <span class="token boolean">true</span>

  <span class="token comment">//SystemBus&#x5BF9;&#x8C61;&#x6DFB;&#x52A0;&#x5339;&#x914D;&#x89C4;&#x5219;&#x5B9A;&#x4E49;&#xFF08;firewalld&#xFF09;</span>
    rule <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;type=&apos;signal&apos;,sender=&apos;%s&apos;,path=&apos;%s&apos;,interface=&apos;%s&apos;,member=&apos;Reloaded&apos;&quot;</span><span class="token punctuation">,</span> firewalldName<span class="token punctuation">,</span> firewalldPath<span class="token punctuation">,</span> firewalldInterface<span class="token punctuation">)</span>
    bus<span class="token punctuation">.</span><span class="token function">BusObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">&quot;org.freedesktop.DBus.AddMatch&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> rule<span class="token punctuation">)</span>

    rule <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;type=&apos;signal&apos;,interface=&apos;org.freedesktop.DBus&apos;,member=&apos;NameOwnerChanged&apos;,path=&apos;/org/freedesktop/DBus&apos;,sender=&apos;org.freedesktop.DBus&apos;,arg0=&apos;%s&apos;&quot;</span><span class="token punctuation">,</span> firewalldName<span class="token punctuation">)</span>
    bus<span class="token punctuation">.</span><span class="token function">BusObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">&quot;org.freedesktop.DBus.AddMatch&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> rule<span class="token punctuation">)</span>

    runner<span class="token punctuation">.</span>signal <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>godbus<span class="token punctuation">.</span>Signal<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
    bus<span class="token punctuation">.</span><span class="token function">Signal</span><span class="token punctuation">(</span>runner<span class="token punctuation">.</span>signal<span class="token punctuation">)</span>

    <span class="token keyword">go</span> runner<span class="token punctuation">.</span><span class="token function">dbusSignalHandler</span><span class="token punctuation">(</span>bus<span class="token punctuation">)</span>  <span class="token comment">//D-Bus&#x4FE1;&#x53F7;&#x76D1;&#x542C;&#x5904;&#x7406;Handler</span>
<span class="token punctuation">}</span>

<span class="token comment">//goroutine&#x76D1;&#x542C;D-Bus&#x4FE1;&#x53F7;&#xFF0C;&#x76D1;&#x542C;FirewallD&#x53D1;&#x751F;&#x53D8;&#x5316;&#x548C;reload&#x4FE1;&#x53F7;&#x5219;reload&#x89C4;&#x5219;&#x96C6;</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">dbusSignalHandler</span><span class="token punctuation">(</span>bus utildbus<span class="token punctuation">.</span>Connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    firewalld <span class="token operator">:=</span> bus<span class="token punctuation">.</span><span class="token function">Object</span><span class="token punctuation">(</span>firewalldName<span class="token punctuation">,</span> firewalldPath<span class="token punctuation">)</span>

    <span class="token keyword">for</span> s <span class="token operator">:=</span> <span class="token keyword">range</span> runner<span class="token punctuation">.</span>signal <span class="token punctuation">{</span>
        <span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token comment">// &#x53CD;&#x6CE8;&#x518C;dbus</span>
            bus<span class="token punctuation">.</span><span class="token function">Signal</span><span class="token punctuation">(</span>runner<span class="token punctuation">.</span>signal<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">switch</span> s<span class="token punctuation">.</span>Name <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">&quot;org.freedesktop.DBus.NameOwnerChanged&quot;</span><span class="token punctuation">:</span>  <span class="token comment">//&#x4FE1;&#x53F7;&#xFF1A;&#x6307;&#x5B9A;&#x540D;&#x79F0;&#x7684;&#x62E5;&#x6709;&#x8005;&#x53D1;&#x751F;&#x4E86;&#x53D8;&#x5316;</span>
            name <span class="token operator">:=</span> s<span class="token punctuation">.</span>Body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
            new_owner <span class="token operator">:=</span> s<span class="token punctuation">.</span>Body<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>

      <span class="token comment">// &#x4FE1;&#x53F7;&#x540D;&#x79F0;&#x4E3A;&quot;org.fedoraproject.FirewallD1&quot;</span>
            <span class="token keyword">if</span> name <span class="token operator">!=</span> firewalldName <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>new_owner<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>

            firewalld<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>firewalldInterface<span class="token operator">+</span><span class="token string">&quot;.getDefaultZone&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

      runner<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//&#x91CD;&#x65B0;&#x52A0;&#x8F7D;&#x4E0E;&#x540C;&#x6B65;&#x89C4;&#x5219;(&#x904D;&#x5386;&#x8C03;&#x7528;runner.reloadFuncs())</span>
        <span class="token keyword">case</span> firewalldInterface <span class="token operator">+</span> <span class="token string">&quot;.Reloaded&quot;</span><span class="token punctuation">:</span>
            runner<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>runner.Destroy()</strong>  D-bus&#x76D1;&#x542C;&#x6CE8;&#x6D88;</p>
<div><p class="code-filename">pkg/util/iptables/iptables.go:218</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>runner <span class="token operator">*</span>runner<span class="token punctuation">)</span> <span class="token function">Destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> runner<span class="token punctuation">.</span>signal <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        runner<span class="token punctuation">.</span>signal <span class="token operator">&lt;-</span> <span class="token boolean">nil</span>            <span class="token comment">//D-Bug&#x4FE1;&#x53F7;channel&#x7F6E;&#x4E3A;&#x7A7A;&#x5B9E;&#x73B0;&#x53CD;&#x6CE8;&#x518C;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4E0A;&#x9762;&#x4E3A;kube-proxy&#x7B2C;&#x4E09;&#x5C42;&#x7684;iptables Proxier&#x4EE3;&#x7801;&#x5206;&#x6790;&#x6240;&#x6709;&#x5185;&#x5BB9;&#xFF0C;&#x5BF9;&#x4E8E;&#x53E6;&#x5916;&#x4E24;&#x79CD;&#x6A21;&#x5F0F;ipvs&#x3001;userspace&#x6A21;&#x5F0F;&#x7684;proxier&#x5B9E;&#x73B0;&#x4EE3;&#x7801;&#x5206;&#x6790;&#x53EF;&#x67E5;&#x8BE2;userspace-mode proxier&#x548C;ipvs-mode proxier&#x6587;&#x7AE0;&#x5185;&#x5BB9;&#x3002; </p>
<p><strong>~&#x672C;&#x6587; END~</strong> </p>
<footer class="page-footer"><span class="copyright">Copyright &#xA9; farmer.hutao@outlook.com 2019 all right reserved&#xFF0C;powered by Gitbook</span><span class="footer-modification">&#x8BE5;&#x6587;&#x4EF6;&#x4FEE;&#x8BA2;&#x65F6;&#x95F4;&#xFF1A;
2019-06-20 14:58:28
</span></footer><div id="anchors-navbar"><i class="fa fa-anchor"></i><ul><p><a href="#Iptables-mode_Proxier">Iptables-mode Proxier</a></p><li><a href="#&#x6982;&#x8FF0;">1. &#x6982;&#x8FF0;</a></li><li><a href="#Proxier_&#x6570;&#x636E;&#x7ED3;&#x6784;&#x4E0E;&#x7C7B;&#x5B9A;&#x4E49;">2. Proxier &#x6570;&#x636E;&#x7ED3;&#x6784;&#x4E0E;&#x7C7B;&#x5B9A;&#x4E49;</a></li><li><a href="#Proxier&#x5BF9;&#x8C61;&#x751F;&#x6210;&#x4E0E;&#x8FD0;&#x884C;">3. Proxier&#x5BF9;&#x8C61;&#x751F;&#x6210;&#x4E0E;&#x8FD0;&#x884C;</a></li><li><a href="#Proxier_&#x670D;&#x52A1;&#x4E0E;&#x7AEF;&#x70B9;&#x66F4;&#x65B0;_Tracker">4. Proxier &#x670D;&#x52A1;&#x4E0E;&#x7AEF;&#x70B9;&#x66F4;&#x65B0; Tracker</a></li><li><a href="#syncProxyRule_&#x540C;&#x6B65;&#x914D;&#x7F6E;&#x4E0E;&#x89C4;&#x5219;">5. syncProxyRule &#x540C;&#x6B65;&#x914D;&#x7F6E;&#x4E0E;&#x89C4;&#x5219;</a></li><ul><li><a href="#&#x66F4;&#x65B0;_service_&#x548C;_endpoints__&#x8FD4;&#x56DE;&#x66F4;&#x65B0;&#x7ED3;&#x679C;">5.1. &#x66F4;&#x65B0; service &#x548C; endpoints ;&#x8FD4;&#x56DE;&#x66F4;&#x65B0;&#x7ED3;&#x679C;</a></li><ul><li><a href="#UpdateServiceMap()_SVC_&#x670D;&#x52A1;&#x7684;&#x66F4;&#x65B0;&#x5B9E;&#x73B0;">5.1.1. UpdateServiceMap() SVC &#x670D;&#x52A1;&#x7684;&#x66F4;&#x65B0;&#x5B9E;&#x73B0;</a></li><li><a href="#UpdateEndpointsMap()_&#x7AEF;&#x70B9;&#x66F4;&#x65B0;&#x7684;&#x5B9E;&#x73B0;">5.1.2. UpdateEndpointsMap() &#x7AEF;&#x70B9;&#x66F4;&#x65B0;&#x7684;&#x5B9E;&#x73B0;</a></li></ul><li><a href="#&#x521B;&#x5EFA;&#x4E0E;&#x8054;&#x63A5;_kube_&#x94FE;">5.2. &#x521B;&#x5EFA;&#x4E0E;&#x8054;&#x63A5; kube &#x94FE;</a></li><li><a href="#&#x521B;&#x5EFA;_Iptables_&#x57FA;&#x7840;&#x6570;&#x636E;">5.3. &#x521B;&#x5EFA; Iptables &#x57FA;&#x7840;&#x6570;&#x636E;</a></li><li><a href="#&#x4E3A;&#x6BCF;&#x4E2A;_service_&#x521B;&#x5EFA;_rules">5.4. &#x4E3A;&#x6BCF;&#x4E2A; service &#x521B;&#x5EFA; rules</a></li><li><a href="#&#x914D;&#x7F6E;&#x6536;&#x5C3E;&#x89C4;&#x5219;&#x6570;&#x636E;">5.5. &#x914D;&#x7F6E;&#x6536;&#x5C3E;&#x89C4;&#x5219;&#x6570;&#x636E;</a></li><li><a href="#&#x6C47;&#x96C6;&#x4E0E;&#x52A0;&#x8F7D;_iptables_&#x914D;&#x7F6E;&#x89C4;&#x5219;&#x6570;&#x636E;">5.6. &#x6C47;&#x96C6;&#x4E0E;&#x52A0;&#x8F7D; iptables &#x914D;&#x7F6E;&#x89C4;&#x5219;&#x6570;&#x636E;</a></li></ul><li><a href="#IPtables_&#x5E95;&#x5C42;&#x7684;_runner_&#x5B9E;&#x73B0;">6. IPtables &#x5E95;&#x5C42;&#x7684; runner &#x5B9E;&#x73B0;</a></li><ul><li><a href="#iptables_&#x6267;&#x884C;&#x5668;">6.1. iptables &#x6267;&#x884C;&#x5668;</a></li><li><a href="#iptables_&#x6267;&#x884C;&#x5668;&#x65B9;&#x6CD5;">6.2. iptables &#x6267;&#x884C;&#x5668;&#x65B9;&#x6CD5;</a></li></ul></ul></div><a href="#&#x6982;&#x8FF0;" id="goTop"><i class="fa fa-arrow-up"></i></a>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="arch.html" class="navigation navigation-prev " aria-label="Previous page: Proxy 服务框架">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="ipvs.html" class="navigation navigation-next " aria-label="Next page: Ipvs-Mode Proxier">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Iptables-mode Proxier","level":"2.5.2","depth":2,"next":{"title":"Ipvs-Mode Proxier","level":"2.5.3","depth":2,"path":"core/kube-proxy/ipvs.md","ref":"core/kube-proxy/ipvs.md","articles":[]},"previous":{"title":"Proxy 服务框架","level":"2.5.1","depth":2,"path":"core/kube-proxy/arch.md","ref":"core/kube-proxy/arch.md","articles":[]},"dir":"ltr"},"config":{"plugins":["theme-comscore","codeblock-filename","navigator","simple-page-toc","expandable-chapters-small","search-pro","splitter","multipart","tbfed-pagefooter","prism","-highlight","editlink","github","github-buttons@2.1.0","donate","copy-code-button"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"Copyright &copy farmer.hutao@outlook.com 2019","modify_label":"该文件修订时间：","modify_format":"YYYY-MM-DD HH:mm:ss"},"prism":{},"github":{"url":"https://github.com/farmer-hutao/k8s-source-code-analysis"},"editlink":{"label":"编辑本页","multilingual":false,"base":"https://github.com/farmer-hutao/k8s-source-code-analysis/edit/master"},"simple-page-toc":{"maxDepth":4,"skipFirstH1":true},"splitter":{},"search-pro":{"cutWordLib":"nodejieba","defineWord":["Gitbook Use"]},"search":{},"multipart":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"donate":{"alipay":"","alipayText":"支付宝打赏","button":"鼓励作者","title":"催作者快快更新","wechat":"./image/wx.jpg","wechatText":"微信小额捐赠，鼓励作者尽快更新～"},"fontsettings":{"theme":"white","family":"sans","size":2},"codeblock-filename":{},"theme-comscore":{},"navigator":{},"github-buttons":{"repo":"farmer-hutao/k8s-source-code-analysis","types":["star"],"size":"small"},"expandable-chapters-small":{},"copy-code-button":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":true}},"theme":"default","author":"Tao Hu <farmer.hutao@outlook.com>","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"《k8s-1.13版本源码分析》","gitbook":"*","description":"k8s source code analysis"},"file":{"path":"core/kube-proxy/iptables.md","mtime":"2019-06-20T06:58:28.312Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-08-27T11:22:39.392Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-editlink/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-github-buttons/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-donate/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-theme-comscore/test.js"></script>
        
    

    </body>
</html>

