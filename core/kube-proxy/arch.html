
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Proxy 服务框架 · 《k8s-1.13版本源码分析》</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Tao Hu <farmer.hutao@outlook.com>">
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-codeblock-filename/block.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-navigator/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-multipart/multipart.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-tbfed-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-prism/prism.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-donate/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-theme-comscore/test.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="iptables.html" />
    
    
    <link rel="prev" href="./" />
    

    <style>
    @media only screen and (max-width: 640px) {
        .book-header .hidden-mobile {
            display: none;
        }
    }
    </style>
    <script>
        window["gitbook-plugin-github-buttons"] = {"repo":"farmer-hutao/k8s-source-code-analysis","types":["star"],"size":"small"};
    </script>

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Part I - 准备工作</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                        <b>1.1.</b>
                    
                    前言
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../../prepare/">
            
                <a href="../../prepare/">
            
                    
                        <b>1.2.</b>
                    
                    k8s源码分析准备工作
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../../prepare/get-code.html">
            
                <a href="../../prepare/get-code.html">
            
                    
                        <b>1.2.1.</b>
                    
                    源码准备
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../../prepare/debug-environment.html">
            
                <a href="../../prepare/debug-environment.html">
            
                    
                        <b>1.2.2.</b>
                    
                    测试环境搭建-单节点
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../../prepare/debug-environment-3node.html">
            
                <a href="../../prepare/debug-environment-3node.html">
            
                    
                        <b>1.2.3.</b>
                    
                    测试环境搭建-三节点
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../../prepare/debug.html">
            
                <a href="../../prepare/debug.html">
            
                    
                        <b>1.2.4.</b>
                    
                    源码调试
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Part II - 核心组件</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../">
            
                <a href="../">
            
                    
                        <b>2.1.</b>
                    
                    概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../scheduler/">
            
                <a href="../scheduler/">
            
                    
                        <b>2.2.</b>
                    
                    scheduler
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.2.1" data-path="../scheduler/design.html">
            
                <a href="../scheduler/design.html">
            
                    
                        <b>2.2.1.</b>
                    
                    调度器设计
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.2" data-path="../scheduler/before-scheduler-run.html">
            
                <a href="../scheduler/before-scheduler-run.html">
            
                    
                        <b>2.2.2.</b>
                    
                    调度程序启动前逻辑
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.3" data-path="../scheduler/scheduler-framework.html">
            
                <a href="../scheduler/scheduler-framework.html">
            
                    
                        <b>2.2.3.</b>
                    
                    调度器框架
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.4" data-path="../scheduler/generic-scheduler.html">
            
                <a href="../scheduler/generic-scheduler.html">
            
                    
                        <b>2.2.4.</b>
                    
                    一般调度过程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.5" data-path="../scheduler/predicate.html">
            
                <a href="../scheduler/predicate.html">
            
                    
                        <b>2.2.5.</b>
                    
                    预选过程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.6" data-path="../scheduler/priority.html">
            
                <a href="../scheduler/priority.html">
            
                    
                        <b>2.2.6.</b>
                    
                    优选过程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.7" data-path="../scheduler/preempt.html">
            
                <a href="../scheduler/preempt.html">
            
                    
                        <b>2.2.7.</b>
                    
                    抢占调度
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.8" data-path="../scheduler/init.html">
            
                <a href="../scheduler/init.html">
            
                    
                        <b>2.2.8.</b>
                    
                    调度器初始化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.9" data-path="../scheduler/affinity.html">
            
                <a href="../scheduler/affinity.html">
            
                    
                        <b>2.2.9.</b>
                    
                    专题-亲和性调度
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.10" data-path="../scheduler/summarize.html">
            
                <a href="../scheduler/summarize.html">
            
                    
                        <b>2.2.10.</b>
                    
                    scheduler 总结
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../controller-manager/">
            
                <a href="../controller-manager/">
            
                    
                        <b>2.3.</b>
                    
                    controller-manager
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.3.1" data-path="../controller-manager/controller.html">
            
                <a href="../controller-manager/controller.html">
            
                    
                        <b>2.3.1.</b>
                    
                    控制器概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.2" data-path="../controller-manager/custom-controller.html">
            
                <a href="../controller-manager/custom-controller.html">
            
                    
                        <b>2.3.2.</b>
                    
                    自定义控制器
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../apiserver/">
            
                <a href="../apiserver/">
            
                    
                        <b>2.4.</b>
                    
                    apiserver
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="./">
            
                <a href="./">
            
                    
                        <b>2.5.</b>
                    
                    kube-proxy
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="2.5.1" data-path="arch.html">
            
                <a href="arch.html">
            
                    
                        <b>2.5.1.</b>
                    
                    Proxy 服务框架
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5.2" data-path="iptables.html">
            
                <a href="iptables.html">
            
                    
                        <b>2.5.2.</b>
                    
                    Iptables-mode Proxier
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5.3" data-path="ipvs.html">
            
                <a href="ipvs.html">
            
                    
                        <b>2.5.3.</b>
                    
                    Ipvs-Mode Proxier
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5.4" data-path="userspace.html">
            
                <a href="userspace.html">
            
                    
                        <b>2.5.4.</b>
                    
                    Userspace-mode Proxier
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="../kubelet/">
            
                <a href="../kubelet/">
            
                    
                        <b>2.6.</b>
                    
                    kubelet
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Part III - 周边项目</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../../around/">
            
                <a href="../../around/">
            
                    
                        <b>3.1.</b>
                    
                    概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../../around/client-go/">
            
                <a href="../../around/client-go/">
            
                    
                        <b>3.2.</b>
                    
                    client-go
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.2.1" data-path="../../around/client-go/informer.html">
            
                <a href="../../around/client-go/informer.html">
            
                    
                        <b>3.2.1.</b>
                    
                    Informer (一)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.2" data-path="../../around/client-go/informer2.html">
            
                <a href="../../around/client-go/informer2.html">
            
                    
                        <b>3.2.2.</b>
                    
                    Informer(二)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Proxy 服务框架</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="Proxy_&#x670D;&#x52A1;&#x6846;&#x67B6;">Proxy &#x670D;&#x52A1;&#x6846;&#x67B6;</h1>
<!-- toc -->
<ul>
<li><a href="#%E7%A8%8B%E5%BA%8F%E5%85%A5%E5%8F%A3%E4%B8%8E%E5%88%9D%E5%A7%8B%E5%8C%96">&#x7A0B;&#x5E8F;&#x5165;&#x53E3;&#x4E0E;&#x521D;&#x59CB;&#x5316;</a></li>
<li><a href="#proxy-server%E5%88%9B%E5%BB%BA">Proxy Server&#x521B;&#x5EFA;</a></li>
<li><a href="#proxy-server%E8%BF%90%E8%A1%8C">Proxy Server&#x8FD0;&#x884C;</a></li>
<li><a href="#%E5%90%8C%E6%AD%A5%E8%A7%84%E5%88%99%E6%9C%BA%E5%88%B6informer">&#x540C;&#x6B65;&#x89C4;&#x5219;&#x673A;&#x5236;(Informer)</a></li>
</ul>
<!-- tocstop -->
<h2 id="&#x7A0B;&#x5E8F;&#x5165;&#x53E3;&#x4E0E;&#x521D;&#x59CB;&#x5316;">1. &#x7A0B;&#x5E8F;&#x5165;&#x53E3;&#x4E0E;&#x521D;&#x59CB;&#x5316;</h2>
<p>kube-proxy&#x4F7F;&#x7528;&#x901A;&#x7528;Cobra&#x6846;&#x67B6;&#x6784;&#x5EFA;&#x4E00;&#x4E2A;&#x6807;&#x51C6;&#x7684;CLI&#x5E94;&#x7528;.&#x540C;kubernets&#x57FA;&#x7840;&#x7EC4;&#x4EF6;(&#x5982;:scheduler)&#x4E00;&#x6837;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x521B;&#x5EFA;&#x5E94;&#x7528;&#x548C;&#x8FD0;&#x884C;&#x5E94;&#x7528;&#xFF0C;&#x56E0;&#x6B64;&#x5E94;&#x7528;command&#x6784;&#x5EFA;&#x5C42;&#x4E0D;&#x5C06;&#x5BF9;&#x5176;&#x6DF1;&#x5165;&#x5206;&#x6790;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x91CD;&#x5FC3;&#x805A;&#x7126;&#x5728;&#x540E;&#x9762;&#x7684;proxyserver&#x521B;&#x5EFA;&#x4E0E;proxyserver run&#x4EE3;&#x7801;&#x5206;&#x6790;&#x3002;</p>
<div><p class="code-filename">cmd/kube-proxy/proxy.go:35</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    command <span class="token operator">:=</span> app<span class="token punctuation">.</span><span class="token function">NewProxyCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//Cobra&#x547D;&#x4EE4;&#x98CE;&#x683C;&#x5E94;&#x7528;&#x5BF9;&#x8C61;&#x521B;&#x5EFA;</span>
  <span class="token comment">//......</span>

  <span class="token comment">//&#x5BF9;&#x524D;&#x9762;&#x5B9E;&#x4F8B;&#x5316;Command&#x5BF9;&#x8C61;&#x7684;&#x6267;&#x884C;</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> command<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">&quot;error: %v\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>NewProxyCommand()</strong>&#x8FD4;&#x56DE;&#x547D;&#x4EE4;command&#x5BF9;&#x8C61;,command.Execute()&#x5219;&#x8C03;&#x7528;&#x5B9A;&#x4E49;&#x7684;Run: func{},&#x6267;&#x884C;&#x5185;&#x90E8;&#x7684;opts.Run().</p>
<div><p class="code-filename">cmd/kube-proxy/app/server.go:370</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">NewProxyCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command <span class="token punctuation">{</span>
  <span class="token comment">// &#x521B;&#x5EFA;options&#x5BF9;&#x8C61;(&#x5168;&#x5C40;&#x7684;&#x5E94;&#x7528;&#x914D;&#x7F6E;&#x5BF9;&#x8C61;)</span>
    opts <span class="token operator">:=</span> <span class="token function">NewOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    cmd <span class="token operator">:=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>
        Use<span class="token punctuation">:</span> <span class="token string">&quot;kube-proxy&quot;</span><span class="token punctuation">,</span>
        Long<span class="token punctuation">:</span> <span class="token string">`The Kubernetes network proxy runs on each node...&#x7565;`</span><span class="token punctuation">,</span>
        Run<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//Command&#x5E94;&#x7528;RUN&#x547D;&#x4EE4;func&#x5B9A;&#x4E49;</span>
            verflag<span class="token punctuation">.</span><span class="token function">PrintAndExitIfRequested</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            utilflag<span class="token punctuation">.</span><span class="token function">PrintFlags</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">initForOS</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>WindowsService<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                klog<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;failed OS init: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
      <span class="token comment">// &#x5B8C;&#x6210;&#x6240;&#x6709;&#x9700;&#x6C42;&#x7684;options&#x914D;&#x7F6E;(&#x5916;&#x7F6E;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3001;&#x81EA;&#x5B9A;&#x4E49;&#x4E3B;&#x673A;&#x540D;&#x5904;&#x7406;&#x3001;&#x7279;&#x5F81;&#x529F;&#x80FD;&#x5F00;&#x5173;&#x8BBE;&#x7F6E;&#x7B49;)</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> opts<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                klog<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;failed complete: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
      <span class="token comment">// &#x6821;&#x9A8C;kube-proxy&#x914D;&#x7F6E;&#x7684;&#x6709;&#x6548;&#x6027;</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> opts<span class="token punctuation">.</span><span class="token function">Validate</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                klog<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;failed validate: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
      klog<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//&#x5E94;&#x7528;&#x771F;&#x6B63;&#x6267;&#x884C;Run(),&#x540E;&#x9762;&#x8FDB;&#x884C;&#x5206;&#x6790;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> err <span class="token builtin">error</span>
    opts<span class="token punctuation">.</span>config<span class="token punctuation">,</span> err <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">ApplyDefaults</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>config<span class="token punctuation">)</span>   <span class="token comment">//&#x5E94;&#x7528;&#x9ED8;&#x8BA4;&#x914D;&#x7F6E;&#xFF0C;&#x5B8C;&#x6210;&#x914D;&#x7F6E;&#x7684;&#x521D;&#x59CB;&#x5316;&#x5DE5;&#x4F5C;</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        klog<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to create flag defaults: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    opts<span class="token punctuation">.</span><span class="token function">AddFlags</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    cmd<span class="token punctuation">.</span><span class="token function">MarkFlagFilename</span><span class="token punctuation">(</span><span class="token string">&quot;config&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;yaml&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;yml&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;json&quot;</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> cmd  <span class="token comment">//&#x8FD4;&#x56DE;&#x547D;&#x4EE4;command&#x5BF9;&#x8C61;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>NewOptions() &#x5168;&#x5C40;&#x914D;&#x7F6E;&#x5BF9;&#x8C61;&#x521B;&#x5EFA;</p>
<div><p class="code-filename">cmd/kube-proxy/app/server.go:184</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">NewOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Options <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Options<span class="token punctuation">{</span>
        config<span class="token punctuation">:</span>      <span class="token function">new</span><span class="token punctuation">(</span>kubeproxyconfig<span class="token punctuation">.</span>KubeProxyConfiguration<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//&#x5B9E;&#x4F8B;&#x5316;&#x914D;&#x7F6E;config&#x5BF9;&#x8C61;</span>
        healthzPort<span class="token punctuation">:</span> ports<span class="token punctuation">.</span>ProxyHealthzPort<span class="token punctuation">,</span>                      <span class="token comment">//Healthz&#x7AEF;&#x53E3;</span>
        metricsPort<span class="token punctuation">:</span> ports<span class="token punctuation">.</span>ProxyStatusPort<span class="token punctuation">,</span>                       <span class="token comment">//metrics&#x7AEF;&#x53E3;</span>
        scheme<span class="token punctuation">:</span>      scheme<span class="token punctuation">.</span>Scheme<span class="token punctuation">,</span>
        codecs<span class="token punctuation">:</span>      scheme<span class="token punctuation">.</span>Codecs<span class="token punctuation">,</span>
        CleanupIPVS<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//&#x5B8C;&#x6574;&#x7684;&#x914D;&#x7F6E;&#x7ED3;&#x6784;&#x4F53;&#x4E0E;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x65F6;&#x7528;&#x6237;&#x4F20;&#x9012;&#x7684;&#x547D;&#x4EE4;&#x9009;&#x9879;&#x76F8;&#x5BF9;&#x5E94;</span>
<span class="token keyword">type</span> KubeProxyConfiguration <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    metav1<span class="token punctuation">.</span>TypeMeta
    FeatureGates <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">bool</span>              <span class="token comment">//&#x529F;&#x80FD;&#x7279;&#x5F81;&#x6A21;&#x5757;&#x5F00;&#x5173;</span>
    BindAddress <span class="token builtin">string</span>                        <span class="token comment">//&#x9ED8;&#x8BA4;&#x6240;&#x6709;&#x63A5;&#x53E3;0.0.0.0 </span>
    HealthzBindAddress <span class="token builtin">string</span>                 <span class="token comment">//&#x9ED8;&#x8BA4;0.0.0.0:10256</span>
    MetricsBindAddress <span class="token builtin">string</span>                 <span class="token comment">//&#x9ED8;&#x8BA4;127.0.0.1:10249</span>
    EnableProfiling <span class="token builtin">bool</span>                      <span class="token comment">//&quot;/debug/pprof&quot;</span>
    ClusterCIDR <span class="token builtin">string</span>                        <span class="token comment">//ClusterCIDR</span>
    HostnameOverride <span class="token builtin">string</span>                   <span class="token comment">//&#x81EA;&#x5B9A;&#x4E49;Hostname</span>
    ClientConnection apimachineryconfig<span class="token punctuation">.</span>ClientConnectionConfiguration  <span class="token comment">//apiserver client</span>
  IPTables KubeProxyIPTablesConfiguration   <span class="token comment">//IPTABLES&#x914D;&#x7F6E;&#x9879;(&#x5730;&#x5740;&#x4F2A;&#x88C5;&#x3001;&#x540C;&#x6B65;&#x5468;&#x671F;&#x7B49;)</span>
  IPVS KubeProxyIPVSConfiguration           <span class="token comment">//IPVS&#x914D;&#x7F6E;&#x9879;(&#x540C;&#x6B65;&#x5468;&#x671F;&#x3001;&#x8C03;&#x5EA6;&#x5668;&#x7B49;)</span>
    OOMScoreAdj <span class="token operator">*</span><span class="token builtin">int32</span>                        <span class="token comment">//&#x4FEE;&#x6539;OOMScoreAdj&#x5206;&#x503C;</span>
    Mode ProxyMode                            <span class="token comment">//proxy&#x6A21;&#x5F0F;</span>
    PortRange <span class="token builtin">string</span>                          <span class="token comment">//&#x7AEF;&#x53E3;range</span>
    ResourceContainer <span class="token builtin">string</span>                  <span class="token comment">//&quot;Default: /kube-proxy&quot;</span>
    UDPIdleTimeout metav1<span class="token punctuation">.</span>Duration            <span class="token comment">//UDP&#x7A7A;&#x95F2;&#x8D85;&#x65F6;</span>
    Conntrack KubeProxyConntrackConfiguration <span class="token comment">//Conntrack&#x5BF9;&#x8C61;</span>
    ConfigSyncPeriod metav1<span class="token punctuation">.</span>Duration          <span class="token comment">//&#x540C;&#x6B65;&#x5468;&#x671F;</span>
    NodePortAddresses <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>                <span class="token comment">//Node&#x5730;&#x5740;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
    ProxyHealthzPort <span class="token operator">=</span> <span class="token number">10256</span>
  ProxyStatusPort <span class="token operator">=</span> <span class="token number">10249</span>
<span class="token punctuation">)</span>
</code></pre>
<p><strong>opts.Run()</strong> &#x521B;&#x5EFA;proxy&#x670D;&#x52A1;&#x5E76;&#x542F;&#x52A8;</p>
<div><p class="code-filename">cmd/kube-proxy/app/server.go:250</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Options<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>WriteConfigTo<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> o<span class="token punctuation">.</span><span class="token function">writeConfigFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>           <span class="token comment">//&#x5199;&#x914D;&#x7F6E;&#x6587;&#x4EF6;</span>
    <span class="token punctuation">}</span>

    proxyServer<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">NewProxyServer</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>  <span class="token comment">//&#x57FA;&#x4E8E;&#x914D;&#x7F6E;&#x521B;&#x5EFA;proxy&#x670D;&#x52A1;</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> proxyServer<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>              <span class="token comment">//&#x8FD0;&#x884C;proxy&#x670D;&#x52A1;&#xFF0C;&#x540E;&#x7EED;&#x8BE6;&#x7EC6;&#x5206;&#x6790;proxyserver&#x6267;&#x884C;&#x4EE3;&#x7801;&#x903B;&#x8F91;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x4E0A;&#x9762;&#x5DF2;&#x5B8C;&#x6210;&#x5BF9;<strong>kube-proxy&#x7B2C;&#x4E00;&#x5C42;</strong>(CLI&#x521B;&#x5EFA;&#x3001;&#x914D;&#x7F6E;&#x9879;&#x521D;&#x59CB;&#x5316;&#x3001;&#x542F;&#x52A8;)&#x5206;&#x6790;,&#x4E0B;&#x9762;&#x8FDB;&#x5165;proxy Server&#x521B;&#x5EFA;&#x4E0E;&#x542F;&#x52A8;&#x8FD0;&#x884C;&#x4EE3;&#x7801;&#x5206;&#x6790;( kube-proxy&#x7B2C;&#x4E8C;&#x5C42; )&#x3002;</p>
<h2 id="Proxy_Server&#x521B;&#x5EFA;">2. Proxy Server&#x521B;&#x5EFA;</h2>
<p><strong>NewProxyServer()</strong> <em>&#x975E;windows&#x7248;&#x672C;&#x4EE3;&#x7801;</em> </p>
<div><p class="code-filename">cmd/kube-proxy/app/server_others.go:55</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">NewProxyServer</span><span class="token punctuation">(</span>o <span class="token operator">*</span>Options<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>ProxyServer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">newProxyServer</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>config<span class="token punctuation">,</span> o<span class="token punctuation">.</span>CleanupAndExit<span class="token punctuation">,</span> o<span class="token punctuation">.</span>CleanupIPVS<span class="token punctuation">,</span> o<span class="token punctuation">.</span>scheme<span class="token punctuation">,</span> o<span class="token punctuation">.</span>master<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">newProxyServer</span><span class="token punctuation">(</span>
    config <span class="token operator">*</span>proxyconfigapi<span class="token punctuation">.</span>KubeProxyConfiguration<span class="token punctuation">,</span>
    cleanupAndExit <span class="token builtin">bool</span><span class="token punctuation">,</span>
    cleanupIPVS <span class="token builtin">bool</span><span class="token punctuation">,</span>
    scheme <span class="token operator">*</span>runtime<span class="token punctuation">.</span>Scheme<span class="token punctuation">,</span>
    master <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>ProxyServer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> config <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;config is required&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> c<span class="token punctuation">,</span> err <span class="token operator">:=</span> configz<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>proxyconfigapi<span class="token punctuation">.</span>GroupName<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to register configz: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

  <span class="token comment">//&#x534F;&#x8BAE;IPV4 or IPV6</span>
    protocol <span class="token operator">:=</span> utiliptables<span class="token punctuation">.</span>ProtocolIpv4
    <span class="token keyword">if</span> net<span class="token punctuation">.</span><span class="token function">ParseIP</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>BindAddress<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">To4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;IPv6 bind address (%s), assume IPv6 operation&quot;</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>BindAddress<span class="token punctuation">)</span>
        protocol <span class="token operator">=</span> utiliptables<span class="token punctuation">.</span>ProtocolIpv6
    <span class="token punctuation">}</span>

  <span class="token comment">// &#x5173;&#x952E;&#x4F9D;&#x8D56;&#x5DE5;&#x5177;&#x5B9E;&#x73B0;&#x7684;api&#x63A5;&#x53E3;iptables/ipvs/ipset/dbus</span>
  <span class="token comment">// &#x4ECE;&#x6B64;&#x5904;&#x5219;&#x53EF;&#x4EE5;&#x770B;&#x51FA;kube-proxy&#x5E95;&#x5C42;&#x6280;&#x672F;&#x7684;&#x4F9D;&#x8D56;&#xFF08;&#x5F53;&#x7136;&#x4E0D;&#x540C;&#x7684;proxy-mode&#xFF0C;&#x5B9E;&#x73B0;&#x6280;&#x672F;&#x4E5F;&#x4E0D;&#x4E00;&#x6837; &#xFF09;</span>
    <span class="token keyword">var</span> iptInterface utiliptables<span class="token punctuation">.</span>Interface
    <span class="token keyword">var</span> ipvsInterface utilipvs<span class="token punctuation">.</span>Interface
    <span class="token keyword">var</span> kernelHandler ipvs<span class="token punctuation">.</span>KernelHandler
    <span class="token keyword">var</span> ipsetInterface utilipset<span class="token punctuation">.</span>Interface
    <span class="token keyword">var</span> dbus utildbus<span class="token punctuation">.</span>Interface


  <span class="token comment">// exec&#x547D;&#x4EE4;&#x6267;&#x884C;&#x5668;&#x5BF9;&#x8C61;&#x521B;&#x5EFA;</span>
    execer <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// dbus&#x5BF9;&#x8C61;&#x521B;&#x5EFA;&#xFF08;linux&#x5B9E;&#x73B0;&#x8FDB;&#x7A0B;&#x95F4;&#x901A;&#x4FE1;&#x673A;&#x5236;&#xFF09;</span>
    dbus <span class="token operator">=</span> utildbus<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// iptables&#x64CD;&#x4F5C;&#x5BF9;&#x8C61;&#x521B;&#x5EFA;</span>
    iptInterface <span class="token operator">=</span> utiliptables<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>execer<span class="token punctuation">,</span> dbus<span class="token punctuation">,</span> protocol<span class="token punctuation">)</span>
  <span class="token comment">// IPVS</span>
    kernelHandler <span class="token operator">=</span> ipvs<span class="token punctuation">.</span><span class="token function">NewLinuxKernelHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// ipset</span>
    ipsetInterface <span class="token operator">=</span> utilipset<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>execer<span class="token punctuation">)</span>
  <span class="token comment">// IPVS&#x73AF;&#x5883;&#x68C0;&#x6D4B;</span>
    canUseIPVS<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ipvs<span class="token punctuation">.</span><span class="token function">CanUseIPVSProxier</span><span class="token punctuation">(</span>kernelHandler<span class="token punctuation">,</span> ipsetInterface<span class="token punctuation">)</span>
    <span class="token keyword">if</span> canUseIPVS <span class="token punctuation">{</span>
        ipvsInterface <span class="token operator">=</span> utilipvs<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>execer<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// We omit creation of pretty much everything if we run in cleanup mode</span>
    <span class="token keyword">if</span> cleanupAndExit <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>ProxyServer<span class="token punctuation">{</span>
            execer<span class="token punctuation">:</span>         execer<span class="token punctuation">,</span>
            IptInterface<span class="token punctuation">:</span>   iptInterface<span class="token punctuation">,</span>
            IpvsInterface<span class="token punctuation">:</span>  ipvsInterface<span class="token punctuation">,</span>
            IpsetInterface<span class="token punctuation">:</span> ipsetInterface<span class="token punctuation">,</span>
            CleanupAndExit<span class="token punctuation">:</span> cleanupAndExit<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

  <span class="token comment">//api client</span>
    client<span class="token punctuation">,</span> eventClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">createClients</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ClientConnection<span class="token punctuation">,</span> master<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token comment">//&#x4E3B;&#x673A;&#x540D;</span>
    hostname<span class="token punctuation">,</span> err <span class="token operator">:=</span> utilnode<span class="token punctuation">.</span><span class="token function">GetHostname</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>HostnameOverride<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
  <span class="token comment">// &#x4E8B;&#x4EF6;&#x5E7F;&#x64AD;&#x5668;</span>
    eventBroadcaster <span class="token operator">:=</span> record<span class="token punctuation">.</span><span class="token function">NewBroadcaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// Create event recorder</span>
    recorder <span class="token operator">:=</span> eventBroadcaster<span class="token punctuation">.</span><span class="token function">NewRecorder</span><span class="token punctuation">(</span>scheme<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>EventSource<span class="token punctuation">{</span>Component<span class="token punctuation">:</span> <span class="token string">&quot;kube-proxy&quot;</span><span class="token punctuation">,</span> Host<span class="token punctuation">:</span> hostname<span class="token punctuation">}</span><span class="token punctuation">)</span>

    nodeRef <span class="token operator">:=</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">.</span>ObjectReference<span class="token punctuation">{</span>
        Kind<span class="token punctuation">:</span>      <span class="token string">&quot;Node&quot;</span><span class="token punctuation">,</span>
        Name<span class="token punctuation">:</span>      hostname<span class="token punctuation">,</span>
        UID<span class="token punctuation">:</span>       types<span class="token punctuation">.</span><span class="token function">UID</span><span class="token punctuation">(</span>hostname<span class="token punctuation">)</span><span class="token punctuation">,</span>
        Namespace<span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> healthzServer <span class="token operator">*</span>healthcheck<span class="token punctuation">.</span>HealthzServer
    <span class="token keyword">var</span> healthzUpdater healthcheck<span class="token punctuation">.</span>HealthzUpdater

  <span class="token comment">//&#x521B;&#x5EFA;&#x9ED8;&#x8BA4;&#x7684;healthzServer&#x670D;&#x52A1;&#x5BF9;&#x8C61;</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>HealthzBindAddress<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        healthzServer <span class="token operator">=</span> healthcheck<span class="token punctuation">.</span><span class="token function">NewDefaultHealthzServer</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>HealthzBindAddress<span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>config<span class="token punctuation">.</span>IPTables<span class="token punctuation">.</span>SyncPeriod<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> recorder<span class="token punctuation">,</span> nodeRef<span class="token punctuation">)</span>
        healthzUpdater <span class="token operator">=</span> healthzServer
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> proxier proxy<span class="token punctuation">.</span>ProxyProvider
    <span class="token keyword">var</span> serviceEventHandler proxyconfig<span class="token punctuation">.</span>ServiceHandler
    <span class="token keyword">var</span> endpointsEventHandler proxyconfig<span class="token punctuation">.</span>EndpointsHandler

  <span class="token comment">// proxyMode&#x6A21;&#x5F0F;&#x914D;&#x7F6E;&#x83B7;&#x53D6;</span>
    proxyMode <span class="token operator">:=</span> <span class="token function">getProxyMode</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Mode<span class="token punctuation">)</span><span class="token punctuation">,</span> iptInterface<span class="token punctuation">,</span> kernelHandler<span class="token punctuation">,</span> ipsetInterface<span class="token punctuation">,</span> iptables<span class="token punctuation">.</span>LinuxKernelCompatTester<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// &#x8282;&#x70B9;&#x7ED1;&#x5B9A;IP</span>
    nodeIP <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">ParseIP</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>BindAddress<span class="token punctuation">)</span>
    <span class="token keyword">if</span> nodeIP<span class="token punctuation">.</span><span class="token function">IsUnspecified</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nodeIP <span class="token operator">=</span> utilnode<span class="token punctuation">.</span><span class="token function">GetNodeIP</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> hostname<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> proxyMode <span class="token operator">==</span> proxyModeIPTables <span class="token punctuation">{</span>                   <span class="token comment">// proxyMode&#x4E3A;&quot;IPTables&quot;</span>
        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Using iptables Proxier.&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> config<span class="token punctuation">.</span>IPTables<span class="token punctuation">.</span>MasqueradeBit <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token comment">// MasqueradeBit must be specified or defaulted.</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to read IPTables MasqueradeBit from config&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//&#x521B;&#x5EFA;iptables proxier&#x5BF9;&#x8C61;</span>
        proxierIPTables<span class="token punctuation">,</span> err <span class="token operator">:=</span> iptables<span class="token punctuation">.</span><span class="token function">NewProxier</span><span class="token punctuation">(</span>
            iptInterface<span class="token punctuation">,</span>
            utilsysctl<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            execer<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>IPTables<span class="token punctuation">.</span>SyncPeriod<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>IPTables<span class="token punctuation">.</span>MinSyncPeriod<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>IPTables<span class="token punctuation">.</span>MasqueradeAll<span class="token punctuation">,</span>
            <span class="token function">int</span><span class="token punctuation">(</span><span class="token operator">*</span>config<span class="token punctuation">.</span>IPTables<span class="token punctuation">.</span>MasqueradeBit<span class="token punctuation">)</span><span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>ClusterCIDR<span class="token punctuation">,</span>
            hostname<span class="token punctuation">,</span>
            nodeIP<span class="token punctuation">,</span>
            recorder<span class="token punctuation">,</span>
            healthzUpdater<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>NodePortAddresses<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to create proxier: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        metrics<span class="token punctuation">.</span><span class="token function">RegisterMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//iptables proxier&#x5BF9;&#x8C61;&#x548C;&#x4E8B;&#x4EF6;&#x5904;&#x7406;</span>
        proxier <span class="token operator">=</span> proxierIPTables               
        serviceEventHandler <span class="token operator">=</span> proxierIPTables
        endpointsEventHandler <span class="token operator">=</span> proxierIPTables
        <span class="token comment">// No turning back. Remove artifacts that might still exist from the userspace Proxier.</span>
        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Tearing down inactive rules.&quot;</span><span class="token punctuation">)</span>
        <span class="token comment">//&#x6A21;&#x5F0F;&#x8F6C;&#x6362;&#x6E05;&#x7406;userspace/ipvs&#x6A21;&#x5F0F;&#x6240;&#x521B;&#x5EFA;iptables&#x89C4;&#x5219;</span>
        userspace<span class="token punctuation">.</span><span class="token function">CleanupLeftovers</span><span class="token punctuation">(</span>iptInterface<span class="token punctuation">)</span>
        <span class="token keyword">if</span> canUseIPVS <span class="token punctuation">{</span>
            ipvs<span class="token punctuation">.</span><span class="token function">CleanupLeftovers</span><span class="token punctuation">(</span>ipvsInterface<span class="token punctuation">,</span> iptInterface<span class="token punctuation">,</span> ipsetInterface<span class="token punctuation">,</span> cleanupIPVS<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> proxyMode <span class="token operator">==</span> proxyModeIPVS <span class="token punctuation">{</span>                  <span class="token comment">// proxyMode&#x4E3A;&quot;IPVS&quot;</span>
        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Using ipvs Proxier.&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//ipvs proxier&#x5BF9;&#x8C61;&#x521B;&#x5EFA;</span>
        proxierIPVS<span class="token punctuation">,</span> err <span class="token operator">:=</span> ipvs<span class="token punctuation">.</span><span class="token function">NewProxier</span><span class="token punctuation">(</span>
            iptInterface<span class="token punctuation">,</span>
            ipvsInterface<span class="token punctuation">,</span>
            ipsetInterface<span class="token punctuation">,</span>
            utilsysctl<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            execer<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>IPVS<span class="token punctuation">.</span>SyncPeriod<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>IPVS<span class="token punctuation">.</span>MinSyncPeriod<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>IPVS<span class="token punctuation">.</span>ExcludeCIDRs<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>IPTables<span class="token punctuation">.</span>MasqueradeAll<span class="token punctuation">,</span>
            <span class="token function">int</span><span class="token punctuation">(</span><span class="token operator">*</span>config<span class="token punctuation">.</span>IPTables<span class="token punctuation">.</span>MasqueradeBit<span class="token punctuation">)</span><span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>ClusterCIDR<span class="token punctuation">,</span>
            hostname<span class="token punctuation">,</span>
            nodeIP<span class="token punctuation">,</span>
            recorder<span class="token punctuation">,</span>
            healthzServer<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>IPVS<span class="token punctuation">.</span>Scheduler<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>NodePortAddresses<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to create proxier: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        metrics<span class="token punctuation">.</span><span class="token function">RegisterMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//ipvs proxier&#x5BF9;&#x8C61;&#x548C;&#x4E8B;&#x4EF6;&#x5904;&#x7406;</span>
        proxier <span class="token operator">=</span> proxierIPVS
        serviceEventHandler <span class="token operator">=</span> proxierIPVS
        endpointsEventHandler <span class="token operator">=</span> proxierIPVS
        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Tearing down inactive rules.&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//&#x6A21;&#x5F0F;&#x8F6C;&#x6362;&#x6E05;&#x7406;userspace/iptables&#x6A21;&#x5F0F;&#x89C4;&#x5219;</span>
        userspace<span class="token punctuation">.</span><span class="token function">CleanupLeftovers</span><span class="token punctuation">(</span>iptInterface<span class="token punctuation">)</span>
        iptables<span class="token punctuation">.</span><span class="token function">CleanupLeftovers</span><span class="token punctuation">(</span>iptInterface<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                                              <span class="token comment">// proxyMode&#x4E3A;&quot;userspace&quot;</span>
        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Using userspace Proxier.&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//&#x521B;&#x5EFA;RR&#x6A21;&#x5F0F;&#x8D1F;&#x8F7D;&#x5747;&#x8861;</span>
        loadBalancer <span class="token operator">:=</span> userspace<span class="token punctuation">.</span><span class="token function">NewLoadBalancerRR</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//&#x8BBE;&#x7F6E;EndpointsConfigHandler(endpoints&#x4E8B;&#x4EF6;&#x5904;&#x7406;)</span>
        endpointsEventHandler <span class="token operator">=</span> loadBalancer
    <span class="token comment">//&#x521B;&#x5EFA;userspace proxier&#x5BF9;&#x8C61;</span>
        proxierUserspace<span class="token punctuation">,</span> err <span class="token operator">:=</span> userspace<span class="token punctuation">.</span><span class="token function">NewProxier</span><span class="token punctuation">(</span>
            loadBalancer<span class="token punctuation">,</span>
            net<span class="token punctuation">.</span><span class="token function">ParseIP</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>BindAddress<span class="token punctuation">)</span><span class="token punctuation">,</span>
            iptInterface<span class="token punctuation">,</span>
            execer<span class="token punctuation">,</span>
            <span class="token operator">*</span>utilnet<span class="token punctuation">.</span><span class="token function">ParsePortRangeOrDie</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>PortRange<span class="token punctuation">)</span><span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>IPTables<span class="token punctuation">.</span>SyncPeriod<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>IPTables<span class="token punctuation">.</span>MinSyncPeriod<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>UDPIdleTimeout<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>NodePortAddresses<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to create proxier: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token comment">//userspace proxier&#x5BF9;&#x8C61;&#x548C;service&#x4E8B;&#x4EF6;&#x5904;&#x7406;</span>
        serviceEventHandler <span class="token operator">=</span> proxierUserspace
        proxier <span class="token operator">=</span> proxierUserspace

        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Tearing down inactive rules.&quot;</span><span class="token punctuation">)</span>
        <span class="token comment">//&#x6A21;&#x5F0F;&#x8F6C;&#x6362;&#x6E05;&#x7406;iptables/ipvs&#x6A21;&#x5F0F;&#x6240;&#x521B;&#x5EFA;iptables&#x89C4;&#x5219;</span>
        iptables<span class="token punctuation">.</span><span class="token function">CleanupLeftovers</span><span class="token punctuation">(</span>iptInterface<span class="token punctuation">)</span>
        <span class="token keyword">if</span> canUseIPVS <span class="token punctuation">{</span>
            ipvs<span class="token punctuation">.</span><span class="token function">CleanupLeftovers</span><span class="token punctuation">(</span>ipvsInterface<span class="token punctuation">,</span> iptInterface<span class="token punctuation">,</span> ipsetInterface<span class="token punctuation">,</span> cleanupIPVS<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  <span class="token comment">//&#x6CE8;&#x518C;reloadfunc&#x4E3A;proxier&#x7684;sync()&#x540C;&#x6B65;&#x65B9;&#x6CD5;</span>
    iptInterface<span class="token punctuation">.</span><span class="token function">AddReloadFunc</span><span class="token punctuation">(</span>proxier<span class="token punctuation">.</span>Sync<span class="token punctuation">)</span>

  <span class="token comment">// &#x6784;&#x5EFA;ProxyServer&#x5BF9;&#x8C61;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>ProxyServer<span class="token punctuation">{</span>
        Client<span class="token punctuation">:</span>                 client<span class="token punctuation">,</span>                  <span class="token comment">//apiServer client</span>
        EventClient<span class="token punctuation">:</span>            eventClient<span class="token punctuation">,</span>             <span class="token comment">//&#x4E8B;&#x4EF6;client</span>
        IptInterface<span class="token punctuation">:</span>           iptInterface<span class="token punctuation">,</span>            <span class="token comment">//iptables&#x63A5;&#x53E3;</span>
        IpvsInterface<span class="token punctuation">:</span>          ipvsInterface<span class="token punctuation">,</span>           <span class="token comment">//ipvs&#x63A5;&#x53E3;</span>
        IpsetInterface<span class="token punctuation">:</span>         ipsetInterface<span class="token punctuation">,</span>          <span class="token comment">//ipset&#x63A5;&#x53E3;</span>
        execer<span class="token punctuation">:</span>                 execer<span class="token punctuation">,</span>                  <span class="token comment">//exec&#x547D;&#x4EE4;&#x6267;&#x884C;&#x5668;   </span>
        Proxier<span class="token punctuation">:</span>                proxier<span class="token punctuation">,</span>                 <span class="token comment">//proxier&#x521B;&#x5EFA;&#x5BF9;&#x8C61;</span>
        Broadcaster<span class="token punctuation">:</span>            eventBroadcaster<span class="token punctuation">,</span>        <span class="token comment">//&#x4E8B;&#x4EF6;&#x5E7F;&#x64AD;&#x5668;</span>
        Recorder<span class="token punctuation">:</span>               recorder<span class="token punctuation">,</span>                <span class="token comment">//&#x4E8B;&#x4EF6;&#x8BB0;&#x5F55;&#x5668;</span>
        ConntrackConfiguration<span class="token punctuation">:</span> config<span class="token punctuation">.</span>Conntrack<span class="token punctuation">,</span>        <span class="token comment">//Conntrack&#x914D;&#x7F6E;</span>
        Conntracker<span class="token punctuation">:</span>            <span class="token operator">&amp;</span>realConntracker<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token comment">//Conntrack&#x5BF9;&#x8C61;</span>
        ProxyMode<span class="token punctuation">:</span>              proxyMode<span class="token punctuation">,</span>               <span class="token comment">//proxy&#x6A21;&#x5F0F;</span>
        NodeRef<span class="token punctuation">:</span>                nodeRef<span class="token punctuation">,</span>                 <span class="token comment">//node&#x8282;&#x70B9;reference&#x4FE1;&#x606F;</span>
        MetricsBindAddress<span class="token punctuation">:</span>     config<span class="token punctuation">.</span>MetricsBindAddress<span class="token punctuation">,</span>        <span class="token comment">//metric&#x670D;&#x52A1;&#x5730;&#x5740;&#x914D;&#x7F6E;</span>
        EnableProfiling<span class="token punctuation">:</span>        config<span class="token punctuation">.</span>EnableProfiling<span class="token punctuation">,</span>           <span class="token comment">//debug/pprof&#x914D;&#x7F6E;</span>
        OOMScoreAdj<span class="token punctuation">:</span>            config<span class="token punctuation">.</span>OOMScoreAdj<span class="token punctuation">,</span>               <span class="token comment">//OOMScoreAdj&#x503C;&#x914D;&#x7F6E;</span>
        ResourceContainer<span class="token punctuation">:</span>      config<span class="token punctuation">.</span>ResourceContainer<span class="token punctuation">,</span>         <span class="token comment">//&#x5BB9;&#x5668;&#x8D44;&#x6E90;&#x914D;&#x7F6E;</span>
        ConfigSyncPeriod<span class="token punctuation">:</span>       config<span class="token punctuation">.</span>ConfigSyncPeriod<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> <span class="token comment">//&#x540C;&#x6B65;&#x5468;&#x671F;&#x914D;&#x7F6E;</span>
        ServiceEventHandler<span class="token punctuation">:</span>    serviceEventHandler<span class="token punctuation">,</span>              <span class="token comment">//&#x5904;&#x7406;service&#x4E8B;&#x4EF6;proxier&#x5BF9;&#x8C61;</span>
        EndpointsEventHandler<span class="token punctuation">:</span>  endpointsEventHandler<span class="token punctuation">,</span>            <span class="token comment">//&#x5904;&#x7406;endpoints&#x4E8B;&#x4EF6;proxier&#x5BF9;&#x8C61;</span>
        HealthzServer<span class="token punctuation">:</span>          healthzServer<span class="token punctuation">,</span>                    <span class="token comment">//&#x5065;&#x5EB7;&#x68C0;&#x6D4B;&#x670D;&#x52A1;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="Proxy_Server&#x8FD0;&#x884C;">3. Proxy Server&#x8FD0;&#x884C;</h2>
<div><p class="code-filename">cmd/kube-proxy/app/server.go:481</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>ProxyServer<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    klog<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Version: %+v&quot;</span><span class="token punctuation">,</span> version<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">// &#x5982;&#x679C;CleanupAndExit&#x8BBE;&#x7F6E;&#x4E3A;true,&#x5219;&#x5220;&#x9664;&#x5B58;&#x5728;&#x7684;&#x6240;&#x6709;iptables&#x89C4;&#x5219;&#x9879;&#xFF0C;&#x7136;&#x540E;&#x5E94;&#x7528;&#x9000;&#x51FA;&#x3002;</span>
    <span class="token keyword">if</span> s<span class="token punctuation">.</span>CleanupAndExit <span class="token punctuation">{</span>
        encounteredError <span class="token operator">:=</span> userspace<span class="token punctuation">.</span><span class="token function">CleanupLeftovers</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>IptInterface<span class="token punctuation">)</span>
        encounteredError <span class="token operator">=</span> iptables<span class="token punctuation">.</span><span class="token function">CleanupLeftovers</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>IptInterface<span class="token punctuation">)</span> <span class="token operator">||</span> encounteredError
        encounteredError <span class="token operator">=</span> ipvs<span class="token punctuation">.</span><span class="token function">CleanupLeftovers</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>IpvsInterface<span class="token punctuation">,</span> s<span class="token punctuation">.</span>IptInterface<span class="token punctuation">,</span> s<span class="token punctuation">.</span>IpsetInterface<span class="token punctuation">,</span> s<span class="token punctuation">.</span>CleanupIPVS<span class="token punctuation">)</span> <span class="token operator">||</span> encounteredError
        <span class="token keyword">if</span> encounteredError <span class="token punctuation">{</span>
            <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;encountered an error while tearing down rules.&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

  <span class="token comment">// &#x6839;&#x636E;&#x542F;&#x52A8;&#x53C2;&#x6570;&#x914D;&#x7F6E;&quot;oom-score-adj&quot;&#x5206;&#x503C;&#x8C03;&#x6574;&#xFF0C;&#x53D6;&#x503C;&#x533A;&#x95F4;[-1000, 1000]</span>
    <span class="token keyword">var</span> oomAdjuster <span class="token operator">*</span>oom<span class="token punctuation">.</span>OOMAdjuster
    <span class="token keyword">if</span> s<span class="token punctuation">.</span>OOMScoreAdj <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        oomAdjuster <span class="token operator">=</span> oom<span class="token punctuation">.</span><span class="token function">NewOOMAdjuster</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> oomAdjuster<span class="token punctuation">.</span><span class="token function">ApplyOOMScoreAdj</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token operator">*</span>s<span class="token punctuation">.</span>OOMScoreAdj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  <span class="token comment">//&quot;resource-container&quot;&#x8BBE;&#x7F6E;&#x662F;&#x5426;&#x8FD0;&#x884C;&#x5728;&#x5BB9;&#x5668;&#x91CC;</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>ResourceContainer<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> resourcecontainer<span class="token punctuation">.</span><span class="token function">RunInResourceContainer</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>ResourceContainer<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to start in resource-only container %q: %v&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>ResourceContainer<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Running in resource-only container %q&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>ResourceContainer<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  <span class="token comment">//&#x4E8B;&#x4EF6;&#x5E7F;&#x64AD;&#x5668;</span>
    <span class="token keyword">if</span> s<span class="token punctuation">.</span>Broadcaster <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">.</span>EventClient <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        s<span class="token punctuation">.</span>Broadcaster<span class="token punctuation">.</span><span class="token function">StartRecordingToSink</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v1core<span class="token punctuation">.</span>EventSinkImpl<span class="token punctuation">{</span>Interface<span class="token punctuation">:</span> s<span class="token punctuation">.</span>EventClient<span class="token punctuation">.</span><span class="token function">Events</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// &#x6839;&#x636E;&#x914D;&#x7F6E;&#x542F;&#x52A8;healthz&#x5065;&#x5EB7;&#x68C0;&#x6D4B;&#x670D;&#x52A1;</span>
    <span class="token keyword">if</span> s<span class="token punctuation">.</span>HealthzServer <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        s<span class="token punctuation">.</span>HealthzServer<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

  <span class="token comment">// &#x6839;&#x636E;&#x914D;&#x7F6E;&#x542F;&#x52A8;metrics&#x670D;&#x52A1;&#x3002;URI: &quot;/proxyMode&quot; &#x4E0E; &quot;/metrics&quot;</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>MetricsBindAddress<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        mux <span class="token operator">:=</span> mux<span class="token punctuation">.</span><span class="token function">NewPathRecorderMux</span><span class="token punctuation">(</span><span class="token string">&quot;kube-proxy&quot;</span><span class="token punctuation">)</span>
        healthz<span class="token punctuation">.</span><span class="token function">InstallHandler</span><span class="token punctuation">(</span>mux<span class="token punctuation">)</span>
        mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/proxyMode&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>ProxyMode<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        mux<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token string">&quot;/metrics&quot;</span><span class="token punctuation">,</span> prometheus<span class="token punctuation">.</span><span class="token function">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> s<span class="token punctuation">.</span>EnableProfiling <span class="token punctuation">{</span>
            routes<span class="token punctuation">.</span>Profiling<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">Install</span><span class="token punctuation">(</span>mux<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        configz<span class="token punctuation">.</span><span class="token function">InstallHandler</span><span class="token punctuation">(</span>mux<span class="token punctuation">)</span>
        <span class="token keyword">go</span> wait<span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>MetricsBindAddress<span class="token punctuation">,</span> mux<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;starting metrics server failed: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> wait<span class="token punctuation">.</span>NeverStop<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

  <span class="token comment">// &#x5982;&#x679C;&#x9700;&#x8981;(&#x547D;&#x4EE4;&#x9009;&#x9879;&#x6216;&#x914D;&#x7F6E;&#x9879;)&#x8C03;&#x8282;conntrack&#x914D;&#x7F6E;&#x503C;</span>
    <span class="token keyword">if</span> s<span class="token punctuation">.</span>Conntracker <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        max<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getConntrackMax</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>ConntrackConfiguration<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> max <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            err <span class="token operator">:=</span> s<span class="token punctuation">.</span>Conntracker<span class="token punctuation">.</span><span class="token function">SetMax</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> err <span class="token operator">!=</span> readOnlySysFSError <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> err
                <span class="token punctuation">}</span>

                <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token string">&quot;DOCKER RESTART NEEDED (docker issue #24000): /sys is read-only: &quot;</span> <span class="token operator">+</span>
                    <span class="token string">&quot;cannot modify conntrack limits, problems may arise later.&quot;</span>
                s<span class="token punctuation">.</span>Recorder<span class="token punctuation">.</span><span class="token function">Eventf</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>NodeRef<span class="token punctuation">,</span> api<span class="token punctuation">.</span>EventTypeWarning<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
     <span class="token comment">//&#x8BBE;&#x7F6E;conntracker&#x7684;TCPEstablishedTimeout</span>
        <span class="token keyword">if</span> s<span class="token punctuation">.</span>ConntrackConfiguration<span class="token punctuation">.</span>TCPEstablishedTimeout <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">.</span>ConntrackConfiguration<span class="token punctuation">.</span>TCPEstablishedTimeout<span class="token punctuation">.</span>Duration <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            timeout <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>ConntrackConfiguration<span class="token punctuation">.</span>TCPEstablishedTimeout<span class="token punctuation">.</span>Duration <span class="token operator">/</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>Conntracker<span class="token punctuation">.</span><span class="token function">SetTCPEstablishedTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token comment">//&#x8BBE;&#x7F6E;conntracker&#x7684;TCPCloseWaitTimeout</span>
        <span class="token keyword">if</span> s<span class="token punctuation">.</span>ConntrackConfiguration<span class="token punctuation">.</span>TCPCloseWaitTimeout <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">.</span>ConntrackConfiguration<span class="token punctuation">.</span>TCPCloseWaitTimeout<span class="token punctuation">.</span>Duration <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            timeout <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>ConntrackConfiguration<span class="token punctuation">.</span>TCPCloseWaitTimeout<span class="token punctuation">.</span>Duration <span class="token operator">/</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>Conntracker<span class="token punctuation">.</span><span class="token function">SetTCPCloseWaitTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

   <span class="token comment">// informer&#x673A;&#x5236;&#x83B7;&#x53D6;&#x4E0E;&#x76D1;&#x542C;Services&#x548C;Endpoints&#x7684;&#x914D;&#x7F6E;&#x4E0E;&#x4E8B;&#x4EF6;&#x4FE1;&#x606F;</span>
   <span class="token comment">// &#x6CE8;&#x518C;ServiceEventHandler&#x670D;&#x52A1;&#x4E8B;&#x4EF6;&#x7684;&#x5904;&#x7406;</span>
   <span class="token comment">// &#x6CE8;&#x518C;EndpointsEventHandler&#x7AEF;&#x70B9;&#x4E8B;&#x4EF6;&#x7684;&#x5904;&#x7406;</span>
    informerFactory <span class="token operator">:=</span> informers<span class="token punctuation">.</span><span class="token function">NewSharedInformerFactory</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Client<span class="token punctuation">,</span> s<span class="token punctuation">.</span>ConfigSyncPeriod<span class="token punctuation">)</span>
    serviceConfig <span class="token operator">:=</span> config<span class="token punctuation">.</span><span class="token function">NewServiceConfig</span><span class="token punctuation">(</span>informerFactory<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Services</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>ConfigSyncPeriod<span class="token punctuation">)</span>
    serviceConfig<span class="token punctuation">.</span><span class="token function">RegisterEventHandler</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>ServiceEventHandler<span class="token punctuation">)</span>
    <span class="token keyword">go</span> serviceConfig<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>wait<span class="token punctuation">.</span>NeverStop<span class="token punctuation">)</span>

    endpointsConfig <span class="token operator">:=</span> config<span class="token punctuation">.</span><span class="token function">NewEndpointsConfig</span><span class="token punctuation">(</span>informerFactory<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Endpoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>ConfigSyncPeriod<span class="token punctuation">)</span>
    endpointsConfig<span class="token punctuation">.</span><span class="token function">RegisterEventHandler</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>EndpointsEventHandler<span class="token punctuation">)</span>
    <span class="token keyword">go</span> endpointsConfig<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>wait<span class="token punctuation">.</span>NeverStop<span class="token punctuation">)</span>

    <span class="token keyword">go</span> informerFactory<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>wait<span class="token punctuation">.</span>NeverStop<span class="token punctuation">)</span>

  <span class="token comment">// &quot;&#x65B0;&#x751F;&#x513F;&#x964D;&#x751F;&#x7684;&#x54ED;&#x58F0;&quot;&#xFF0C;&#x4F5C;&#x8005;&#x547D;&#x540D;&#x6BD4;&#x8F83;&#x6709;&#x751F;&#x6D3B;&#x60C5;&#x8DA3;^_^</span>
  <span class="token comment">//  &#x670D;&#x52A1;&#x6210;&#x529F;&#x542F;&#x52A8;&#xFF0C;&#x5C06;&#x542F;&#x52A8;&#x4E8B;&#x4EF6;&#x5E7F;&#x64AD;&#x3002;</span>
  <span class="token comment">//   s.Recorder.Eventf(s.NodeRef, api.EventTypeNormal, &quot;Starting&quot;, &quot;Starting kube-proxy.&quot;)</span>
  <span class="token comment">//      nodeRef := &amp;v1.ObjectReference{</span>
    <span class="token comment">//        Kind:      &quot;Node&quot;,</span>
    <span class="token comment">//        Name:      hostname,</span>
    <span class="token comment">//        UID:       types.UID(hostname),</span>
    <span class="token comment">//       Namespace: &quot;&quot;,</span>
    <span class="token comment">//   }</span>
    s<span class="token punctuation">.</span><span class="token function">birthCry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// Proxier(&#x4EE3;&#x7406;&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x8005;)&#x8FDB;&#x884C;&#x5FAA;&#x73AF;&#x914D;&#x7F6E;&#x540C;&#x6B65;&#x4E0E;&#x5904;&#x7406;proxy&#x903B;&#x8F91;&#xFF08;&#x672C;&#x6587;&#x805A;&#x7126;&#x5E94;&#x7528;&#x4E3B;&#x6846;&#x67B6;&#xFF0C;&#x540E;&#x6709;&#x4E13;&#x7BC7;&#x5206;&#x6790;Proxier&#xFF09;</span>
    <span class="token comment">// &#x6B64;&#x65F6;&#x5C06;&#x8FDB;&#x5165;&#x4E86;proxier&#x8FD0;&#x884C;&#xFF0C;&#x9ED8;&#x8BA4;&#x4F7F;&#x7528;&#x7684;iptables&#x6A21;&#x5F0F;&#x7684;proxier&#x5BF9;&#x8C61;</span>
    s<span class="token punctuation">.</span>Proxier<span class="token punctuation">.</span><span class="token function">SyncLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>s.Proxier.SyncLoop()&#x7684;&#x8FD0;&#x884C;&#x5C06;&#x8FDB;&#x5165;<strong>kube-proxy&#x7B2C;&#x4E09;&#x5C42;</strong>(service&#x5B9E;&#x73B0;&#x673A;&#x5236;&#x5C42;),Proxier&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;&#x662F;&#x5728;proxy server&#x5BF9;&#x8C61;&#x521B;&#x5EFA;&#x65F6;&#x901A;&#x8FC7;config&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x6216;&quot;-proxy-mode&quot;&#x6307;&#x5B9A;&#xFF08;userspace / iptables / ipvs&#x6A21;&#x5F0F;&#xFF09;&#xFF0C;&#x800C;&#x9ED8;&#x8BA4;&#x4F7F;&#x7528;&#x7684;iptables&#x6A21;&#x5F0F;proxier&#x5BF9;&#x8C61;&#x3002;&#x7B2C;&#x4E09;&#x5C42;&#x7684;&#x4EE3;&#x7801;&#x5206;&#x6790;&#x5C06;&#x9488;&#x5BF9;&#x4E09;&#x79CD;&#x6A21;&#x5F0F;&#x8BBE;&#x7ACB;&#x4E13;&#x7BC7;&#x5206;&#x6790;&#xFF0C;&#x6B64;&#x5904;&#x4E3A;&#x5173;&#x952E;&#x90E8;&#x5206;&#x8BF7;&#x8BB0;&#x4F4F;&#x6B64;&#x5904;&#xFF0C;&#x5728;&#x540E;&#x9762;proxier&#x7684;&#x5206;&#x6790;&#x6587;&#x7AE0;&#x91CD;&#x70B9;&#x5173;&#x6CE8;&#x3002;</p>
<p>&#x5728;&#x7B2C;&#x4E8C;&#x5C42;&#x7684;&#x6846;&#x67B6;&#x5C42;&#x6211;&#x4EEC;&#x8FD8;&#x987B;&#x5173;&#x6CE8;kube-proxy&#x4E0E;kubernetes&#x96C6;&#x7FA4;&#x540C;&#x6B65;&#x4FE1;&#x606F;&#x7684;&#x673A;&#x5236;informer&#x3002;kube-proxy&#x7EC4;&#x4EF6;&#x5728;proxy server&#x7684;run()&#x8FD0;&#x884C;&#x521B;&#x5EFA;service&#x3001;endpoints&#x7684;informer&#x5BF9;&#x5176;list&#x540C;&#x6B65;&#x6570;&#x636E;&#x548C;watch&#x76D1;&#x542C;&#x4E8B;&#x4EF6;(add&#x3001;delete&#x3001;update)&#xFF0C;&#x8C03;&#x7528;&#x6CE8;&#x518C;&#x7684;proxier handler&#x8FDB;&#x884C;&#x5904;&#x7406;(<strong>&#x7B2C;&#x4E09;&#x5C42;proxier&#x7684;&#x540C;&#x6B65;&#x5904;&#x7406;&#x673A;&#x5236;&#x8C03;&#x7528;&#x4E0E;&#x89E6;&#x53D1;</strong>)&#x3002; </p>
<h2 id="&#x540C;&#x6B65;&#x89C4;&#x5219;&#x673A;&#x5236;(Informer)">4. &#x540C;&#x6B65;&#x89C4;&#x5219;&#x673A;&#x5236;(Informer)</h2>
<p>kube-proxy&#x540C;&#x6837;&#x4F7F;&#x7528;client-go&#x6807;&#x51C6;&#x7684;ApiServer&#x540C;&#x6B65;&#x65B9;&#x5F0F;&#xFF0C;&#x521B;&#x5EFA;informer,&#x6CE8;&#x518C;&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#x5668;handler&#xFF0C;&#x6301;&#x7EED;&#x76D1;&#x63A7;watch&#x4E8B;&#x4EF6;&#x5E76;&#x8C03;&#x7528;handler&#x5904;&#x7406;&#x4E8B;&#x4EF6;add/update/delete&#xFF0C;&#x540E;&#x7AEF;&#x5904;&#x7406;&#x5219;&#x7531;proxier(userspace/iptables/ipvs)&#x5B9E;&#x73B0;&#x3002;&#x56E0;&#x4E3A;<strong>endpoints</strong>&#x7684;&#x540C;&#x6B65;&#x4E0E;<strong>service&#x540C;&#x6B65;</strong>&#x65B9;&#x5F0F;&#x4E00;&#x81F4;&#xFF0C;&#x5219;&#x4E0B;&#x9762;&#x4EC5;&#x8BF4;&#x660E;service&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#x3002;</p>
<div><p class="code-filename">pkg/proxy/config/config.go:174</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">NewServiceConfig</span><span class="token punctuation">(</span>serviceInformer coreinformers<span class="token punctuation">.</span>ServiceInformer<span class="token punctuation">,</span> resyncPeriod time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token operator">*</span>ServiceConfig <span class="token punctuation">{</span>
    result <span class="token operator">:=</span> <span class="token operator">&amp;</span>ServiceConfig<span class="token punctuation">{</span>
        lister<span class="token punctuation">:</span>       serviceInformer<span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token comment">//&#x76D1;&#x542C;&#x5668;</span>
        listerSynced<span class="token punctuation">:</span> serviceInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>HasSynced<span class="token punctuation">,</span>    <span class="token comment">//&#x76D1;&#x542C;&#x5668;&#x540C;&#x6B65;&#x72B6;&#x6001;&#x503C;</span>
    <span class="token punctuation">}</span>

  <span class="token comment">//&#x5728;&#x670D;&#x52A1;informer&#x4E0A;&#x6DFB;&#x52A0;&#x4E86;&#x8D44;&#x6E90;&#x4E8B;&#x4EF6;&#x7684;&#x5904;&#x7406;&#x5668;handleFunc&#x3002;&#xFF08;Add/update/delete&#xFF09;</span>
    serviceInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddEventHandlerWithResyncPeriod</span><span class="token punctuation">(</span>
        cache<span class="token punctuation">.</span>ResourceEventHandlerFuncs<span class="token punctuation">{</span>
            AddFunc<span class="token punctuation">:</span>    result<span class="token punctuation">.</span>handleAddService<span class="token punctuation">,</span>
            UpdateFunc<span class="token punctuation">:</span> result<span class="token punctuation">.</span>handleUpdateService<span class="token punctuation">,</span>
            DeleteFunc<span class="token punctuation">:</span> result<span class="token punctuation">.</span>handleDeleteService<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        resyncPeriod<span class="token punctuation">,</span>     
    <span class="token punctuation">)</span>

    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre>
<div><p class="code-filename">pkg/proxy/config/config.go:119</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ServiceConfig<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> utilruntime<span class="token punctuation">.</span><span class="token function">HandleCrash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Starting service config controller&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Shutting down service config controller&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token operator">!</span>controller<span class="token punctuation">.</span><span class="token function">WaitForCacheSync</span><span class="token punctuation">(</span><span class="token string">&quot;service config&quot;</span><span class="token punctuation">,</span> stopCh<span class="token punctuation">,</span> c<span class="token punctuation">.</span>listerSynced<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>eventHandlers <span class="token punctuation">{</span>
        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Calling handler.OnServiceSynced()&quot;</span><span class="token punctuation">)</span>
        c<span class="token punctuation">.</span>eventHandlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">OnServiceSynced</span><span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token comment">//&#x670D;&#x52A1;&#x4E0E;proxier&#x5904;&#x7406;&#x540C;&#x6B65;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">&lt;-</span>stopCh
<span class="token punctuation">}</span>
</code></pre>
<p>HandleAddService()&#x65B0;&#x589E;&#x4E8B;&#x4EF6;&#x5904;&#x7406;</p>
<div><p class="code-filename">pkg/proxy/config/config.go:217</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ServiceConfig<span class="token punctuation">)</span> <span class="token function">handleAddService</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    service<span class="token punctuation">,</span> ok <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Service<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unexpected object type: %v&quot;</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>eventHandlers <span class="token punctuation">{</span>
        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Calling handler.OnServiceAdd&quot;</span><span class="token punctuation">)</span>
        c<span class="token punctuation">.</span>eventHandlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">OnServiceAdd</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span>            <span class="token comment">//&#x670D;&#x52A1;&#x65B0;&#x589E;&#x4E8B;&#x4EF6;&#x4E0E;proxier&#x5904;&#x7406;&#x540C;&#x6B65;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>HandleUpdateService()&#x66F4;&#x65B0;&#x4E8B;&#x4EF6;&#x5904;&#x7406;</p>
<div><p class="code-filename">pkg/proxy/config/config.go:229</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ServiceConfig<span class="token punctuation">)</span> <span class="token function">handleUpdateService</span><span class="token punctuation">(</span>oldObj<span class="token punctuation">,</span> newObj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    oldService<span class="token punctuation">,</span> ok <span class="token operator">:=</span> oldObj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Service<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unexpected object type: %v&quot;</span><span class="token punctuation">,</span> oldObj<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    service<span class="token punctuation">,</span> ok <span class="token operator">:=</span> newObj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Service<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unexpected object type: %v&quot;</span><span class="token punctuation">,</span> newObj<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>eventHandlers <span class="token punctuation">{</span>
        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Calling handler.OnServiceUpdate&quot;</span><span class="token punctuation">)</span>
        c<span class="token punctuation">.</span>eventHandlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">OnServiceUpdate</span><span class="token punctuation">(</span>oldService<span class="token punctuation">,</span> service<span class="token punctuation">)</span> <span class="token comment">//&#x670D;&#x52A1;&#x66F4;&#x65B0;&#x4E8B;&#x4EF6;&#x4E0E;proxier&#x5904;&#x7406;&#x540C;&#x6B65; </span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>HandleDeleteService()&#x5220;&#x9664;&#x4E8B;&#x4EF6;&#x5904;&#x7406;</p>
<div><p class="code-filename">pkg/proxy/config/config.go:246</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>ServiceConfig<span class="token punctuation">)</span> <span class="token function">handleDeleteService</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    service<span class="token punctuation">,</span> ok <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Service<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
        tombstone<span class="token punctuation">,</span> ok <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span>DeletedFinalStateUnknown<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unexpected object type: %v&quot;</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> service<span class="token punctuation">,</span> ok <span class="token operator">=</span> tombstone<span class="token punctuation">.</span>Obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Service<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
            utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unexpected object type: %v&quot;</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>eventHandlers <span class="token punctuation">{</span>
        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Calling handler.OnServiceDelete&quot;</span><span class="token punctuation">)</span>
        c<span class="token punctuation">.</span>eventHandlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">OnServiceDelete</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span>         <span class="token comment">//&#x670D;&#x52A1;&#x5220;&#x9664;&#x4E8B;&#x4EF6;&#x4E0E;proxier&#x5904;&#x7406;&#x540C;&#x6B65;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x7B2C;&#x4E09;&#x5C42;proxier&#x5206;&#x6790;&#xFF0C;&#x8BF7;&#x53C2;&#x770B;iptables&#x3001;ipvs&#x3001;userspace-mode proxier&#x5206;&#x6790;&#x6587;&#x6863;&#x3002;</p>
<p><strong>&#x301C;&#x672C;&#x6587;END&#x301C;</strong> </p>
<footer class="page-footer"><span class="copyright">Copyright &#xA9; farmer.hutao@outlook.com 2019 all right reserved&#xFF0C;powered by Gitbook</span><span class="footer-modification">&#x8BE5;&#x6587;&#x4EF6;&#x4FEE;&#x8BA2;&#x65F6;&#x95F4;&#xFF1A;
2019-05-09 10:25:02
</span></footer><div id="anchors-navbar"><i class="fa fa-anchor"></i><ul><p><a href="#Proxy_&#x670D;&#x52A1;&#x6846;&#x67B6;">Proxy &#x670D;&#x52A1;&#x6846;&#x67B6;</a></p><li><a href="#&#x7A0B;&#x5E8F;&#x5165;&#x53E3;&#x4E0E;&#x521D;&#x59CB;&#x5316;">1. &#x7A0B;&#x5E8F;&#x5165;&#x53E3;&#x4E0E;&#x521D;&#x59CB;&#x5316;</a></li><li><a href="#Proxy_Server&#x521B;&#x5EFA;">2. Proxy Server&#x521B;&#x5EFA;</a></li><li><a href="#Proxy_Server&#x8FD0;&#x884C;">3. Proxy Server&#x8FD0;&#x884C;</a></li><li><a href="#&#x540C;&#x6B65;&#x89C4;&#x5219;&#x673A;&#x5236;(Informer)">4. &#x540C;&#x6B65;&#x89C4;&#x5219;&#x673A;&#x5236;(Informer)</a></li></ul></div><a href="#&#x7A0B;&#x5E8F;&#x5165;&#x53E3;&#x4E0E;&#x521D;&#x59CB;&#x5316;" id="goTop"><i class="fa fa-arrow-up"></i></a>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="./" class="navigation navigation-prev " aria-label="Previous page: kube-proxy">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="iptables.html" class="navigation navigation-next " aria-label="Next page: Iptables-mode Proxier">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Proxy 服务框架","level":"2.5.1","depth":2,"next":{"title":"Iptables-mode Proxier","level":"2.5.2","depth":2,"path":"core/kube-proxy/iptables.md","ref":"core/kube-proxy/iptables.md","articles":[]},"previous":{"title":"kube-proxy","level":"2.5","depth":1,"path":"core/kube-proxy/README.md","ref":"core/kube-proxy/README.md","articles":[{"title":"Proxy 服务框架","level":"2.5.1","depth":2,"path":"core/kube-proxy/arch.md","ref":"core/kube-proxy/arch.md","articles":[]},{"title":"Iptables-mode Proxier","level":"2.5.2","depth":2,"path":"core/kube-proxy/iptables.md","ref":"core/kube-proxy/iptables.md","articles":[]},{"title":"Ipvs-Mode Proxier","level":"2.5.3","depth":2,"path":"core/kube-proxy/ipvs.md","ref":"core/kube-proxy/ipvs.md","articles":[]},{"title":"Userspace-mode Proxier","level":"2.5.4","depth":2,"path":"core/kube-proxy/userspace.md","ref":"core/kube-proxy/userspace.md","articles":[]}]},"dir":"ltr"},"config":{"plugins":["theme-comscore","codeblock-filename","navigator","simple-page-toc","expandable-chapters-small","search-pro","splitter","multipart","tbfed-pagefooter","prism","-highlight","editlink","github","github-buttons@2.1.0","donate","copy-code-button"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"Copyright &copy farmer.hutao@outlook.com 2019","modify_label":"该文件修订时间：","modify_format":"YYYY-MM-DD HH:mm:ss"},"prism":{},"github":{"url":"https://github.com/farmer-hutao/k8s-source-code-analysis"},"editlink":{"label":"编辑本页","multilingual":false,"base":"https://github.com/farmer-hutao/k8s-source-code-analysis/edit/master"},"simple-page-toc":{"maxDepth":4,"skipFirstH1":true},"splitter":{},"search-pro":{"cutWordLib":"nodejieba","defineWord":["Gitbook Use"]},"search":{},"multipart":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"donate":{"alipay":"","alipayText":"支付宝打赏","button":"鼓励作者","title":"催作者快快更新","wechat":"./image/wx.jpg","wechatText":"微信小额捐赠，鼓励作者尽快更新～"},"fontsettings":{"theme":"white","family":"sans","size":2},"codeblock-filename":{},"theme-comscore":{},"navigator":{},"github-buttons":{"repo":"farmer-hutao/k8s-source-code-analysis","types":["star"],"size":"small"},"expandable-chapters-small":{},"copy-code-button":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":true}},"theme":"default","author":"Tao Hu <farmer.hutao@outlook.com>","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"《k8s-1.13版本源码分析》","gitbook":"*","description":"k8s source code analysis"},"file":{"path":"core/kube-proxy/arch.md","mtime":"2019-05-09T02:25:02.413Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-05-29T03:18:27.613Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-editlink/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-github-buttons/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-donate/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-theme-comscore/test.js"></script>
        
    

    </body>
</html>

