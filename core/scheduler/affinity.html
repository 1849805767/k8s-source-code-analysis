
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>专题-亲和性调度 · 《k8s-1.13版本源码分析》</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Tao Hu <farmer.hutao@outlook.com>">
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-codeblock-filename/block.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-navigator/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-multipart/multipart.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-tbfed-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-prism/prism.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-donate/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-theme-comscore/test.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="summarize.html" />
    
    
    <link rel="prev" href="init.html" />
    

    <style>
    @media only screen and (max-width: 640px) {
        .book-header .hidden-mobile {
            display: none;
        }
    }
    </style>
    <script>
        window["gitbook-plugin-github-buttons"] = {"repo":"farmer-hutao/k8s-source-code-analysis","types":["star"],"size":"small"};
    </script>

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Part I - 准备工作</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                        <b>1.1.</b>
                    
                    前言
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../../prepare/">
            
                <a href="../../prepare/">
            
                    
                        <b>1.2.</b>
                    
                    k8s源码分析准备工作
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../../prepare/get-code.html">
            
                <a href="../../prepare/get-code.html">
            
                    
                        <b>1.2.1.</b>
                    
                    源码准备
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../../prepare/debug-environment.html">
            
                <a href="../../prepare/debug-environment.html">
            
                    
                        <b>1.2.2.</b>
                    
                    测试环境搭建-单节点
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../../prepare/debug-environment-3node.html">
            
                <a href="../../prepare/debug-environment-3node.html">
            
                    
                        <b>1.2.3.</b>
                    
                    测试环境搭建-三节点
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../../prepare/debug.html">
            
                <a href="../../prepare/debug.html">
            
                    
                        <b>1.2.4.</b>
                    
                    源码调试
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Part II - 核心组件</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../">
            
                <a href="../">
            
                    
                        <b>2.1.</b>
                    
                    概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="./">
            
                <a href="./">
            
                    
                        <b>2.2.</b>
                    
                    scheduler
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.2.1" data-path="design.html">
            
                <a href="design.html">
            
                    
                        <b>2.2.1.</b>
                    
                    调度器设计
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.2" data-path="before-scheduler-run.html">
            
                <a href="before-scheduler-run.html">
            
                    
                        <b>2.2.2.</b>
                    
                    调度程序启动前逻辑
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.3" data-path="scheduler-framework.html">
            
                <a href="scheduler-framework.html">
            
                    
                        <b>2.2.3.</b>
                    
                    调度器框架
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.4" data-path="generic-scheduler.html">
            
                <a href="generic-scheduler.html">
            
                    
                        <b>2.2.4.</b>
                    
                    一般调度过程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.5" data-path="predicate.html">
            
                <a href="predicate.html">
            
                    
                        <b>2.2.5.</b>
                    
                    预选过程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.6" data-path="priority.html">
            
                <a href="priority.html">
            
                    
                        <b>2.2.6.</b>
                    
                    优选过程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.7" data-path="preempt.html">
            
                <a href="preempt.html">
            
                    
                        <b>2.2.7.</b>
                    
                    抢占调度
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.8" data-path="init.html">
            
                <a href="init.html">
            
                    
                        <b>2.2.8.</b>
                    
                    调度器初始化
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.2.9" data-path="affinity.html">
            
                <a href="affinity.html">
            
                    
                        <b>2.2.9.</b>
                    
                    专题-亲和性调度
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.10" data-path="summarize.html">
            
                <a href="summarize.html">
            
                    
                        <b>2.2.10.</b>
                    
                    scheduler 总结
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../controller-manager/">
            
                <a href="../controller-manager/">
            
                    
                        <b>2.3.</b>
                    
                    controller-manager
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.3.1" data-path="../controller-manager/controller.html">
            
                <a href="../controller-manager/controller.html">
            
                    
                        <b>2.3.1.</b>
                    
                    控制器概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3.2" data-path="../controller-manager/custom-controller.html">
            
                <a href="../controller-manager/custom-controller.html">
            
                    
                        <b>2.3.2.</b>
                    
                    自定义控制器
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../apiserver/">
            
                <a href="../apiserver/">
            
                    
                        <b>2.4.</b>
                    
                    apiserver
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="../kube-proxy/">
            
                <a href="../kube-proxy/">
            
                    
                        <b>2.5.</b>
                    
                    kube-proxy
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.5.1" data-path="../kube-proxy/arch.html">
            
                <a href="../kube-proxy/arch.html">
            
                    
                        <b>2.5.1.</b>
                    
                    Proxy 服务框架
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5.2" data-path="../kube-proxy/iptables.html">
            
                <a href="../kube-proxy/iptables.html">
            
                    
                        <b>2.5.2.</b>
                    
                    Iptables-mode Proxier
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5.3" data-path="../kube-proxy/ipvs.html">
            
                <a href="../kube-proxy/ipvs.html">
            
                    
                        <b>2.5.3.</b>
                    
                    Ipvs-Mode Proxier
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5.4" data-path="../kube-proxy/userspace.html">
            
                <a href="../kube-proxy/userspace.html">
            
                    
                        <b>2.5.4.</b>
                    
                    Userspace-mode Proxier
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="../kubelet/">
            
                <a href="../kubelet/">
            
                    
                        <b>2.6.</b>
                    
                    kubelet
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Part III - 周边项目</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../../around/">
            
                <a href="../../around/">
            
                    
                        <b>3.1.</b>
                    
                    概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../../around/client-go/">
            
                <a href="../../around/client-go/">
            
                    
                        <b>3.2.</b>
                    
                    client-go
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.2.1" data-path="../../around/client-go/informer.html">
            
                <a href="../../around/client-go/informer.html">
            
                    
                        <b>3.2.1.</b>
                    
                    Informer (一)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.2" data-path="../../around/client-go/informer2.html">
            
                <a href="../../around/client-go/informer2.html">
            
                    
                        <b>3.2.2.</b>
                    
                    Informer(二)
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >专题-亲和性调度</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="&#x4E13;&#x9898;-&#x4EB2;&#x548C;&#x6027;&#x8C03;&#x5EA6;(Author_-_XiaoYang)">&#x4E13;&#x9898;-&#x4EB2;&#x548C;&#x6027;&#x8C03;&#x5EA6;(Author - XiaoYang)</h1>
<!-- toc -->
<ul>
<li><a href="#%E7%AE%80%E4%BB%8B">&#x7B80;&#x4ECB;</a><ul>
<li><a href="#%E7%BA%A6%E6%9D%9F%E8%B0%83%E5%BA%A6">&#x7EA6;&#x675F;&#x8C03;&#x5EA6;</a></li>
<li><a href="#labelsselector%E6%A0%87%E7%AD%BE%E9%80%89%E6%8B%A9%E5%99%A8">Labels.selector&#x6807;&#x7B7E;&#x9009;&#x62E9;&#x5668;</a></li>
</ul>
</li>
<li><a href="#node%E4%BA%B2%E5%92%8C%E6%80%A7">Node&#x4EB2;&#x548C;&#x6027;</a><ul>
<li><a href="#node%E4%BA%B2%E5%92%8C%E6%80%A7%E9%A2%84%E9%80%89%E7%AD%96%E7%95%A5matchnodeselectorpred">Node&#x4EB2;&#x548C;&#x6027;<code>&#x9884;&#x9009;&#x7B56;&#x7565;MatchNodeSelectorPred</code></a></li>
<li><a href="#node%E4%BA%B2%E5%92%8C%E6%80%A7%E4%BC%98%E9%80%89%E7%AD%96%E7%95%A5nodeaffinitypriority">Node&#x4EB2;&#x548C;&#x6027;<code>&#x4F18;&#x9009;&#x7B56;&#x7565;NodeAffinityPriority</code></a></li>
</ul>
</li>
<li><a href="#pod%E4%BA%B2%E5%92%8C%E6%80%A7">Pod&#x4EB2;&#x548C;&#x6027;</a><ul>
<li><a href="#pod%E4%BA%B2%E5%92%8C%E6%80%A7%E9%A2%84%E9%80%89%E7%AD%96%E7%95%A5matchinterpodaffinitypred">Pod&#x4EB2;&#x548C;&#x6027;<code>&#x9884;&#x9009;&#x7B56;&#x7565;MatchInterPodAffinityPred</code></a></li>
<li><a href="#pod%E4%BA%B2%E5%92%8C%E6%80%A7%E4%BC%98%E9%80%89%E7%AD%96%E7%95%A5interpodaffinitypriority">Pod&#x4EB2;&#x548C;&#x6027;<code>&#x4F18;&#x9009;&#x7B56;&#x7565;InterPodAffinityPriority</code></a></li>
</ul>
</li>
<li><a href="#service%E4%BA%B2%E5%92%8C%E6%80%A7">Service&#x4EB2;&#x548C;&#x6027;</a><ul>
<li><a href="#serice%E4%BA%B2%E5%92%8C%E6%80%A7%E9%A2%84%E9%80%89%E7%AD%96%E7%95%A5checkserviceaffinity-">Serice&#x4EB2;&#x548C;&#x6027;<code>&#x9884;&#x9009;&#x7B56;&#x7565;checkServiceAffinity</code></a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
<h2 id="&#x7B80;&#x4ECB;">1. &#x7B80;&#x4ECB;</h2>
<p>&#x5728;&#x672A;&#x5206;&#x6790;&#x548C;&#x6DF1;&#x5165;&#x7406;&#x89E3;scheduler&#x6E90;&#x7801;&#x903B;&#x8F91;&#x4E4B;&#x524D;&#xFF0C;&#x672C;&#x4EBA;&#x5728;&#x64CD;&#x4F5C;&#x914D;&#x7F6E;&#x4EB2;&#x548C;&#x6027;&#x4E0A;&#xFF0C;&#x7531;&#x4E8E;&#x5B98;&#x65B9;&#x548C;&#x7B2C;&#x4E09;&#x65B9;&#x6587;&#x6863;&#x8005;&#x8BF4;&#x660E;&#x4E0D;&#x6E05;&#x695A;&#x7B49;&#x539F;&#x56E0;&#xFF0C;&#x5728;&#x4EB2;&#x548C;&#x6027;&#x7406;&#x89E3;&#x4E0A;&#x6709;&#x9047;&#x5230;&#x8FC7;&#x4E00;&#x4E9B;&#x56F0;&#x60D1;&#xFF0C;&#x5982;&#xFF1A; </p>
<ol>
<li><p>&#x4EB2;&#x548C;&#x6027;&#x7684;operator&#x7684; &#x201C;<em>In</em>&#x201D;&#x5E95;&#x5C42;&#x662F;&#x4EC0;&#x4E48;&#x5339;&#x914D;&#x64CD;&#x4F5C;&#xFF1F;&#x6B63;&#x5219;&#x5339;&#x914D;&#x5417;&#xFF1F;&#x201C;<em>Gt/Lt</em>&#x201D;&#x5E95;&#x5C42;&#x53C8;&#x662F;&#x4EC0;&#x4E48;&#x64CD;&#x4F5C;&#x5B9E;&#x73B0;&#x7684;&#xFF1F; </p>
</li>
<li><p>&#x6240;&#x6709;&#x80FD;&#x67E5;&#x5230;&#x7684;&#x6587;&#x6863;&#x63CF;&#x8FF0;pod&#x4EB2;&#x548C;&#x6027;&#x7684;topoloykey&#x6709;&#x4E09;&#x4E2A;&#xFF1A; 
<em>kubernetes.io/hostname</em> 
<em>failure-domain.beta.kubernetes.io/zone</em> 
<em>failure-domain.beta.kubernetes.io/region</em> 
&#x4E3A;&#x4EC0;&#x4E48;&#xFF1F;&#x771F;&#x7684;&#x53EA;&#x652F;&#x6301;&#x8FD9;&#x4E09;&#x4E2A;key&#xFF1F;&#x4E0D;&#x80FD;&#x81EA;&#x5B9A;&#x4E49;&#xFF1F; </p>
</li>
<li><p>Pod&#x4E0E;Node&#x4EB2;&#x548C;&#x6027;&#x4E24;&#x79CD;&#x7C7B;&#x578B;&#x7684;&#x5DEE;&#x5F02;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;&#x800C;Pod&#x4EB2;&#x548C;&#x6027;&#x6B63;&#x771F;&#x8981;&#x53BB;&#x5339;&#x914D;&#x7684;&#x662F;&#x4EC0;&#x4E48;&#xFF0C;&#x5176;&#x5185;&#x5728;&#x903B;&#x8F91;&#x662F;&#xFF1F; 
&#x4E0D;&#x77E5;&#x9053;&#x4F60;&#x4EEC;&#x662F;&#x5426;&#x6709;&#x540C;&#x6837;&#x7C7B;&#x4F3C;&#x7684;&#x95EE;&#x9898;&#x6216;&#x56F0;&#x60D1;&#x5462;&#xFF1F;&#x5F53;&#x4F60;&#x6E05;&#x6670;&#x7684;&#x7406;&#x89E3;&#x4E86;&#x4EE3;&#x7801;&#x903B;&#x8F91;&#x5B9E;&#x73B0;&#x540E;&#xFF0C;&#x90A3;&#x4E48;&#x4F60;&#x4F1A;&#x89C9;&#x5F97;&#x4E00;&#x5207;&#x662F;&#x90A3;&#x4E48;&#x7684; 
&#x6E05;&#x695A;&#x660E;&#x786E;&#x4E86;&#xFF0C;&#x4E0D;&#x518D;&#x6709;&#x201C;&#x9690;&#x6027;&#x77E5;&#x8BC6;&#x201D;&#x95EE;&#x9898;&#x5B58;&#x5728;&#x3002;&#x6240;&#x4EE5;&#x6211;&#x5E0C;&#x671B;&#x672C;&#x6587;&#x6240;&#x8FF0;&#x5185;&#x5BB9;&#x80FD;&#x7ED9;&#x5927;&#x5BB6;&#x5728;kubernetes&#x4EB2;&#x548C;&#x6027;&#x7684;&#x89E3;&#x60D1;&#x4E0A;&#x6709;&#x6240;&#x5E2E;&#x52A9;&#x3002; </p>
</li>
</ol>
<h3 id="&#x7EA6;&#x675F;&#x8C03;&#x5EA6;">1.1. &#x7EA6;&#x675F;&#x8C03;&#x5EA6;</h3>
<p>  &#x5728;&#x5C55;&#x5F00;&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;&#x524D;&#x4E3A;&#x66F4;&#x597D;&#x7684;&#x7406;&#x89E3;&#x4EB2;&#x548C;&#x6027;&#x4EE3;&#x7801;&#x903B;&#x8F91;&#xFF0C;&#x8865;&#x5145;&#x4E00;&#x4E9B;kubernetes&#x8C03;&#x5EA6;&#x76F8;&#x5173;&#x7684;&#x57FA;&#x7840;&#x77E5;&#x8BC6;&#xFF1A; </p>
<ol>
<li>&#x4EB2;&#x548C;&#x6027;&#x76EE;&#x7684;&#x662F;&#x4E3A;&#x4E86;&#x5B9E;&#x73B0;&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x6309;&#x9700;&#x5C06;pod&#x8C03;&#x5EA6;&#x5230;<code>&#x6307;&#x5B9A;Node</code>&#x4E0A;&#xFF0C;&#x6211;&#x79F0;&#x4E4B;&#x4E3A;<code>&#x201C;&#x7EA6;&#x675F;&#x8C03;&#x5EA6;&#x201D;</code>&#x3002; </li>
<li><p>&#x7EA6;&#x675F;&#x8C03;&#x5EA6;&#x64CD;&#x4F5C;&#x4E0A;&#x5E38;&#x7528;&#x4EE5;&#x4E0B;&#x4E09;&#x7C7B;&#xFF1A; </p>
</li>
<li><p><strong>NodeSelector / NodeName</strong>     <em>node&#x6807;&#x7B7E;&#x9009;&#x62E9;&#x5668; &#x548C; &quot;nodeName&quot;&#x5339;&#x914D;</em></p>
</li>
<li><strong>Affinity (Node/Pod/Service&#xFF09;</strong>  <em>&#x4EB2;&#x548C;&#x6027;</em></li>
<li><p><strong>Taint / Toleration</strong>                       <em>&#x6C61;&#x70B9;&#x548C;&#x5BB9;&#x5FCD;</em> </p>
</li>
<li><p>&#x672C;&#x6587;&#x6240;&#x8FF0;&#x4E3B;&#x9898;&#x662F;&#x4EB2;&#x548C;&#x6027;&#xFF0C;&#x4EB2;&#x548C;&#x6027;&#x5206;&#x4E3A;&#x4E09;&#x79CD;&#x7C7B;&#x578B;Node&#x3001;Pod&#x3001;Service&#x4EB2;&#x548C;&#xFF0C;&#x4EE5;&#x4E0B;&#x662F;&#x4EB2;&#x548C;&#x6027;&#x9884;&#x9009;&#x548C;&#x4F18;&#x9009;&#x9636;&#x6BB5;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#x7684;&#x7B56;&#x7565;&#x5BF9;&#x5E94;&#x8868;&#xFF08;<em>&#x540E;&#x9762;&#x6709;&#x8BE6;&#x7EC6;&#x5206;&#x6790;</em>&#xFF09;&#xFF1A; </p>
</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:center">&#x9884;&#x9009;&#x9636;&#x6BB5;&#x7B56;&#x7565;</th>
<th style="text-align:center">Pod.Spec&#x914D;&#x7F6E;</th>
<th style="text-align:center">&#x7C7B;&#x522B;</th>
<th style="text-align:center">&#x6B21;&#x5E8F;</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">MatchNodeSelecotorPred</td>
<td style="text-align:center"><em>NodeAffinity.RequiredDuringScheduling<br>IgnoredDuringExecution</em></td>
<td style="text-align:center">Node</td>
<td style="text-align:center">6</td>
</tr>
<tr>
<td style="text-align:center">MatchInterPodAffinityPred</td>
<td style="text-align:center"><em>PodAffinity.RequiredDuringScheduling<br>IgnoredDuringExecution<br>**PodAntiAffinity.RequiredDuringScheduling<br>IgnoredDuringExecution</em></td>
<td style="text-align:center">Pod</td>
<td style="text-align:center">22</td>
</tr>
<tr>
<td style="text-align:center">CheckServiceAffinityPred</td>
<td style="text-align:center"></td>
<td style="text-align:center">Service</td>
<td style="text-align:center">12</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:center">&#x4F18;&#x9009;&#x9636;&#x6BB5;&#x7B56;&#x7565;</th>
<th style="text-align:center">Pod.Spec&#x914D;&#x7F6E;</th>
<th style="text-align:center">&#x9ED8;&#x8BA4;&#x6743;&#x91CD;</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">InterPodAffinityPriority</td>
<td style="text-align:center">PodAffinity.PreferredDuringScheduling<br>IgnoredDuringExecution</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">NodeAffinityPriority</td>
<td style="text-align:center">NodeAffinity.PreferredDuringScheduling<br>IgnoredDuringExecution</td>
<td style="text-align:center">1</td>
</tr>
</tbody>
</table>
<h3 id="Labels_selector&#x6807;&#x7B7E;&#x9009;&#x62E9;&#x5668;">1.2. Labels.selector&#x6807;&#x7B7E;&#x9009;&#x62E9;&#x5668;</h3>
<p>labels selector&#x662F;&#x4EB2;&#x548C;&#x6027;&#x4EE3;&#x7801;&#x5E95;&#x5C42;&#x4F7F;&#x7528;&#x6700;&#x57FA;&#x7840;&#x7684;&#x4EE3;&#x7801;&#x5DE5;&#x5177;&#xFF0C;&#x4E0D;&#x8BBA;&#x662F;nodeAffinity&#x8FD8;&#x662F;podAffinity&#x90FD;&#x662F;&#x9700;&#x8981;&#x7528;&#x5230;&#x5B83;&#x3002;&#x5728;&#x4F7F;&#x7528;yml&#x7C7B;&#x578B;deployment&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;pod&#xFF0C;&#x914D;&#x7F6E;&#x5176;&#x4EB2;&#x548C;&#x6027;&#x65F6;&#x987B;&#x6307;&#x5B9A;&#x5339;&#x914D;&#x8868;&#x8FBE;&#x5F0F;&#xFF0C;&#x5176;&#x6839;&#x672C;&#x7684;&#x5339;&#x914D;&#x90FD;&#x662F;&#x8981;&#x5BF9;Node&#x6216;pod&#x7684;labels&#x6807;&#x7B7E;&#x8FDB;&#x884C;&#x6761;&#x4EF6;&#x5339;&#x914D;&#x3002;&#x800C;&#x8FD9;&#x4E9B;labels&#x6807;&#x7B7E;&#x5339;&#x914D;&#x8BA1;&#x7B97;&#x5C31;&#x5FC5;&#x987B;&#x8981;&#x7528;&#x5230;labels.selector&#x5DE5;&#x5177;(&#x516C;&#x5171;&#x4F7F;&#x7528;&#x90E8;&#x5206;)&#x3002; &#x6240;&#x4EE5;&#x5728;&#x5C06;&#x6B64;&#x5757;&#x6700;&#x5E95;&#x5C42;&#x7684;&#x5339;&#x914D;&#x8BA1;&#x7B97;&#x5206;&#x6790;&#x90E8;&#x5206;&#x653E;&#x5728;&#x6700;&#x524D;&#x9762;&#xFF0C;&#x4EE5;&#x4FBF;&#x4E8E;&#x540E;&#x9762;&#x6E90;&#x7801;&#x5206;&#x6790;&#x90E8;&#x5206;&#x66F4;&#x5BB9;&#x6613;&#x7406;&#x89E3;&#x3002; </p>
<blockquote>
<p>labels.selector&#x63A5;&#x53E3;&#x5B9A;&#x4E49;&#xFF0C;&#x5173;&#x952E;&#x7684;&#x65B9;&#x6CD5;&#x662F;Matchs()</p>
</blockquote>
<div><p class="code-filename">vendor/k8s.io/apimachinery/pkg/labels/selector.go:36</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> Selector <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Matches</span><span class="token punctuation">(</span>Labels<span class="token punctuation">)</span> <span class="token builtin">bool</span>  
    <span class="token function">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
    <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
    <span class="token function">Add</span><span class="token punctuation">(</span>r <span class="token operator">...</span>Requirement<span class="token punctuation">)</span> Selector
    <span class="token function">Requirements</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>requirements Requirements<span class="token punctuation">,</span> selectable <span class="token builtin">bool</span><span class="token punctuation">)</span>
    <span class="token function">DeepCopySelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Selector
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>&#x770B;&#x4E00;&#x4E0B;&#x8C03;&#x7528;&#x7AEF;&#xFF0C;&#x5982;&#x4E0B;&#x9762;&#x7684;&#x51E0;&#x4E2A;&#x5B9E;&#x4F8B;&#x7684;func&#xFF0C;&#x8C03;&#x7528;labels.NewSelector()&#x5B9E;&#x4F8B;&#x5316;&#x4E00;&#x4E2A;labels.selector&#x5BF9;&#x8C61;&#x8FD4;&#x56DE;.</p>
</blockquote>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">LabelSelectorAsSelector</span><span class="token punctuation">(</span>ps <span class="token operator">*</span>LabelSelector<span class="token punctuation">)</span> <span class="token punctuation">(</span>labels<span class="token punctuation">.</span>Selector<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
    selector <span class="token operator">:=</span> labels<span class="token punctuation">.</span><span class="token function">NewSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   
  <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NodeSelectorRequirementsAsSelector</span><span class="token punctuation">(</span>nsm <span class="token punctuation">[</span><span class="token punctuation">]</span>v1<span class="token punctuation">.</span>NodeSelectorRequirement<span class="token punctuation">)</span> <span class="token punctuation">(</span>labels<span class="token punctuation">.</span>Selector<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    selector <span class="token operator">:=</span> labels<span class="token punctuation">.</span><span class="token function">NewSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token operator">...</span>
    <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TopologySelectorRequirementsAsSelector</span><span class="token punctuation">(</span>tsm <span class="token punctuation">[</span><span class="token punctuation">]</span>v1<span class="token punctuation">.</span>TopologySelectorLabelRequirement<span class="token punctuation">)</span> <span class="token punctuation">(</span>labels<span class="token punctuation">.</span>Selector<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
    selector <span class="token operator">:=</span> labels<span class="token punctuation">.</span><span class="token function">NewSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>NewSelector&#x8FD4;&#x56DE;&#x7684;&#x662F;&#x4E00;&#x4E2A;InternelSelector&#x7C7B;&#x578B;&#xFF0C;&#x800C;InternelSelector&#x7C7B;&#x578B;&#x662F;&#x4E00;&#x4E2A;Requirement&#xFF08;&#x5FC5;&#x8981;&#x6761;&#x4EF6;&#xFF09; </p>
<p>&#x7C7B;&#x578B;&#x7684;&#x5217;&#x8868;&#x3002; </p>
</blockquote>
<div><p class="code-filename">vendor/k8s.io/apimachinery/pkg/labels/selector.go:79</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">NewSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Selector <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">internalSelector</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> internalSelector <span class="token punctuation">[</span><span class="token punctuation">]</span>Requirement
</code></pre>
<blockquote>
<p>InternelSelector&#x7C7B;&#x7684;Matches()&#x5E95;&#x5C42;&#x5B9E;&#x73B0;&#x662F;&#x904D;&#x5386;&#x8C03;&#x7528;requirement.Matches()</p>
</blockquote>
<div><p class="code-filename">vendor/k8s.io/apimachinery/pkg/labels/selector.go:340</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>lsel internalSelector<span class="token punctuation">)</span> <span class="token function">Matches</span><span class="token punctuation">(</span>l Labels<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> ix <span class="token operator">:=</span> <span class="token keyword">range</span> lsel <span class="token punctuation">{</span>
      <span class="token comment">// internalSelector[ix]&#x4E3A;Requirement</span>
        <span class="token keyword">if</span> matches <span class="token operator">:=</span> lsel<span class="token punctuation">[</span>ix<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Matches</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>matches <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>&#x518D;&#x6765;&#x770B;&#x4E0B;requirment&#x7ED3;&#x6784;&#x5B9A;&#x4E49;(key&#x3001;&#x64CD;&#x4F5C;&#x7B26;&#x3001;&#x503C; )       <em>&quot;&#x8FD9;&#x5C31;&#x662F;&#x914D;&#x7F6E;&#x7684;&#x4EB2;&#x548C;&#x5339;&#x914D;&#x6761;&#x4EF6;&#x8868;&#x8FBE;&#x5F0F;&quot;</em></p>
</blockquote>
<div><p class="code-filename">vendor/k8s.io/apimachinery/pkg/labels/selector.go:114</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> Requirement <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    key      <span class="token builtin">string</span>
    operator selection<span class="token punctuation">.</span>Operator
    <span class="token comment">// In huge majority of cases we have at most one value here.</span>
    <span class="token comment">// It is generally faster to operate on a single-element slice</span>
    <span class="token comment">// than on a single-element map, so we have a slice here.</span>
    strValues <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>requirment.matchs() &#x771F;&#x6B63;&#x7684;&#x6761;&#x4EF6;&#x8868;&#x8FBE;&#x5F0F;&#x64CD;&#x4F5C;&#x5B9E;&#x73B0;,&#x57FA;&#x4E8E;&#x8868;&#x8FBE;&#x5F0F;<code>operator</code>,&#x8BA1;&#x7B97;<code>key/value</code>,&#x8FD4;&#x56DE;&#x5339;&#x914D;<code>&#x4E0E;&#x5426;</code></p>
</blockquote>
<div><p class="code-filename">vendor/k8s.io/apimachinery/pkg/labels/selector.go:192</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Requirement<span class="token punctuation">)</span> <span class="token function">Matches</span><span class="token punctuation">(</span>ls Labels<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> r<span class="token punctuation">.</span>operator <span class="token punctuation">{</span>
    <span class="token keyword">case</span> selection<span class="token punctuation">.</span>In<span class="token punctuation">,</span> selection<span class="token punctuation">.</span>Equals<span class="token punctuation">,</span> selection<span class="token punctuation">.</span>DoubleEquals<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ls<span class="token punctuation">.</span><span class="token function">Has</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>                       <span class="token comment">//IN</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> r<span class="token punctuation">.</span><span class="token function">hasValue</span><span class="token punctuation">(</span>ls<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> selection<span class="token punctuation">.</span>NotIn<span class="token punctuation">,</span> selection<span class="token punctuation">.</span>NotEquals<span class="token punctuation">:</span>   <span class="token comment">//NotIn</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ls<span class="token punctuation">.</span><span class="token function">Has</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">!</span>r<span class="token punctuation">.</span><span class="token function">hasValue</span><span class="token punctuation">(</span>ls<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>        
    <span class="token keyword">case</span> selection<span class="token punctuation">.</span>Exists<span class="token punctuation">:</span>                       <span class="token comment">//Exists</span>
        <span class="token keyword">return</span> ls<span class="token punctuation">.</span><span class="token function">Has</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
    <span class="token keyword">case</span> selection<span class="token punctuation">.</span>DoesNotExist<span class="token punctuation">:</span>                 <span class="token comment">//NotExists</span>
        <span class="token keyword">return</span> <span class="token operator">!</span>ls<span class="token punctuation">.</span><span class="token function">Has</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
    <span class="token keyword">case</span> selection<span class="token punctuation">.</span>GreaterThan<span class="token punctuation">,</span> selection<span class="token punctuation">.</span>LessThan<span class="token punctuation">:</span> <span class="token comment">// GT&#x3001;LT</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>ls<span class="token punctuation">.</span><span class="token function">Has</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        lsValue<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>ls<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>   <span class="token comment">//&#x80FD;&#x8F6C;&#x5316;&#x4E3A;&#x6570;&#x503C;&#x7684;&#x201D;&#x5B57;&#x7B26;&#x6570;&#x503C;&#x201C;</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;ParseInt failed for value %+v in label %+v, %+v&quot;</span><span class="token punctuation">,</span> ls<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> ls<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// There should be only one strValue in r.strValues, and can be converted to a integer.</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>strValues<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
            klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid values count %+v of requirement %#v, for &apos;Gt&apos;, &apos;Lt&apos; operators, exactly one value is required&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>strValues<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">var</span> rValue <span class="token builtin">int64</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> r<span class="token punctuation">.</span>strValues <span class="token punctuation">{</span>
            rValue<span class="token punctuation">,</span> err <span class="token operator">=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>strValues<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;ParseInt failed for value %+v in requirement %#v, for &apos;Gt&apos;, &apos;Lt&apos; operators, the value must be an integer&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>strValues<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>operator <span class="token operator">==</span> selection<span class="token punctuation">.</span>GreaterThan <span class="token operator">&amp;&amp;</span> lsValue <span class="token operator">&gt;</span> rValue<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>operator <span class="token operator">==</span> selection<span class="token punctuation">.</span>LessThan <span class="token operator">&amp;&amp;</span> lsValue <span class="token operator">&lt;</span> rValue<span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><em>&#x6CE8;&#xFF1A;</em>
<em>&#x9664;&#x4E86;LabelsSelector&#x5916;&#x8FD8;&#x6709;NodeSelector &#x3001;FieldsSelector&#x3001;PropertySelector&#x7B49;&#xFF0C;&#x4F46;&#x57FA;&#x672C;&#x90FD;&#x662F;&#x7C7B;&#x4F3C;&#x7684;Selector&#x63A5;&#x53E3;&#x5B9E;&#x73B0;&#xFF0C;&#x903B;&#x8F91;&#x4E0A;&#x90FD;&#x57FA;&#x672C;&#x4E00;&#x81F4;&#xFF0C;&#x540E;&#x5728;&#x6E90;&#x7801;&#x5206;&#x6790;&#x8FC7;&#x7A0B;&#x6709;&#x76F8;&#x5E94;&#x7684;&#x8BF4;&#x660E;&#x3002;</em></p>
<h2 id="Node&#x4EB2;&#x548C;&#x6027;">2. Node&#x4EB2;&#x548C;&#x6027;</h2>
<p>Node&#x4EB2;&#x548C;&#x6027;&#x57FA;&#x7840;&#x63CF;&#x8FF0;:</p>
<p><img src="image/affinity/nodeAffinity.png" alt="C97CE27E-F20D-4EE1-B2E5-29D8211D99D2"></p>
<p>yml&#x914D;&#x7F6E;&#x5B9E;&#x4F8B;sample&#xFF1A;</p>
<pre class="language-"><code class="lang-yaml"><span class="token punctuation">---</span>
apiVersion<span class="token punctuation">:</span>v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> with<span class="token punctuation">-</span>node<span class="token punctuation">-</span>affinity
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
    <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>    <span class="token comment">#pod&#x5B9E;&#x4F8B;&#x90E8;&#x7F72;&#x5728;prd-zone-A &#x6216; prd-zone-B</span>
      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>
        <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> kubernetes.io/prd<span class="token punctuation">-</span>zone<span class="token punctuation">-</span>name
            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
            <span class="token key atrule">values</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> prd<span class="token punctuation">-</span>zone<span class="token punctuation">-</span>A
            <span class="token punctuation">-</span> prd<span class="token punctuation">-</span>zone<span class="token punctuation">-</span>B
      <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">preference</span><span class="token punctuation">:</span>
          <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> securityZone
            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
            <span class="token key atrule">values</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> BussinssZone
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> with<span class="token punctuation">-</span>node<span class="token punctuation">-</span>affinity
    <span class="token key atrule">image</span><span class="token punctuation">:</span> gcr.io/google_containers/pause<span class="token punctuation">:</span><span class="token number">2.0</span>
</code></pre>
<h3 id="Node&#x4EB2;&#x548C;&#x6027;&#x9884;&#x9009;&#x7B56;&#x7565;MatchNodeSelectorPred">2.1. Node&#x4EB2;&#x548C;&#x6027;&#x9884;&#x9009;&#x7B56;&#x7565;MatchNodeSelectorPred</h3>
<p><strong>&#x7B56;&#x7565;&#x8BF4;&#x660E;&#xFF1A;</strong></p>
<p>&#x57FA;&#x4E8E;NodeSelector&#x548C;NodeAffinity&#x5B9A;&#x4E49;&#x4E3A;&#x88AB;&#x8C03;&#x5EA6;&#x7684;pod&#x9009;&#x62E9;&#x76F8;&#x5339;&#x914D;&#x7684;Node&#xFF08;Nodes Labels&#xFF09;</p>
<p><strong>&#x9002;&#x7528;NodeAffinity&#x914D;&#x7F6E;&#x9879;</strong>&#xFF1A; </p>
<p>NodeAffinity.<code>Required</code>DuringSchedulingIgnoredDuringExecution </p>
<p><strong>&#x9884;&#x9009;&#x7B56;&#x7565;&#x6E90;&#x7801;&#x5206;&#x6790;&#xFF1A;</strong></p>
<ol>
<li><strong><em>&#x7B56;&#x7565;&#x6CE8;&#x518C;</em></strong>&#xFF1A; defaults.init()&#x6CE8;&#x518C;&#x4E86;&#x4E00;&#x6761;&#x540D;&#x4E3A;&#x201C;MatchNodeSelectorPred&#x201D;&#x9884;&#x9009;&#x7B56;&#x7565;&#x9879;,&#x7B56;&#x7565;Func&#x662F;PodMatchNodeSelector()</li>
</ol>
<div><p class="code-filename">pkg/scheduler/algorithmprovider/defaults/defaults.go:78</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
factory<span class="token punctuation">.</span><span class="token function">RegisterFitPredicate</span><span class="token punctuation">(</span>predicates<span class="token punctuation">.</span>MatchNodeSelectorPred<span class="token punctuation">,</span> predicates<span class="token punctuation">.</span>PodMatchNodeSelector<span class="token punctuation">)</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
<ol>
<li><strong><em>&#x7B56;&#x7565;Func</em></strong>:  <strong>PodMatchNodeSelector()</strong> </li>
</ol>
<p>&#x83B7;&#x53D6;&#x76EE;&#x6807;Node&#x4FE1;&#x606F;,&#x8C03;&#x7528;podMatchesNodeSelectorAndAffinityTerms()&#x5BF9;&#x88AB;&#x8C03;&#x5EA6;pod&#x548C;&#x76EE;&#x6807;node&#x8FDB;&#x884C;&#x4EB2;&#x548C;&#x6027;&#x5339;&#x914D;&#x3002; &#x5982;&#x679C;&#x7B26;&#x5408;&#x5219;&#x8FD4;&#x56DE;true,&#x53CD;&#x4E4B;false&#x5E76;&#x8BB0;&#x5F55;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x3002; </p>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/predicates.go:853</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">PodMatchNodeSelector</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> meta algorithm<span class="token punctuation">.</span>PredicateMetadata<span class="token punctuation">,</span> nodeInfo <span class="token operator">*</span>schedulercache<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>algorithm<span class="token punctuation">.</span>PredicateFailureReason<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// &#x83B7;&#x53D6;node&#x4FE1;&#x606F;</span>
    node <span class="token operator">:=</span> nodeInfo<span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> node <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;node not found&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token comment">// &#x5173;&#x952E;&#x5B50;&#x903B;&#x8F91;func</span>
  <span class="token comment">// &#x8F93;&#x5165;&#x53C2;&#x6570;:&#x88AB;&#x8C03;&#x5EA6;&#x7684;pod&#x548C;&#x524D;&#x9762;&#x83B7;&#x53D6;&#x7684;node(&#x88AB;&#x68C0;&#x6D4B;&#x7684;node)</span>
    <span class="token keyword">if</span> <span class="token function">podMatchesNodeSelectorAndAffinityTerms</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>algorithm<span class="token punctuation">.</span>PredicateFailureReason<span class="token punctuation">{</span>ErrNodeSelectorNotMatch<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>&#x200B;    <strong>podMatchesNodeSelectorAndAffinityTerms()</strong></p>
<p>&#x200B;    NodeSelector&#x548C;NodeAffinity&#x5B9A;&#x4E49;&#x7684;&quot;&#x5FC5;&#x8981;&#x6761;&#x4EF6;&quot;&#x914D;&#x7F6E;&#x5339;&#x914D;&#x68C0;&#x6D4B;</p>
</blockquote>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/predicates.go:807</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">podMatchesNodeSelectorAndAffinityTerms</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> node <span class="token operator">*</span>v1<span class="token punctuation">.</span>Node<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
  <span class="token comment">// &#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E86;NodeSelector,&#x5219;&#x68C0;&#x6D4B;Node labels&#x662F;&#x5426;&#x6EE1;&#x8DB3;NodeSelector&#x6240;&#x5B9A;&#x4E49;&#x7684;&#x6240;&#x6709;terms&#x9879;.   </span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>NodeSelector<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        selector <span class="token operator">:=</span> labels<span class="token punctuation">.</span><span class="token function">SelectorFromSet</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>NodeSelector<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>selector<span class="token punctuation">.</span><span class="token function">Matches</span><span class="token punctuation">(</span>labels<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Labels<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token comment">//&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E86;NodeAffinity&#xFF0C;&#x5219;&#x8FDB;&#x884C;Node&#x4EB2;&#x548C;&#x6027;&#x5339;&#x914D;  nodeMatchesNodeSelectorTerms() *[&#x540E;&#x9762;&#x6709;&#x8BE6;&#x7EC6;&#x5206;&#x6790;]* </span>
    nodeAffinityMatches <span class="token operator">:=</span> <span class="token boolean">true</span>
    affinity <span class="token operator">:=</span> pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Affinity
    <span class="token keyword">if</span> affinity <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> affinity<span class="token punctuation">.</span>NodeAffinity <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        nodeAffinity <span class="token operator">:=</span> affinity<span class="token punctuation">.</span>NodeAffinity
        <span class="token keyword">if</span> nodeAffinity<span class="token punctuation">.</span>RequiredDuringSchedulingIgnoredDuringExecution <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> nodeAffinity<span class="token punctuation">.</span>RequiredDuringSchedulingIgnoredDuringExecution <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            nodeSelectorTerms <span class="token operator">:=</span> nodeAffinity<span class="token punctuation">.</span>RequiredDuringSchedulingIgnoredDuringExecution<span class="token punctuation">.</span>NodeSelectorTerms
            klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Match for RequiredDuringSchedulingIgnoredDuringExecution node selector terms %+v&quot;</span><span class="token punctuation">,</span> nodeSelectorTerms<span class="token punctuation">)</span>

      <span class="token comment">// &#x5173;&#x952E;&#x5904;&#x7406;func: nodeMatchesNodeSelectorTerms()                             </span>
            nodeAffinityMatches <span class="token operator">=</span> nodeAffinityMatches <span class="token operator">&amp;&amp;</span> <span class="token function">nodeMatchesNodeSelectorTerms</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> nodeSelectorTerms<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> nodeAffinityMatches
<span class="token punctuation">}</span>
</code></pre>
<p><em>&#x6CE8;</em>&#xFF1A;</p>
<ul>
<li><p><em>NodeSelector&#x548C;NodeAffinity.Require... &#x90FD;&#x5B58;&#x5728;&#x914D;&#x7F6E;&#x5219;<code>&#x90FD;</code>&#x9700;True&#xFF1B;</em></p>
</li>
<li><p><em>&#x5982;&#x679C;NodeSelector&#x5931;&#x8D25;&#x5219;&#x76F4;&#x63A5;false,&#x4E0D;&#x5904;&#x7406;NodeAffinity;</em></p>
</li>
<li><p><em>&#x5982;&#x679C;&#x6307;&#x5B9A;&#x4E86;&#x591A;&#x4E2A; NodeSelectorTerms&#xFF0C;&#x90A3; node&#x53EA;&#x8981;&#x6EE1;&#x8DB3;<code>&#x5176;&#x4E2D;&#x4E00;&#x4E2A;</code>&#x6761;&#x4EF6;;</em></p>
</li>
<li><p><em>&#x5982;&#x679C;&#x6307;&#x5B9A;&#x4E86;&#x591A;&#x4E2A; MatchExpressions&#xFF0C;&#x90A3;&#x5FC5;&#x987B;&#x8981;&#x6EE1;&#x8DB3;<code>&#x6240;&#x6709;</code>&#x6761;&#x4EF6;.</em></p>
</li>
</ul>
<p> <strong>nodeMatchesNodeSelectorTerms()</strong> 
&#x8C03;&#x7528;v1helper.MatchNodeSelectorTerms()&#x8FDB;&#x884C;NodeSelectorTerm&#x5B9A;&#x4E49;&#x7684;&#x5FC5;&#x8981;&#x6761;&#x4EF6;&#x8FDB;&#x884C;&#x68C0;&#x6D4B;&#x662F;&#x5426;&#x7B26;&#x5408;&#x3002;
&#x5173;&#x952E;&#x7684;&#x914D;&#x7F6E;&#x5B9A;&#x4E49;&#x5206;&#x4E3A;&#x4E24;&#x7C7B;(matchExpressions/matchFileds)&#xFF1A;
<em>-&#x201C;requiredDuringSchedulingIgnoredDuringExecution.<strong>matchExpressions</strong>&#x201D;&#x5B9A;&#x4E49;&#x68C0;&#x6D4B;(&#x5339;&#x914D;key&#x4E0E;value)</em>
<em>-&#x201C;requiredDuringSchedulingIgnoredDuringExecution.<strong>matchFileds</strong>&#x201D;&#x5B9A;&#x4E49;&#x68C0;&#x6D4B;(&#x4E0D;&#x5339;&#x914D;key&#xFF0C;&#x53EA;value)</em></p>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/predicates.go:797</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">nodeMatchesNodeSelectorTerms</span><span class="token punctuation">(</span>node <span class="token operator">*</span>v1<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> nodeSelectorTerms <span class="token punctuation">[</span><span class="token punctuation">]</span>v1<span class="token punctuation">.</span>NodeSelectorTerm<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    nodeFields <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// &#x83B7;&#x53D6;&#x68C0;&#x6D4B;&#x76EE;&#x6807;node&#x7684;Filelds</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> algorithm<span class="token punctuation">.</span>NodeFieldSelectorKeys <span class="token punctuation">{</span>
        nodeFields<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token comment">// &#x8C03;&#x7528;v1helper.MatchNodeSelectorTerms()</span>
  <span class="token comment">// &#x53C2;&#x6570;&#xFF1A;nodeSelectorTerms  &#x4EB2;&#x548C;&#x6027;&#x914D;&#x7F6E;&#x7684;&#x5FC5;&#x8981;&#x6761;&#x4EF6;Terms</span>
  <span class="token comment">//      labels             &#x88AB;&#x68C0;&#x6D4B;&#x7684;&#x76EE;&#x6807;node&#x7684;label&#x5217;&#x8868; </span>
  <span class="token comment">//      fields             &#x88AB;&#x68C0;&#x6D4B;&#x7684;&#x76EE;&#x6807;node filed&#x5217;&#x8868;</span>
    <span class="token keyword">return</span> v1helper<span class="token punctuation">.</span><span class="token function">MatchNodeSelectorTerms</span><span class="token punctuation">(</span>nodeSelectorTerms<span class="token punctuation">,</span> labels<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Labels<span class="token punctuation">)</span><span class="token punctuation">,</span> fields<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>nodeFields<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// pkg/apis/core/v1/helper/helpers.go:302</span>
<span class="token keyword">func</span> <span class="token function">MatchNodeSelectorTerms</span><span class="token punctuation">(</span> nodeSelectorTerms <span class="token punctuation">[</span><span class="token punctuation">]</span>v1<span class="token punctuation">.</span>NodeSelectorTerm<span class="token punctuation">,</span>
    nodeLabels labels<span class="token punctuation">.</span>Set<span class="token punctuation">,</span> nodeFields fields<span class="token punctuation">.</span>Set<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> req <span class="token operator">:=</span> <span class="token keyword">range</span> nodeSelectorTerms <span class="token punctuation">{</span>
        <span class="token comment">// nil or empty term selects no objects</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>MatchExpressions<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>MatchFields<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
    <span class="token comment">// MatchExpressions&#x6761;&#x4EF6;&#x8868;&#x8FBE;&#x5F0F;&#x5339;&#x914D;                                             &#x2460; </span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>MatchExpressions<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            labelSelector<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">NodeSelectorRequirementsAsSelector</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>MatchExpressions<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token operator">!</span>labelSelector<span class="token punctuation">.</span><span class="token function">Matches</span><span class="token punctuation">(</span>nodeLabels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token comment">// MatchFields&#x6761;&#x4EF6;&#x8868;&#x8FBE;&#x5F0F;&#x5339;&#x914D;                                                   &#x2461;</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>MatchFields<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            fieldSelector<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">NodeSelectorRequirementsAsFieldSelector</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>MatchFields<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token operator">!</span>fieldSelector<span class="token punctuation">.</span><span class="token function">Matches</span><span class="token punctuation">(</span>nodeFields<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x2460;  <em>NodeSelectorRequirementAsSelector()</em>
&#x662F;&#x5BF9;&#x201C;requiredDuringSchedulingIgnoredDuringExecution.matchExpressions&quot;&#x6240;&#x914D;&#x7F6E;&#x7684;&#x8868;&#x8FBE;&#x5F0F;&#x8FDB;&#x884C;Selector&#x8868;&#x8FBE;&#x5F0F;&#x8FDB;&#x884C;&#x683C;&#x5F0F;&#x5316;&#x52A0;&#x5DE5;&#xFF0C;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;labels.Selector&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;. [<em>&#x672C;&#x6587;&#x5F00;&#x5934;1.2&#x7AE0;&#x8282;&#x6709;&#x5206;&#x6790;</em>]</p>
<div><p class="code-filename">pkg/apis/core/v1/helper/helpers.go:222</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">NodeSelectorRequirementsAsSelector</span><span class="token punctuation">(</span>nsm <span class="token punctuation">[</span><span class="token punctuation">]</span>v1<span class="token punctuation">.</span>NodeSelectorRequirement<span class="token punctuation">)</span> <span class="token punctuation">(</span>labels<span class="token punctuation">.</span>Selector<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>nsm<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> labels<span class="token punctuation">.</span><span class="token function">Nothing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    selector <span class="token operator">:=</span> labels<span class="token punctuation">.</span><span class="token function">NewSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> expr <span class="token operator">:=</span> <span class="token keyword">range</span> nsm <span class="token punctuation">{</span>
        <span class="token keyword">var</span> op selection<span class="token punctuation">.</span>Operator
        <span class="token keyword">switch</span> expr<span class="token punctuation">.</span>Operator <span class="token punctuation">{</span>
        <span class="token keyword">case</span> v1<span class="token punctuation">.</span>NodeSelectorOpIn<span class="token punctuation">:</span>
            op <span class="token operator">=</span> selection<span class="token punctuation">.</span>In
        <span class="token keyword">case</span> v1<span class="token punctuation">.</span>NodeSelectorOpNotIn<span class="token punctuation">:</span>
            op <span class="token operator">=</span> selection<span class="token punctuation">.</span>NotIn
        <span class="token keyword">case</span> v1<span class="token punctuation">.</span>NodeSelectorOpExists<span class="token punctuation">:</span>
            op <span class="token operator">=</span> selection<span class="token punctuation">.</span>Exists
        <span class="token keyword">case</span> v1<span class="token punctuation">.</span>NodeSelectorOpDoesNotExist<span class="token punctuation">:</span>
            op <span class="token operator">=</span> selection<span class="token punctuation">.</span>DoesNotExist
        <span class="token keyword">case</span> v1<span class="token punctuation">.</span>NodeSelectorOpGt<span class="token punctuation">:</span>
            op <span class="token operator">=</span> selection<span class="token punctuation">.</span>GreaterThan
        <span class="token keyword">case</span> v1<span class="token punctuation">.</span>NodeSelectorOpLt<span class="token punctuation">:</span>
            op <span class="token operator">=</span> selection<span class="token punctuation">.</span>LessThan
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%q is not a valid node selector operator&quot;</span><span class="token punctuation">,</span> expr<span class="token punctuation">.</span>Operator<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// &#x8868;&#x8FBE;&#x5F0F;&#x7684;&#x4E09;&#x4E2A;&#x5173;&#x952E;&#x8981;&#x7D20;&#xFF1A; expr.Key, op, expr.Values </span>
        r<span class="token punctuation">,</span> err <span class="token operator">:=</span> labels<span class="token punctuation">.</span><span class="token function">NewRequirement</span><span class="token punctuation">(</span>expr<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> op<span class="token punctuation">,</span> expr<span class="token punctuation">.</span>Values<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        selector <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token operator">*</span>r<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> selector<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p> &#x2461; <em>NodeSelectorRequirementAs<code>Field</code>Selector()</em>
&#x662F;&#x5BF9;&#x201C;requiredDuringSchedulingIgnoredDuringExecution.matchFields&quot;&#x6240;&#x914D;&#x7F6E;&#x7684;&#x8868;&#x8FBE;&#x5F0F;&#x8FDB;&#x884C;Selector&#x8868;&#x8FBE;&#x5F0F;&#x8FDB;&#x884C;&#x683C;&#x5F0F;&#x5316;&#x52A0;&#x5DE5;&#xFF0C;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;Fields.Selector&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;.</p>
<div><p class="code-filename">pkg/apis/core/v1/helper/helpers.go:256</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">NodeSelectorRequirementsAsFieldSelector</span><span class="token punctuation">(</span>nsm <span class="token punctuation">[</span><span class="token punctuation">]</span>v1<span class="token punctuation">.</span>NodeSelectorRequirement<span class="token punctuation">)</span> <span class="token punctuation">(</span>fields<span class="token punctuation">.</span>Selector<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>nsm<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> fields<span class="token punctuation">.</span><span class="token function">Nothing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    selectors <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>fields<span class="token punctuation">.</span>Selector<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> expr <span class="token operator">:=</span> <span class="token keyword">range</span> nsm <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> expr<span class="token punctuation">.</span>Operator <span class="token punctuation">{</span>
        <span class="token keyword">case</span> v1<span class="token punctuation">.</span>NodeSelectorOpIn<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>expr<span class="token punctuation">.</span>Values<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unexpected number of value (%d) for node field selector operator %q&quot;</span><span class="token punctuation">,</span>
                    <span class="token function">len</span><span class="token punctuation">(</span>expr<span class="token punctuation">.</span>Values<span class="token punctuation">)</span><span class="token punctuation">,</span> expr<span class="token punctuation">.</span>Operator<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            selectors <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>selectors<span class="token punctuation">,</span> fields<span class="token punctuation">.</span><span class="token function">OneTermEqualSelector</span><span class="token punctuation">(</span>expr<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> expr<span class="token punctuation">.</span>Values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">case</span> v1<span class="token punctuation">.</span>NodeSelectorOpNotIn<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>expr<span class="token punctuation">.</span>Values<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unexpected number of value (%d) for node field selector operator %q&quot;</span><span class="token punctuation">,</span>
                    <span class="token function">len</span><span class="token punctuation">(</span>expr<span class="token punctuation">.</span>Values<span class="token punctuation">)</span><span class="token punctuation">,</span> expr<span class="token punctuation">.</span>Operator<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            selectors <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>selectors<span class="token punctuation">,</span> fields<span class="token punctuation">.</span><span class="token function">OneTermNotEqualSelector</span><span class="token punctuation">(</span>expr<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> expr<span class="token punctuation">.</span>Values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%q is not a valid node field selector operator&quot;</span><span class="token punctuation">,</span> expr<span class="token punctuation">.</span>Operator<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> fields<span class="token punctuation">.</span><span class="token function">AndSelectors</span><span class="token punctuation">(</span>selectors<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<ol>
<li><strong>&#x5173;&#x952E;&#x6570;&#x636E;&#x7ED3;&#x6784;</strong>
<strong>NodeSelector</strong>&#x76F8;&#x5173;&#x7ED3;&#x6784;&#x7684;&#x5B9A;&#x4E49;</li>
</ol>
<div><p class="code-filename">vendor/k8s.io/api/core/v1/types.go:2436</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> NodeSelector <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    NodeSelectorTerms <span class="token punctuation">[</span><span class="token punctuation">]</span>NodeSelectorTerm <span class="token string">`json:&quot;nodeSelectorTerms&quot; protobuf:&quot;bytes,1,rep,name=nodeSelectorTerms&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> NodeSelectorTerm <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    MatchExpressions <span class="token punctuation">[</span><span class="token punctuation">]</span>NodeSelectorRequirement <span class="token string">`json:&quot;matchExpressions,omitempty&quot; protobuf:&quot;bytes,1,rep,name=matchExpressions&quot;`</span>
    MatchFields <span class="token punctuation">[</span><span class="token punctuation">]</span>NodeSelectorRequirement <span class="token string">`json:&quot;matchFields,omitempty&quot; protobuf:&quot;bytes,2,rep,name=matchFields&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> NodeSelectorRequirement <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Key <span class="token builtin">string</span> <span class="token string">`json:&quot;key&quot; protobuf:&quot;bytes,1,opt,name=key&quot;`</span>
    Operator NodeSelectorOperator <span class="token string">`json:&quot;operator&quot; protobuf:&quot;bytes,2,opt,name=operator,casttype=NodeSelectorOperator&quot;`</span>
    Values <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:&quot;values,omitempty&quot; protobuf:&quot;bytes,3,rep,name=values&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> NodeSelectorOperator <span class="token builtin">string</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
    NodeSelectorOpIn           NodeSelectorOperator <span class="token operator">=</span> <span class="token string">&quot;In&quot;</span>
    NodeSelectorOpNotIn        NodeSelectorOperator <span class="token operator">=</span> <span class="token string">&quot;NotIn&quot;</span>
    NodeSelectorOpExists       NodeSelectorOperator <span class="token operator">=</span> <span class="token string">&quot;Exists&quot;</span>
    NodeSelectorOpDoesNotExist NodeSelectorOperator <span class="token operator">=</span> <span class="token string">&quot;DoesNotExist&quot;</span>
    NodeSelectorOpGt           NodeSelectorOperator <span class="token operator">=</span> <span class="token string">&quot;Gt&quot;</span>
    NodeSelectorOpLt           NodeSelectorOperator <span class="token operator">=</span> <span class="token string">&quot;Lt&quot;</span>
<span class="token punctuation">)</span>
</code></pre>
<p><strong>FieldsSelector</strong>&#x5B9E;&#x73B0;&#x7C7B;&#x7684;&#x7ED3;&#x6784;&#x5B9A;&#x4E49;&#xFF08;<code>Match value</code>)</p>
<div><p class="code-filename">vendor/k8s.io/apimachinery/pkg/fields/selector.go:78</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> hasTerm <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    field<span class="token punctuation">,</span> value <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>hasTerm<span class="token punctuation">)</span> <span class="token function">Matches</span><span class="token punctuation">(</span>ls Fields<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> ls<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>field<span class="token punctuation">)</span> <span class="token operator">==</span> t<span class="token punctuation">.</span>value
<span class="token punctuation">}</span>

<span class="token keyword">type</span> notHasTerm <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    field<span class="token punctuation">,</span> value <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>notHasTerm<span class="token punctuation">)</span> <span class="token function">Matches</span><span class="token punctuation">(</span>ls Fields<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> ls<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>field<span class="token punctuation">)</span> <span class="token operator">!=</span> t<span class="token punctuation">.</span>value
<span class="token punctuation">}</span>
</code></pre>
<h3 id="Node&#x4EB2;&#x548C;&#x6027;&#x4F18;&#x9009;&#x7B56;&#x7565;NodeAffinityPriority">2.2. Node&#x4EB2;&#x548C;&#x6027;&#x4F18;&#x9009;&#x7B56;&#x7565;NodeAffinityPriority</h3>
<p><strong>&#x7B56;&#x7565;&#x8BF4;&#x660E;&#xFF1A;</strong></p>
<p>&#x901A;&#x8FC7;&#x88AB;&#x8C03;&#x5EA6;&#x7684;pod&#x4EB2;&#x548C;&#x6027;&#x914D;&#x7F6E;&#x5B9A;&#x4E49;&#x6761;&#x4EF6;&#xFF0C;&#x5BF9;&#x6F5C;&#x5728;&#x53EF;&#x88AB;&#x8C03;&#x5EA6;&#x8FD0;&#x884C;&#x7684;Nodes&#x8FDB;&#x884C;&#x4EB2;&#x548C;&#x6027;&#x5339;&#x914D;&#x5E76;&#x8BC4;&#x5206;.</p>
<p><strong>&#x9002;&#x7528;NodeAffinity&#x914D;&#x7F6E;&#x9879;</strong>&#xFF1A; </p>
<p>NodeAffinity.PreferredDuringSchedulingIgnoredDuringExecution </p>
<p><strong>&#x9884;&#x9009;&#x7B56;&#x7565;&#x6E90;&#x7801;&#x5206;&#x6790;&#xFF1A;</strong></p>
<ol>
<li><p><strong><em>&#x7B56;&#x7565;&#x6CE8;&#x518C;</em></strong>&#xFF1A;defaultPriorities()&#x6CE8;&#x518C;&#x4E86;&#x4E00;&#x6761;&#x540D;&#x4E3A;&#x201C;NodeAffinityPriority&#x201D;&#x4F18;&#x9009;&#x7B56;&#x7565;&#x9879;.&#x5E76;&#x6CE8;&#x518C;&#x4E86;&#x7B56;&#x7565;&#x7684;&#x4E24;&#x4E2A;&#x65B9;&#x6CD5;Map/Reduce&#xFF1A; </p>
<ul>
<li>CalculateNodeAffinityPriorityMap()  map&#x8BA1;&#x7B97;&#xFF0C; &#x5BF9;&#x6F5C;&#x5728;&#x88AB;&#x8C03;&#x5EA6;Node&#x8FDB;&#x884C;&#x4EB2;&#x548C;&#x5339;&#x914D;&#xFF0C;&#x5E76;&#x4E3A;&#x5176;&#x8BA1;&#x6743;&#x91CD;&#x5F97;&#x5206;. </li>
<li>CalculateNodeAffinityPriorityReduce()  reduce&#x8BA1;&#x7B97;&#xFF0C;&#x91CD;&#x65B0;&#x7EDF;&#x8BA1;&#x5F97;&#x5206;,&#x53D6;&#x503C;&#x533A;&#x95F4;0~10. </li>
</ul>
</li>
</ol>
<div><p class="code-filename">pkg/scheduler/algorithmprovider/defaults/defaults.go:266</p></div>
<pre class="language-"><code class="lang-go"><span class="token comment">//k8s.io/kubernetes/pkg/scheduler/algorithmprovider/defaults/defaults.go/algorithmprovider/defaults.go </span>

<span class="token keyword">func</span> <span class="token function">defaultPriorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> sets<span class="token punctuation">.</span>String <span class="token punctuation">{</span>
  <span class="token operator">...</span>

factory<span class="token punctuation">.</span><span class="token function">RegisterPriorityFunction2</span><span class="token punctuation">(</span><span class="token string">&quot;NodeAffinityPriority&quot;</span><span class="token punctuation">,</span> priorities<span class="token punctuation">.</span>CalculateNodeAffinityPriorityMap<span class="token punctuation">,</span> priorities<span class="token punctuation">.</span>CalculateNodeAffinityPriorityReduce<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
<ol>
<li><p><strong><em>&#x7B56;&#x7565;Func</em></strong>:</p>
<blockquote>
<p><code>map&#x8BA1;&#x7B97;</code>  <strong>CalculateNodeAffinityPriorityMap()</strong></p>
<pre class="language-"><code>   &#x904D;&#x5386;affinity.NodeAffinity.PreferredDuringSchedulingIgnoredDuringExecution&#x6240; &#x5B9A;&#x4E49;&#x7684;Terms&#x89E3;NodeSelector&#x5BF9;&#x8C61;(labels.selector)&#x540E;&#xFF0C;&#x5BF9;&#x6F5C;&#x5728;&#x88AB;&#x8C03;&#x5EA6;Node&#x7684;labels&#x8FDB;&#x884C;Match&#x5339;&#x914D;&#x68C0;&#x6D4B;&#xFF0C;&#x5982;&#x679C;&#x5339;&#x914D;&#x5219;&#x5C06;&#x6761;&#x4EF6;&#x6240;&#x7ED9;&#x5B9A;&#x7684;Weight&#x6743;&#x91CD;&#x503C;&#x7D2F;&#x8BA1;&#x3002; &#x6700;&#x540E;&#x5C06;&#x8FD4;&#x56DE;&#x5404;&#x6F5C;&#x5728;&#x7684;&#x88AB;&#x8C03;&#x5EA6;Node&#x6700;&#x540E;&#x5206;&#x503C;&#x3002; 
</code></pre></blockquote>
</li>
</ol>
<div><p class="code-filename">pkg/scheduler/algorithm/priorities/node_affinity.go:34</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">CalculateNodeAffinityPriorityMap</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> meta <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> nodeInfo <span class="token operator">*</span>schedulercache<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">)</span> <span class="token punctuation">(</span>schedulerapi<span class="token punctuation">.</span>HostPriority<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x83B7;&#x53D6;&#x88AB;&#x68C0;&#x6D4B;&#x7684;Node&#x4FE1;&#x606F;</span>
  node <span class="token operator">:=</span> nodeInfo<span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> node <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> schedulerapi<span class="token punctuation">.</span>HostPriority<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;node not found&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// &#x9ED8;&#x8BA4;&#x4E3A;Spec&#x914D;&#x7F6E;&#x7684;Affinity</span>
    affinity <span class="token operator">:=</span> pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Affinity
    <span class="token keyword">if</span> priorityMeta<span class="token punctuation">,</span> ok <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>priorityMetadata<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        <span class="token comment">// We were able to parse metadata, use affinity from there.</span>
        affinity <span class="token operator">=</span> priorityMeta<span class="token punctuation">.</span>affinity
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> count <span class="token builtin">int32</span>
    <span class="token keyword">if</span> affinity <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> affinity<span class="token punctuation">.</span>NodeAffinity <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> affinity<span class="token punctuation">.</span>NodeAffinity<span class="token punctuation">.</span>PreferredDuringSchedulingIgnoredDuringExecution <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x904D;&#x5386;PreferredDuringSchedulingIgnoredDuringExecution&#x5B9A;&#x4E49;&#x7684;`&#x5FC5;&#x8981;&#x6761;&#x4EF6;&#x9879;`(Terms)</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> affinity<span class="token punctuation">.</span>NodeAffinity<span class="token punctuation">.</span>PreferredDuringSchedulingIgnoredDuringExecution <span class="token punctuation">{</span>
            preferredSchedulingTerm <span class="token operator">:=</span> <span class="token operator">&amp;</span>affinity<span class="token punctuation">.</span>NodeAffinity<span class="token punctuation">.</span>PreferredDuringSchedulingIgnoredDuringExecution<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">if</span> preferredSchedulingTerm<span class="token punctuation">.</span>Weight <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>  <span class="token comment">//&#x6CE8;&#x610F;&#x524D;&#x7AEF;&#x7684;&#x914D;&#x7F6E;&#xFF0C;&#x5982;&#x679C;weight&#x4E3A;0&#x5219;&#x4E0D;&#x505A;&#x4EFB;&#x4F55;&#x5904;&#x7406;</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// TODO: Avoid computing it for all nodes if this becomes a performance problem.</span>
      <span class="token comment">// &#x83B7;&#x53D6;node&#x4EB2;&#x548C;MatchExpression&#x8868;&#x8FBE;&#x5F0F;&#x6761;&#x4EF6;&#xFF0C;&#x5B9E;&#x4F8B;&#x5316;label.Selector&#x5BF9;&#x8C61;.  </span>
            nodeSelector<span class="token punctuation">,</span> err <span class="token operator">:=</span> v1helper<span class="token punctuation">.</span><span class="token function">NodeSelectorRequirementsAsSelector</span><span class="token punctuation">(</span>preferredSchedulingTerm<span class="token punctuation">.</span>Preference<span class="token punctuation">.</span>MatchExpressions<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> schedulerapi<span class="token punctuation">.</span>HostPriority<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> nodeSelector<span class="token punctuation">.</span><span class="token function">Matches</span><span class="token punctuation">(</span>labels<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Labels<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                count <span class="token operator">+=</span> preferredSchedulingTerm<span class="token punctuation">.</span>Weight
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
     <span class="token comment">// &#x8FD4;&#x56DE;Node&#x5F97;&#x5206;</span>
    <span class="token keyword">return</span> schedulerapi<span class="token punctuation">.</span>HostPriority<span class="token punctuation">{</span>
        Host<span class="token punctuation">:</span>  node<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
        Score<span class="token punctuation">:</span> <span class="token function">int</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p> &#x518D;&#x6B21;&#x770B;&#x5230;&#x524D;&#x9762;(&#x9884;&#x9009;&#x7B56;&#x7565;&#x5206;&#x6790;&#x65F6;)&#x5206;&#x6790;&#x8FC7;&#x7684;NodeSelectorRequirementAsSelector()<br><code>&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;labels.Selector&#x5B9E;&#x4F8B;&#x5BF9;&#x8C61;</code> &#x4F7F;&#x7528;selector.Matches&#x5BF9;node.Labels&#x8FDB;&#x884C;&#x5339;&#x914D;&#x662F;&#x5426;&#x7B26;&#x5408;&#x6761;&#x4EF6;.</p>
<blockquote>
<p> <code>reduce&#x8BA1;&#x7B97;</code>  <strong>CalculateNodeAffinityPriorityReduce()</strong></p>
<p> &#x5C06;&#x5404;&#x4E2A;node&#x7684;&#x6700;&#x540E;&#x5F97;&#x5206;&#x91CD;&#x65B0;&#x8BA1;&#x7B97;&#x5206;&#x5E03;&#x533A;&#x95F4;&#x5728;0&#x301C;10.</p>
<p> &#x4EE3;&#x7801;&#x5185;&#x7ED9;&#x5B9A;&#x4E00;&#x4E2A;NormalizeReduce()&#x65B9;&#x6CD5;&#xFF0C;MaxPriority&#x503C;&#x4E3A;10,reverse&#x53D6;&#x53CD;false&#x5173;&#x95ED;</p>
</blockquote>
<div><p class="code-filename">pkg/scheduler/algorithm/priorities/node_affinity.go:77</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">const</span>    MaxPriority <span class="token operator">=</span> <span class="token number">10</span>
<span class="token keyword">var</span> CalculateNodeAffinityPriorityReduce <span class="token operator">=</span> <span class="token function">NormalizeReduce</span><span class="token punctuation">(</span>schedulerapi<span class="token punctuation">.</span>MaxPriority<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
</code></pre>
<p>NormalizeReduce() </p>
<ul>
<li>&#x7ED3;&#x679C;&#x8BC4;&#x5206;&#x53D6;&#x503C;0&#x301C;MaxPriority</li>
<li>reverse&#x53D6;&#x53CD;&#x4E3A;true&#x65F6;&#xFF0C;&#x6700;&#x7EC8;&#x8BC4;&#x5206;=(MaxPriority-&#x5176;&#x539F;&#x8BC4;&#x5206;&#x503C;&#xFF09; </li>
</ul>
<div><p class="code-filename">pkg/scheduler/algorithm/priorities/reduce.go:29</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">NormalizeReduce</span><span class="token punctuation">(</span>maxPriority <span class="token builtin">int</span><span class="token punctuation">,</span> reverse <span class="token builtin">bool</span><span class="token punctuation">)</span> algorithm<span class="token punctuation">.</span>PriorityReduceFunction <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>
        <span class="token boolean">_</span> <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span>
        <span class="token boolean">_</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token boolean">_</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>schedulercache<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">,</span>
        result schedulerapi<span class="token punctuation">.</span>HostPriorityList<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>

        <span class="token keyword">var</span> maxCount <span class="token builtin">int</span>
        <span class="token comment">// &#x53D6;&#x51FA;&#x6700;&#x5927;&#x7684;&#x503C;</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> result <span class="token punctuation">{</span>
            <span class="token keyword">if</span> result<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Score <span class="token operator">&gt;</span> maxCount <span class="token punctuation">{</span>
                maxCount <span class="token operator">=</span> result<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Score
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token comment">// &#x5982;&#x679C;&#x6700;&#x5927;&#x7684;&#x503C;&#x4E3A;0&#xFF0C;&#x4E14;&#x53D6;&#x53CD;&#x8BBE;&#x4E3A;&#x771F;&#xFF0C;&#x5219;&#x5C06;&#x6240;&#x6709;&#x7684;&#x8BC4;&#x5206;&#x8BBE;&#x7F6E;&#x4E3A;MaxPriority</span>
        <span class="token keyword">if</span> maxCount <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> reverse <span class="token punctuation">{</span>
                <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> result <span class="token punctuation">{</span>
                    result<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Score <span class="token operator">=</span> maxPriority
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// &#x8BA1;&#x7B97;&#x540E;&#x5F97;&#x5206; = maxPrority * &#x539F;&#x5206;&#x503C; / &#x6700;&#x5927;&#x503C;</span>
        <span class="token comment">// &#x5982;&#x679C;&#x53D6;&#x53CD;&#x4E3A;&#x771F;&#x5219; maxPrority - &#x8BA1;&#x7B97;&#x540E;&#x5F97;&#x5206;</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> result <span class="token punctuation">{</span>
            score <span class="token operator">:=</span> result<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Score

            score <span class="token operator">=</span> maxPriority <span class="token operator">*</span> score <span class="token operator">/</span> maxCount
            <span class="token keyword">if</span> reverse <span class="token punctuation">{</span>
                score <span class="token operator">=</span> maxPriority <span class="token operator">-</span> score
            <span class="token punctuation">}</span>

            result<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Score <span class="token operator">=</span> score
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="Pod&#x4EB2;&#x548C;&#x6027;">3. Pod&#x4EB2;&#x548C;&#x6027;</h2>
<p>Pod&#x4EB2;&#x548C;&#x6027;&#x57FA;&#x7840;&#x63CF;&#x8FF0;:</p>
<p><img src="image/affinity/podAffinity.png" alt="image-20190416170112768"></p>
<p>yml&#x914D;&#x7F6E;&#x5B9E;&#x4F8B;sample&#xFF1A;</p>
<pre class="language-"><code class="lang-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> affinity
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> affinity
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> affinity
        <span class="token key atrule">role</span><span class="token punctuation">:</span> lab<span class="token punctuation">-</span>web
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.9.0
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx_web_Lab
      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>                     <span class="token comment">#&#x4E3A;&#x5B9E;&#x73B0;&#x9AD8;&#x53EF;&#x7528;&#xFF0C;&#x4E09;&#x4E2A;pod&#x5E94;&#x8BE5;&#x5206;&#x5E03;&#x5728;&#x4E0D;&#x540C;Node&#x4E0A;</span>
        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span> 
          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>  
          <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>
              <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app
                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                <span class="token key atrule">values</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> prod<span class="token punctuation">-</span>pod
            <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname
</code></pre>
<h3 id="Pod&#x4EB2;&#x548C;&#x6027;&#x9884;&#x9009;&#x7B56;&#x7565;MatchInterPodAffinityPred">3.1. Pod&#x4EB2;&#x548C;&#x6027;&#x9884;&#x9009;&#x7B56;&#x7565;MatchInterPodAffinityPred</h3>
<p><strong>&#x7B56;&#x7565;&#x8BF4;&#x660E;&#xFF1A;</strong></p>
<p>&#x5BF9;&#x9700;&#x88AB;&#x8C03;&#x5EA6;&#x7684;Pod&#x8FDB;&#x884C;&#x4EB2;&#x548C;/&#x53CD;&#x4EB2;&#x548C;&#x914D;&#x7F6E;&#x5339;&#x914D;&#x68C0;&#x6D4B;&#x76EE;&#x6807;Pods&#xFF0C;&#x7136;&#x540E;&#x83B7;&#x53D6;&#x6EE1;&#x8DB3;&#x4EB2;&#x548C;&#x6761;&#x4EF6;&#x7684;Pods&#x6240;&#x8FD0;&#x884C;&#x7684;Nodes
&#x200B;&#x7684; <strong>TopologyKey&#x7684;&#x503C;</strong>(&#x4EB2;&#x548C;&#x6027;pod&#x5B9A;&#x4E49;topologyKey)&#x4E0E;&#x76EE;&#x6807; Nodes&#x8FDB;&#x884C;&#x4E00;&#x4E00;&#x5339;&#x914D;&#x662F;&#x5426;&#x7B26;&#x5408;&#x6761;&#x4EF6;. </p>
<p><strong>&#x9002;&#x7528;NodeAffinity&#x914D;&#x7F6E;&#x9879;</strong>&#xFF1A; 
PodAffinity.<code>Required</code>DuringSchedulingIgnoredDuringExecution<br>PodAntiAffinity.<code>Required</code>DuringSchedulingIgnoredDuringExecution</p>
<p><strong>&#x9884;&#x9009;&#x7B56;&#x7565;&#x6E90;&#x7801;&#x5206;&#x6790;&#xFF1A;</strong></p>
<ol>
<li><strong><em>&#x7B56;&#x7565;&#x6CE8;&#x518C;</em></strong>&#xFF1A;defaultPredicates()&#x6CE8;&#x518C;&#x4E86;&#x4E00;&#x6761;&#x540D;&#x4E3A;&#x201C;MatchInterPodAffinity&#x201D;&#x9884;&#x9009;&#x7B56;&#x7565;&#x9879;.</li>
</ol>
<div><p class="code-filename">pkg/scheduler/algorithmprovider/defaults/defaults.go:143</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">defaultPredicates</span><span class="token punctuation">(</span><span class="token punctuation">)</span> sets<span class="token punctuation">.</span>String <span class="token punctuation">{</span>
  <span class="token operator">...</span>

factory<span class="token punctuation">.</span><span class="token function">RegisterFitPredicateFactory</span><span class="token punctuation">(</span>
            predicates<span class="token punctuation">.</span>MatchInterPodAffinityPred<span class="token punctuation">,</span>
            <span class="token keyword">func</span><span class="token punctuation">(</span>args factory<span class="token punctuation">.</span>PluginFactoryArgs<span class="token punctuation">)</span> algorithm<span class="token punctuation">.</span>FitPredicate <span class="token punctuation">{</span>
                <span class="token keyword">return</span> predicates<span class="token punctuation">.</span><span class="token function">NewPodAffinityPredicate</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">,</span> args<span class="token punctuation">.</span>PodLister<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
<ol>
<li><strong>&#x7B56;&#x7565;Func</strong>: <strong>checker.InterPodAffinityMatches()</strong>
Func&#x662F;&#x901A;&#x8FC7;NewPodAffinityProdicate()&#x5B9E;&#x4F8B;&#x5316;PodAffinityChecker&#x7C7B;&#x5BF9;&#x8C61;&#x540E;&#x8FD4;&#x56DE;&#x3002;</li>
</ol>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/predicates.go:1138</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">type</span> PodAffinityChecker <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    info      NodeInfo
    podLister algorithm<span class="token punctuation">.</span>PodLister
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewPodAffinityPredicate</span><span class="token punctuation">(</span>info NodeInfo<span class="token punctuation">,</span> podLister algorithm<span class="token punctuation">.</span>PodLister<span class="token punctuation">)</span> algorithm<span class="token punctuation">.</span>FitPredicate <span class="token punctuation">{</span>
    checker <span class="token operator">:=</span> <span class="token operator">&amp;</span>PodAffinityChecker<span class="token punctuation">{</span>
        info<span class="token punctuation">:</span>      info<span class="token punctuation">,</span>
        podLister<span class="token punctuation">:</span> podLister<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> checker<span class="token punctuation">.</span>InterPodAffinityMatches  <span class="token comment">//&#x8FD4;&#x56DE;&#x7B56;&#x7565;func</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p><strong>InterPodAffinityMatches()</strong>
&#x68C0;&#x6D4B;&#x4E00;&#x4E2A;pod&#x662F;&#x5426;&#x6EE1;&#x8DB3;&#x8C03;&#x5EA6;&#x5230;&#x7279;&#x5B9A;&#x7684;&#xFF08;&#x7B26;&#x5408;pod&#x4EB2;&#x548C;&#x6216;&#x53CD;&#x4EB2;&#x548C;&#x914D;&#x7F6E;&#xFF09;Node&#x4E0A;&#x3002; </p>
<ol>
<li>satisfiesExistingPodsAntiAffinity()  &#x6EE1;&#x8DB3;&#x5B58;&#x5728;&#x7684;Pods&#x53CD;&#x4EB2;&#x548C;&#x914D;&#x7F6E;. </li>
<li>satisfiesPodsAffinityAntiAffinity()   &#x6EE1;&#x8DB3;Pods&#x4EB2;&#x548C;&#x4E0E;&#x53CD;&#x4EB2;&#x548C;&#x914D;&#x7F6E;. </li>
</ol>
</blockquote>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/predicates.go:1155</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>PodAffinityChecker<span class="token punctuation">)</span> <span class="token function">InterPodAffinityMatches</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> meta algorithm<span class="token punctuation">.</span>PredicateMetadata<span class="token punctuation">,</span> nodeInfo <span class="token operator">*</span>schedulercache<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>algorithm<span class="token punctuation">.</span>PredicateFailureReason<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    node <span class="token operator">:=</span> nodeInfo<span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> node <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;node not found&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>     
                                          <span class="token comment">//&#x2460;</span>
    <span class="token keyword">if</span> failedPredicates<span class="token punctuation">,</span> <span class="token builtin">error</span> <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">satisfiesExistingPodsAntiAffinity</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> meta<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">)</span><span class="token punctuation">;</span> failedPredicates <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        failedPredicates <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>algorithm<span class="token punctuation">.</span>PredicateFailureReason<span class="token punctuation">{</span>ErrPodAffinityNotMatch<span class="token punctuation">}</span><span class="token punctuation">,</span> failedPredicates<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> failedPredicates<span class="token punctuation">,</span> <span class="token builtin">error</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Now check if &lt;pod&gt; requirements will be satisfied on this node.</span>
    affinity <span class="token operator">:=</span> pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Affinity
    <span class="token keyword">if</span> affinity <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token punctuation">(</span>affinity<span class="token punctuation">.</span>PodAffinity <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> affinity<span class="token punctuation">.</span>PodAntiAffinity <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>   
                                         <span class="token comment">//&#x2461; </span>
    <span class="token keyword">if</span> failedPredicates<span class="token punctuation">,</span> <span class="token builtin">error</span> <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">satisfiesPodsAffinityAntiAffinity</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> meta<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">,</span> affinity<span class="token punctuation">)</span><span class="token punctuation">;</span> failedPredicates <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        failedPredicates <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>algorithm<span class="token punctuation">.</span>PredicateFailureReason<span class="token punctuation">{</span>ErrPodAffinityNotMatch<span class="token punctuation">}</span><span class="token punctuation">,</span> failedPredicates<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> failedPredicates<span class="token punctuation">,</span> <span class="token builtin">error</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x2460; satisfiesExistingPodsAntiAffinity()
&#x68C0;&#x6D4B;&#x5F53;pod&#x88AB;&#x8C03;&#x5EA6;&#x5230;&#x76EE;&#x6807;node&#x4E0A;&#x662F;&#x5426;&#x89E6;&#x72AF;&#x4E86;&#x5176;&#x5B83;pods&#x6240;&#x5B9A;&#x4E49;&#x7684;&#x53CD;&#x4EB2;&#x548C;&#x914D;&#x7F6E;.
<em>&#x5373;&#xFF1A;&#x5F53;&#x8C03;&#x5EA6;&#x4E00;&#x4E2A;pod&#x5230;&#x76EE;&#x6807;Node&#x4E0A;&#xFF0C;&#x800C;&#x67D0;&#x4E2A;&#x6216;&#x67D0;&#x4E9B;Pod&#x5B9A;&#x4E49;&#x4E86;&#x53CD;&#x4EB2;&#x548C;&#x914D;&#x7F6E;&#x4E0E;&#x88AB;</em>
        <em>&#x8C03;&#x5EA6;&#x7684;Pod&#x76F8;&#x5339;&#x914D;(&#x89E6;&#x72AF;)&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4E0D;&#x5E94;&#x8BE5;&#x5C06;&#x6B64;Node&#x52A0;&#x5165;&#x5230;&#x53EF;&#x9009;&#x7684;&#x6F5C;&#x5728;&#x8C03;&#x5EA6;Nodes&#x5217;&#x8868;&#x5185;.</em></p>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/predicates.go:1293</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>PodAffinityChecker<span class="token punctuation">)</span> <span class="token function">satisfiesExistingPodsAntiAffinity</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> meta algorithm<span class="token punctuation">.</span>PredicateMetadata<span class="token punctuation">,</span> nodeInfo <span class="token operator">*</span>schedulercache<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">)</span> <span class="token punctuation">(</span>algorithm<span class="token punctuation">.</span>PredicateFailureReason<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    node <span class="token operator">:=</span> nodeInfo<span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> node <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ErrExistingPodsAntiAffinityRulesNotMatch<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Node is nil&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> topologyMaps <span class="token operator">*</span>topologyPairsMaps
  <span class="token comment">//&#x5982;&#x679C;&#x5B58;&#x5728;&#x9884;&#x5904;&#x7406;&#x7684;MetaData&#x5219;&#x76F4;&#x63A5;&#x83B7;&#x53D6;topologyPairsAntiAffinityPodsMap</span>
    <span class="token keyword">if</span> predicateMeta<span class="token punctuation">,</span> ok <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>predicateMetadata<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        topologyMaps <span class="token operator">=</span> predicateMeta<span class="token punctuation">.</span>topologyPairsAntiAffinityPodsMap
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//  &#x4E0D;&#x5B58;&#x5728;&#x9884;&#x5904;&#x7406;&#x7684;MetaData&#x5904;&#x7406;&#x903B;&#x8F91;.</span>
    <span class="token comment">//  &#x8FC7;&#x6EE4;&#x6389;pod&#x7684;nodeName&#x7B49;&#x4E8E;NodeInfo.Node.Name,&#x4E14;&#x4E0D;&#x5B58;&#x5728;&#x4E8E;nodeinfo&#x4E2D;.</span>
    <span class="token comment">//  &#x5373;&#x8FD0;&#x884C;&#x5728;&#x5176;&#x5B83;Nodes&#x4E0A;&#x7684;Pods</span>
        filteredPods<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>podLister<span class="token punctuation">.</span><span class="token function">FilteredList</span><span class="token punctuation">(</span>nodeInfo<span class="token punctuation">.</span>Filter<span class="token punctuation">,</span> labels<span class="token punctuation">.</span><span class="token function">Everything</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            errMessage <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to get all pods, %+v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            klog<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>errMessage<span class="token punctuation">)</span>
            <span class="token keyword">return</span> ErrExistingPodsAntiAffinityRulesNotMatch<span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>errMessage<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token comment">// &#x83B7;&#x53D6;&#x88AB;&#x8C03;&#x5EA6;Pod&#x4E0E;&#x5176;&#x5B83;&#x5B58;&#x5728;&#x53CD;&#x4EB2;&#x548C;&#x914D;&#x7F6E;&#x7684;Pods&#x5339;&#x914D;&#x7684;topologyMaps</span>
        <span class="token keyword">if</span> topologyMaps<span class="token punctuation">,</span> err <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">getMatchingAntiAffinityTopologyPairsOfPods</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> filteredPods<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            errMessage <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to get all terms that pod %+v matches, err: %+v&quot;</span><span class="token punctuation">,</span> <span class="token function">podName</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            klog<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>errMessage<span class="token punctuation">)</span>
            <span class="token keyword">return</span> ErrExistingPodsAntiAffinityRulesNotMatch<span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>errMessage<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  <span class="token comment">// &#x904D;&#x5386;&#x6240;&#x6709;topology pairs(&#x6240;&#x6709;&#x53CD;&#x4EB2;&#x548C;topologyKey/Value)&#xFF0C;&#x68C0;&#x6D4B;Node&#x662F;&#x5426;&#x6709;&#x5F71;&#x54CD;.</span>
    <span class="token keyword">for</span> topologyKey<span class="token punctuation">,</span> topologyValue <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span>Labels <span class="token punctuation">{</span>
        <span class="token keyword">if</span> topologyMaps<span class="token punctuation">.</span>topologyPairToPods<span class="token punctuation">[</span>topologyPair<span class="token punctuation">{</span>key<span class="token punctuation">:</span> topologyKey<span class="token punctuation">,</span> value<span class="token punctuation">:</span> topologyValue<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot schedule pod %+v onto node %v&quot;</span><span class="token punctuation">,</span> <span class="token function">podName</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
            <span class="token keyword">return</span> ErrExistingPodsAntiAffinityRulesNotMatch<span class="token punctuation">,</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>getMatchingAntiAffinityTopologyPairsOfPods()
&#x83B7;&#x53D6;&#x88AB;&#x8C03;&#x5EA6;Pod&#x4E0E;&#x5176;&#x5B83;&#x5B58;&#x5728;&#x53CD;&#x4EB2;&#x548C;&#x914D;&#x7F6E;&#x7684;Pods&#x5339;&#x914D;&#x7684;topologyMaps</p>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/predicates.go:1270</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>PodAffinityChecker<span class="token punctuation">)</span> <span class="token function">getMatchingAntiAffinityTopologyPairsOfPods</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> existingPods <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>topologyPairsMaps<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    topologyMaps <span class="token operator">:=</span> <span class="token function">newTopologyPairsMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token comment">// &#x904D;&#x5386;&#x6240;&#x6709;&#x5B58;&#x5728;Pods,&#x83B7;&#x53D6;pod&#x6240;&#x8FD0;&#x884C;&#x7684;Node&#x4FE1;&#x606F;</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> existingPod <span class="token operator">:=</span> <span class="token keyword">range</span> existingPods <span class="token punctuation">{</span>
        existingPodNode<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">GetNodeInfo</span><span class="token punctuation">(</span>existingPod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>NodeName<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> apierrors<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Node not found, %v&quot;</span><span class="token punctuation">,</span> existingPod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>NodeName<span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
    <span class="token comment">// &#x4F9D;&#x636E;&#x88AB;&#x8C03;&#x5EA6;&#x7684;pod&#x3001;&#x76EE;&#x6807;pod&#x3001;&#x76EE;&#x6807;Node&#x4FE1;&#x606F;(&#x4E0A;&#x9762;&#x83B7;&#x53D6;&#x5F97;&#x5230;)&#x83B7;&#x53D6;TopologyPairs&#x3002;</span>
    <span class="token comment">// getMatchingAntiAffinityTopologyPairsOfPod()&#x4E0B;&#x9762;&#x8BE6;&#x8FF0;</span>
        existingPodTopologyMaps<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getMatchingAntiAffinityTopologyPairsOfPod</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> existingPod<span class="token punctuation">,</span> existingPodNode<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        topologyMaps<span class="token punctuation">.</span><span class="token function">appendMaps</span><span class="token punctuation">(</span>existingPodTopologyMaps<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> topologyMaps<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">//1)&#x662F;&#x5426;ExistingPod&#x5B9A;&#x4E49;&#x4E86;&#x53CD;&#x4EB2;&#x548C;&#x914D;&#x7F6E;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;</span>
<span class="token comment">//2)&#x5982;&#x679C;&#x6709;&#x5B9A;&#x4E49;&#xFF0C;&#x662F;&#x5426;&#x6709;&#x4EFB;&#x52A1;&#x4E00;&#x4E2A;&#x53CD;&#x4EB2;&#x548C;Term&#x5339;&#x914D;&#x9700;&#x88AB;&#x8C03;&#x5EA6;&#x7684;pod.</span>
<span class="token comment">//  &#x5982;&#x679C;&#x914D;&#x7F6E;&#x5219;&#x5C06;&#x8FD4;&#x56DE;term&#x5B9A;&#x4E49;&#x7684;TopologyKey&#x548C;Node&#x7684;topologyValue.</span>
<span class="token keyword">func</span> <span class="token function">getMatchingAntiAffinityTopologyPairsOfPod</span><span class="token punctuation">(</span>newPod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> existingPod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> node <span class="token operator">*</span>v1<span class="token punctuation">.</span>Node<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>topologyPairsMaps<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    affinity <span class="token operator">:=</span> existingPod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Affinity
    <span class="token keyword">if</span> affinity <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> affinity<span class="token punctuation">.</span>PodAntiAffinity <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    topologyMaps <span class="token operator">:=</span> <span class="token function">newTopologyPairsMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> term <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token function">GetPodAntiAffinityTerms</span><span class="token punctuation">(</span>affinity<span class="token punctuation">.</span>PodAntiAffinity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        namespaces <span class="token operator">:=</span> priorityutil<span class="token punctuation">.</span><span class="token function">GetNamespacesFromPodAffinityTerm</span><span class="token punctuation">(</span>existingPod<span class="token punctuation">,</span> <span class="token operator">&amp;</span>term<span class="token punctuation">)</span>
        selector<span class="token punctuation">,</span> err <span class="token operator">:=</span> metav1<span class="token punctuation">.</span><span class="token function">LabelSelectorAsSelector</span><span class="token punctuation">(</span>term<span class="token punctuation">.</span>LabelSelector<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> priorityutil<span class="token punctuation">.</span><span class="token function">PodMatchesTermsNamespaceAndSelector</span><span class="token punctuation">(</span>newPod<span class="token punctuation">,</span> namespaces<span class="token punctuation">,</span> selector<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> topologyValue<span class="token punctuation">,</span> ok <span class="token operator">:=</span> node<span class="token punctuation">.</span>Labels<span class="token punctuation">[</span>term<span class="token punctuation">.</span>TopologyKey<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
                pair <span class="token operator">:=</span> topologyPair<span class="token punctuation">{</span>key<span class="token punctuation">:</span> term<span class="token punctuation">.</span>TopologyKey<span class="token punctuation">,</span> value<span class="token punctuation">:</span> topologyValue<span class="token punctuation">}</span>
                topologyMaps<span class="token punctuation">.</span><span class="token function">addTopologyPair</span><span class="token punctuation">(</span>pair<span class="token punctuation">,</span> existingPod<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> topologyMaps<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x2461;  satisfiesPodsAffinityAntiAffinity() 
&#x6EE1;&#x8DB3;Pods&#x4EB2;&#x548C;&#x4E0E;&#x53CD;&#x4EB2;&#x548C;&#x914D;&#x7F6E;.
&#x6211;&#x4EEC;&#x5148;&#x770B;&#x4E00;&#x4E0B;&#x4EE3;&#x7801;&#x7ED3;&#x6784;&#xFF0C;&#x6211;&#x5C06;&#x5171;&#x5206;&#x4E3A;&#x4E24;&#x4E2A;&#x90E8;&#x5206;if{}&#x90E8;&#x5206;,else{}&#x90E8;&#x5206;,&#x4F9D;&#x8D56;&#x4E8E;&#x662F;&#x5426;&#x6307;&#x5B9A;&#x4E86;&#x9884;&#x5904;&#x7406;&#x7684;&#x9884;&#x9009;metadata.</p>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/predicates.go:1367</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>PodAffinityChecker<span class="token punctuation">)</span> <span class="token function">satisfiesPodsAffinityAntiAffinity</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span>
    meta algorithm<span class="token punctuation">.</span>PredicateMetadata<span class="token punctuation">,</span> nodeInfo <span class="token operator">*</span>schedulercache<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">,</span>
    affinity <span class="token operator">*</span>v1<span class="token punctuation">.</span>Affinity<span class="token punctuation">)</span> <span class="token punctuation">(</span>algorithm<span class="token punctuation">.</span>PredicateFailureReason<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    node <span class="token operator">:=</span> nodeInfo<span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> node <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ErrPodAffinityRulesNotMatch<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Node is nil&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> predicateMeta<span class="token punctuation">,</span> ok <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>predicateMetadata<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
      <span class="token operator">...</span>    <span class="token comment">//partI</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
    <span class="token operator">...</span>    <span class="token comment">//partII  </span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>partI</code> if{...}</p>
<ul>
<li>&#x5982;&#x679C;&#x6307;&#x5B9A;&#x4E86;&#x9884;&#x5904;&#x7406;metadata&#xFF0C;&#x5219;&#x4F7F;&#x7528;&#x6B64;&#x903B;&#x8F91;&#xFF0C;&#x5426;&#x5219;&#x8DF3;&#x81F3;else{...} </li>
<li>&#x83B7;&#x53D6;&#x6240;&#x6709;pod&#x4EB2;&#x548C;&#x6027;&#x5B9A;&#x4E49;AffinityTerms&#xFF0C;&#x5982;&#x679C;&#x5B58;&#x5728;&#x4EB2;&#x548C;&#x6027;&#x5B9A;&#x4E49;&#xFF0C;&#x57FA;&#x4E8E;&#x6307;&#x5B9A;&#x7684;metadata&#x5224;&#x65AD;AffinityTerms&#x6240;&#x5B9A;&#x4E49;&#x7684;nodeTopoloykey&#x4E0E;&#x503C;<strong>&#x662F;&#x5426;&#x6240;&#x6709;&#x90FD;&#x5B58;&#x5728;&#x4E8E;</strong>metadata.topologyPairsPotential<code>Affinity</code>Pods&#x4E4B;&#x5185;&#xFF08;&#x6F5C;&#x5728;&#x5339;&#x914D;&#x4EB2;&#x548C;&#x5B9A;&#x4E49;&#x7684;pod list&#xFF09;&#x3002;  </li>
<li>&#x83B7;&#x53D6;&#x6240;&#x6709;pod&#x4EB2;&#x548C;&#x6027;&#x5B9A;&#x4E49;AntiAffinityTerms&#xFF0C;&#x5982;&#x679C;&#x5B58;&#x5728;&#x53CD;&#x4EB2;&#x548C;&#x5B9A;&#x4E49;&#xFF0C;&#x57FA;&#x4E8E;&#x6307;&#x5B9A;&#x7684;metadata&#x5224;&#x65AD;AntiAffinityTerms&#x6240;&#x5B9A;&#x4E49;&#x7684;nodeTopoloykey&#x4E0E;&#x503C; <strong>&#x662F;&#x5426;&#x6709;&#x4E00;&#x4E2A;&#x5B58;&#x5728;&#x4E8E;</strong> metadata.topologyPairsPotential<code>AntiAffinity</code>Pods&#x4E4B;&#x5185;&#x7684;&#x60C5;&#x51B5;&#xFF08;&#x6F5C;&#x5728;&#x5339;&#x914D;anti&#x53CD;&#x4EB2;&#x548C;&#x5B9A;&#x4E49;&#x7684;pod list&#xFF09;&#x3002; </li>
</ul>
<pre class="language-"><code class="lang-go">    <span class="token keyword">if</span> predicateMeta<span class="token punctuation">,</span> ok <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>predicateMetadata<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        <span class="token comment">// &#x68C0;&#x6D4B;&#x6240;&#x6709;affinity terms.</span>
        topologyPairsPotentialAffinityPods <span class="token operator">:=</span> predicateMeta<span class="token punctuation">.</span>topologyPairsPotentialAffinityPods
        <span class="token keyword">if</span> affinityTerms <span class="token operator">:=</span> <span class="token function">GetPodAffinityTerms</span><span class="token punctuation">(</span>affinity<span class="token punctuation">.</span>PodAffinity<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">len</span><span class="token punctuation">(</span>affinityTerms<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            matchExists <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">nodeMatchesAllTopologyTerms</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> topologyPairsPotentialAffinityPods<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">,</span> affinityTerms<span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token operator">!</span>matchExists <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>topologyPairsPotentialAffinityPods<span class="token punctuation">.</span>topologyPairToPods<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">targetPodMatchesAffinityOfPod</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> pod<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot schedule pod %+v onto node %v, because of PodAffinity&quot;</span><span class="token punctuation">,</span>
                        <span class="token function">podName</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> ErrPodAffinityRulesNotMatch<span class="token punctuation">,</span> <span class="token boolean">nil</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// &#x68C0;&#x6D4B;&#x6240;&#x6709;anti-affinity terms.</span>
        topologyPairsPotentialAntiAffinityPods <span class="token operator">:=</span> predicateMeta<span class="token punctuation">.</span>topologyPairsPotentialAntiAffinityPods
        <span class="token keyword">if</span> antiAffinityTerms <span class="token operator">:=</span> <span class="token function">GetPodAntiAffinityTerms</span><span class="token punctuation">(</span>affinity<span class="token punctuation">.</span>PodAntiAffinity<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">len</span><span class="token punctuation">(</span>antiAffinityTerms<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            matchExists <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">nodeMatchesAnyTopologyTerm</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> topologyPairsPotentialAntiAffinityPods<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">,</span> antiAffinityTerms<span class="token punctuation">)</span>
            <span class="token keyword">if</span> matchExists <span class="token punctuation">{</span>
                klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot schedule pod %+v onto node %v, because of PodAntiAffinity&quot;</span><span class="token punctuation">,</span>
                    <span class="token function">podName</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
                <span class="token keyword">return</span> ErrPodAntiAffinityRulesNotMatch<span class="token punctuation">,</span> <span class="token boolean">nil</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre>
<p>&#x4EE5;&#x4E0B;&#x8BF4;&#x660E;&#x7EE7;&#x7EED;if{&#x2026;}&#x5185;&#x6240;&#x7528;&#x7684;&#x5404;&#x4E2A;<strong>&#x5B50;&#x903B;&#x8F91;&#x51FD;&#x6570;&#x5206;&#x6790;</strong>(&#x6309;&#x4EE3;&#x7801;&#x4F4D;&#x7F6E;&#x7684;&#x5148;&#x540E;&#x987A;&#x5E8F;)&#xFF1A;</p>
<p><em>GetPodAffinityTerms()</em> 
<em>&#x5982;&#x679C;&#x5B58;&#x5728;podAffinity&#x786C;&#x4EF6;&#x914D;&#x7F6E;&#xFF0C;&#x83B7;&#x53D6;&#x6240;&#x6709;&quot;&#x5339;&#x914D;&#x5FC5;&#x8981;&#x6761;&#x4EF6;&#x201D;Terms</em></p>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/predicates.go:1217</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">GetPodAffinityTerms</span><span class="token punctuation">(</span>podAffinity <span class="token operator">*</span>v1<span class="token punctuation">.</span>PodAffinity<span class="token punctuation">)</span> <span class="token punctuation">(</span>terms <span class="token punctuation">[</span><span class="token punctuation">]</span>v1<span class="token punctuation">.</span>PodAffinityTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> podAffinity <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>podAffinity<span class="token punctuation">.</span>RequiredDuringSchedulingIgnoredDuringExecution<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            terms <span class="token operator">=</span> podAffinity<span class="token punctuation">.</span>RequiredDuringSchedulingIgnoredDuringExecution
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> terms
<span class="token punctuation">}</span>
</code></pre>
<p><em>nodeMatchesAllTopologyTerms()</em> 
<em>&#x5224;&#x65AD;&#x76EE;&#x6807;Node&#x662F;&#x5426;<strong>&#x5339;&#x914D;&#x6240;&#x6709;</strong>&#x4EB2;&#x548C;&#x6027;&#x914D;&#x7F6E;&#x7684;&#x5B9A;&#x4E49;Terms&#x7684;topology&#x503C;</em>.</p>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/predicates.go:1336</p></div>
<pre class="language-"><code class="lang-go"><span class="token comment">// &#x76EE;&#x6807;Node&#x987B;&#x5339;&#x914D;&#x6240;&#x6709;Affinity terms&#x6240;&#x5B9A;&#x4E49;&#x7684;TopologyKey&#xFF0C;&#x4E14;&#x503C;&#x987B;&#x4E0E;nodes(&#x8FD0;&#x884C;&#x88AB;&#x4EB2;&#x548C;&#x5339;&#x914D;&#x8868;&#x8FBE;&#x5F0F;&#x5339;&#x914D;&#x7684;Pods)</span>
<span class="token comment">// &#x7684;TopologyKey&#x548C;&#x503C;&#x76F8;&#x5339;&#x914D;&#x3002;</span>
<span class="token comment">// &#x6CE8;&#xFF1A;&#x6B64;&#x903B;&#x8F91;&#x5185;metadata&#x9884;&#x8BA1;&#x7B97;&#x4E86;topologyPairs</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>PodAffinityChecker<span class="token punctuation">)</span> <span class="token function">nodeMatchesAllTopologyTerms</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> topologyPairs <span class="token operator">*</span>topologyPairsMaps<span class="token punctuation">,</span> nodeInfo <span class="token operator">*</span>schedulercache<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">,</span> terms <span class="token punctuation">[</span><span class="token punctuation">]</span>v1<span class="token punctuation">.</span>PodAffinityTerm<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    node <span class="token operator">:=</span> nodeInfo<span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> term <span class="token operator">:=</span> <span class="token keyword">range</span> terms <span class="token punctuation">{</span>
    <span class="token comment">// &#x5224;&#x65AD;&#x76EE;&#x6807;node&#x4E0A;&#x662F;&#x5426;&#x5B58;&#x5728;&#x4EB2;&#x548C;&#x914D;&#x7F6E;&#x5B9A;&#x4E49;&#x7684;TopologyKey&#x7684;key&#xFF0C;&#x53D6;&#x51FA;&#x5176;topologykey&#x503C;</span>
    <span class="token comment">// &#x6839;&#x636E;key&#x4E0E;&#x503C;&#x521B;&#x5EFA;topologyPair</span>
    <span class="token comment">// &#x57FA;&#x4E8E;metadata.topologyPairsPotentialAffinityPods(&#x6F5C;&#x5728;&#x4EB2;&#x548C;pods&#x7684;topologyPairs)&#x5224;&#x65AD;\</span>
       <span class="token comment">//&#x76EE;&#x6807;node&#x4E0A;&#x7684;ToplogyKey&#x4E0E;value&#x662F;&#x5426;&#x76F8;&#x4E92;&#x5339;&#x914D;.</span>
        <span class="token keyword">if</span> topologyValue<span class="token punctuation">,</span> ok <span class="token operator">:=</span> node<span class="token punctuation">.</span>Labels<span class="token punctuation">[</span>term<span class="token punctuation">.</span>TopologyKey<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
            pair <span class="token operator">:=</span> topologyPair<span class="token punctuation">{</span>key<span class="token punctuation">:</span> term<span class="token punctuation">.</span>TopologyKey<span class="token punctuation">,</span> value<span class="token punctuation">:</span> topologyValue<span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> topologyPairs<span class="token punctuation">.</span>topologyPairToPods<span class="token punctuation">[</span>pair<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token comment">// &#x4E00;&#x9879;&#x4E0D;&#x6EE1;&#x8DB3;&#x5219;&#x4E3A;false</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token comment">// topologyPairsMaps&#x7ED3;&#x6784;&#x5B9A;&#x4E49;</span>
<span class="token keyword">type</span> topologyPairsMaps <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    topologyPairToPods    <span class="token keyword">map</span><span class="token punctuation">[</span>topologyPair<span class="token punctuation">]</span>podSet
    podToTopologyPairs    <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>topologyPairSet
<span class="token punctuation">}</span>
</code></pre>
<p><em>targetPodMatchesAffinityOfPod()</em>
&#x6839;&#x636E;pod&#x7684;&#x4EB2;&#x548C;&#x5B9A;&#x4E49;&#x68C0;&#x6D4B;&#x76EE;&#x6807;pod&#x7684;NameSpace&#x662F;&#x5426;&#x7B26;&#x5408;&#x6761;&#x4EF6;&#x4EE5;&#x53CA; Labels.selector&#x6761;&#x4EF6;&#x8868;&#x8FBE;&#x5F0F;&#x662F;&#x5426;&#x5339;&#x914D;. </p>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/metadata.go:498</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">targetPodMatchesAffinityOfPod</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> targetPod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    affinity <span class="token operator">:=</span> pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Affinity
    <span class="token keyword">if</span> affinity <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> affinity<span class="token punctuation">.</span>PodAffinity <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    affinityProperties<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getAffinityTermProperties</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> <span class="token function">GetPodAffinityTerms</span><span class="token punctuation">(</span>affinity<span class="token punctuation">.</span>PodAffinity<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">// &#x2460; </span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error in getting affinity properties of Pod %v&quot;</span><span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>                                          <span class="token comment">// &#x2461; </span>
    <span class="token keyword">return</span> <span class="token function">podMatchesAllAffinityTermProperties</span><span class="token punctuation">(</span>targetPod<span class="token punctuation">,</span> affinityProperties<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// &#x2460; &#x83B7;&#x53D6;affinityTerms&#x6240;&#x5B9A;&#x4E49;&#x6240;&#x6709;&#x7684;namespaces &#x548C; selector &#x5217;&#x8868;&#xFF0C;</span>
<span class="token comment">//    &#x8FD4;&#x56DE;affinityTermProperites&#x6570;&#x7EC4;. &#x6570;&#x7EC4;&#x7684;&#x6BCF;&#x9879;&#x5B9A;&#x4E49;{namesapces,selector}.</span>
<span class="token keyword">func</span> <span class="token function">getAffinityTermProperties</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> terms <span class="token punctuation">[</span><span class="token punctuation">]</span>v1<span class="token punctuation">.</span>PodAffinityTerm<span class="token punctuation">)</span> <span class="token punctuation">(</span>properties <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>affinityTermProperties<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> terms <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> properties<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> term <span class="token operator">:=</span> <span class="token keyword">range</span> terms <span class="token punctuation">{</span>
        namespaces <span class="token operator">:=</span> priorityutil<span class="token punctuation">.</span><span class="token function">GetNamespacesFromPodAffinityTerm</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> <span class="token operator">&amp;</span>term<span class="token punctuation">)</span>
    <span class="token comment">// &#x57FA;&#x4E8E;&#x5B9A;&#x4E49;&#x7684;&#x4EB2;&#x548C;&#x6027;term&#xFF0C;&#x521B;&#x5EFA;labels.selector</span>
        selector<span class="token punctuation">,</span> err <span class="token operator">:=</span> metav1<span class="token punctuation">.</span><span class="token function">LabelSelectorAsSelector</span><span class="token punctuation">(</span>term<span class="token punctuation">.</span>LabelSelector<span class="token punctuation">)</span> 
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        <span class="token comment">// &#x8FD4;&#x56DE; namespaces &#x548C; selector</span>
        properties <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>properties<span class="token punctuation">,</span> <span class="token operator">&amp;</span>affinityTermProperties<span class="token punctuation">{</span>namespaces<span class="token punctuation">:</span> namespaces<span class="token punctuation">,</span> selector<span class="token punctuation">:</span> selector<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> properties<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// &#x8FD4;&#x56DE;Namespace&#x5217;&#x8868;&#xFF08;&#x5982;&#x679C;term&#x672A;&#x6307;&#x5B9A;Namespace&#x5219;&#x4F7F;&#x7528;&#x88AB;&#x8C03;&#x5EA6;pod&#x7684;Namespace&#xFF09;.</span>
<span class="token keyword">func</span> <span class="token function">GetNamespacesFromPodAffinityTerm</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> podAffinityTerm <span class="token operator">*</span>v1<span class="token punctuation">.</span>PodAffinityTerm<span class="token punctuation">)</span> sets<span class="token punctuation">.</span>String <span class="token punctuation">{</span>
    names <span class="token operator">:=</span> sets<span class="token punctuation">.</span>String<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>podAffinityTerm<span class="token punctuation">.</span>Namespaces<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        names<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        names<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>podAffinityTerm<span class="token punctuation">.</span>Namespaces<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> names
<span class="token punctuation">}</span>

<span class="token comment">// &#x2461; &#x904D;&#x5386;properties&#x6240;&#x6709;&#x5B9A;&#x4E49;&#x7684;namespaces &#x548C; selector &#x5217;&#x8868;&#xFF0C;&#x8C03;&#x7528;PodMatchesTermsNamespaceAndSelector()&#x8FDB;&#x884C;&#x4E00;&#x4E00;&#x5339;&#x914D;.</span>
<span class="token keyword">func</span> <span class="token function">podMatchesAllAffinityTermProperties</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> properties <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>affinityTermProperties<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> property <span class="token operator">:=</span> <span class="token keyword">range</span> properties <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>priorityutil<span class="token punctuation">.</span><span class="token function">PodMatchesTermsNamespaceAndSelector</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> property<span class="token punctuation">.</span>namespaces<span class="token punctuation">,</span> property<span class="token punctuation">.</span>selector<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
<span class="token comment">//  &#x68C0;&#x6D4B;NameSpaces&#x4E00;&#x81F4;&#x6027;&#x548C;Labels.selector&#x662F;&#x5426;&#x5339;&#x914D;.</span>
<span class="token comment">//  - &#x5982;&#x679C;pod.Namespaces&#x4E0D;&#x76F8;&#x7B49;&#x4E8E;&#x6307;&#x5B9A;&#x7684;NameSpace&#x503C;&#x5219;&#x8FD4;&#x56DE;false&#xFF0C;&#x5982;&#x679C;true&#x5219;&#x7EE7;&#x7EED;labels match.</span>
<span class="token comment">//  - &#x5982;&#x679C;pod.labels&#x4E0D;&#x80FD;Match Labels.selector&#x9009;&#x62E9;&#x5668;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;false,&#x53CD;&#x4E4B;true</span>
<span class="token keyword">func</span> <span class="token function">PodMatchesTermsNamespaceAndSelector</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> namespaces sets<span class="token punctuation">.</span>String<span class="token punctuation">,</span> selector labels<span class="token punctuation">.</span>Selector<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>namespaces<span class="token punctuation">.</span><span class="token function">Has</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>selector<span class="token punctuation">.</span><span class="token function">Matches</span><span class="token punctuation">(</span>labels<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Labels<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre>
<p><em>GetPodAntiAffinityTerms()</em>
<em>&#x83B7;&#x53D6;pod&#x53CD;&#x4EB2;&#x548C;&#x914D;&#x7F6E;&#x6240;&#x6709;&#x7684;&#x5FC5;&#x8981;&#x6761;&#x4EF6;Terms</em></p>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/predicates.go:1231</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">GetPodAntiAffinityTerms</span><span class="token punctuation">(</span>podAntiAffinity <span class="token operator">*</span>v1<span class="token punctuation">.</span>PodAntiAffinity<span class="token punctuation">)</span> <span class="token punctuation">(</span>terms <span class="token punctuation">[</span><span class="token punctuation">]</span>v1<span class="token punctuation">.</span>PodAffinityTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> podAntiAffinity <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>podAntiAffinity<span class="token punctuation">.</span>RequiredDuringSchedulingIgnoredDuringExecution<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            terms <span class="token operator">=</span> podAntiAffinity<span class="token punctuation">.</span>RequiredDuringSchedulingIgnoredDuringExecution
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> terms
<span class="token punctuation">}</span>
</code></pre>
<p><em>nodeMatchesAnyTopologyTerm()</em>
&#x5224;&#x65AD;&#x76EE;&#x6807;Node&#x662F;&#x5426;<strong>&#x6709;&#x5339;&#x914D;&#x4E86;</strong>&#x53CD;&#x4EB2;&#x548C;&#x7684;&#x5B9A;&#x4E49;Terms&#x7684;topology&#x503C;*.</p>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/predicates.go:1353</p></div>
<pre class="language-"><code class="lang-go"><span class="token comment">//  Node&#x53EA;&#x987B;&#x5339;&#x914D;&#x4EFB;&#x4F55;&#x4E00;&#x6761;AnitAffinity terms&#x6240;&#x5B9A;&#x4E49;&#x7684;TopologyKey&#x5219;&#x4E3A;True</span>
<span class="token comment">//  &#x903B;&#x8F91;&#x7B49;&#x540C;&#x4E8E;nodeMatchesAllTopologyTerms(),&#x53EA;&#x662F;&#x5339;&#x914D;&#x4E00;&#x6761;&#x5219;&#x8FD4;&#x56DE;&#x4E3A;true.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>PodAffinityChecker<span class="token punctuation">)</span> <span class="token function">nodeMatchesAnyTopologyTerm</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> topologyPairs <span class="token operator">*</span>topologyPairsMaps<span class="token punctuation">,</span> nodeInfo <span class="token operator">*</span>schedulercache<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">,</span> terms <span class="token punctuation">[</span><span class="token punctuation">]</span>v1<span class="token punctuation">.</span>PodAffinityTerm<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    node <span class="token operator">:=</span> nodeInfo<span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> term <span class="token operator">:=</span> <span class="token keyword">range</span> terms <span class="token punctuation">{</span>
        <span class="token keyword">if</span> topologyValue<span class="token punctuation">,</span> ok <span class="token operator">:=</span> node<span class="token punctuation">.</span>Labels<span class="token punctuation">[</span>term<span class="token punctuation">.</span>TopologyKey<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
            pair <span class="token operator">:=</span> topologyPair<span class="token punctuation">{</span>key<span class="token punctuation">:</span> term<span class="token punctuation">.</span>TopologyKey<span class="token punctuation">,</span> value<span class="token punctuation">:</span> topologyValue<span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> topologyPairs<span class="token punctuation">.</span>topologyPairToPods<span class="token punctuation">[</span>pair<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span> <span class="token comment">// &#x4E00;&#x9879;&#x6EE1;&#x8DB3;&#x5219;&#x4E3A;true</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>partII</code> else{...}</p>
<ul>
<li>&#x5982;&#x679C;&#x6CA1;&#x6709;&#x9884;&#x5904;&#x7406;&#x7684;Metadata&#xFF0C;&#x5219;&#x901A;&#x8FC7;&#x6307;&#x5B9A;podFilter&#x8FC7;&#x6EE4;&#x5668;&#x83B7;&#x53D6;&#x6EE1;&#x8DB3;&#x6761;&#x4EF6;&#x7684;pod&#x5217;&#x8868;</li>
<li>&#x83B7;&#x53D6;&#x6240;&#x6709;&#x4EB2;&#x548C;&#x914D;&#x7F6E;&#x5B9A;&#x4E49;&#xFF0C;&#x5982;&#x679C;&#x5B58;&#x5728;&#x5219;&#xFF0C;&#x901A;&#x8FC7;&#x83B7;&#x53D6;PodAffinity&#x6240;&#x5B9A;&#x4E49;&#x7684;&#x6240;&#x6709;namespaces&#x548C;&#x6807;&#x7B7E;&#x6761;&#x4EF6;&#x8868;&#x8FBE;&#x5F0F;&#x8FDB;&#x884C;&#x5339;&#x914D;&#x201D;&#x76EE;&#x6807;pod&quot;,&#x5B8C;&#x5168;&#x7B26;&#x5408;&#x5219;&#x83B7;&#x53D6;<strong>&#x6B64;&#x76EE;&#x6807;pod&#x7684;&#x8FD0;&#x884C;node&#x7684;topologykey&#xFF08;&#x6B64;&#x4E3A;affinity&#x6307;&#x5B9A;&#x7684;topologykey&#xFF09;&#x7684; <code>&#x503C;</code></strong>&#x548C;&quot;&#x6F5C;&#x5728;Node&quot;&#x7684;topologykey&#x7684;&#x503C;&#x6BD4;&#x5BF9;&#x662F;&#x5426;&#x4E00;&#x81F4;&#x3002; </li>
<li>&#x4E0E;&#x4E0A;&#x7C7B;&#x4F3C;&#xFF0C;&#x83B7;&#x53D6;&#x6240;&#x6709;anti&#x53CD;&#x4EB2;&#x548C;&#x914D;&#x7F6E;&#x5B9A;&#x4E49;&#xFF0C;&#x5982;&#x679C;&#x5B58;&#x5728;&#x5219;&#xFF0C;&#x901A;&#x8FC7;&#x83B7;&#x53D6;PodAntiAffinity&#x6240;&#x5B9A;&#x4E49;&#x7684;&#x6240;&#x6709;namespaces&#x548C;&#x6807;&#x7B7E;&#x6761;&#x4EF6;&#x8868;&#x8FBE;&#x5F0F;&#x8FDB;&#x884C;&#x5339;&#x914D;&#x201D;&#x76EE;&#x6807;pod&quot;,&#x5B8C;&#x5168;&#x7B26;&#x5408;&#x5219;&#x83B7;&#x53D6;&#x6B64;&#x76EE;&#x6807;pod&#x7684;&#x8FD0;&#x884C;node&#x7684;topologykey&#xFF08;&#x6B64;&#x4E3A;AntiAffinity&#x6307;&#x5B9A;&#x7684;topologykey&#xFF09;&#x7684;&#x503C;&#x548C;&quot;&#x6F5C;&#x5728;Node&quot;&#x7684;topologykey&#x7684;&#x503C;&#x6BD4;&#x5BF9;&#x662F;&#x5426;&#x4E00;&#x81F4;&#x3002; </li>
</ul>
<pre class="language-"><code class="lang-go"><span class="token keyword">else</span> <span class="token punctuation">{</span> 
  <span class="token comment">// We don&apos;t have precomputed metadata. We have to follow a slow path to check affinity terms.</span>
        filteredPods<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>podLister<span class="token punctuation">.</span><span class="token function">FilteredList</span><span class="token punctuation">(</span>nodeInfo<span class="token punctuation">.</span>Filter<span class="token punctuation">,</span> labels<span class="token punctuation">.</span><span class="token function">Everything</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> ErrPodAffinityRulesNotMatch<span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>

    <span class="token comment">//&#x83B7;&#x53D6;&#x4EB2;&#x548C;&#x3001;&#x53CD;&#x4EB2;&#x548C;&#x914D;&#x7F6E;&#x5B9A;&#x4E49;&#x7684;&quot;&#x5339;&#x914D;&#x6761;&#x4EF6;&quot;Terms</span>
        affinityTerms <span class="token operator">:=</span> <span class="token function">GetPodAffinityTerms</span><span class="token punctuation">(</span>affinity<span class="token punctuation">.</span>PodAffinity<span class="token punctuation">)</span>
        antiAffinityTerms <span class="token operator">:=</span> <span class="token function">GetPodAntiAffinityTerms</span><span class="token punctuation">(</span>affinity<span class="token punctuation">.</span>PodAntiAffinity<span class="token punctuation">)</span>

        matchFound<span class="token punctuation">,</span> termsSelectorMatchFound <span class="token operator">:=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> targetPod <span class="token operator">:=</span> <span class="token keyword">range</span> filteredPods <span class="token punctuation">{</span>
            <span class="token comment">// &#x904D;&#x5386;&#x6240;&#x6709;&#x76EE;&#x6807;Pod,&#x68C0;&#x6D4B;&#x6240;&#x6709;&#x4EB2;&#x548C;&#x6027;&#x914D;&#x7F6E;&quot;&#x5339;&#x914D;&#x6761;&#x4EF6;&quot;Terms</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>matchFound <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>affinityTerms<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token comment">// podMatchesPodAffinityTerms()&#x5BF9;namespaces&#x548C;&#x6807;&#x7B7E;&#x6761;&#x4EF6;&#x8868;&#x8FBE;&#x5F0F;&#x8FDB;&#x884C;&#x5339;&#x914D;&#x76EE;&#x6807;pod&#x3010;&#x8BE6;&#x89E3;&#x540E;&#x8FF0;&#x3011;</span>
                affTermsMatch<span class="token punctuation">,</span> termsSelectorMatch<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">podMatchesPodAffinityTerms</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> targetPod<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">,</span> affinityTerms<span class="token punctuation">)</span>
                <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    errMessage <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot schedule pod %+v onto node %v, because of PodAffinity, err: %v&quot;</span><span class="token punctuation">,</span> <span class="token function">podName</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
                    klog<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>errMessage<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> ErrPodAffinityRulesNotMatch<span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>errMessage<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> termsSelectorMatch <span class="token punctuation">{</span>
                    termsSelectorMatchFound <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> affTermsMatch <span class="token punctuation">{</span>
                    matchFound <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// &#x540C;&#x4E0A;&#xFF0C;&#x904D;&#x5386;&#x6240;&#x6709;&#x76EE;&#x6807;Pod,&#x68C0;&#x6D4B;&#x6240;&#x6709;Anti&#x53CD;&#x4EB2;&#x548C;&#x914D;&#x7F6E;&quot;&#x5339;&#x914D;&#x6761;&#x4EF6;&quot;Terms.</span>
            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>antiAffinityTerms<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                antiAffTermsMatch<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">podMatchesPodAffinityTerms</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> targetPod<span class="token punctuation">,</span> nodeInfo<span class="token punctuation">,</span> antiAffinityTerms<span class="token punctuation">)</span>
                <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> antiAffTermsMatch <span class="token punctuation">{</span>
                    klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot schedule pod %+v onto node %v, because of PodAntiAffinityTerm, err: %v&quot;</span><span class="token punctuation">,</span>
                        <span class="token function">podName</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> ErrPodAntiAffinityRulesNotMatch<span class="token punctuation">,</span> <span class="token boolean">nil</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token operator">!</span>matchFound <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>affinityTerms<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> termsSelectorMatchFound <span class="token punctuation">{</span>
                klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot schedule pod %+v onto node %v, because of PodAffinity&quot;</span><span class="token punctuation">,</span>
                    <span class="token function">podName</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
                <span class="token keyword">return</span> ErrPodAffinityRulesNotMatch<span class="token punctuation">,</span> <span class="token boolean">nil</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Check if pod matches its own affinity properties (namespace and label selector).</span>
            <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">targetPodMatchesAffinityOfPod</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> pod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot schedule pod %+v onto node %v, because of PodAffinity&quot;</span><span class="token punctuation">,</span>
                    <span class="token function">podName</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
                <span class="token keyword">return</span> ErrPodAffinityRulesNotMatch<span class="token punctuation">,</span> <span class="token boolean">nil</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x4EE5;&#x4E0B;&#x8BF4;&#x660E;&#x7EE7;&#x7EED;else{&#x2026;}&#x5185;&#x6240;&#x7528;&#x7684;<strong>&#x5B50;&#x903B;&#x8F91;&#x51FD;&#x6570;&#x5206;&#x6790;</strong>&#xFF1A;</p>
<p><em>podMatchesPodAffinityTerms()</em> 
<em>&#x901A;&#x8FC7;&#x83B7;&#x53D6;&#x4EB2;&#x548C;&#x914D;&#x7F6E;&#x5B9A;&#x4E49;&#x7684;&#x6240;&#x6709;namespaces&#x548C;&#x6807;&#x7B7E;&#x6761;&#x4EF6;&#x8868;&#x8FBE;&#x5F0F;&#x8FDB;&#x884C;&#x5339;&#x914D;&#x76EE;&#x6807;pod,&#x5B8C;&#x5168;&#x7B26;&#x5408;&#x5219;&#x83B7;&#x53D6;&#x6B64;&#x76EE;&#x6807;pod&#x7684;&#x8FD0;&#x884C;node&#x7684;topologykey&#xFF08;&#x6B64;&#x4E3A;affinity&#x6307;&#x5B9A;&#x7684;topologykey&#xFF09;&#x7684;<code>&#x503C;</code>&#x548C;&#x6F5C;&#x5728;Node&#x7684;topologykey&#x7684;<code>&#x503C;</code>&#x6BD4;&#x5BF9;&#x662F;&#x5426;&#x4E00;&#x81F4;.</em></p>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/predicates.go:1189</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>PodAffinityChecker<span class="token punctuation">)</span> <span class="token function">podMatchesPodAffinityTerms</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> targetPod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeInfo <span class="token operator">*</span>schedulercache<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">,</span> terms <span class="token punctuation">[</span><span class="token punctuation">]</span>v1<span class="token punctuation">.</span>PodAffinityTerm<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>terms<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;terms array is empty&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// &#x83B7;&#x53D6;{namespaces,selector}&#x5217;&#x8868;</span>
    props<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getAffinityTermProperties</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> terms<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token comment">// &#x5339;&#x914D;&#x76EE;&#x6807;pod&#x662F;&#x5426;&#x5728;affinityTerm&#x5B9A;&#x4E49;&#x7684;{namespaces,selector}&#x5217;&#x8868;&#x5185;&#x6240;&#x6709;&#x9879;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5339;&#x914D;&#x5219;&#x8FD4;&#x56DE;false,</span>
    <span class="token comment">// &#x5982;&#x679C;&#x5339;&#x914D;&#x5219;&#x83B7;&#x53D6;&#x6B64;pod&#x7684;&#x8FD0;&#x884C;node&#x4FE1;&#x606F;(&#x79F0;&#x4E3A;&#x76EE;&#x6807;Node)&#xFF0C;</span>
    <span class="token comment">// &#x901A;&#x8FC7;&#x201C;&#x76EE;&#x6807;Node&#x201D;&#x6240;&#x5B9A;&#x4E49;&#x7684;topologykey&#xFF08;&#x6B64;&#x4E3A;affinity&#x6307;&#x5B9A;&#x7684;topologykey&#xFF09;&#x7684;&#x503C;&#x6765;&#x5339;&#x914D;&#x201C;&#x6F5C;&#x5728;&#x88AB;&#x8C03;&#x5EA6;&#x7684;Node&#x201D;&#x7684;topologykey&#x662F;&#x5426;&#x4E00;&#x81F4;&#x3002;</span>
    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">podMatchesAllAffinityTermProperties</span><span class="token punctuation">(</span>targetPod<span class="token punctuation">,</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Namespace and selector of the terms have matched. Now we check topology of the terms.</span>
    targetPodNode<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">GetNodeInfo</span><span class="token punctuation">(</span>targetPod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>NodeName<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> term <span class="token operator">:=</span> <span class="token keyword">range</span> terms <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>term<span class="token punctuation">.</span>TopologyKey<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;empty topologyKey is not allowed except for PreferredDuringScheduling pod anti-affinity&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>priorityutil<span class="token punctuation">.</span><span class="token function">NodesHaveSameTopologyKey</span><span class="token punctuation">(</span>nodeInfo<span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targetPodNode<span class="token punctuation">,</span> term<span class="token punctuation">.</span>TopologyKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>priorityutil.NodesHaveSameTopologyKey()<em> </em>&#x6B63;&#x771F;&#x7684;toplogykey&#x6BD4;&#x8F83;&#x5B9E;&#x73B0;&#x7684;&#x903B;&#x8F91;&#x4EE3;&#x7801;&#x5757;&#x3002;<em>
<em>*&#x4ECE;&#x6B64;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;&#x770B;&#x51FA;deployment&#x7684;yml&#x5BF9;topologykey&#x8BBE;&#x5B9A;&#x7684;&#x53EF;&#x4EE5;&#x652F;&#x6301;&#x81EA;&#x5B9A;&#x4E49;&#x7684;</em></em></p>
<div><p class="code-filename">pkg/scheduler/algorithm/priorities/util/topologies.go:53</p></div>
<pre class="language-"><code>// &#x5224;&#x65AD;&#x4E24;&#x8005;&#x7684;topologyKey&#x5B9A;&#x4E49;&#x7684;&#x503C;&#x662F;&#x5426;&#x4E00;&#x81F4;&#x3002;
func NodesHaveSameTopologyKey(nodeA, nodeB *v1.Node, topologyKey string) bool {
    if len(topologyKey) == 0 {
        return false
    }

    if nodeA.Labels == nil || nodeB.Labels == nil {
        return false
    }

    nodeALabel, okA := nodeA.Labels[topologyKey]   //&#x53D6;Node&#x4E00;&#x4E2A;&#x88AB;&#x610F;&#x4E49;&#x5316;&#x7684;&#x201C;Label&#x201D;&#x7684;&#x503C;value
    nodeBLabel, okB := nodeB.Labels[topologyKey]

    // If found label in both nodes, check the label
    if okB &amp;&amp; okA {                                  
        return nodeALabel == nodeBLabel             //&#x6BD4;&#x5BF9;  
    }

    return false
}
</code></pre><h3 id="Pod&#x4EB2;&#x548C;&#x6027;&#x4F18;&#x9009;&#x7B56;&#x7565;InterPodAffinityPriority">3.2. Pod&#x4EB2;&#x548C;&#x6027;&#x4F18;&#x9009;&#x7B56;&#x7565;InterPodAffinityPriority</h3>
<p><strong>&#x7B56;&#x7565;&#x8BF4;&#x660E;&#xFF1A;</strong>
&#x5E76;&#x53D1;&#x904D;&#x5386;&#x6240;&#x6709;&#x6F5C;&#x5728;&#x7684;&#x76EE;&#x6807;Nodes&#xFF0C;&#x5BF9;Pods&#x4E0E;&#x9700;&#x88AB;&#x8C03;&#x5EA6;Pod&#x7684;&#x4EB2;&#x548C;&#x548C;&#x53CD;&#x4EB2;&#x6027;&#x68C0;&#x6D4B;&#xFF0C;&#x5BF9;&#x4EB2;&#x6027;&#x5339;&#x914D;&#x5219;&#x589E;&#xFF0C;&#x5BF9;&#x53CD;&#x4EB2;&#x6027;
&#x5339;&#x914D;&#x5219;&#x51CF;&#xFF0C; &#x6700;&#x7EC8;&#x5BF9;&#x6BCF;&#x4E2A;Node&#x8FDB;&#x884C;&#x7EDF;&#x8BA1;&#x5206;&#x6570;&#x3002;  </p>
<p><strong>&#x9002;&#x7528;NodeAffinity&#x914D;&#x7F6E;&#x9879;</strong>&#xFF1A; 
PodAffinity.<code>Preferred</code>DuringSchedulingIgnoredDuringExecution<br>PodAntiAffinity.<code>Preferred</code>DuringSchedulingIgnoredDuringExecution</p>
<p><strong>&#x9884;&#x9009;&#x7B56;&#x7565;&#x6E90;&#x7801;&#x5206;&#x6790;&#xFF1A;</strong></p>
<ol>
<li><strong><em>&#x7B56;&#x7565;&#x6CE8;&#x518C;</em></strong>&#xFF1A;defaultPriorities()&#x6CE8;&#x518C;&#x4E86;&#x4E00;&#x6761;&#x540D;&#x4E3A;&#x201C;InterPodAffinityPriority&#x201D;&#x4F18;&#x9009;&#x7B56;&#x7565;&#x9879;.</li>
</ol>
<div><p class="code-filename">pkg/scheduler/algorithmprovider/defaults/defaults.go:145</p></div>
<pre class="language-"><code class="lang-go"><span class="token comment">// k8s.io/kubernetes/pkg/scheduler/algorithmprovider/defaults/defaults.go</span>
<span class="token keyword">func</span> <span class="token function">defaultPriorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> sets<span class="token punctuation">.</span>String <span class="token punctuation">{</span>
  <span class="token operator">...</span>

    factory<span class="token punctuation">.</span><span class="token function">RegisterPriorityConfigFactory</span><span class="token punctuation">(</span>
            <span class="token string">&quot;InterPodAffinityPriority&quot;</span><span class="token punctuation">,</span>
            factory<span class="token punctuation">.</span>PriorityConfigFactory<span class="token punctuation">{</span>
                Function<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>args factory<span class="token punctuation">.</span>PluginFactoryArgs<span class="token punctuation">)</span> algorithm<span class="token punctuation">.</span>PriorityFunction <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> priorities<span class="token punctuation">.</span><span class="token function">NewInterPodAffinityPriority</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">,</span> args<span class="token punctuation">.</span>NodeLister<span class="token punctuation">,</span> args<span class="token punctuation">.</span>PodLister<span class="token punctuation">,</span> args<span class="token punctuation">.</span>HardPodAffinitySymmetricWeight<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                Weight<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
<ol>
<li><strong>&#x7B56;&#x7565;Func</strong>: <strong>interPodAffinity.CalculateInterPodAffinityPriority()</strong>
&#x901A;&#x8FC7;NewPodAffinityPriority()&#x5B9E;&#x4F8B;&#x5316;interPodAffinityod&#x7C7B;&#x5BF9;&#x8C61;&#x53CA;CalculateInterPodAffinityPriority()&#x7B56;&#x7565;Func&#x8FD4;&#x56DE;&#x3002;</li>
</ol>
<div><p class="code-filename">pkg/scheduler/algorithm/priorities/interpod_affinity.go:45</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">NewInterPodAffinityPriority</span><span class="token punctuation">(</span>
    info predicates<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">,</span>
    nodeLister algorithm<span class="token punctuation">.</span>NodeLister<span class="token punctuation">,</span>
    podLister algorithm<span class="token punctuation">.</span>PodLister<span class="token punctuation">,</span>
    hardPodAffinityWeight <span class="token builtin">int32</span><span class="token punctuation">)</span> algorithm<span class="token punctuation">.</span>PriorityFunction <span class="token punctuation">{</span>
    interPodAffinity <span class="token operator">:=</span> <span class="token operator">&amp;</span>InterPodAffinity<span class="token punctuation">{</span>
        info<span class="token punctuation">:</span>                  info<span class="token punctuation">,</span>
        nodeLister<span class="token punctuation">:</span>            nodeLister<span class="token punctuation">,</span>
        podLister<span class="token punctuation">:</span>             podLister<span class="token punctuation">,</span>
        hardPodAffinityWeight<span class="token punctuation">:</span> hardPodAffinityWeight<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> interPodAffinity<span class="token punctuation">.</span>CalculateInterPodAffinityPriority
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p><strong>CalculateInterPodAffinityPriority()</strong>
&#x57FA;&#x4E8E;pod&#x4EB2;&#x548C;&#x6027;&#x914D;&#x7F6E;&#x5339;&#x914D;&quot;&#x5FC5;&#x8981;&#x6761;&#x4EF6;&#x9879;&#x201D;Terms,&#x5E76;&#x53D1;&#x5904;&#x7406;&#x6240;&#x6709;&#x76EE;&#x6807;nodes,&#x4E3A;&#x5176;&#x76EE;&#x6807;node&#x7EDF;&#x8BA1;&#x4EB2;&#x548C;weight&#x5F97;&#x5206;.
&#x6211;&#x4EEC;&#x5148;&#x6765;&#x770B;&#x4E00;&#x4E0B;&#x5B83;&#x7684;&#x4EE3;&#x7801;&#x7ED3;&#x6784;&#xFF1A;</p>
<ul>
<li>processPod := func(existingPod *v1.Pod) error {&#x2026; <code>pm.processTerms()</code>}</li>
<li>processNode := func(i int) {&#x2026;}</li>
<li>workqueue.ParallelizeUntil(context.TODO(), 16, len(allNodeNames), <code>processNode</code>)</li>
<li>fScore = float64(schedulerapi.MaxPriority) * ((pm.counts[node.Name] - minCount) / (maxCount - minCount))</li>
</ul>
<p>&#x6B64;&#x4EE3;&#x7801;&#x903B;&#x8F91;&#x9700;&#x7406;&#x89E3;&#x51E0;&#x4E2A;&#x5B9A;&#x4E49;&#xFF1A;
pod                                                         &#x4E00;&#x4E2A;&quot;<strong>&#x9700;&#x88AB;&#x8C03;&#x5EA6;&#x7684;Pod&quot;</strong> 
hasAffinityConstraints                        &quot;&#x88AB;&#x8C03;&#x5EA6;&#x7684;pod&quot;&#x662F;&#x5426;&#x6709;&#x5B9A;&#x4E49;&#x4EB2;&#x548C;&#x914D;&#x7F6E; 
hasAntiAffinityConstraints                &quot;&#x88AB;&#x8C03;&#x5EA6;&#x7684;pod&quot;&#x662F;&#x5426;&#x6709;&#x5B9A;&#x4E49;&#x4EB2;&#x548C;&#x914D;&#x7F6E;
existingPod                                            &#x4E00;&#x4E2A;&#x5F85;&#x5904;&#x7406;&#x7684;&quot;<strong>&#x4EB2;&#x548C;&#x76EE;&#x6807;pod</strong>&quot; 
existingPodNode                                  &#x8FD0;&#x884C;&#x6B64;&#x201C;&#x4EB2;&#x548C;&#x76EE;&#x6807;pod&#x201D;&#x7684;&#x8282;&#x70B9;--&#x201C;<strong>&#x76EE;&#x6807;Node</strong>&#x201D;
existingHasAffinityConstraints          &quot;&#x4EB2;&#x548C;&#x76EE;&#x6807;pod&quot;&#x662F;&#x5426;&#x5B58;&#x5728;&#x4EB2;&#x548C;&#x7EA6;&#x675F;<br>existingHasAntiAffinityConstraints    &quot;&#x4EB2;&#x548C;&#x76EE;&#x6807;pod&quot;&#x662F;&#x5426;&#x5B58;&#x5728;&#x53CD;&#x4EB2;&#x548C;&#x7EA6;&#x675F; </p>
</blockquote>
<div><p class="code-filename">pkg/scheduler/algorithm/priorities/interpod_affinity.go:119</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ipa <span class="token operator">*</span>InterPodAffinity<span class="token punctuation">)</span> <span class="token function">CalculateInterPodAffinityPriority</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> nodeNameToInfo <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>schedulercache<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">,</span> nodes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Node<span class="token punctuation">)</span> <span class="token punctuation">(</span>schedulerapi<span class="token punctuation">.</span>HostPriorityList<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    affinity <span class="token operator">:=</span> pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Affinity
  <span class="token comment">//&quot;&#x9700;&#x88AB;&#x8C03;&#x5EA6;Pod&quot;&#x662F;&#x5426;&#x5B58;&#x5728;&#x4EB2;&#x548C;&#x3001;&#x53CD;&#x4EB2;&#x548C;&#x7EA6;&#x675F;&#x914D;&#x7F6E;</span>
    hasAffinityConstraints <span class="token operator">:=</span> affinity <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> affinity<span class="token punctuation">.</span>PodAffinity <span class="token operator">!=</span> <span class="token boolean">nil</span>
    hasAntiAffinityConstraints <span class="token operator">:=</span> affinity <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> affinity<span class="token punctuation">.</span>PodAntiAffinity <span class="token operator">!=</span> <span class="token boolean">nil</span>

    allNodeNames <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>nodeNameToInfo<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> name <span class="token operator">:=</span> <span class="token keyword">range</span> nodeNameToInfo <span class="token punctuation">{</span>
        allNodeNames <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>allNodeNames<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> maxCount <span class="token builtin">float64</span>
    <span class="token keyword">var</span> minCount <span class="token builtin">float64</span>

    pm <span class="token operator">:=</span> <span class="token function">newPodAffinityPriorityMap</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span>

  <span class="token comment">// processPod()&#x4E3B;&#x8981;&#x5904;&#x7406;pod&#x4EB2;&#x548C;&#x548C;&#x53CD;&#x4EB2;&#x548C;weight&#x7D2F;&#x8BA1;&#x7684;&#x903B;&#x8F91;&#x4EE3;&#x7801;&#x3002;                     &#x2461;</span>
  <span class="token comment">// &#x8C03;&#x7528;&#x4E86;Terms&#x5904;&#x7406;&#x65B9;&#x6CD5;&#xFF1A;processTerms()</span>
    processPod <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>existingPod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>     
        <span class="token operator">...</span>
       <span class="token comment">// &#x4EB2;&#x548C;&#x6027;&#x68C0;&#x6D4B;&#x903B;&#x8F91;&#x4EE3;&#x7801;                                                    &#x2460; </span>
       pm<span class="token punctuation">.</span><span class="token function">processTerms</span><span class="token punctuation">(</span>terms<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> existingPod<span class="token punctuation">,</span> existingPodNode<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>
    <span class="token punctuation">}</span>
  <span class="token comment">//ProcessNode()&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x5224;&#x65AD;&#x662F;&#x5426;&#x5B58;&#x5728;&#x4EB2;&#x548C;&#x6027;&#x914D;&#x7F6E;&#x9009;&#x62E9;&#x8C03;&#x7528;processPod()                &#x2462;</span>
    processNode <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token operator">...</span>
                    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">processPod</span><span class="token punctuation">(</span>existingPod<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                        pm<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span>
  <span class="token comment">// &#x5E76;&#x53D1;&#x591A;&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x8C03;&#x7528;ProcessNode()</span>
    workqueue<span class="token punctuation">.</span><span class="token function">ParallelizeUntil</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>allNodeNames<span class="token punctuation">)</span><span class="token punctuation">,</span> processNode<span class="token punctuation">)</span>

  <span class="token operator">...</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> node <span class="token operator">:=</span> <span class="token keyword">range</span> nodes <span class="token punctuation">{</span>
        <span class="token keyword">if</span> pm<span class="token punctuation">.</span>counts<span class="token punctuation">[</span>node<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">&gt;</span> maxCount <span class="token punctuation">{</span>
            maxCount <span class="token operator">=</span> pm<span class="token punctuation">.</span>counts<span class="token punctuation">[</span>node<span class="token punctuation">.</span>Name<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> pm<span class="token punctuation">.</span>counts<span class="token punctuation">[</span>node<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">&lt;</span> minCount <span class="token punctuation">{</span>
            minCount <span class="token operator">=</span> pm<span class="token punctuation">.</span>counts<span class="token punctuation">[</span>node<span class="token punctuation">.</span>Name<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    result <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>schedulerapi<span class="token punctuation">.</span>HostPriorityList<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> node <span class="token operator">:=</span> <span class="token keyword">range</span> nodes <span class="token punctuation">{</span>
        fScore <span class="token operator">:=</span> <span class="token function">float64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>maxCount <span class="token operator">-</span> minCount<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>           <span class="token comment">//reduce&#x8BA1;&#x7B97;fScore&#x5206;             &#x2463; </span>
            fScore <span class="token operator">=</span> <span class="token function">float64</span><span class="token punctuation">(</span>schedulerapi<span class="token punctuation">.</span>MaxPriority<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span>counts<span class="token punctuation">[</span>node<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">-</span> minCount<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>maxCount <span class="token operator">-</span> minCount<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        result <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> schedulerapi<span class="token punctuation">.</span>HostPriority<span class="token punctuation">{</span>
                                 Host<span class="token punctuation">:</span> node<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> 
                                 Score<span class="token punctuation">:</span> <span class="token function">int</span><span class="token punctuation">(</span>fScore<span class="token punctuation">)</span>
                                 <span class="token punctuation">}</span><span class="token punctuation">)</span>  
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x2460; <strong>ProcessTerms()</strong>
&#x7ED9;&#x5B9A;Pod&#x548C;&#x6B64;Pod&#x7684;&#x5B9A;&#x4E49;&#x7684;&#x4EB2;&#x548C;&#x6027;&#x914D;&#x7F6E;(podAffinityTerm)&#x3001;&#x88AB;&#x6D4B;&#x76EE;&#x6807;pod&#x3001;&#x8FD0;&#x884C;&#x88AB;&#x6D4B;&#x76EE;&#x6807;pod&#x7684;Node&#x4FE1;&#x606F;&#xFF0C;&#x5BF9;&#x6240;&#x6709;&#x6F5C;&#x5728;&#x53EF;&#x88AB;&#x8C03;&#x5EA6;&#x7684;Nodes&#x5217;&#x8868;&#x8FDB;&#x884C;&#x4E00;&#x4E00;&#x68C0;&#x6D4B;,&#x5E76;&#x5BF9;&#x6839;&#x636E;&#x68C0;&#x6D4B;&#x7ED3;&#x679C;&#x4E3A;node&#x8FDB;&#x884C;weight&#x7D2F;&#x8BA1;&#x3002; 
&#x6D41;&#x7A0B;&#x5982;&#x4E0B;&#xFF1A; </p>
<ol>
<li><p>&#x201C;&#x88AB;&#x6D4B;Pod&#x201D;&#x7684;namespaces&#x662F;&#x5426;&#x4E0E;&#x201C;&#x7ED9;&#x5B9A;&#x7684;pod&#x201D;&#x7684;namespaces&#x662F;&#x5426;&#x4E00;&#x81F4;&#xFF1B; </p>
</li>
<li><p>&#x201C;&#x88AB;&#x6D4B;Pod&#x201D;&#x7684;labels&#x662F;&#x5426;&#x4E0E;&#x201C;&#x7ED9;&#x5B9A;&#x7684;pod&#x201D;&#x7684;podAffinityTerm&#x5B9A;&#x4E49;&#x5339;&#x914D;;</p>
</li>
<li><p>&#x5982;&#x679C;&#x524D;&#x4E24;&#x6761;&#x4EF6;&#x90FD;&#x4E3A;True&#xFF0C;&#x5219;&#x5BF9;&#x8FD0;&#x884C;&#x201C;&#x88AB;&#x6D4B;&#x7684;pod&#x201D;&#x7684;node&#x7684;TopologyKey&#x7684;&#x503C;&#x4E0E;&#x6240;&#x6709;&#x6F5C;&#x5728;&#x53EF;&#x88AB;&#x8C03;&#x5EA6;&#x7684;Node&#x8FDB;&#x884C;&#x904D;&#x5386;&#x68C0;&#x6D4B; TopologyKey&#x7684;&#x503C;&#x662F;&#x5426;&#x4E00;&#x81F4;&#xFF0C;true&#x5219;&#x7D2F;&#x8BA1;weight&#x503C;.</p>
<blockquote>
<blockquote>
<p>&#x903B;&#x8F91;&#x7406;&#x89E3;&#xFF1A;</p>
<p><code>1</code>&#x4E0E;<code>2</code>&#x5B9E;&#x73B0;&#x4E86;&#x627E;&#x51FA;&#x5728;&#x540C;&#x4E00;&#x4E2A;namespace&#x4E0B;&#x6EE1;&#x8DB3;&#x88AB;&#x8C03;pod&#x6240;&#x914D;&#x7F6E;podAffinityTerm&#x7684;pods;</p>
<p><code>3</code>&#x5219;&#x5B9E;&#x73B0;&#x83B7;&#x53D6;topologyKey&#x7684;&#x503C;&#x4E0E;&#x6F5C;&#x5728;&#x88AB;&#x8C03;&#x5EA6;&#x7684;Node&#x8FDB;&#x884C;&#x5339;&#x914D;&#x68C0;&#x6D4B;&#x201D; .</p>
<p><code>&#x6B64;&#x5904;&#x5219;&#x53EF;&#x6E05;&#x695A;&#x7684;&#x7406;&#x89E3;pod&#x4EB2;&#x548C;&#x6027;&#x914D;&#x7F6E;&#x5339;&#x914D;&#x7684;&#x5185;&#x5728;&#x542B;&#x4E49;&#x4E0E;&#x903B;&#x8F91;&#x3002;</code></p>
</blockquote>
</blockquote>
</li>
</ol>
<div><p class="code-filename">pkg/scheduler/algorithm/priorities/interpod_affinity.go:107</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>podAffinityPriorityMap<span class="token punctuation">)</span> <span class="token function">processTerms</span><span class="token punctuation">(</span>terms <span class="token punctuation">[</span><span class="token punctuation">]</span>v1<span class="token punctuation">.</span>WeightedPodAffinityTerm<span class="token punctuation">,</span> podDefiningAffinityTerm<span class="token punctuation">,</span> podToCheck <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> fixedNode <span class="token operator">*</span>v1<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> multiplier <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> terms <span class="token punctuation">{</span>
        term <span class="token operator">:=</span> <span class="token operator">&amp;</span>terms<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        p<span class="token punctuation">.</span><span class="token function">processTerm</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>term<span class="token punctuation">.</span>PodAffinityTerm<span class="token punctuation">,</span> podDefiningAffinityTerm<span class="token punctuation">,</span> podToCheck<span class="token punctuation">,</span> fixedNode<span class="token punctuation">,</span> <span class="token function">float64</span><span class="token punctuation">(</span>term<span class="token punctuation">.</span>Weight<span class="token operator">*</span><span class="token function">int32</span><span class="token punctuation">(</span>multiplier<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>podAffinityPriorityMap<span class="token punctuation">)</span> <span class="token function">processTerm</span><span class="token punctuation">(</span>term <span class="token operator">*</span>v1<span class="token punctuation">.</span>PodAffinityTerm<span class="token punctuation">,</span> podDefiningAffinityTerm<span class="token punctuation">,</span> podToCheck <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> fixedNode <span class="token operator">*</span>v1<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> weight <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x83B7;&#x53D6;namesapce&#x4FE1;&#x606F;(affinityTerm.Namespaces&#x6216;pod.Namesapce)</span>
    <span class="token comment">// &#x6839;&#x636E;podAffinityTerm&#x5B9A;&#x4E49;&#x751F;&#x6210;selector&#x5BF9;&#x8C61;&#xFF08;&#x53C2;&#x770B;&#x672C;&#x6587;&#x5F00;&#x5934;&#x7684;&#x8FF0;labelSelector&#xFF09;</span>
    namespaces <span class="token operator">:=</span> priorityutil<span class="token punctuation">.</span><span class="token function">GetNamespacesFromPodAffinityTerm</span><span class="token punctuation">(</span>podDefiningAffinityTerm<span class="token punctuation">,</span> term<span class="token punctuation">)</span>
    selector<span class="token punctuation">,</span> err <span class="token operator">:=</span> metav1<span class="token punctuation">.</span><span class="token function">LabelSelectorAsSelector</span><span class="token punctuation">(</span>term<span class="token punctuation">.</span>LabelSelector<span class="token punctuation">)</span> <span class="token comment">//labeSelector</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        p<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//&#x5224;&#x65AD;&#x201C;&#x88AB;&#x68C0;&#x6D4B;&#x7684;Pod&#x201D;&#x7684;Namespace&#x548C;Selector Labels&#x662F;&#x5426;&#x5339;&#x914D;</span>
    match <span class="token operator">:=</span> priorityutil<span class="token punctuation">.</span><span class="token function">PodMatchesTermsNamespaceAndSelector</span><span class="token punctuation">(</span>podToCheck<span class="token punctuation">,</span> namespaces<span class="token punctuation">,</span> selector<span class="token punctuation">)</span>
    <span class="token keyword">if</span> match <span class="token punctuation">{</span>
        <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            p<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">defer</span> p<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> node <span class="token operator">:=</span> <span class="token keyword">range</span> p<span class="token punctuation">.</span>nodes <span class="token punctuation">{</span>
                <span class="token comment">//&#x5BF9;&quot;&#x8FD0;&#x884C;&#x88AB;&#x68C0;&#x6D4B;&#x4EB2;&#x548C;Pod&#x7684;Node&#x8282;&#x70B9;&quot; &#x4E0E;&#x88AB;&#x8003;&#x8651;&#x7684;&#x6240;&#x6709;Nodes&#x8FDB;&#x884C;&#x4E00;&#x4E00;&#x5339;&#x914D;TopologyKey&#x68C0;&#x67E5;,&#x5982;&#x76F8;&#x7B49;&#x5219;&#x8FDB;&#x884C;&#x7D2F;&#x52A0;&#x6743;&#x503C;</span>
                <span class="token keyword">if</span> priorityutil<span class="token punctuation">.</span><span class="token function">NodesHaveSameTopologyKey</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> fixedNode<span class="token punctuation">,</span> term<span class="token punctuation">.</span>TopologyKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    p<span class="token punctuation">.</span>counts<span class="token punctuation">[</span>node<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">+=</span> weight
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><em>GetNamespaceFromPodAffinitTerm()</em>
&#x8FD4;&#x56DE;Namespaces&#x5217;&#x8868;&#xFF08;&#x5982;&#x679C;term&#x672A;&#x6307;&#x5B9A;Namespace&#x5219;&#x4F7F;&#x7528;&#x88AB;&#x8C03;&#x5EA6;pod&#x7684;Namespace&#xFF09;</p>
<div><p class="code-filename">pkg/scheduler/algorithm/priorities/util/topologies.go:28</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">GetNamespacesFromPodAffinityTerm</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> podAffinityTerm <span class="token operator">*</span>v1<span class="token punctuation">.</span>PodAffinityTerm<span class="token punctuation">)</span> sets<span class="token punctuation">.</span>String <span class="token punctuation">{</span>
    names <span class="token operator">:=</span> sets<span class="token punctuation">.</span>String<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>podAffinityTerm<span class="token punctuation">.</span>Namespaces<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        names<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        names<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>podAffinityTerm<span class="token punctuation">.</span>Namespaces<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> names
<span class="token punctuation">}</span>
</code></pre>
<p><em>PodMatchesTermsNamespaceAndSelector()</em>
&#x68C0;&#x6D4B;NameSpace&#x4E00;&#x81F4;&#x6027;&#x548C;Labels.selector&#x662F;&#x5426;&#x5339;&#x914D;.</p>
<div><p class="code-filename">pkg/scheduler/algorithm/priorities/util/topologies.go:40</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">PodMatchesTermsNamespaceAndSelector</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> namespaces sets<span class="token punctuation">.</span>String<span class="token punctuation">,</span> selector labels<span class="token punctuation">.</span>Selector<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>namespaces<span class="token punctuation">.</span><span class="token function">Has</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token operator">!</span>selector<span class="token punctuation">.</span><span class="token function">Matches</span><span class="token punctuation">(</span>labels<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Labels<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x2461; <strong>processPod() </strong> &#x5904;&#x7406;&#x4EB2;&#x548C;&#x548C;&#x53CD;&#x4EB2;&#x548C;&#x903B;&#x8F91;&#x5C42;&#xFF0C;&#x8C03;&#x7528;processTerms()&#x8FDB;&#x884C;&#x68C0;&#x6D4B;&#x4E0E;&#x7EDF;&#x8BA1;&#x6743;&#x91CD;&#x503C;&#x3002;</p>
<div><p class="code-filename">pkg/scheduler/algorithm/priorities/interpod_affinity.go:136</p></div>
<pre class="language-"><code class="lang-go">    processPod <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>existingPod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
        existingPodNode<span class="token punctuation">,</span> err <span class="token operator">:=</span> ipa<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">GetNodeInfo</span><span class="token punctuation">(</span>existingPod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>NodeName<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> apierrors<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Node not found, %v&quot;</span><span class="token punctuation">,</span> existingPod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>NodeName<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> err
        <span class="token punctuation">}</span>
        existingPodAffinity <span class="token operator">:=</span> existingPod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Affinity
        existingHasAffinityConstraints <span class="token operator">:=</span> existingPodAffinity <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> existingPodAffinity<span class="token punctuation">.</span>PodAffinity <span class="token operator">!=</span> <span class="token boolean">nil</span>
        existingHasAntiAffinityConstraints <span class="token operator">:=</span> existingPodAffinity <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> existingPodAffinity<span class="token punctuation">.</span>PodAntiAffinity <span class="token operator">!=</span> <span class="token boolean">nil</span>
    <span class="token comment">//&#x5982;&#x679C;&quot;&#x9700;&#x88AB;&#x8C03;&#x5EA6;&#x7684;Pod&quot;&#x5B58;&#x5728;&#x4EB2;&#x548C;&#x7EA6;&#x675F;&#xFF0C;&#x5219;&#x4E0E;&quot;&#x4EB2;&#x548C;&#x76EE;&#x6807;Pod&quot;&#x548C;&quot;&#x4EB2;&#x548C;&#x76EE;&#x6807;Node&quot;&#x8FDB;&#x884C;&#x4E00;&#x6B21;ProcessTerms()&#x68C0;&#x6D4B;&#xFF0C;&#x5982;&#x679C;&#x6210;&#x7ACB;&#x5219;wieght&#x6743;&#x91CD;&#x503C;&#x52A0;1&#x500D;.</span>
        <span class="token keyword">if</span> hasAffinityConstraints <span class="token punctuation">{</span>
            terms <span class="token operator">:=</span> affinity<span class="token punctuation">.</span>PodAffinity<span class="token punctuation">.</span>PreferredDuringSchedulingIgnoredDuringExecution
            pm<span class="token punctuation">.</span><span class="token function">processTerms</span><span class="token punctuation">(</span>terms<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> existingPod<span class="token punctuation">,</span> existingPodNode<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token comment">// &#x5982;&#x679C;&quot;&#x9700;&#x88AB;&#x8C03;&#x5EA6;&#x7684;Pod&quot;&#x5B58;&#x5728;&#x53CD;&#x4EB2;&#x548C;&#x7EA6;&#x675F;&#xFF0C;&#x5219;&#x4E0E;&quot;&#x4EB2;&#x548C;&#x76EE;&#x6807;Pod&quot;&#x548C;&quot;&#x4EB2;&#x548C;&#x76EE;&#x6807;Node&quot;&#x8FDB;&#x884C;&#x4E00;&#x6B21;ProcessTerms()&#x68C0;&#x6D4B;&#xFF0C;&#x5982;&#x679C;&#x6210;&#x7ACB;&#x5219;wieght&#x6743;&#x91CD;&#x503C;&#x51CF;1&#x500D;.</span>
        <span class="token keyword">if</span> hasAntiAffinityConstraints <span class="token punctuation">{</span>
            terms <span class="token operator">:=</span> affinity<span class="token punctuation">.</span>PodAntiAffinity<span class="token punctuation">.</span>PreferredDuringSchedulingIgnoredDuringExecution
            pm<span class="token punctuation">.</span><span class="token function">processTerms</span><span class="token punctuation">(</span>terms<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> existingPod<span class="token punctuation">,</span> existingPodNode<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
   <span class="token comment">//&#x5982;&#x679C;&quot;&#x4EB2;&#x548C;&#x76EE;&#x6807;Pod&quot;&#x5B58;&#x5728;&#x4EB2;&#x548C;&#x7EA6;&#x675F;&#xFF0C;&#x5219;&#x53CD;&#x8FC7;&#x6765;&#x4E0E;&quot;&#x9700;&#x88AB;&#x8C03;&#x5EA6;&#x7684;Pod&quot;&#x548C;&quot;&#x4EB2;&#x548C;&#x76EE;&#x6807;Node&quot;&#x8FDB;&#x884C;&#x4E00;&#x6B21;ProcessTerms()&#x68C0;&#x6D4B;&#xFF0C;&#x5982;&#x679C;&#x6210;&#x7ACB;&#x5219;wieght&#x6743;&#x91CD;&#x503C;&#x52A0;1&#x500D;. </span>
        <span class="token keyword">if</span> existingHasAffinityConstraints <span class="token punctuation">{</span>
            <span class="token keyword">if</span> ipa<span class="token punctuation">.</span>hardPodAffinityWeight <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                terms <span class="token operator">:=</span> existingPodAffinity<span class="token punctuation">.</span>PodAffinity<span class="token punctuation">.</span>RequiredDuringSchedulingIgnoredDuringExecution
                <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> term <span class="token operator">:=</span> <span class="token keyword">range</span> terms <span class="token punctuation">{</span>
                    pm<span class="token punctuation">.</span><span class="token function">processTerm</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>term<span class="token punctuation">,</span> existingPod<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> existingPodNode<span class="token punctuation">,</span> <span class="token function">float64</span><span class="token punctuation">(</span>ipa<span class="token punctuation">.</span>hardPodAffinityWeight<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            terms <span class="token operator">:=</span> existingPodAffinity<span class="token punctuation">.</span>PodAffinity<span class="token punctuation">.</span>PreferredDuringSchedulingIgnoredDuringExecution
            pm<span class="token punctuation">.</span><span class="token function">processTerms</span><span class="token punctuation">(</span>terms<span class="token punctuation">,</span> existingPod<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> existingPodNode<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token comment">// &#x5982;&#x679C;&quot;&#x4EB2;&#x548C;&#x76EE;&#x6807;Pod&quot;&#x5B58;&#x5728;&#x53CD;&#x4EB2;&#x548C;&#x7EA6;&#x675F;&#xFF0C;&#x5219;&#x53CD;&#x8FC7;&#x6765;&#x4E0E;&quot;&#x9700;&#x88AB;&#x8C03;&#x5EA6;&#x7684;Pod&quot;&#x548C;&quot;&#x4EB2;&#x548C;&#x76EE;&#x6807;Node&quot;&#x8FDB;&#x884C;&#x4E00;&#x6B21;ProcessTerms()&#x68C0;&#x6D4B;&#xFF0C;&#x5982;&#x679C;&#x6210;&#x7ACB;&#x5219;wieght&#x6743;&#x91CD;&#x503C;&#x51CF;1&#x500D;.</span>
        <span class="token keyword">if</span> existingHasAntiAffinityConstraints <span class="token punctuation">{</span>
            terms <span class="token operator">:=</span> existingPodAffinity<span class="token punctuation">.</span>PodAntiAffinity<span class="token punctuation">.</span>PreferredDuringSchedulingIgnoredDuringExecution
            pm<span class="token punctuation">.</span><span class="token function">processTerms</span><span class="token punctuation">(</span>terms<span class="token punctuation">,</span> existingPod<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> existingPodNode<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x2462; <strong>processNode </strong> &#x5982;&#x679C;&quot;&#x88AB;&#x8C03;&#x5EA6;pod&quot;&#x672A;&#x5B9A;&#x4E49;&#x4EB2;&#x548C;&#x914D;&#x7F6E;&#xFF0C;&#x5219;&#x68C0;&#x6D4B;&#x6F5C;&#x5728;Nodes&#x7684;&#x4EB2;&#x548C;&#x6027;&#x5B9A;&#x4E49;.</p>
<div><p class="code-filename">pkg/scheduler/algorithm/priorities/interpod_affinity.go:193</p></div>
<pre class="language-"><code class="lang-go">    processNode <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nodeInfo <span class="token operator">:=</span> nodeNameToInfo<span class="token punctuation">[</span>allNodeNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> nodeInfo<span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> hasAffinityConstraints <span class="token operator">||</span> hasAntiAffinityConstraints <span class="token punctuation">{</span>
                <span class="token comment">// We need to process all the nodes.</span>
                <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> existingPod <span class="token operator">:=</span> <span class="token keyword">range</span> nodeInfo<span class="token punctuation">.</span><span class="token function">Pods</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">processPod</span><span class="token punctuation">(</span>existingPod<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                        pm<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> existingPod <span class="token operator">:=</span> <span class="token keyword">range</span> nodeInfo<span class="token punctuation">.</span><span class="token function">PodsWithAffinity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">processPod</span><span class="token punctuation">(</span>existingPod<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                        pm<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>&#x2463; &#x6700;&#x540E;&#x7684;&#x5F97;&#x5206;fscore&#x8BA1;&#x7B97;&#x516C;&#x5F0F;&#xFF1A;</p>
<pre class="language-"><code class="lang-go"><span class="token comment">// 10 * (node&#x6743;&#x91CD;&#x7D2F;&#x8BA1;&#x503C; - &#x6700;&#x5C0F;&#x6743;&#x91CD;&#x5F97;&#x5206;&#x503C;) / (&#x6700;&#x5927;&#x6743;&#x91CD;&#x5F97;&#x5206;&#x503C; - &#x6700;&#x5C0F;&#x6743;&#x91CD;&#x5F97;&#x5206;&#x503C;)</span>
fScore <span class="token operator">=</span> <span class="token function">float64</span><span class="token punctuation">(</span>schedulerapi<span class="token punctuation">.</span>MaxPriority<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span>counts<span class="token punctuation">[</span>node<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">-</span> minCount<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>maxCount <span class="token operator">-</span> minCount<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
    <span class="token comment">// MaxPriority defines the max priority value.</span>
    MaxPriority <span class="token operator">=</span> <span class="token number">10</span>
<span class="token punctuation">)</span>
</code></pre>
<h2 id="Service&#x4EB2;&#x548C;&#x6027;">4. Service&#x4EB2;&#x548C;&#x6027;</h2>
<p>&#x5728;default&#x8C03;&#x5EA6;&#x5668;&#x4EE3;&#x7801;&#x5185;&#x5E76;&#x672A;&#x6CE8;&#x518C;&#x6B64;&#x9884;&#x9009;&#x7B56;&#x7565;&#xFF0C;&#x4EC5;&#x6709;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#x3002;&#x8FDE;google/baidu&#x4E0A;&#x90FD;&#x65E0;&#x6CD5;&#x67E5;&#x8BE2;&#x5230;&#x76F8;&#x5173;&#x4F7F;&#x7528;&#x6848;&#x4F8B;&#xFF0C;&#x914D;&#x7F6E;&#x7528;&#x6CD5;&#x4E0D;&#x4E88;&#x5206;&#x6790;&#xFF0C;&#x4EC5;&#x770B;&#x4E0B;&#x9762;&#x6E90;&#x7801;&#x8BE6;&#x7EC6;&#x5206;&#x6790;&#x3002; </p>
<p>&#x4EE3;&#x7801;&#x573A;&#x666F;&#x5E94;&#x7528;&#x6CE8;&#x91CA;&#x8BD1;&#x6587;&#xFF1A;
<em>&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;Pod&#x88AB;&#x8C03;&#x5EA6;&#x5230;&#x5E26;&#x6709;Label &#x201C;region=foo&#x201D;&#x7684;Nodes&#xFF08;&#x8D44;&#x6E90;&#x96C6;&#x7FA4;&#xFF09;&#x4E0A;&#xFF0C; &#x90A3;&#x4E48;&#x5176;&#x670D;&#x52A1;&#x540E;&#x9762;&#x7684;&#x5176;&#x5B83;Pod&#x90FD;&#x5C06;&#x8C03;&#x5EA6;&#x81F3;Label &#x201C;region=foo&#x201D;&#x7684;Nodes&#x3002;</em> </p>
<h3 id="Serice&#x4EB2;&#x548C;&#x6027;&#x9884;&#x9009;&#x7B56;&#x7565;checkServiceAffinity">4.1. Serice&#x4EB2;&#x548C;&#x6027;&#x9884;&#x9009;&#x7B56;&#x7565;checkServiceAffinity</h3>
<blockquote>
<p>&#x901A;&#x8FC7;NewServiceAffinityPredicate()&#x521B;&#x5EFA;&#x4E00;&#x4E2A;ServiceAffinity&#x7C7B;&#x5BF9;&#x8C61;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x4E24;&#x4E2A;&#x9884;&#x9009;&#x7B56;&#x7565;&#x6240;&#x5FC5;&#x987B;&#x7684;&#x5904;&#x7406;Func:</p>
<ul>
<li><p>affinity.checkServiceAffinity      &#x57FA;&#x4E8E;&#x9884;&#x9009;&#x5143;&#x6570;&#x636E;Meta&#xFF0C;&#x5BF9;&#x88AB;&#x8C03;&#x5EA6;&#x7684;pod&#x68C0;&#x6D4B;Node&#x662F;&#x5426;&#x6EE1;&#x8DB3;&#x670D;&#x52A1;&#x4EB2;&#x548C;&#x6027;. </p>
</li>
<li><p>affinity.serverAffinityMetadataProducer  &#x57FA;&#x4E8E;&#x9884;&#x9009;Meta&#x7684;pod&#x4FE1;&#x606F;&#xFF0C;&#x83B7;&#x53D6;<strong>&#x670D;&#x52A1;&#x4FE1;&#x606F;</strong>&#x548C;&#x5728;&#x76F8;&#x540C;NameSpace&#x4E0B;&#x7684;&#x7684;<strong>Pod&#x5217;&#x8868;</strong>&#xFF0C;&#x4F9B;&#x4EB2;&#x548C;&#x68C0;&#x6D4B;&#x65F6;&#x4F7F;&#x7528;&#x3002; </p>
</li>
</ul>
<p><em>&#x540E;&#x9762;&#x5C06;&#x8BE6;&#x8FF0;&#x5904;&#x7406;func</em> </p>
</blockquote>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/predicates.go:955</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">NewServiceAffinityPredicate</span><span class="token punctuation">(</span>podLister algorithm<span class="token punctuation">.</span>PodLister<span class="token punctuation">,</span> serviceLister algorithm<span class="token punctuation">.</span>ServiceLister<span class="token punctuation">,</span> nodeInfo NodeInfo<span class="token punctuation">,</span> labels <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>algorithm<span class="token punctuation">.</span>FitPredicate<span class="token punctuation">,</span> PredicateMetadataProducer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    affinity <span class="token operator">:=</span> <span class="token operator">&amp;</span>ServiceAffinity<span class="token punctuation">{</span>
        podLister<span class="token punctuation">:</span>     podLister<span class="token punctuation">,</span>
        serviceLister<span class="token punctuation">:</span> serviceLister<span class="token punctuation">,</span>
        nodeInfo<span class="token punctuation">:</span>      nodeInfo<span class="token punctuation">,</span>
        labels<span class="token punctuation">:</span>        labels<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> affinity<span class="token punctuation">.</span>checkServiceAffinity<span class="token punctuation">,</span> affinity<span class="token punctuation">.</span>serviceAffinityMetadataProducer
<span class="token punctuation">}</span>
</code></pre>
<p><strong>affinity.serverAffinityMetadataProducer()</strong>
&#x8F93;&#x5165;&#xFF1A;predicateMateData 
&#x8FD4;&#x56DE;&#xFF1A;services &#x548C; pods </p>
<ol>
<li>&#x57FA;&#x4E8E;&#x9884;&#x9009;MetaData&#x7684;pod&#x4FE1;&#x606F;&#x67E5;&#x8BE2;&#x51FA;services </li>
<li>&#x57FA;&#x4E8E;&#x9884;&#x9009;MetaData&#x7684;pod Lables&#x83B7;&#x53D6;&#x6240;&#x6709;&#x5339;&#x914D;&#x7684;pods,&#x4E14;&#x8FC7;&#x6EE4;&#x6389;&#x4EC5;&#x5269;&#x5728;&#x540C;&#x4E00;&#x4E2A;Namespace&#x7684;pods&#x3002; </li>
</ol>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/predicates.go:934</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>ServiceAffinity<span class="token punctuation">)</span> <span class="token function">serviceAffinityMetadataProducer</span><span class="token punctuation">(</span>pm <span class="token operator">*</span>predicateMetadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> pm<span class="token punctuation">.</span>pod <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot precompute service affinity, a pod is required to calculate service affinity.&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    pm<span class="token punctuation">.</span>serviceAffinityInUse <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">var</span> errSvc<span class="token punctuation">,</span> errList <span class="token builtin">error</span>
    <span class="token comment">// 1.&#x57FA;&#x4E8E;&#x9884;&#x9009;MetaData&#x7684;pod&#x4FE1;&#x606F;&#x67E5;&#x8BE2;services</span>
    pm<span class="token punctuation">.</span>serviceAffinityMatchingPodServices<span class="token punctuation">,</span> errSvc <span class="token operator">=</span> s<span class="token punctuation">.</span>serviceLister<span class="token punctuation">.</span><span class="token function">GetPodServices</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span>pod<span class="token punctuation">)</span>
    <span class="token comment">// 2.&#x57FA;&#x4E8E;&#x9884;&#x9009;MetaData&#x7684;pod Lables&#x83B7;&#x53D6;&#x6240;&#x6709;&#x5339;&#x914D;&#x7684;pods</span>
    selector <span class="token operator">:=</span> <span class="token function">CreateSelectorFromLabels</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span>pod<span class="token punctuation">.</span>Labels<span class="token punctuation">)</span>
    allMatches<span class="token punctuation">,</span> errList <span class="token operator">:=</span> s<span class="token punctuation">.</span>podLister<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span>

    <span class="token comment">// In the future maybe we will return them as part of the function.</span>
    <span class="token keyword">if</span> errSvc <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> errList <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Some Error were found while precomputing svc affinity: \nservices:%v , \npods:%v&quot;</span><span class="token punctuation">,</span> errSvc<span class="token punctuation">,</span> errList<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3.&#x8FC7;&#x6EE4;&#x6389;&#x4EC5;&#x5269;&#x5728;&#x540C;&#x4E00;&#x4E2A;Namespace&#x7684;pods</span>
    pm<span class="token punctuation">.</span>serviceAffinityMatchingPodList <span class="token operator">=</span> <span class="token function">FilterPodsByNamespace</span><span class="token punctuation">(</span>allMatches<span class="token punctuation">,</span> pm<span class="token punctuation">.</span>pod<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>affinity.checkServiceAffinity()</strong>
&#x57FA;&#x4E8E;&#x9884;&#x5904;&#x7406;&#x7684;MetaData&#xFF0C;&#x5BF9;&#x88AB;&#x8C03;&#x5EA6;&#x7684;pod&#x68C0;&#x6D4B;Node&#x662F;&#x5426;&#x6EE1;&#x8DB3;&#x670D;&#x52A1;&#x4EB2;&#x548C;&#x6027;&#x3002;</p>
<blockquote>
<blockquote>
<p>&#x6700;&#x7EC8;&#x7684;&#x4EB2;&#x548C;&#x68C0;&#x6D4B;Labels: </p>
<p>&#x200B;    Final affinityLabels =&#xFF08;A &#x2229; B&#xFF09;+ &#xFF08;B &#x2229; C&#xFF09;  &#x4E0E; node.Labels &#x8FDB;&#x884C;Match&#x8BA1;&#x7B97;  //&#x2229;&#x4EA4;&#x96C6;&#x7B26;&#x53F7; </p>
<p>A: <code>&#x9700;&#x88AB;&#x8C03;&#x5EA6;pod</code>&#x7684;<code>NodeSelector&#x914D;&#x7F6E;</code> 
B: <code>&#x9700;&#x88AB;&#x8C03;&#x5EA6;pod</code>&#x5B9A;&#x4E49;&#x7684;&#x670D;&#x52A1;&#x4EB2;&#x548C;<code>affinityLabels&#x914D;&#x7F6E;</code> 
C: &#x88AB;&#x9009;&#x5B9A;&#x7684;<code>&#x4EB2;&#x548C;&#x76EE;&#x6807;Node</code>&#x7684;<code>Lables</code></p>
</blockquote>
</blockquote>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/predicates.go:992</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>ServiceAffinity<span class="token punctuation">)</span> <span class="token function">checkServiceAffinity</span><span class="token punctuation">(</span>pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> meta algorithm<span class="token punctuation">.</span>PredicateMetadata<span class="token punctuation">,</span> nodeInfo <span class="token operator">*</span>schedulercache<span class="token punctuation">.</span>NodeInfo<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>algorithm<span class="token punctuation">.</span>PredicateFailureReason<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> services <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Service
    <span class="token keyword">var</span> pods <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod
    <span class="token keyword">if</span> pm<span class="token punctuation">,</span> ok <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>predicateMetadata<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pm<span class="token punctuation">.</span>serviceAffinityMatchingPodList <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> pm<span class="token punctuation">.</span>serviceAffinityMatchingPodServices <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        services <span class="token operator">=</span> pm<span class="token punctuation">.</span>serviceAffinityMatchingPodServices
        pods <span class="token operator">=</span> pm<span class="token punctuation">.</span>serviceAffinityMatchingPodList
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Make the predicate resilient in case metadata is missing.</span>
        pm <span class="token operator">=</span> <span class="token operator">&amp;</span>predicateMetadata<span class="token punctuation">{</span>pod<span class="token punctuation">:</span> pod<span class="token punctuation">}</span>
        s<span class="token punctuation">.</span><span class="token function">serviceAffinityMetadataProducer</span><span class="token punctuation">(</span>pm<span class="token punctuation">)</span>
        pods<span class="token punctuation">,</span> services <span class="token operator">=</span> pm<span class="token punctuation">.</span>serviceAffinityMatchingPodList<span class="token punctuation">,</span> pm<span class="token punctuation">.</span>serviceAffinityMatchingPodServices
    <span class="token punctuation">}</span>
    <span class="token comment">// &#x7B5B;&#x9009;&#x6389;&#x5B58;&#x5728;&#x4E8E;Node&#xFF08;nodeinfo&#xFF09;&#x4E0A;pods&#xFF0C;&#x4E14;&#x4E0E;&#x4E4B;&#x8FDB;&#x884C;podKey&#x6BD4;&#x5BF9;&#x4E0D;&#x76F8;&#x7B49;&#x7684;pods&#x3002;          &#x2460;</span>
    filteredPods <span class="token operator">:=</span> nodeInfo<span class="token punctuation">.</span><span class="token function">FilterOutPods</span><span class="token punctuation">(</span>pods<span class="token punctuation">)</span>
    node <span class="token operator">:=</span> nodeInfo<span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> node <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;node not found&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// affinityLabes&#x4EA4;&#x96C6; ==&#xFF08;A &#x2229; B&#xFF09; </span>
  <span class="token comment">// A&#xFF1A;&#x88AB;&#x8C03;&#x5EA6;pod&#x7684;NodeSelector&#x5B9A;&#x4E49;  B&#xFF1A;&#x5B9A;&#x4E49;&#x7684;&#x4EB2;&#x548C;&#x6027;Labels                           &#x2461;</span>
    affinityLabels <span class="token operator">:=</span> <span class="token function">FindLabelsInSet</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>labels<span class="token punctuation">,</span> labels<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>NodeSelector<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// Step 1: If we don&apos;t have all constraints, introspect nodes to find the missing constraints.</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>labels<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token function">len</span><span class="token punctuation">(</span>affinityLabels<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>services<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>filteredPods<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                <span class="token comment">//&quot;&#x88AB;&#x9009;&#x5B9A;&#x7684;&#x4EB2;&#x548C;Node&quot;</span>
        <span class="token comment">//&#x57FA;&#x4E8E;&#x7B2C;&#x4E00;&#x4E2A;filteredPods&#x83B7;&#x53D6;Node&#x4FE1;&#x606F;</span>
                nodeWithAffinityLabels<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>nodeInfo<span class="token punctuation">.</span><span class="token function">GetNodeInfo</span><span class="token punctuation">(</span>filteredPods<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>NodeName<span class="token punctuation">)</span>
                <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
                <span class="token punctuation">}</span>
                <span class="token comment">// &#x8F93;&#x5165;&#xFF1A;&#x4EA4;&#x96C6;Labels&#x3001;&#x670D;&#x52A1;&#x4EB2;&#x548C;Labels&#x3001;&#x88AB;&#x9009;&#x51FA;&#x7684;&#x4EB2;&#x548C;Node Lables</span>
                <span class="token comment">// affinityLabels = affinityLabels + &#x4EA4;&#x96C6;&#xFF08;B &#x2229; C&#xFF09;</span>
                <span class="token comment">// B: &#x670D;&#x52A1;&#x4EB2;&#x548C;Labels  C:&#x88AB;&#x9009;&#x51FA;&#x7684;&#x4EB2;&#x548C;Node&#x7684;Lables                           &#x2462;</span>
                <span class="token function">AddUnsetLabelsToMap</span><span class="token punctuation">(</span>affinityLabels<span class="token punctuation">,</span> s<span class="token punctuation">.</span>labels<span class="token punctuation">,</span> labels<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>nodeWithAffinityLabels<span class="token punctuation">.</span>Labels<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// &#x8FDB;&#x884C;&#x4E00;&#x6B21;&#x6700;&#x7EC8;&#x7684;&#x5339;&#x914D;&#xFF08;affinityLabels &#x4E0E; &#x88AB;&#x68C0;&#x6D4B;&#x4EB2;&#x548C;&#x7684;node.Labels &#xFF09;               &#x2463;</span>
    <span class="token keyword">if</span> <span class="token function">CreateSelectorFromLabels</span><span class="token punctuation">(</span>affinityLabels<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Matches</span><span class="token punctuation">(</span>labels<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Labels<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>algorithm<span class="token punctuation">.</span>PredicateFailureReason<span class="token punctuation">{</span>ErrServiceAffinityViolated<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x2460; <em>FilterOutPods()</em> 
&#x7B5B;&#x9009;&#x6389;&#x5B58;&#x5728;&#x4E8E;Node&#xFF08;nodeinfo&#xFF09;&#x4E0A;pods&#xFF0C;&#x4E14;&#x4E0E;&#x4E4B;&#x8FDB;&#x884C;podKey&#x6BD4;&#x5BF9;&#x4E0D;&#x76F8;&#x7B49;&#x7684;pods
filteredPods = &#x672A;&#x5728;Node&#x4E0A;&#x7684;pods + &#x5728;node&#x4E0A;&#x4F46;podKey&#x76F8;&#x540C;&#x7684;pods</p>
<div><p class="code-filename">pkg/scheduler/cache/node_info.go:656</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>NodeInfo<span class="token punctuation">)</span> <span class="token function">FilterOutPods</span><span class="token punctuation">(</span>pods <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod <span class="token punctuation">{</span>
    <span class="token comment">//&#x83B7;&#x53D6;Node&#x7684;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;</span>
    node <span class="token operator">:=</span> n<span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> node <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> pods
    <span class="token punctuation">}</span>
    filtered <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>pods<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> pods <span class="token punctuation">{</span>
         <span class="token comment">//&#x5982;&#x679C;pod&#xFF08;&#x4EB2;&#x548C;matched&#xFF09;&#x7684;NodeName &#x4E0D;&#x7B49;&#x4E8E;Spec&#x914D;&#x7F6E;&#x7684;nodeNmae (&#x5373;pod&#x4E0D;&#x5728;&#x6B64;Node&#x4E0A;)&#xFF0C;&#x5C06;pod&#x653E;&#x5165;filtered.</span>
        <span class="token keyword">if</span> p<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>NodeName <span class="token operator">!=</span> node<span class="token punctuation">.</span>Name <span class="token punctuation">{</span>
            filtered <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>filtered<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//&#x5982;&#x679C;&#x5728;&#x6B64;Node&#x4E0A;&#xFF0C;&#x5219;&#x83B7;&#x53D6;podKey&#xFF08;pod.UID&#xFF09;</span>
        <span class="token comment">//&#x904D;&#x5386;&#x6B64;Node&#x4E0A;&#x6240;&#x6709;&#x7684;&#x76EE;&#x6807;Pods&#xFF0C;&#x83B7;&#x53D6;&#x6BCF;&#x4E2A;podKey&#x8FDB;&#x884C;&#x4E0E;&#x5339;&#x914D;pod&#x7684;podkey&#x662F;&#x5426;&#x76F8;&#x540C;&#xFF0C;</span>
    <span class="token comment">//&#x76F8;&#x540C;&#x5219;&#x5C06;pod&#x653E;&#x5165;filtered&#x5E76;&#x8FD4;&#x56DE;</span>
        podKey<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">GetPodKey</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> np <span class="token operator">:=</span> <span class="token keyword">range</span> n<span class="token punctuation">.</span><span class="token function">Pods</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            npodkey<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">GetPodKey</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span>
            <span class="token keyword">if</span> npodkey <span class="token operator">==</span> podKey <span class="token punctuation">{</span>
                filtered <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>filtered<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> filtered
<span class="token punctuation">}</span>
</code></pre>
<p>&#x2461; <em>FindLabelsInSet() </em> 
&#x53C2;&#x6570;&#x4E00;&#xFF1A; (B)&#x5B9A;&#x4E49;&#x7684;&#x4EB2;&#x548C;&#x6027;Labels&#x914D;&#x7F6E;
&#x53C2;&#x6570;&#x4E8C;&#xFF1A; (A)&#x88AB;&#x8C03;&#x5EA6;pod&#x7684;&#x5B9A;&#x4E49;NodeSelector&#x914D;&#x7F6E;Selector
&#x68C0;&#x6D4B;&#x5B58;&#x5728;&#x7684;&#x4E8E;NodeSelector&#x7684;&#x4EB2;&#x548C;&#x6027;Labels&#x914D;&#x7F6E;&#xFF0C;&#x5219;&#x53D6;&#x4E24;&#x8005;&#x7684;&#x4EA4;&#x96C6;&#x90E8;&#x5206;. &#xFF08;A &#x2229; B&#xFF09; </p>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/utils.go:26</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">FindLabelsInSet</span><span class="token punctuation">(</span>labelsToKeep <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> selector labels<span class="token punctuation">.</span>Set<span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span>
    aL <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> l <span class="token operator">:=</span> <span class="token keyword">range</span> labelsToKeep <span class="token punctuation">{</span>
        <span class="token keyword">if</span> selector<span class="token punctuation">.</span><span class="token function">Has</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            aL<span class="token punctuation">[</span>l<span class="token punctuation">]</span> <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> aL
<span class="token punctuation">}</span>
</code></pre>
<p>&#x2462; <em>AddUnsetLabelsToMap()</em>
&#x53C2;&#x6570;&#x4E00;&#xFF1A; (N)&#x5728;FindLabelsInSet()&#x8BA1;&#x7B97;&#x51FA;&#x6765;&#x7684;&#x4EA4;&#x96C6;Labels 
&#x53C2;&#x6570;&#x4E8C;&#xFF1A; (B)&#x5B9A;&#x4E49;&#x7684;&#x4EB2;&#x548C;&#x6027;Labels&#x914D;&#x7F6E;
&#x53C2;&#x6570;&#x4E09;&#xFF1A; (C)&quot;&#x88AB;&#x9009;&#x51FA;&#x7684;&#x4EB2;&#x548C;Node&quot;&#x4E0A;&#x7684;Lables
 &#x68C0;&#x6D4B;&#x5B58;&#x5728;&#x7684;&#x4E8E;&quot;&#x88AB;&#x9009;&#x51FA;&#x7684;&#x4EB2;&#x548C;Node&quot;&#x4E0A;&#x7684;&#x4EB2;&#x548C;&#x6027;&#x914D;&#x7F6E;Labels&#xFF0C;&#x5219;&#x53D6;&#x4E24;&#x8005;&#x7684;&#x4EA4;&#x96C6;&#x90E8;&#x5206;&#x5B58;&#x653E;&#x81F3;N.      (B &#x2229; C)=&gt;N</p>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/utils.go:37</p></div>
<pre class="language-"><code class="lang-go"><span class="token comment">// &#x8F93;&#x5165;&#xFF1A;&#x4EA4;&#x96C6;Labels&#x3001;&#x670D;&#x52A1;&#x4EB2;&#x548C;Labels&#x3001;&#x88AB;&#x9009;&#x51FA;&#x7684;&#x4EB2;&#x548C;Node Lables</span>
<span class="token comment">// &#x586B;&#x5145;&#xFF1A;Labels&#x4EA4;&#x96C6; ==&#xFF08;B &#x2229; C&#xFF09; B: &#x670D;&#x52A1;&#x4EB2;&#x548C;Labels  C:&#x88AB;&#x9009;&#x51FA;&#x7684;&#x4EB2;&#x548C;Node Lables</span>
<span class="token keyword">func</span> <span class="token function">AddUnsetLabelsToMap</span><span class="token punctuation">(</span>aL <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> labelsToAdd <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> labelSet labels<span class="token punctuation">.</span>Set<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> l <span class="token operator">:=</span> <span class="token keyword">range</span> labelsToAdd <span class="token punctuation">{</span>
        <span class="token comment">// &#x5982;&#x679C;&#x5B58;&#x5728;&#x5219;&#x4E0D;&#x4F5C;&#x4EFB;&#x4F55;&#x64CD;&#x4F5C;</span>
        <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> exists <span class="token operator">:=</span> aL<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">;</span> exists <span class="token punctuation">{</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// &#x53CD;&#x4E4B;&#xFF0C;&#x8BA1;&#x7B97;&#x5305;&#x542B;&#x7684;&#x4EA4;&#x96C6;&#x90E8;&#x5206; C &#x2229; B</span>
        <span class="token keyword">if</span> labelSet<span class="token punctuation">.</span><span class="token function">Has</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            aL<span class="token punctuation">[</span>l<span class="token punctuation">]</span> <span class="token operator">=</span> labelSet<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&#x2463; <em>CreateSelectorFromLabels().Match()</em>  &#x8FD4;&#x56DE;labels.Selector&#x5BF9;&#x8C61;</p>
<div><p class="code-filename">pkg/scheduler/algorithm/predicates/utils.go:62</p></div>
<pre class="language-"><code class="lang-go"><span class="token keyword">func</span> <span class="token function">CreateSelectorFromLabels</span><span class="token punctuation">(</span>aL <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> labels<span class="token punctuation">.</span>Selector <span class="token punctuation">{</span>
    <span class="token keyword">if</span> aL <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>aL<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> labels<span class="token punctuation">.</span><span class="token function">Everything</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> labels<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>aL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AsSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>End</strong> </p>
<footer class="page-footer"><span class="copyright">Copyright &#xA9; farmer.hutao@outlook.com 2019 all right reserved&#xFF0C;powered by Gitbook</span><span class="footer-modification">&#x8BE5;&#x6587;&#x4EF6;&#x4FEE;&#x8BA2;&#x65F6;&#x95F4;&#xFF1A;
2019-06-20 14:58:28
</span></footer><div id="anchors-navbar"><i class="fa fa-anchor"></i><ul><p><a href="#&#x4E13;&#x9898;-&#x4EB2;&#x548C;&#x6027;&#x8C03;&#x5EA6;(Author_-_XiaoYang)">&#x4E13;&#x9898;-&#x4EB2;&#x548C;&#x6027;&#x8C03;&#x5EA6;(Author - XiaoYang)</a></p><li><a href="#&#x7B80;&#x4ECB;">1. &#x7B80;&#x4ECB;</a></li><ul><li><a href="#&#x7EA6;&#x675F;&#x8C03;&#x5EA6;">1.1. &#x7EA6;&#x675F;&#x8C03;&#x5EA6;</a></li><li><a href="#Labels_selector&#x6807;&#x7B7E;&#x9009;&#x62E9;&#x5668;">1.2. Labels.selector&#x6807;&#x7B7E;&#x9009;&#x62E9;&#x5668;</a></li></ul><li><a href="#Node&#x4EB2;&#x548C;&#x6027;">2. Node&#x4EB2;&#x548C;&#x6027;</a></li><ul><li><a href="#Node&#x4EB2;&#x548C;&#x6027;&#x9884;&#x9009;&#x7B56;&#x7565;MatchNodeSelectorPred">2.1. Node&#x4EB2;&#x548C;&#x6027;&#x9884;&#x9009;&#x7B56;&#x7565;MatchNodeSelectorPred</a></li><li><a href="#Node&#x4EB2;&#x548C;&#x6027;&#x4F18;&#x9009;&#x7B56;&#x7565;NodeAffinityPriority">2.2. Node&#x4EB2;&#x548C;&#x6027;&#x4F18;&#x9009;&#x7B56;&#x7565;NodeAffinityPriority</a></li></ul><li><a href="#Pod&#x4EB2;&#x548C;&#x6027;">3. Pod&#x4EB2;&#x548C;&#x6027;</a></li><ul><li><a href="#Pod&#x4EB2;&#x548C;&#x6027;&#x9884;&#x9009;&#x7B56;&#x7565;MatchInterPodAffinityPred">3.1. Pod&#x4EB2;&#x548C;&#x6027;&#x9884;&#x9009;&#x7B56;&#x7565;MatchInterPodAffinityPred</a></li><li><a href="#Pod&#x4EB2;&#x548C;&#x6027;&#x4F18;&#x9009;&#x7B56;&#x7565;InterPodAffinityPriority">3.2. Pod&#x4EB2;&#x548C;&#x6027;&#x4F18;&#x9009;&#x7B56;&#x7565;InterPodAffinityPriority</a></li></ul><li><a href="#Service&#x4EB2;&#x548C;&#x6027;">4. Service&#x4EB2;&#x548C;&#x6027;</a></li><ul><li><a href="#Serice&#x4EB2;&#x548C;&#x6027;&#x9884;&#x9009;&#x7B56;&#x7565;checkServiceAffinity">4.1. Serice&#x4EB2;&#x548C;&#x6027;&#x9884;&#x9009;&#x7B56;&#x7565;checkServiceAffinity</a></li></ul></ul></div><a href="#&#x7B80;&#x4ECB;" id="goTop"><i class="fa fa-arrow-up"></i></a>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="init.html" class="navigation navigation-prev " aria-label="Previous page: 调度器初始化">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="summarize.html" class="navigation navigation-next " aria-label="Next page: scheduler 总结">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"专题-亲和性调度","level":"2.2.9","depth":2,"next":{"title":"scheduler 总结","level":"2.2.10","depth":2,"path":"core/scheduler/summarize.md","ref":"core/scheduler/summarize.md","articles":[]},"previous":{"title":"调度器初始化","level":"2.2.8","depth":2,"path":"core/scheduler/init.md","ref":"core/scheduler/init.md","articles":[]},"dir":"ltr"},"config":{"plugins":["theme-comscore","codeblock-filename","navigator","simple-page-toc","expandable-chapters-small","search-pro","splitter","multipart","tbfed-pagefooter","prism","-highlight","editlink","github","github-buttons@2.1.0","donate","copy-code-button"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"Copyright &copy farmer.hutao@outlook.com 2019","modify_label":"该文件修订时间：","modify_format":"YYYY-MM-DD HH:mm:ss"},"prism":{},"github":{"url":"https://github.com/farmer-hutao/k8s-source-code-analysis"},"editlink":{"label":"编辑本页","multilingual":false,"base":"https://github.com/farmer-hutao/k8s-source-code-analysis/edit/master"},"simple-page-toc":{"maxDepth":4,"skipFirstH1":true},"splitter":{},"search-pro":{"cutWordLib":"nodejieba","defineWord":["Gitbook Use"]},"search":{},"multipart":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"donate":{"alipay":"","alipayText":"支付宝打赏","button":"鼓励作者","title":"催作者快快更新","wechat":"./image/wx.jpg","wechatText":"微信小额捐赠，鼓励作者尽快更新～"},"fontsettings":{"theme":"white","family":"sans","size":2},"codeblock-filename":{},"theme-comscore":{},"navigator":{},"github-buttons":{"repo":"farmer-hutao/k8s-source-code-analysis","types":["star"],"size":"small"},"expandable-chapters-small":{},"copy-code-button":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":true}},"theme":"default","author":"Tao Hu <farmer.hutao@outlook.com>","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"《k8s-1.13版本源码分析》","gitbook":"*","description":"k8s source code analysis"},"file":{"path":"core/scheduler/affinity.md","mtime":"2019-06-20T06:58:28.322Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-06-20T07:00:23.544Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-editlink/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-github-buttons/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-donate/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-theme-comscore/test.js"></script>
        
    

    </body>
</html>

